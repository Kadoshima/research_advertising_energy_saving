# フェーズ0-1 har/003 動作ライン手順（2025-11-25 19:00）

フェーズ0-1で har/003 を「フェーズ1へ渡せる1本のHARライン」まで仕上げるための最小手順。ToDoチェックリストとしてそのまま使う。

---

## 0. ゴールと割り切り
- 対象: har/003（胸Acc 3ch基準）
- ゴール目安: 12c mean BAcc≈0.8、4c mean BAcc≈0.85、代表foldで4c BAcc≳0.88–0.90。
- 校正: オフラインで T_global / τ_global を決め、BLE側へ渡せる U/S/CCS を出す。
- 割り切り: 全foldでECE≤0.05は狙わない。fold1/4/5の崩れは診断レーン扱い、代表fold優先。

## 1. ディレクトリと設定
- 構成（前提）:
```
har/003/
  configs/phase0-1.local.yaml
  data_processed/
  docs/フェーズ0-1/{splits.yaml, 再構築指示書.md, har_phase0-1_results.md, 動作ライン手順.md}
  models/
  runs/phase0-1/
  src/{preprocess_mhealth.py, model.py, train_phase0-1.py, calibration.py, offline_calibrate.py, uscs_compute.py}
```
- config 必須項目:
  - `paths.processed_dir="har/003/data_processed"`, `paths.runs_dir="har/003/runs/phase0-1"`
  - `model.in_ch=3`, `model.n_classes=12`
  - `train.batch=256, lr=1e-3, weight_decay=1e-4, max_epoch=80, early_stop_patience=10, use_class_weight=true`
  - `calibration.ece_bins=15`
  - `unknown.tau_target_coverage=[0.05,0.15]`（実運用はオフライン τ_global）

## 2. 前処理（preprocess_mhealth.py）
- 入力: `data/MHEALTHDATASET/mHealth_subject{ID}.log`、Fs=50Hz。
- 窓: 長さ2.0s(100点)、hop1.0s。中心±0.25sで多数決し窓純度≥0.75、Null(0)窓は破棄。
- ラベル: `y12`=1–12、`y4`=Locomotion/Transition/Stationary/Ignoreへのマップ。
- 正規化: 被験者別 z-score を X 全体に適用。
- 出力: `data_processed/subject{ID:02d}.npz` に `X(N,100,3), y12, y4, spans, preproc_hash`。

## 3. LOSO 分割（splits.yaml）
- 既定の5foldを固定（valはfoldごとにローテーション）。seed=42。再編集しない。

## 4. モデル（model.py）
- 入力 `[B,100,3]` → permute → Conv1d系 Tiny DS-CNN で logits `[B,12]` を出す。
- 例: Conv1d 3→32(k5) → DW32(k5)→PW64 → DW64(k5,dil=2)→PW96 → GAP → Linear 96→12。パラメタ≲数千、FLOPs<0.05Mを目安。

## 5. 学習（train_phase0-1.py）
- Dataset: `y = y12-1` で0–11化。train shuffle=True、val/test shuffle=False。
- Optim: Adam(lr=1e-3, wd=1e-4)、Loss: freq逆数のクラス重み付きCE。
- early-stop: val BAcc(12c)が10epoch改善なしで停止。best stateを保存。
- metrics.json（fold毎）: val/testのBAcc・F1、val_logits、val_labels（必要ならtest_logitsも保存）。
- summary.json: fold別test指標の mean/median/min/max。

## 6. オフライン校正（offline_calibrate.py）
- 全foldの val_logits/val_labels を結合。
- T_global 探索: grid {0.5,0.75,1.0,1.25,1.5,1.75,2.0,2.5,3.0} でECE(15bin)最小のTを選択。
- τ_global: `probs=softmax(logits/T_global)` の maxp 10%分位を採用（target_unknown=0.10、要件5–15%内）。
- 保存: `global_calibration.json` に T_global, tau_global, target_unknown, ece_val, unknown_val。
- calibrated集計: T/τを各fold testに適用し、12c/4cのBAcc/F1/ECE/Unknownを `summary_calibrated.json` に出力。

## 7. 代表foldの選定と評価
- summaryから4c BAccがmedianに近いfoldを representative_fold とする（fold2想定）。
- 代表foldの test logits に T_global/τ_global を適用し、12c/4c BAcc・F1・ECE・Unknown を計算。
- `har_phase0-1_results.md` に before/after T/τ と代表foldの指標を記載。

## 8. エクスポート
- 代表foldのbestモデルを FP32→int8 PTQ で `models/har003_phase0-1_foldX_int8.tflite` として保存。
- `har_config.h` 用メタ: model_id, calib_T, unknown_tau, window_len=1.0, overlap=0.5, W_sec=10, theta_low/high など Phase1項目に合わせて記録。

## 9. 注意事項
- fold毎にT/τを最適化しない。T_global/τ_globalを全foldへ適用。
- ECE 0.05にこだわり過ぎない。代表foldで0.05〜0.07ならBLE用途は許容。
- 学習と校正を同一スクリプトに混ぜない。trainとoffline_calibrateを分離。
- 全foldを完璧にしようとしない。代表foldを仕上げ、崩れfoldは診断レポート扱い。
- ドキュメント更新を忘れない。本手順や再構築指示書に変更点を追記する。

---

## チェックリスト
- [ ] data_processed を再生成し preproc_hash を記録した。
- [ ] splits.yaml（LOSO固定）を確認した。
- [ ] 各foldの metrics.json に val_logits/labels と指標を残した。
- [ ] offline_calibrate で T_global/τ_global を決定し global_calibration.json を保存した。
- [ ] summary_calibrated.json でゲート確認、代表foldを決定した。
- [ ] 代表foldの指標を har_phase0-1_results.md に記載した。
- [ ] int8 TFLite と har_config.h メタを出力した。
