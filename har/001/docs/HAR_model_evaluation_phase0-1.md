# HAR小型MLモデル 評価リスト（Phase 0-1）

**作成日**: 2025-11-26
**データソース**: `har/001/runs/phase0-1/summary.json`, `fold5/metrics.json`
**モデル**: DSCNN-based HAR (DS-CNN with 3 depthwise separable layers)

研究目的（BLE送信間隔制御のためのU/S/CCS計算）に照らして、Phase 0-1で実装したモデルを評価します。

---

## 1. モデル基本仕様

| 評価項目 | Phase 0-1 実装値 | 目標値 | 達成状況 |
|---------|-----------------|--------|---------|
| パラメータ数 | 63,180 | ~1,000 | ❌ 63x超過 |
| FLOPs | 未測定 | ~0.03M | - |
| float32サイズ (KB) | 246 KB (0.24 MB) | - | - |
| int8 TFLiteサイズ (KB) | 61.7 KB (推定) | ≤22 KB | ❌ 2.8x超過 |
| Arena推定メモリ (KB) | 未測定 | ≤50 KB (ESP32制約) | ⚠️ 要実測 |

**コメント**:
- パラメータ数とモデルサイズが目標を大幅に超過
- ESP32実装には軽量化（チャネル数削減、層数削減）が必須
- アーキテクチャ: Conv1d(3→48) + 3×DSConv + 2×Linear(160→128→12)

---

## 2. 認識性能（10-fold LOSO）

| 評価項目 | Phase 0-1 実装値 | fold5代表モデル | 備考 |
|---------|-----------------|----------------|------|
| Test Accuracy (BAcc, 12-class) | 74.1% ± 14.4% | 91.0% | LOSO平均 / 最優秀fold |
| Macro F1 (12-class) | 68.0% ± 13.9% | 82.8% | クラス不均衡考慮 |
| Weighted F1 (12-class) | 未記録 | 未記録 | - |
| 4-class BAcc | 82.0% ± 14.5% | 94.8% | Operational分類 |
| 4-class Macro F1 | 66.9% ± 13.2% | 72.5% | - |
| クラス別F1（最低クラス） | 未測定 | Standing: 0%, Sitting: 0% | **構造的失敗** |

**コメント**:
- 12-class BAccは要件（≥80%）未達、4-class BAccは達成
- Standing/Sitting認識は壊滅的（平均33.3% / 20.0%）
- Lying認識は全被験者100%（重力シグネチャが明確）
- **被験者間分散が大きい**: fold1=54%, fold5=91%

---

## 3. 較正性能（重要）

| 評価項目 | Phase 0-1 実装値 | fold5代表モデル | 目標値 | 達成状況 |
|---------|-----------------|----------------|--------|---------|
| ECE (Expected Calibration Error) | 0.147 ± 0.106 | 0.0425 | ≤0.06 | ❌平均未達 / ✅fold5達成 |
| 最適温度 T | - | 1.056 | 0.5-5.0 | ✅ |
| Unknown閾値 τ | - | 0.50 | 5-15% coverage | ✅ |
| 実際のUnknown率 (%) | 10.5% ± 9.6% | 3.3% | 5-15% | ✅平均達成 |
| Reliability Diagram形状 | 未確認 | 未確認 | 対角線に近い | - |

**コメント**:
- 10-fold平均ECE=0.147は目標未達だが、fold5は0.0425で達成
- Temperature scaling適用済み（T=1.056≈1は良い傾向）
- Unknown率の被験者間分散が大きい（fold2=32.5%, fold10=0%）
- **較正品質は被験者依存が強い**

---

## 4. U/S/CCS出力品質

| 評価項目 | Phase 0-1 実装値 | 備考 |
|---------|-----------------|------|
| U分布の妥当性 | 未検証 | 動作時↑, 静止時↓の期待挙動 |
| S（安定度）の追従性 | 未検証 | 遷移検出の実測必要 |
| CCS分布範囲 | 理論上[0,1] | CCS = 0.6×U + 0.4×(1-S) |
| 状態遷移の安定性 | 未検証 | 振動抑制（min_stay=2s, max_switch=1Hz） |

**コメント**:
- U/S/CCSの実データ計算は未実施（実装済みだがログ未保存）
- BLE制御影響度分析で間接的に評価: Operational_Acc平均84.6%
- Stationary誤分類率の最悪ケース: Sub04で33.7%（→+40%電力消費）

---

## 5. 推論効率

| 評価項目 | Phase 0-1 実装値 | 目標値 | 備考 |
|---------|-----------------|--------|------|
| 推論時間@ESP32 (ms) | 未測定 | ≪1000ms | ESP32実装未実施 |
| 推論時間@PC (ms) | 未測定 | 参考値 | - |
| 量子化による精度低下 | 未測定 | int8 vs float32 | TFLite変換未実施 |

**コメント**:
- ESP32実装はPhase 1で予定
- モデルサイズ超過のため、軽量化後に再測定必要

---

## 6. 実用性

| 評価項目 | Phase 0-1 実装値 | 仕様要件 | 達成状況 |
|---------|-----------------|---------|---------|
| 入力仕様との整合性 | ✅ (100, 3) | (100, 6), 50Hz, 2s窓 | ⚠️ Gyro未使用 |
| 出力12クラスの対応 | ✅ | mHealth準拠 | ✅ |
| 4クラス集約の実装 | ✅ | Active/Transit/Stable/Ignore | ✅ |
| エラーハンドリング | 未実装 | IMU欠損時の挙動 | ❌ |

**コメント**:
- Chest Acc 3軸のみ使用（Gyroは未使用、`in_ch=3`）
- 4-class mapping実装済み: Locomotion/Transition/Stationary/Unknown
- IMU欠損時のフォールバック処理は未実装

---

## 7. コード品質・再現性

| 評価項目 | Phase 0-1 実装値 | 備考 |
|---------|-----------------|------|
| 学習コードの実行可能性 | ✅ | `train_phase0-1.py` |
| シード固定・再現性 | ✅ | seed=42固定 |
| TFLite変換成功 | 未実施 | Phase 1で予定 |
| 設定ファイル出力 | ✅ | YAML形式 (`phase0-1.local.yaml`) |
| ドキュメント完全性 | ✅ | 作業ログ、再評価報告書、外れ値分析 |

**コメント**:
- 全スクリプトが再実行可能、設定ファイルも完備
- トレーサビリティ完全（根拠数字→ソースファイル全て明記）
- TFLite変換とESP32実装はPhase 1で実施予定

---

## 優先度評価と総合判定

フェーズ0-1の目的上、以下の優先順位で評価します：

### 評価結果サマリー

| 優先度 | 評価観点 | Phase 0-1 達成度 | 判定 |
|-------|---------|-----------------|------|
| **最優先** | 較正性能（ECE ≤ 0.06） | fold5: ✅達成 / 平均: ❌未達 | △ |
| **高優先** | モデルサイズ（ESP32実装可能性） | ❌ 61.7KB（目標22KB） | ❌ |
| **高優先** | 認識精度（4-class BAcc ≥ 80%） | ✅ 82.0%達成 | ✅ |
| **中優先** | 推論効率 | 未測定 | - |
| **参考** | コード品質 | ✅ 完全再現可能 | ✅ |

### Phase 0-1 総合判定

**条件付き完了**: 以下の条件でPhase 1へ進行可能

#### ✅ 達成項目
1. **4-class認識精度**: BAcc 82.0%（要件≥80%）達成
2. **代表モデル較正性能**: fold5 ECE=0.0425（要件≤0.06）達成
3. **Unknown率**: 10.5%（要件5-15%）達成
4. **再現性**: 完全なトレーサビリティ確保

#### ❌ 未達項目（Phase 1での対応必要）
1. **モデルサイズ**: 61.7KB → 目標22KB（2.8倍超過）
   - 対応策: チャネル数削減（48→24, 96→48, etc.）、層数削減
2. **12-class較正性能**: 平均ECE=0.147（要件≤0.06未達）
   - 対応策: 4-class統合で回避（12-class個別制御は断念）
3. **Standing/Sitting認識**: 構造的失敗（平均33%/20%）
   - 対応策: Stationary統合で回避、または腰センサ追加（Phase 0-2）

#### ⚠️ 重要な制約
- **Chest sensor limitation**: Standing/Sitting区別不可（下半身状態が必要）
- **被験者間分散**: fold間で性能が大きく変動（BAcc: 54%-91%）
- **BLE制御影響**: 最悪ケースで+40%電力消費（Stationary誤分類）

### Phase 1への移行判断

**推奨**: Option A（4-class統合）で進行

**理由**:
1. 4-class BAccは要件達成済み（82.0%）
2. fold5代表モデルは較正性能も達成（ECE=0.0425）
3. BLE制御には4-class区分で十分（個別姿勢は不要）
4. モデル軽量化とESP32実装に集中可能

**Phase 1での重点タスク**:
1. モデル軽量化（目標: ≤22KB TFLite）
2. ESP32実装と推論時間測定
3. U/S/CCS実データログ検証
4. BLE制御統合テスト

---

## データソース

- **10-fold summary**: `har/001/runs/phase0-1/summary.json`
- **fold5 metrics**: `har/001/runs/phase0-1/fold5/metrics.json`
- **Model architecture**: `har/001/src/model.py` (DSCNN class)
- **Training config**: `har/001/configs/phase0-1.local.yaml`
- **BLE impact**: `har/001/analysis/ble_impact_summary.csv`
- **Subject analysis**: `har/001/analysis/subject_statistics.json`

---

**検証済み**: 2025-11-26, 全数値を元データファイルから直接抽出確認
