# Phase 2 実験設計書: Safe Contextual Bandit評価

## 1. 実験の目的

1. **Safe-UCBアルゴリズムの有効性**を検証（制約満足 + 報酬最大化）
2. **Warm-Start（Phase 1引き継ぎ）の効果**を定量化
3. **環境変化への適応性**を評価
4. **累積後悔（Regret）の収束性**を確認

---

## 2. 実験の種類

Phase 2では**2種類の実験**を実施:

| 種類 | 目的 | 環境 |
|------|------|------|
| **オフライン評価** | アルゴリズム比較、パラメータ調整 | シミュレーション |
| **オンライン評価** | 実機での有効性検証 | 実環境 |

---

## 3. オフライン評価（シミュレーション）

### 3.1 目的

- アルゴリズム間の比較（Safe-UCB vs UCB vs Fixed）
- ハイパーパラメータの調整
- Warm-Start効果の検証

### 3.2 シミュレーション設定

**入力データ**: Phase 1で収集したCCS時系列

**報酬モデル**:
```
r(a) = -μC(a)
μC(a) = q_adv × (D / T_adv)
```
- q_adv: Phase 1実測値から取得
- D: イベント持続時間（シナリオ設定）

**制約モデル**:
```
g(a) = Pout(τ | a) = (1 - p_d)^⌊τ / T_adv⌋
```
- p_d: Phase 1実測値（≈0.85）
- τ = 2s

**ノイズモデル**:
```
r_observed = r(a) + ε_r,  ε_r ~ N(0, σ_r²)
g_observed = g(a) + ε_g,  ε_g ~ N(0, σ_g²)
```
- σ_r, σ_g: Phase 1実測の標準偏差から設定

### 3.3 比較アルゴリズム

| アルゴリズム | 説明 |
|-------------|------|
| **Safe-UCB** | 提案手法。制約LCBを考慮した腕選択 |
| **UCB** | 制約なしUCB（ベースライン） |
| **Fixed-CCS** | Phase 1の固定写像（ベースライン） |
| **Oracle** | 最適腕を常に選択（理論上界） |

### 3.4 評価指標

| 指標 | 定義 | 目標 |
|------|------|------|
| **累積後悔** | Σ(r* - r_t) | 亜線形成長 O(√T) |
| **制約違反率** | #{g_t > δ} / T | ≤ δ |
| **収束ラウンド** | 最適腕選択率≥90%に達するラウンド | 参考値 |

### 3.5 シナリオ

| シナリオ | 内容 | 評価目的 |
|----------|------|---------|
| S1: 定常環境 | p_d, q_adv固定 | 基本性能 |
| S2: 環境変化 | T=5000でp_d変化 | 適応性 |
| S3: 高ノイズ | σ_r, σ_gを2倍 | ロバスト性 |

### 3.6 Warm-Start実験

| 条件 | 初期化方法 |
|------|-----------|
| **Cold-Start** | μ̂_r = 0, μ̂_g = 0.5 |
| **Warm-Start** | μ̂_r = Phase1_μC, μ̂_g = Phase1_Pout |

**評価**: 収束ラウンド、初期後悔の比較

---

## 4. オンライン評価（実機実験）

### 4.1 目的

- 実環境でのSafe-UCBの動作確認
- 長時間運用での安定性検証
- 環境変化時の適応性評価

### 4.2 実験条件

| 項目 | 値 | 備考 |
|------|-----|------|
| 環境 | E1（干渉弱）, E2（干渉強） | Phase 1と同条件 |
| 距離 | 1m | 固定 |
| Tx Power | 0 dBm | 固定 |
| スキャンモード | Android LOW_LATENCY | 固定 |
| セッション時間 | 60分 | 長時間運用 |

### 4.3 制御条件

| 条件ID | 条件名 | 説明 |
|--------|--------|------|
| C1 | Fixed-CCS | Phase 1の固定写像（ベースライン） |
| C2 | Safe-UCB-Cold | Cold-Start Safe-UCB |
| C3 | Safe-UCB-Warm | Warm-Start Safe-UCB |

### 4.4 反復設計

```
3条件 × 2環境 × 5セッション = 30セッション
```

- 各セッション60分 → 総実験時間: 30時間

### 4.5 セッション構成（60分）

| 時間 | 活動パターン | 目的 |
|------|-------------|------|
| 0-20分 | 座位主体（高CCS） | 学習初期の挙動 |
| 20-40分 | 歩行主体（低CCS） | 活動変化への対応 |
| 40-60分 | 混合（変動CCS） | 適応性評価 |

### 4.6 計測項目

| 項目 | 機器 | 計測対象 |
|------|------|---------|
| 電力 | PPK-II | ESP32のVBAT電流 |
| 送信ログ | ESP32 SD | timestamp, T_adv, CCS, U, S, arm_selected |
| 受信ログ | Android | timestamp, RSSI, seq |
| 学習ログ | ESP32 SD | μ̂_r, μ̂_g, UCB, LCB, N(a) |

### 4.7 ログスキーマ（Phase 2拡張）

**Txログ（Phase 1 + 拡張）**:
```
timestamp_ms, session_id, seq, T_adv, CCS, U, S, activity_label,
arm_selected, reward, constraint_value
```

**Learningログ（Phase 2新規）**:
```
timestamp_ms, round_t, arm, mu_r_hat, mu_g_hat, ucb_r, lcb_g, n_pulls
```

---

## 5. 評価指標

### 5.1 オフライン評価指標

| 指標 | 計算式 | 成功基準 |
|------|--------|---------|
| 累積後悔 | Σ(r* - r_t) | O(√T)成長 |
| 制約違反率 | #{g_t > δ} / T | ≤ δ (例: 5%) |
| 平均報酬 | mean(r_t) for t > T/2 | Fixed-CCS以上 |

### 5.2 オンライン評価指標

| 指標 | 計算式 | 成功基準 |
|------|--------|---------|
| μC/event | Phase 1と同様 | Fixed-CCS以上の削減 |
| Pout(τ) | Phase 1と同様 | ≤ δ を維持 |
| 腕選択分布 | histogram(arm_selected) | 合理的な分布 |
| 学習収束 | μ̂の変動収束 | セッション後半で安定 |

### 5.3 Warm-Start効果指標

| 指標 | 計算式 | 目標 |
|------|--------|------|
| 初期後悔削減率 | 1 - Regret_Warm(T=100) / Regret_Cold(T=100) | ≥ 30% |
| 収束ラウンド短縮 | T_conv_Cold - T_conv_Warm | > 0 |
| 初期違反率 | 違反率(T < 100) | Warm < Cold |

---

## 6. 成功基準

### 6.1 最低ライン（論文成立）

| 基準 | 条件 |
|------|------|
| 制約満足 | Pout(τ) ≤ δ を長期的に維持 |
| 報酬改善 | μC_Safe-UCB ≤ μC_Fixed-CCS |
| 累積後悔 | 亜線形成長を確認 |

### 6.2 理想ライン（トップカンファレンス級）

| 基準 | 条件 |
|------|------|
| 理論バウンド | O(√T log T)の後悔バウンド証明 |
| 適応性 | 環境変化後の再収束を確認 |
| Warm-Start | 収束ラウンド50%短縮 |

---

## 7. 実験スケジュール（案）

### 7.1 オフライン評価

| Week | タスク | 成果物 |
|------|--------|--------|
| 1 | シミュレータ実装 | Python実装 |
| 2 | アルゴリズム比較実験 | 比較結果 |
| 3 | Warm-Start実験 | 効果検証結果 |

### 7.2 オンライン評価

| Week | タスク | 成果物 |
|------|--------|--------|
| 4 | ESP32 Safe-UCB実装 | ファームウェア |
| 5 | E1環境で15セッション | 生データ（E1） |
| 6 | E2環境で15セッション | 生データ（E2） |
| 7 | 分析・執筆 | 論文原稿 |

---

## 8. リスクと対策

| リスク | 兆候 | 対策 |
|--------|------|------|
| 制約違反頻発 | Pout > δ が連続 | δを保守的に設定、Fallback発動 |
| 収束しない | μ̂が発散 | 学習率調整、正則化 |
| 計算リソース不足 | ESP32で処理遅延 | 軽量実装、更新頻度削減 |
| メモリ不足 | RAM枯渇 | 履歴のウィンドウ制限 |

---

## 9. 成果物

| 成果物 | 形式 | 用途 |
|--------|------|------|
| シミュレータ | Python | 再現・パラメータ調整 |
| ESP32実装 | C++ | 実機評価 |
| 実験ログ | CSV | 再現用アーカイブ |
| 後悔曲線 | PNG/PDF | 論文掲載 |
| 制約違反推移 | PNG/PDF | 論文掲載 |

---

## 10. Phase 1との差分

| 項目 | Phase 1 | Phase 2 |
|------|---------|---------|
| 方策 | 固定写像 | オンライン学習 |
| セッション時間 | 15分 | 60分 |
| ログ拡張 | Tx/Rx/Power | + Learning |
| 評価指標 | μC, Pout | + Regret, 収束 |
| 実験回数 | 60セッション | 30セッション |

---

## 11. Phase 3への接続

Phase 2実験データは、Phase 3で以下のように活用:

| Phase 2成果物 | Phase 3での発展 |
|---------------|----------------|
| Safe-UCB実装 | マルチ制約への拡張 |
| 学習パラメータ | 知識蒸留の入力 |
| 適応性データ | 非定常Banditへの発展 |

---

*Last updated: 2025-11-27*
