以下は、**フェーズ0-1（データ整合リファイン）要件定義書**です。フェーズ1のポリシ全体像を維持しつつ、mHealth胸装着データに合わせたHARモデルの再学習と較正を通じて安定したU/S/CCSを提供することを目的とします。

# フェーズ0-1 要件定義書（データ整合リファイン）

**文書ID**: ReFormHAR‑Tiny/REQ‑PH0‑1‑v1.0  
**対象**: mHealth胸装着データへのモデル転移と較正  
**成功見込み**: 70–80%

## 1. 目的
- モデル入力（軸・窓長・前処理）をmHealth胸装着データに合わせ、U（不確実度, Uncertainty）とCCS（複合スコア, Composite score）が素直に機能する状態を再構築する。
- フェーズ1の決め打ち写像とBLE計測を止めずに、HAR推論部のみを差し替え可能な形式で提供する。
- バランス精度（Balanced Accuracy）≥0.80、期待較正誤差（Expected Calibration Error, ECE）≤0.05、未知率（Unknown rate）5–15%を満たし、BLE評価へ合流する。

## 2. スコープと境界
- **対象処理**: 6軸（加速度＋ジャイロ）入力、窓長1.5–2.0 s、50%重畳、被験者別z-score正規化、温度スケーリングによる較正。
- **モデル更新**: 既存DS‑CNN系の最後の畳み込みブロックまでを凍結し、分類ヘッドを再学習。必要に応じて最終ブロックのみ解凍。
- **データ前処理緩和**: 窓純度しきい値0.7–0.8、境界除外±0.25–0.5 s、HPFは0.4 Hzに緩和。
- **除外**: 完全な新規モデル探索、MAB方策の更新、BLEチャネル制御。

## 3. 成功指標と受入基準
- **バランス精度（Balanced Accuracy）**: Validationで≥0.80（12クラス維持）。
- **マクロ平均F1スコア（F1 macro）**: フェーズ1既定モデル比で上昇し、動的クラスの崩落を解消。
- **期待較正誤差（Expected Calibration Error, ECE）**: ≤0.05（温度スケーリング適用後）。
- **未知率（Unknown rate）**: 5–15%（最大確率<τでUnknown、τは適合率-再現率曲線（Precision-Recall, PR）で最適化）。
- **CCS挙動**: 高U時にACTIVE（100 ms）へ、低U/S高時にQUIET（2000 ms）へ遷移する正負例タイムラインを確認。

## 4. 主な作業レーン
1. データ同期・整形: 6軸化、欠損補間、被験者別z-score、窓長2.0 s（比較として1.5 sも評価）。
2. モデル転移: 既存重み読み込み→ヘッド再学習→必要時に最終DWConvも解凍→量子化（QAT optional）。
3. 較正と閾値決定: 温度スケーリングでECEを0.05以下に調整し、{θ_low, θ_high}を受信者操作特性（Receiver Operating Characteristic, ROC）と適合率-再現率曲線（Precision-Recall, PR）で決定。
4. BLE接続評価: フェーズ0-0の評価線を流用し、U/S/CCSを差し替えてPout、TL、電力の変化を測定。

## 5. 成果物
- データ前処理仕様（窓長、重畳、純度、境界、フィルタ、正規化）。
- 再学習レポート（バランス精度, Balanced Accuracy／マクロ平均F1スコア, F1 macro／期待較正誤差, Expected Calibration Error／未知率, Unknown rate／混同行列）。
- 温度スケーリング係数Tと新しきい値{θ_low, θ_high}（Runbook差し替え用）。
- 更新後`.tflite`モデル、Arena/t_inf計測ログ、写像テーブルへの反映手順。

## 6. リスクと緩和
- **分布シフトの過小評価** → 6軸化・窓延長・HPF緩和をセットで適用し、再現データでA/B比較。
- **学習データ不足** → 窓純度しきい値を0.7–0.8に緩和し、被験者分割のfoldを増やす。
- **Unknownしきい値の不一致** → PRカーブでτを決定し、フェーズ1 Runbookにしきい値マッピングを追記。

## 7. フェーズ1との接続
- Policy EngineとBLE Advertiserはフェーズ1設計のまま使用し、HarOutのU/S/CCSのみを差し替える。
- ログスキーマ（model_id, calib_T, window_len, overlap, W_sec）はフェーズ1フォーマットを継続。
- 合格後はフェーズ1要件定義のFR‑2/FR‑3評価に本接続し、MAB導入前の初期方策としてWarm‑startを提供する。

---

# フェーズ0–1 要件定義 v0.1（HAR→BLE接続のための最小決めごと）

## 1) データ仕様（mHealth; chest 前提）

**決めること**

* サンプリング周波数: **50 Hz**
* 単位: **m/s²（加速度）**, **deg/s（ジャイロ）**（異なる場合はスケール変換）
* 軸順序: **Acc[X,Y,Z], Gyro[X,Y,Z]**（右手系; ファイルの列順に合わせて変換）
* 姿勢: 胸センサの**装着方向**（X: 左↔右, Y: 下↔上, Z: 背↔胸）。不明時は**重力ベクトルで補正**（低域通過でg推定）。
* 6軸化: **可**。欠損処理は**線形補間（≤200 ms）/ それ以上は窓ごと除外**。
* データ出所・版管理: `data/MHEALTHDATASET/` 配下に **README.md**, **SHA256.txt**（全ファイルのハッシュ）を置く。

**SHAの作り方（例）**

```bash
find data/MHEALTHDATASET -type f -exec shasum -a 256 {} \; | sort > data/MHEALTHDATASET/SHA256.txt
```

---

## 2) クラス設計（内部12→運用クラス）

**原則**

* 学習は**内部12クラス**（mHealth定義準拠）で実施 → 運用で**後段マッピング**（情報落ちを回避）。
* Unknownは**学習に含めない**（推論時に閾値で排他）。

**マッピング表（例）**
（※語は短縮：Sta=Stationary, Wal=Walking, Jog=Jogging, Run=Running, Bik=Cycling, UpS=Upstairs, DnS=Downstairs, Sit=Sit, Stan=Stand, Lie=Lie, Tras=Transport, Null=Null）

| 内部12 | 運用4        |
| ---- | ---------- |
| Sta  | Locomotion |
| Wal  | Locomotion |
| Jog  | Locomotion |
| Run  | Locomotion |
| Bik  | Locomotion |
| UpS  | Transition |
| DnS  | Transition |
| Sit  | Stationary |
| Stan | Stationary |
| Lie  | Stationary |
| Tras | Ignore     |
| Null | Ignore     |

**併合/除外の基準**

* **Ignore**は評価から除外（train: Hard negativeとして使わない）
* デモ段階は運用4に合算してメトリクスも出す（12も保存）

---

## 3) 分割戦略

* スキーム: **LOSO 5-fold（subject-wise）**
* 例（仮）: `fold-1: train=[S2..S9], val=[S10], test=[S1]` …（全foldでローテーション）
* seed: **42** 固定（NumPy/torch/TF）

**追記ファイル**

* `docs/フェーズ0-1/splits.yaml` に fold ごとの **train/val/test subject_id** を列挙

---

## 4) 前処理パラメータ（デフォルト）

* 入力: **6軸（Acc+Gyro）**
* 窓: **2.0 s**, **50%重畳**
* HPF: **0.4 Hz（一階）**（重力除去は過剰適用せず）
* 正規化: **被験者別 z-score**
* 窓純度: **≥0.75**
* 境界除外: **±0.25 s**
* 安定度Sの窓: **W=10 s**（ラベル遷移/代理指標用）

---

## 5) 学習・較正・評価（最小一式）

**学習**

* Optim: **Adam**, lr=**1e-3**, batch=**256**, max **80** epoch, **early-stop=10**, weight decay **1e-4**
* 損失: **重み付きCE**（クラス頻度逆数で正規化）
* 増強: **±10% 時間伸縮**, **±5° ランダム回転**, **白色ノイズ SNR>20dB**

**較正**

* **ECE**: **等頻度 15-bin**
* **温度スケーリング**: val で **T** を最小化（NLL/ECE両監視）→ **T** を保存

**Unknown判定**

* ルール: **max-softmax < τ** → **Unknown**
* τの決め方: valで **Unknownカバレッジ 5–15%** のレンジで **F1macro** 最大の τ を選ぶ（PRで確認）

**CCSの閾値（θ_low/θ_high）**

* CCS = **0.6·U + 0.4·(1−S)**  
  （注：フェーズ1の統一式〔CCS=0.7×confidence+0.3×stability〕との整合はP1で再較正し、Runbookの置換表に反映）
* val で **ROC/PR**を引き、**低頻度(2000ms)**, **中(500ms)**, **高(100ms)** の3段切替を最適化
* デフォルト初期値: **θ_high=0.70 / θ_low=0.40**, 最小滞在 **2 s**, 切替回数**≤1回/s**

**評価指標**

* **Balanced Accuracy**, **F1(macro)**, **ECE**, **Unknown率**, **推論レイテンシ**
* 運用4クラスに合算した **BAcc/F1** も併記

---

## 6) デプロイ仕様（TinyML）

* 量子化: **PTQ**（per-channel conv）→ 改善余地あれば **QAT 8–15 epoch**
* 校正データ: **2k 窓**（被験者横断）
* TFLM: **Op互換確認**（Conv, DWConv, Add, Mul, Relu/ReLU6, AvgPool, Softmax）
* モデル命名: `model_id=HAR_chest6x_2s_vYYMMDD_NN`
* リソース計測: **Arena ≤ 80 KB, t_inf ≤ 20 ms @240 MHz**（実測値を `docs/フェーズ0-1/deploy_metrics.md` に追記）

---

## 7) ログ拡張（再現用メタ）

**列追加（推奨）**

* `subject_id, activity_id, dataset_version, preproc_hash, split_id, model_id, calib_T, tau_unknown, theta_low, theta_high`

**設定ハッシュ**

* `preproc_hash = SHA256(窓/HPF/zscore/純度/境界/増強のJSON)`
* `run_hash = SHA256(preproc_hash + split_id + model_id + seed)`

---

## 8) ゲート / フォールバック（レーン移行）

* **Go to BLE本接続（レーン1→2）**:
  `BAcc ≥ 0.80` **かつ** `ECE ≤ 0.05` **かつ** `Unknown 5–15%`
* **Fallback（腰寄せ or 擬似U/Sで進行）**:
  `BAcc < 0.80` **または** `ECE > 0.05` を **2 回の微調整**後も満たせない場合、**レーン2**へ移行
  （締切目安：**3実験日 or 2 iteration**）

---

# 付録A：設定ファイルの雛形

**`configs/phase0-1.yaml`**

```yaml
data:
  fs_hz: 50
  axes: [AccX, AccY, AccZ, GyroX, GyroY, GyroZ]
  unit: {acc: "m/s2", gyro: "deg/s"}
  posture: {x: "left->right", y: "down->up", z: "back->chest"}
  missing: {interp_ms_max: 200, drop_window_if_exceeds: true}
  version: "mhealth_v1"
window:
  length_s: 2.0
  hop_s: 1.0
  purity_min: 0.75
  boundary_exclude_s: 0.25
preprocess:
  hpf_hz: 0.4
  zscore_scope: "per_subject"
split:
  scheme: "LOSO_5fold"
  seed: 42
train:
  optim: "adam"
  lr: 1e-3
  batch: 256
  max_epoch: 80
  early_stop_patience: 10
  weight_decay: 1e-4
  loss: "weighted_ce"
  aug: {time_stretch: 0.1, rot_deg: 5, noise_snr_db: 20}
calibration:
  ece_bins: 15
  ece_binning: "equal_frequency"
  temp_scale: true
unknown:
  tau_target_coverage: [0.05, 0.15]
  select_by: "max_F1_macro"
ccs:
  alpha: 0.6  # U weight
  beta: 0.4   # (1-S)
  theta_low: 0.40
  theta_high: 0.70
  min_stay_s: 2.0
  max_switch_per_s: 1
deploy:
  quant: {ptq: true, qat: false, calib_windows: 2000, per_channel: true}
  limits: {arena_kb_max: 80, t_inf_ms_max: 20}
```

---

# 付録B：評価プロトコル（要点だけ）

1. **分割固定** → train で学習 → val で **T, τ, θ** を確定 → test で**一回**評価
2. **指標**：BAcc/F1macro（12 & 運用4）、ECE、Unknown率、t_inf、Arena
3. **ログ**：`*_summary.json` に **seed, split_id, preproc_hash, model_id, calib_T, tau, theta** を必ず保存
4. **BLE接続の準備**：`pred.csv` に `entropy, U, S, CCS` を列追加（BLE側がそのまま読める）

---

# 付録C：小さなFAQ（詰まり回避）

* **GMP(wl=24)で0.43の頭打ち** → **6軸化 & 窓2s**にまず上げる。3軸×短窓は胸では厳しい。
* **Jog/Run/BikがStairs/Staに崩れる** → HPFを弱く、**ジャイロ追加**、**2s窓**で周期特徴を回収。
* **サンプルが少ない**（純度/境界除外で激減）→ **純度0.75/境界0.25s**へ緩和。
* **Uが暴れる** → **温度スケーリング＋移動平均（3–5窓）＋ヒステリシス**。

---

# 次アクション（30分でできること）

1. `configs/phase0-1.yaml` をリポジトリに追加
2. `docs/フェーズ0-1/要件定義.md` に本内容のコピペ＋分割表（splits.yaml）を作成
3. mHealth配下の**SHA256.txt**を作成
4. 既存スクリプトのログ列に**preproc_hash, split_id, model_id, calib_T, tau, theta**を追加

