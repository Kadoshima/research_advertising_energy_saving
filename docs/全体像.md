以下は、**ReFormHAR‑Tiny** の“引きの目線”から描いた **Vision / World Model** です。
目的は、**他のAIがこのプロジェクトの世界観・用語・約束事を読み取って、そのまま正しく解釈・再構成できる**ように、**用語の正規化・不変条件・境界条件・役者・相互作用・成熟段階**を体系化して提示することです。コードや実装詳細には踏み込みません。

---

## 0) North Star（北極星）

> **人に寄り添う省電力AIを“端末だけで成立させる”。**
> センサ→推論→通信の**3層を同時に最適化**し、**期限内に届くこと（Pout(τ)の保証）**と**電池寿命の最大化（mWh/日、µC/イベント最小）**を**同時達成**する。
> 学習は**軽量・安全**で、**環境とユーザの変化**に**自律追従**する。

北極星を定義しておくと、後述の設計判断（方針・評価・リスク対策）はこのベクトルに**常時整合**させます。

---

## 1) World Model（世界観の骨格）

### 1.1 役者（Actors）

* **Edge Node / DUT**：IMU＋マイコン（MCU）。**HAR**（人間行動認識）を**オンデバイス**で推論し、**不確実度 U** と **安定度 S** を生成、**BLE広告**の振る舞いを決める。
* **Gateway（スマホ/受信機）**：BLE広告を受けるだけの**受信主体**。**スキャンは非理想**（チャネル巡回・隙間・モード差）であることを前提とする。
* **Observer / Orchestrator（任意）**：実験・運用でログを収集し、**KPI**（Pout、遅延TL、PDR、µC、平均電流）を算出する。クラウド常時接続は不要。
* **Safety Oracle（概念）**：**QoS制約**（例：Pout(1s) ≤ θ）を定義し、**方策が常に守るべき境界**を提示する“規格書”的存在。
* **Policy Engine（概念→実体）**：**通信層の意思決定器**。Phase‑1はルール写像、Phase‑2でMAB、Phase‑3でSafe‑MAB（制約つき）へ進化。

### 1.2 能力（Capabilities）— 5つの柱

1. **Perception（知覚）**：IMU→HAR→確率分布 (p_k)、**U**（不確実度）、**S**（安定度）。
2. **Decision（意思決定）**：**CCS=0.6 U+0.4 (1−S)** をコンテキストに**BLE広告の間隔・チャネル集合**を決定。
3. **Communication（通信）**：**イベント電荷（µC）最小**で、**期限内初回受信（Pout(τ)の保証）**を満たす広告。
4. **Safety（安全）**：**常時** Pout(τ) ≤ θ を満たす**制約**の中で最適化。違反兆候で**安全側へ自動退避**。
5. **Observability（可観測性）**：**すべての意思決定に根拠ログ**（U,S,CCS,閾値、切替理由、適用可否）を残す。

### 1.3 不変条件（Invariants）

* **オンデバイス優先**：生センサは外に出さない（プライバシ）。
* **QoS優先の最適化**：**Pout(τ) を常に制約**として扱い、その範囲内で電力最小化。
* **後方互換のIF**：Policyの入出力（Context→Arm/Interval）は**固定契約**。内部実装が変わってもIFは壊さない。
* **単一真実のKPI**：**イベント電荷（µC）・Pout(τ)・TL分布**を“一次指標”。平均電流やmWh/日は従属。

### 1.4 境界条件（Operating Envelope）

* **MCU制約**：RAM≲256 KB / Flash≲1 MB、整数演算（INT8）前提。
* **BLE制約**：Legacy Advertising、3ch（37/38/39）、Tx/EIRPとDutyは地域規制遵守。
* **受信制約**：スマホは**連続スキャンではない**（モードで挙動が変化）。**理想化しない**。

---

## 2) Ontology（用語・データ辞書）

### 2.1 概念・変数

* **(p_k)**：HARのクラス確率。
* **U**：正規化エントロピー。不確実度∈[0,1]。
* **S**：安定度∈[0,1]（遷移が少ないほど1に近い）。
* **confidence**：1 − U。CCSの主成分。
* **CCS**：0.7 confidence + 0.3 S（Phase‑1以降の統一定義）。
* **Arm**：通信方策の一単位（Phase‑1：adv_interval；Phase‑2以降：interval×ch_mask[×tx_dbm/phy]）。
* **TL**：イベント検知→最初の受信までの遅延。
* **Pout(τ)**：期限τ内に初回受信できない確率。
* **µC/event**：広告イベント1回あたり電流積分。
* **ΔE/adv**：ON/OFF差 (E_ON − E_OFF) をイベント数 N_adv で割ったエネルギー増分[mJ/adv]。電力議論の主指標。
* **ρ（Duty factor）**：受信側のスキャン占有率。
* **pd**：スキャン窓内での検出同時確率（環境依存）。

### 2.2 ログ主キー（“AIが読める命名”）

* **Tx**：`t, session_id, adv_interval, ch_mask, tx_dbm, state, U, S, CCS, reason`
* **Rx**：`t, session_id, phone_model, scan_mode, rx_uuid, rssi, dedup_flag`
* **Power**：`t, current_mA, voltage_V, event_marker`
* **KPI**：`avg_current, event_charge_uC, TL_p50, TL_p95, Pout_1s/_2s/_3s, PDR`

> すべて**列追加入り**で拡張可能（後方互換）。AIは列名で意味を推定できる。

---

## 3) ビジョンの段階（Maturity Levels）

### **L1：Rule**（Phase‑1の姿）

* **何をするか**：CCSで**adv_interval**を切替（100/500/2000 ms）。**ヒステリシス＋滞在時間**で安定化。
* **なぜ意味があるか**：**イベント電荷**と**平均電流**を即時に落としつつ、**Pout(τ)**・**TL**が**基準と同等**であることを示せる。
* **残る課題**：環境・端末依存性や“受信側の隙間”を考慮できない。最適点は状況で変わる。

### **L2：MAB**（学習化）

* **何をするか**：**腕=（interval, ch_mask）**、**報酬=−µC × 受信成否**、**コンテキスト=（U,S）**。**写像表はWarm‑Start**に。
* **なぜ意味があるか**：**環境ごと**に（干渉、距離、端末差）**最適点に自律収束**。**写像単独**より**+αの省電力**（同QoS）を狙う。
* **残る課題**：**Pout(τ)** は保証されない（平均的に良くても、最悪ケースで欠落が起きうる）。

### **L3：Safe‑MAB**（制約つき最適化）

* **何をするか**：**Pout(τ) ≤ θ** を**制約関数**として腕選択を**常時**制限。**feasible‑arm**集合内で最適化。違反兆候で**安全側デグレード**。
* **なぜ意味があるか**：**QoS保証**と**省電力**を**同時達成**。**解析式の知見（ρ, pd, N＝η等）**を**学習の境界条件**に注入。
* **残る課題**：**先験情報**（端末ごとのスキャン挙動）や**アプリ側の価値**をまだ十分活用していない。

### **L4：Context Fusion**（“世界”を読む）

* **何をするか**：**スマホのスキャン挙動の先験**（37→38→39巡回、モード差の初期オフセットなど）と**アプリの緊急度**（U,S,アラート重要度）を**ポリシに注入**。
* **なぜ意味があるか**：**実環境の非理想**を**事前に知っているポリシ**は、**学習初期の後悔**と**最悪遅延**を減らす。
* **残る課題**：学習の**初期方策**が手作りで、環境やアプリの**多様性**を十分に取り込めない。

### **L5：Knowledge‑Distilled Bandit**（知識蒸留）

* **何をするか**：外部知識（規格・端末挙動・無線環境の一般論・アプリ優先度マップ）を**“圧縮表現”**に蒸留し、**Warm‑Start**と**禁止腕**に変換。
* **なぜ意味があるか**：**現場投入直後**から**安全に**・**そこそこ良い**方策で始められる。**再学習時間**を短縮。
* **残る課題**：知識の鮮度・偏りへの対処（監査・更新ガバナンス）。

> **到達点**：L3（Safe‑MAB）で論文的インパクト、L4/L5で**実運用の堅牢性とTTV（Time‑to‑Value）短縮**。

---

## 4) 価値の地図（Value Map）

### 4.1 定量KPI（“通貨”）

* **一次**：**イベント電荷（µC）**、**Pout(τ)**、**TL（p95）**
* **二次**：平均電流、mWh/日、PDR、F1/Acc
* **複合**：**J/decision**（1検出あたりのエネルギ）／**QoS違反率**（τ毎）

### 4.2 ユースケース枠

* **見守り**（転倒・無動作）：「**偽陰性＜偽陽性**」「Pout(2s)≪θ」
* **労働安全**（急変姿勢の通知）：「**TL p95 ≤ 500 ms** かつ 電池寿命30日↑」
* **スポーツ**（フォーム変化検知）：「**遷移期だけ濃く**、安定期は薄く」
* **PdM×人**（作業者×機械）：「**異常連鎖時**に**バースト広告**で到達率優先」

---

## 5) ガバナンス（Governance Model）

* **規格準拠**：BLE広告・出力規制・Duty規制の**上限**は**Policyが越えない**。
* **安全網**：QoS違反兆候→**安全側へ退避**（短間隔×3ch固定）。
* **説明責任**：各ラウンドの**Decision Rationale**は**不可欠ログ**。
* **データ最小化**：ログは**匿名化**。生波形や生IMUは外に出さない。
* **監査可能性**：実験再現用の**Runbook**と**KPIパイプライン**を常備（環境・端末差まで記録）。

---

## 6) AIのための“読み取りガイド”（他AIが誤解しないために）

### 6.1 契約（IF）— **MUST / SHOULD**

* **MUST**：`decide_interval(context) -> interval` の**IFは固定**（将来MAB/Safe‑MABでも同じIF）。
* **MUST**：`Pout(τ)`は**制約**（L3以降）。違反率の**上限 θ**は**構成情報**として常に明示。
* **MUST**：**Decision Rationale**を**毎切替**で1行出す（理由コード、CCS、ガードの満足可否）。
* **SHOULD**：受信側の**モード/端末挙動**を**先験**として方策に反映（L4以降）。
* **SHOULD**：**イベント電荷辞書**（arm→µC）を**報酬正規化**に使う（学習安定化）。
* **SHOULD**：**フェイルセーフ**（短間隔×3ch）をいつでも呼べる。

### 6.2 推論の取り扱い

* **MUST**：U,Sは**[0,1]正規化**。**CCS**は**0.6/0.4**をデフォルト（変更時はロギング）。
* **SHOULD**：**温度スケーリング**等でUを較正（過信抑制）。
* **MAY**：早期Exitや推論スキップの導入（合算省エネのため）。

### 6.3 受信側の取り扱い

* **MUST**：**受信は非理想**。チャネル巡回・隙間・モード差が存在。
* **SHOULD**：**rx_channel同定**や**scan_mode**をログ化（L2以降）。
* **MAY**：バースト広告＋クールダウン（遷移の見逃し抑止）。

---

## 7) リスク & フェイルセーフ（体系）

| リスク           | 兆候         | フェイルセーフ     | 恒久対策                |
| ------------- | ---------- | ----------- | ------------------- |
| QoS違反（Pout上昇） | TL分布が右シフト  | 短間隔×3ch     | Safe‑MABの制約強化、先験ルール |
| 受信端末差         | PDR低下・端末依存 | 端末切替/再起動    | 端末別事前重み             |
| 切替振動          | 切替頻発ログ     | ヒステリシス/滞在時間 | U/S較正、窓W調整          |
| 学習初期の後悔       | 違反スパイク     | Warm‑Start  | 知識蒸留（禁止腕/初期重み）      |

---

## 8) ロードマップ（Vision → 実装への橋）

* **Phase‑1（L1）**：**写像の価値をKPIで証明**（µC↓、QoS＝基準）。**ログ様式・KPIパイプライン**を固定。
* **Phase‑2（L2）**：**MAB導入**。写像を**初期方策**に採用。**端末挙動の可視化**（rx_channel同定）。
* **Phase‑3（L3）**：**Safe‑MAB**で**Pout(τ) ≤ θ を保証**。**安全側フェイルセーフ**を規範化。
* **Phase‑4（L4）**：**先験（受信側挙動）＋アプリ緊急度**の注入。学習初期の**最悪遅延**を抑制。
* **Phase‑5（L5）**：**知識蒸留（Warm‑Start/禁止腕）**で**TTV短縮**。**大規模複数現場**へ展開。
* **製品化要件**：**MCU実装サイズ/レイテンシ**の提示、**デバイス差異**の先験、**再現パッケージ**（ログ・KPI・Runbook）。

---

## 9) 研究成果の位置づけ（論点の“芯”）

* **通信×推論×安全制約の三層協調**で、**端末内だけ**で**QoS保証**と**電力最小化**を両立。
* **受信側非理想性の知識化**（先験）と**制約最適化**の橋渡し。
* **標準化できるKPI**（µC/イベント、Pout(τ)、TL p95）と**監査可能ログ**で、**再現性**を担保。
* **TinyML実装**を前提とした**現実解**（INT8、RAM/Flash制約内）。

---

## 10) 参考リソース（本ビジョンを支える“根拠集”）

* **プロジェクト資料**：中間発表スライド（不確実度→広告間隔の写像、実測KPI、想定シナリオ）

  * [/mnt/data/中間発表資料_萩原.pdf](/mnt/data/中間発表資料_萩原.pdf)
* **TinyML（実装可能性・スタック）**：総合サーベイ／PdM向けホリスティックレビュー

  * [/mnt/data/A_Comprehensive_Survey_on_TinyML.pdf](/mnt/data/A_Comprehensive_Survey_on_TinyML.pdf)
  * [/mnt/data/A_Holistic_Review_of_the_TinyML_Stack_for_Predictive_Maintenance.pdf](/mnt/data/A_Holistic_Review_of_the_TinyML_Stack_for_Predictive_Maintenance.pdf)
* **BLE受信の非理想性・スキャン挙動**（実機観測・モデル化の背景）

  * [/mnt/data/3661820.pdf](/mnt/data/3661820.pdf)
* **量子化モデルのMCU実装例（RAM/Flash/レイテンシの目安）**

  * [/mnt/data/s41598-025-98571-2.pdf](/mnt/data/s41598-025-98571-2.pdf)
* **HAR省電力・システム最適化の俯瞰**

  * [/mnt/data/1-s2.0-S1574119224001019-main.pdf](/mnt/data/1-s2.0-S1574119224001019-main.pdf)

> これらのリソースは**世界観の“証拠”**としての役割（AIが根拠をたどれる）を持ちます。必要に応じてPhase別に参照箇所を特定し、KPI式・しきい値・境界条件を抽出します。

---

## 11) 要約（AIが誤読しないための短文仕様）

* **Goal**：**Pout(τ)を守りながら**、**µC/event**と**平均電流**を最小化（**端末内完結**）。
* **Signals**：`U∈[0,1]`, `S∈[0,1]`, `CCS=0.6U+0.4(1−S)`。
* **Policy IF**（不変）：`context(U,S,CCS) → interval`（将来MAB/Safe‑MABでも同じ）。
* **KPI**（一次）：`event_charge_uC`, `Pout(τ)`, `TL_p95`。
* **Safety**：`Pout(τ) ≤ θ` を**制約**として常時満たす（L3以降）。
* **Fallback**：いつでも `interval=短/3ch` に退避可。
* **Logs**：**Decision Rationale**を**毎切替**で出力（根拠・閾値・適用成否）。
* **Growth**：L1→L2（学習）→L3（制約）→L4（先験）→L5（知識蒸留）。

---

この **Vision / World Model** を採用すると、**人（現場）にやさしい“端末内AI”**が**段階的に強く**なり、**再現性・可監査性・安全性**を前提に**実装現場へ届く**プロダクトへと育っていきます。
次のステップとして、上記の“**Maturity Level**”を見出しにした**社内標準仕様（Spec 0.x）**と**図表テンプレ**を固めれば、他AI/他チームが**同じ世界観を共有**して**自走**できます。
