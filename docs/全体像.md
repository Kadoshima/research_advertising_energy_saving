# ReFormHAR-Tiny: Vision / World Model

本ドキュメントは、**ReFormHAR-Tiny** プロジェクトの研究ビジョンと世界観を体系的に記述する。
他のAI・研究者がプロジェクトの方向性を正しく理解し、一貫した判断ができるようにすることを目的とする。

---

## 0) 研究ビジョンの階層構造

### Phase 1: 今回のレター（短期目標）

> **「Safe Contextual Banditの前段階として、決め打ちルールの実装と評価指標の確立」**

**位置づけ**:
- Safe-MABの「warm-start用ベースライン」を作る
- 評価指標（Pout(τ), μC）の測定系を確立する
- 単純なルールでも「効果がある」ことを示し、将来の学習ベース手法の土台を作る

**主張**:
> 「HAR不確実度に基づくBLE広告間隔の適応制御において、単純な閾値ルールでも固定間隔と比較して省電力効果が得られることを示した。提案手法は、将来のSafe Contextual Banditによるオンライン最適化の基盤となる。」

**レターに含めるもの**:
1. 問題定式化: Pout(τ)制約下でのエネルギー最小化問題
2. 評価指標: Pout(τ), μC/eventの定義と測定方法
3. 決め打ちルール: CCS→T_adv写像の実装
4. 実験評価: 固定100ms / 固定2000ms / CCS制御の比較
5. Future Work: Safe Contextual Banditへの拡張

**レターに含めないもの（Future Work）**:
- MAB/RLの学習アルゴリズム
- 非理想スキャンのモデリング
- HAR誤認識の統合評価（RoME）

### Phase 2: 研究テーマ（修論〜博士前期）

> **「HAR不確実度を活用したBLE広告のSafe Contextual Bandit最適化」**

**問題定式化**:
- **コンテキスト**: HAR推論の不確実度 U、安定度 S
- **行動（Arm）**: 広告間隔 T_adv ∈ {100, 500, 1000, 2000ms}
- **報酬**: −μC（エネルギー最小化）
- **制約**: Pout(τ) ≤ δ（QoS保証）

**新規性**:
1. HAR不確実度をContextual Banditの「コンテキスト」として初めて使用
2. Pout(τ)を「制約」として扱うSafe Bandit定式化
3. アプリ層（HAR）→通信層（BLE）のクロスレイヤー最適化

### Phase 3: 究極のゴール（5-10年スパン）

> **「アプリ層のセマンティクスが通信層を自律制御する、エッジAIの新しいパラダイム」**

- TinyMLデバイスが「今この瞬間、どれだけ確信を持っているか」を通信スタックに伝える
- 通信層は、そのセマンティクスに応じてリソース配分を動的に変える
- 人間の介入なく、デバイスが自律的に「省電力」と「QoS保証」を両立する

---

## 1) World Model（世界観の骨格）

### 1.1 役者（Actors）

| Actor | 役割 | 備考 |
|-------|------|------|
| **Edge Node / DUT** | IMU＋MCUでHARをオンデバイス推論。U, S, CCSを生成しBLE広告を制御 | ESP32-S3/C3想定 |
| **Gateway（スマホ/受信機）** | BLE広告の受信主体。スキャンは非理想（チャネル巡回・隙間・モード差） | Android LOW_LATENCY |
| **Observer / Orchestrator** | ログ収集、KPI算出。クラウド常時接続は不要 | 実験・運用時 |
| **Safety Oracle（概念）** | QoS制約（Pout(τ) ≤ δ）を定義。方策が守るべき境界 | 規格書的存在 |
| **Policy Engine** | 通信層の意思決定器。Phase 1はルール、Phase 2でSafe-MAB | 段階的進化 |

### 1.2 能力（Capabilities）— 5つの柱

1. **Perception（知覚）**: IMU → HAR → 確率分布 (p_k) → U（不確実度）、S（安定度）
2. **Decision（意思決定）**: CCS をコンテキストに BLE広告間隔を決定
3. **Communication（通信）**: μC/event最小で、Pout(τ)制約を満たす広告
4. **Safety（安全）**: 常時 Pout(τ) ≤ δ を満たす制約の中で最適化。違反兆候で安全側へ退避
5. **Observability（可観測性）**: すべての意思決定に根拠ログ（U, S, CCS, 閾値, 切替理由）を残す

### 1.3 不変条件（Invariants）

- **オンデバイス優先**: 生センサは外に出さない（プライバシ）
- **QoS優先の最適化**: Pout(τ) を常に制約として扱い、その範囲内で電力最小化
- **後方互換のIF**: `decide_interval(context) → interval` のIFは固定（将来MAB/Safe-MABでも同じ）
- **単一真実のKPI**: μC/event、Pout(τ)、TL分布を一次指標。平均電流やmWh/日は従属

### 1.4 境界条件（Operating Envelope）

- **MCU制約**: RAM ≤ 256KB / Flash ≤ 1MB、INT8演算前提
- **BLE制約**: Legacy Advertising、3ch（37/38/39）、Tx/EIRPとDutyは地域規制遵守
- **受信制約**: スマホは連続スキャンではない（モードで挙動が変化）。理想化しない

---

## 2) Ontology（用語・データ辞書）

### 2.1 概念・変数

| 変数 | 定義 | 範囲 |
|------|------|------|
| **(p_k)** | HARのクラス確率 | Σp_k = 1 |
| **U** | 正規化エントロピー（不確実度） | [0, 1] |
| **S** | 安定度（遷移が少ないほど1に近い） | [0, 1] |
| **confidence** | 1 − U | [0, 1] |
| **CCS** | Composite Confidence Score = 0.7×confidence + 0.3×S | [0, 1] |
| **T_adv / Arm** | 広告間隔。Phase 1: {100, 500, 1000, 2000}ms | ms |
| **TL** | Time-to-first-Receive。イベント検知→初回受信までの遅延 | ms |
| **Pout(τ)** | Outage probability。期限τ内に初回受信できない確率 | [0, 1] |
| **μC/event** | 広告イベント1回あたりの電流積分 | μC |

### 2.2 CCS定義の根拠と感度分析

**採用定義**: CCS = 0.7 × (1 − U) + 0.3 × S = 0.7 × confidence + 0.3 × S

**根拠**:
1. **変数名との整合性**: CCS = Composite Confidence Score。高い値が「確信がある」という解釈と一致
2. **Safe Banditとの整合性**: CCS高い → 確信あり → 長い間隔OK → 省電力。単調な写像で直感的
3. **論文での説明容易性**: "Higher CCS indicates the system can safely extend advertising intervals."
4. **主成分の重視**: 推論の確信度（confidence）を0.7、時間的安定性（S）を0.3で補助的に扱う

**係数の選択**:
- α=0.7, β=0.3 は経験的初期値
- confidence（瞬時の推論品質）を主成分とし、stability（時間的一貫性）を補助とする設計意図

**感度分析（Future Work）**:
- 係数 (α, β) の変動が KPI（μC, Pout(τ), TL_p95）に与える影響を評価
- 候補: (0.8, 0.2), (0.7, 0.3), (0.6, 0.4), (0.5, 0.5)
- 評価方法: 同一実験データに対して係数を変えた場合の省電力効果とQoS劣化のトレードオフを可視化
- 最適係数はアプリケーション依存（QoS重視 vs 省電力重視）であり、ユースケース毎に調整可能とする

### 2.3 ログスキーマ

| ログ種別 | 主キー |
|----------|--------|
| **Tx** | `t, session_id, adv_interval, ch_mask, tx_dbm, state, U, S, CCS, reason` |
| **Rx** | `t, session_id, phone_model, scan_mode, rx_uuid, rssi, dedup_flag` |
| **Power** | `t, current_mA, voltage_V, event_marker` |
| **KPI** | `avg_current, event_charge_uC, TL_p50, TL_p95, Pout_1s/_2s/_3s, PDR` |

> すべて列追加で拡張可能（後方互換）。将来のMAB拡張時に `arm, reward, context` 列を追加。

---

## 3) 研究の段階（Phases）

### Phase 1: Rule-based（今回のレター）

| 項目 | 内容 |
|------|------|
| **何をするか** | CCSで adv_interval を切替（100/500/1000/2000ms）。ヒステリシス＋滞在時間で安定化 |
| **なぜ意味があるか** | μC/eventと平均電流を削減しつつ、Pout(τ)・TLが基準と同等であることを示せる |
| **成果物** | 評価指標の確立、warm-start用ベースライン、KPIパイプライン |
| **残る課題** | 環境・端末依存性を考慮できない。最適点は状況で変わる |

### Phase 2: Safe Contextual Bandit（修論テーマ）

| 項目 | 内容 |
|------|------|
| **何をするか** | コンテキスト=(U,S)、腕=T_adv、報酬=−μC、制約=Pout(τ)≤δ のSafe Bandit |
| **なぜ意味があるか** | 環境ごとに最適点へ自律収束しつつ、QoS保証を維持 |
| **アルゴリズム候補** | Conservative UCB, SafeOpt, Constrained Thompson Sampling |
| **残る課題** | 先験情報（端末スキャン挙動）の活用、学習初期の後悔 |

### Phase 3: Semantic-driven Communication（長期ビジョン）

| 項目 | 内容 |
|------|------|
| **何をするか** | アプリ層のセマンティクス（確信度、緊急度、価値）が通信層を自律制御 |
| **なぜ意味があるか** | 人間介入なしで省電力とQoS保証を両立。エッジAIの新パラダイム |
| **発展方向** | 知識蒸留によるwarm-start、マルチデバイス協調、アプリ横断の優先度制御 |

---

## 4) 価値の地図（Value Map）

### 4.1 定量KPI

| 区分 | KPI |
|------|-----|
| **一次（Primary）** | μC/event, Pout(τ), TL_p95 |
| **二次（Secondary）** | 平均電流, mWh/日, PDR, F1/Acc |
| **複合（Composite）** | J/decision（1検出あたりエネルギ）, QoS違反率 |

### 4.2 ユースケース枠

| ユースケース | 要件 |
|--------------|------|
| **見守り**（転倒・無動作） | 偽陰性 < 偽陽性、Pout(2s) ≪ δ |
| **労働安全**（急変姿勢通知） | TL_p95 ≤ 500ms、電池寿命30日↑ |
| **スポーツ**（フォーム変化検知） | 遷移期だけ濃く、安定期は薄く |

---

## 5) ガバナンス（Governance Model）

- **規格準拠**: BLE広告・出力規制・Duty規制の上限はPolicyが越えない
- **安全網**: QoS違反兆候 → 安全側へ退避（短間隔×3ch固定）
- **説明責任**: 各ラウンドの Decision Rationale は不可欠ログ
- **データ最小化**: ログは匿名化。生IMUは外に出さない
- **監査可能性**: 実験再現用の Runbook と KPIパイプラインを常備

---

## 6) リスク & フェイルセーフ

| リスク | 兆候 | フェイルセーフ | 恒久対策 |
|--------|------|----------------|----------|
| QoS違反（Pout上昇） | TL分布が右シフト | 短間隔×3ch | Safe-MABの制約強化 |
| 受信端末差 | PDR低下・端末依存 | 端末切替/再起動 | 端末別事前重み |
| 切替振動 | 切替頻発ログ | ヒステリシス/滞在時間 | U/S較正、窓W調整 |
| 学習初期の後悔 | 違反スパイク | Warm-Start | 知識蒸留（禁止腕/初期重み） |

---

## 7) ロードマップ

```
Phase 1 (レター)          Phase 2 (修論)           Phase 3 (長期)
─────────────────────────────────────────────────────────────────
決め打ちルール実装    →   Safe Contextual Bandit  →  Semantic-driven
評価指標確立              Pout(τ)制約保証             Communication
warm-startベースライン    環境適応学習                 マルチデバイス協調
```

---

## 8) 要約（AIが誤読しないための短文仕様）

- **Goal**: Pout(τ)を守りながら、μC/eventを最小化（端末内完結）
- **Signals**: U ∈ [0,1], S ∈ [0,1], CCS = 0.7×(1−U) + 0.3×S
- **Policy IF（不変）**: `context(U, S, CCS) → interval`（将来Safe-MABでも同じ）
- **KPI（一次）**: μC/event, Pout(τ), TL_p95
- **Safety**: Pout(τ) ≤ δ を制約として常時満たす（Phase 2以降）
- **Fallback**: いつでも `interval=短/3ch` に退避可
- **Logs**: Decision Rationale を毎切替で出力
- **Growth**: Phase 1（ルール）→ Phase 2（Safe Bandit）→ Phase 3（セマンティック制御）

---

## 9) 参考リソース

- **TinyML**: A Comprehensive Survey on TinyML
- **BLE受信の非理想性**: スキャン挙動の実機観測・モデル化
- **HAR省電力**: システム最適化の俯瞰

> これらは世界観の根拠としての役割を持つ。必要に応じてKPI式・閾値・境界条件を抽出。

---

*Last updated: 2025-11-27*
