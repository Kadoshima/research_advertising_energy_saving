# 計測データ検証ログ (2025-11-30)

## 1. 検証対象

| データセット | 日時 | 内容 |
|-------------|------|------|
| `1m_1130_on_02` | 2025-11-30 | ON計測（100/500/1000/2000ms） |
| `1m_off_1129_1` | 2025-11-29 | OFF計測（BLE無効） |
| `row_1120` | 2025-11-20頃 | 旧ON計測（参照用） |
| `row_1123_off` | 2025-11-23頃 | 旧OFF計測（参照用） |

---

## 2. データ構造

### 2.1 1m_1130_on_02（新ON）

```
data/実験データ/研究室/1m_1130_on_02/
├── TX/  (30 files: trial_034_on.csv ~ trial_063_on.csv)
└── RX/  (30 files: rx_trial_241.csv ~ rx_trial_270.csv)
```

**interval別トライアル数**:
- 100ms: 10 trials (trial_034 ~ trial_043)
- 500ms: 10 trials (trial_044 ~ trial_053)
- 1000ms: 5 trials (trial_054 ~ trial_058)
- 2000ms: 5 trials (trial_059 ~ trial_063)

### 2.2 1m_off_1129_1（新OFF）

```
data/実験データ/研究室/1m_off_1129_1/
└── 4 files: trial_026_off.csv ~ trial_029_off.csv
```

---

## 3. Summary行の値

### 3.1 新ON (1m_1130_on_02) - 全30トライアル

| interval | ms_total | adv_count | E_total_mJ | E_per_adv_uJ |
|----------|----------|-----------|------------|--------------|
| 100ms | 29,098-29,443 | 291-295 | 6,468-6,560 | 22,051-22,405 |
| 500ms | 148,667-149,060 | 298-299 | 29,719-29,902 | 99,727-100,291 |
| 1000ms | 298,431-298,622 | 299 | 58,806-58,990 | 196,675-197,292 |
| 2000ms | 598,185-598,385 | 300 | 117,002-117,077 | 390,008-390,254 |

### 3.2 新OFF (1m_off_1129_1)

| file | ms_total | E_total_mJ | P_off (mW) |
|------|----------|------------|------------|
| trial_026_off.csv | 60,000 | 1,694.5 | 28.24 |
| trial_027_off.csv | 60,000 | 1,911.6 | 31.86 |
| trial_028_off.csv | 60,000 | 2,898.3 | **48.31** |
| trial_029_off.csv | 60,000 | 1,825.3 | 30.42 |

**P_off平均**: 34.71 mW（summary E_total_mJから計算）

### 3.4 新OFFの再計算（p_mWを使わず µA×mV から算出）

- 手順: `^\d+,\d+,\d+,` でマッチする行のみ採用し、`mean(P)=mean(mV/1000 × µA/1000)` を計算。エネルギーは `mean(P) × duration`（duration = max(ms)−min(ms)）で近似。

| file | valid lines | total lines | valid率 | 再計算P_off (mW) | 再計算E_off (mJ) |
|------|-------------|-------------|--------|------------------|------------------|
| trial_026_off.csv | 736 | 5,499 | 13.4% | 231.97 | 13,876.74 |
| trial_027_off.csv | 790 | 5,499 | 14.4% | 242.83 | 14,540.73 |
| trial_028_off.csv | 778 | 5,499 | 14.1% | 245.90 | 14,749.53 |
| trial_029_off.csv | 767 | 5,499 | 13.9% | 239.54 | 14,351.27 |

**再計算平均**: P_off = **240.06 mW**, E_off = **14,379.57 mJ**（約60s積算）。p_mW列を使わずとも ON と同等レベルの電力になることを確認。

### 3.3 旧OFF (row_1123_off) 参照

| file | ms_total | E_total_mJ | P_off (mW) |
|------|----------|------------|------------|
| 1m_off_0_001.csv | 60,000 | 941.0 | 15.68 |
| 1m_off_0_002.csv | 60,000 | 1,683.4 | 28.06 |
| 1m_off_0_003.csv | 60,000 | 2,038.6 | 33.98 |
| 1m_off_0_004.csv | 60,000 | 930.6 | 15.51 |
| 1m_off_0_005.csv | 60,000 | 1,029.5 | 17.16 |
| 1m_off_0_006.csv | 60,000 | 2,493.3 | **41.55** |
| 1m_off_0_007.csv | 60,000 | 1,286.2 | 21.44 |

**P_off範囲**: 15.51 - 41.55 mW（非常にバラつきが大きい）

---

## 4. 生データからの電流値

### 4.1 計算方法

```python
# CSVの各行: ms, mV, µA, p_mW
# P_avg = mean(µA) / 1000 * 3.3  # mA * V = mW
```

### 4.2 結果

| データセット | ファイル例 | mean(µA) | P_avg (mW) |
|-------------|-----------|----------|------------|
| **新ON 100ms** | trial_034_on.csv | 68,880 | **227.3** |
| **新ON 100ms** | trial_035_on.csv | 68,333 | **225.5** |
| **新ON 100ms** | trial_036_on.csv | 68,485 | **226.0** |
| 旧ON 100ms | 1m_on_100_001.csv | 71,969 | 237.5 |
| 旧ON 100ms | 1m_on_100_002.csv | 74,818 | 246.9 |
| 旧ON 100ms | 1m_on_100_003.csv | 76,273 | 251.7 |
| **新OFF** | trial_026_off.csv | 71,369 | **235.5** |
| **新OFF** | trial_027_off.csv | 74,849 | **247.0** |
| **新OFF** | trial_028_off.csv | 75,857 | **250.3** |
| 旧OFF | 1m_off_0_001.csv | 69,348 | 228.9 |
| 旧OFF | 1m_off_0_002.csv | 70,078 | 231.3 |
| 旧OFF | 1m_off_0_003.csv | 69,549 | 229.5 |

### 4.3 P_avg 比較サマリ

| データセット | P_avg範囲 (mW) |
|-------------|---------------|
| 新ON (1m_1130_on_02, 100ms) | 225-227 |
| 旧ON (row_1120, 100ms) | 237-252 |
| 新OFF (1m_off_1129_1) | 236-250 |
| 旧OFF (row_1123_off) | 229-231 |

---

## 5. ΔE/adv 計算結果

### 5.1 Summary E_total_mJ ベース（P_off = 34.71 mW）

| interval | ΔE/adv (µJ) | 旧値 (µJ) | 差 |
|----------|------------|----------|-----|
| 100ms | -2,144 ± 99 | 2,257 | **負値** |
| 500ms | -21,824 ± 180 | 9,760 | **負値** |
| 1000ms | -46,594 ± 214 | 19,661 | **負値** |
| 2000ms | -96,463 ± 73 | 39,482 | **負値** |

### 5.2 生データベース（P_off = 235.1 mW）

| interval | ΔE/adv (µJ) | 旧値 (µJ) | 差 |
|----------|------------|----------|-----|
| 100ms | -1,248 ± 100 | 2,257 | **負値** |
| 500ms | -17,354 ± 180 | 9,760 | **負値** |
| 1000ms | -37,658 ± 206 | 19,661 | **負値** |
| 2000ms | -78,640 ± 73 | 39,482 | **負値** |

### 5.3 p_mWを使わず再計算（P_off = 240.06 mW, µA×mV換算）

| interval | ΔE/adv (µJ) | 備考 |
|----------|-------------|------|
| 100ms    | -1,748.9 ± 100.9 | 10トライアル平均 |
| 500ms    | -19,855.9 ± 179.1 | 10トライアル平均 |
| 1000ms   | -42,629.0 ± 219.8 | 5トライアル平均 |
| 2000ms   | -88,602.6 ± 95.4 | 5トライアル平均 |

計算方法: p_mW列は無視し、行ごとに (mV/1000 × µA/1000) を電力[mW]として平均→ duration(最大ms−最小ms)で積分。P_offには再計算平均240.06 mWを使用。

### 5.4 PDR (RX, ESP32パッシブスキャン, N_ADV=300固定)

| interval | PDR (mean) | n |
|----------|------------|---|
| 100ms | 0.221 | 10 |
| 500ms | 0.743 | 10 |
| 1000ms | 0.830 | 5 |
| 2000ms | 0.870 | 5 |

RX側は `rx_trial_241-270.csv` を集計。ADV行をカウントし PDR=rx_count/300 とした。

---

## 6. 問題点の特定

### 6.1 主要な矛盾

**ΔE/adv が負値** = E_on < E_off

物理的解釈: BLE ON時の消費電力 < BLE OFF時の消費電力（ありえない）

### 6.2 数値的事実

```
新ON P_avg (225-227 mW) < 新OFF P_avg (235-250 mW)
```

**新ONの消費電力が新OFFより10-25 mW低い**

### 6.3 旧データとの比較

```
旧ON P_avg (237-252 mW) > 旧OFF P_avg (229-231 mW)
```

旧データでは正常（ON > OFF）

### 6.4 Summary E_total_mJ の問題

| データ | 生データP_avg | Summary P_off | 乖離 |
|--------|--------------|---------------|------|
| 旧OFF 001 | 228.9 mW | 15.68 mW | **14.6倍** |
| 旧OFF 002 | 231.3 mW | 28.06 mW | **8.2倍** |
| 新OFF 026 | 235.5 mW | 28.24 mW | **8.3倍** |

**Summary の E_total_mJ は生データの約1/10**

---

## 7. 考えられる原因

### 7.1 E_total_mJ 計算の問題

TXSDファームウェアの E_total_mJ 計算が生データと乖離している。

可能性:
- p_mW 積分のサンプリング間隔が違う
- 積分開始/終了タイミングのズレ
- バッファリングによるデータ欠損

### 7.2 ON/OFF 計測条件の違い

新ON (1m_1130_on_02) と新OFF (1m_off_1129_1) で:
- 計測日が異なる（11/30 vs 11/29）
- ESP32ボードの状態が異なる可能性
- 温度などの環境条件が異なる可能性

### 7.3 ESP32の状態

新ONの消費電力が低い理由の候補:
- Wi-Fiが無効になっている
- CPU周波数が異なる
- Deep Sleep の挙動が異なる

---

## 8. 旧データの ΔE/adv 参照値

`docs/フェーズ1/results/delta_energy_row1120_row1123_off.md` より:

| interval | ΔE/adv (µJ) | P_off (mW) |
|----------|------------|------------|
| 100ms | 2,256.82 ± 162 | 22.106 |
| 500ms | 9,760.08 ± 339 | 22.106 |
| 1000ms | 19,661.11 ± 134 | 22.106 |
| 2000ms | 39,481.76 ± 63 | 22.106 |

**注**: この P_off = 22.106 mW は Summary E_total_mJ から計算された値であり、生データの P_avg ≈ 230 mW とは異なる。

---

## 9. 結論

### 9.1 確定事項

1. **生データの電流値は一貫している**（~70 mA, P_avg ~230 mW）
2. **Summary E_total_mJ は生データの約1/10**（計算ロジックの問題）
3. **新ON < 新OFF**（ΔE/advが負値になる直接原因）

### 9.2 未確定事項

1. Summary E_total_mJ の計算ロジックの詳細
2. 新ON消費電力が低い原因
3. ON/OFF間の計測条件の一致性

### 9.3 次のアクション

1. **同一セッションでON/OFFを連続計測**して条件を揃える
2. **TXSDファームウェアのE_total_mJ計算ロジック**を確認
3. **生データからの直接計算**をベースラインとして使用することを検討

---

## 付録A. 生データサンプルと文字化け問題

### A.1 新ON: trial_034_on.csv (100ms interval)

**ファイルパス**: `data/実験データ/研究室/1m_1130_on_02/TX/trial_034_on.csv`

```csv
  1| ms,mV,µA,p_mW
  2| # meta, firmware=TXSD_PowerLogger_PASS_THRU_ON_v2, trial_index=1, adv_interval_ms=100
  3| 25,3172,142300,451.4
  4| 35,3252,067400,219.2
  5| 45,3228,061400,198.2
  6| 55,3252,056100,182.4
  7| 65,3256,058600,190.8
```

**Summary行**:
```
# summary, ms_total=29443, adv_count=295, E_total_mJ=6559.994, E_per_adv_uJ=22237.3
```

**統計**:
- サンプル数: 2,942
- 電圧 mV: min=3092, max=3256, mean=3244
- 電流 µA: min=55100, max=252700, mean=68880
- 計算 P_avg: 223.47 mW
- **p_mW=0.0 の行: 0 (0.0%)** ← 正常

### A.2 新OFF: trial_026_off.csv

**ファイルパス**: `data/実験データ/研究室/1m_off_1129_1/trial_026_off.csv`

```csv
  1| ms,mV,µA,p_mW
  2| # meta, firmware=TXSD_PowerLogger_PASS_THRU_OFF_v1, trial_index=1, adv_interval_ms=0
  3| 13,3280,05&200,0.0      ← 文字化け「&」
  4| 23,3236,059900,193.8
  5| 33,3152,15$200,0.0      ← 文字化け「$」
  6| 43,3284,06#400,0.0      ← 文字化け「#」
  7| 53,3280,05%400,0.0      ← 文字化け「%」
```

**Summary行**:
```
# summary, ms_total=60000, adv_count=0, E_total_mJ=1694.535, E_per_adv_uJ=0.0
```

**統計**:
- サンプル数: 5,498
- **p_mW=0.0 の行: 4,621 (84.0%)** ← **異常**

### A.3 旧ON: 1m_on_100_001.csv

**ファイルパス**: `data/実験データ/研究室/row_1120/TX/1m_on_100_001.csv`

```csv
  3| 12,3312,05&100,0.0      ← 文字化け
  4| 23,3240,07!100,0.0      ← 文字化け
  5| 32,3312,05&800,0.0      ← 文字化け
```

**Summary行**:
```
# summary, ms_total=22141, adv_count=222, E_total_mJ=980.825, E_per_adv_uJ=4418.1
```

**統計**:
- サンプル数: 2,213
- **p_mW=0.0 の行: 1,761 (79.6%)** ← **異常**

### A.4 旧OFF: 1m_off_0_001.csv

**ファイルパス**: `data/実験データ/研究室/row_1123_off/TX/1m_off_0_001.csv`

```csv
  3| 154,3284,07%700,2493284,07#100,2403284,07&200,2503284,069600,229,0.0  ← 行が壊れている
```

**Summary行**:
```
# summary, ms_total=60000, adv_count=0, E_total_mJ=940.954, E_per_adv_uJ=0.0
```

**統計**:
- サンプル数: 75 (期待値: ~6,000)
- **p_mW=0.0 の行: 75 (100.0%)** ← **完全に異常**

---

## 付録B. p_mW パースエラー率サマリ

| データセット | ファイル例 | 総行数 | p_mW=0 | エラー率 |
|-------------|-----------|--------|--------|---------|
| **新ON (1m_1130_on_02)** | trial_034_on.csv | 2,942 | 0 | **0.0%** ✓ |
| 新OFF (1m_off_1129_1) | trial_026_off.csv | 5,498 | 4,621 | **84.0%** |
| 旧ON (row_1120) | 1m_on_100_001.csv | 2,213 | 1,761 | **79.6%** |
| 旧OFF (row_1123_off) | 1m_off_0_001.csv | 75 | 75 | **100.0%** |

---

## 付録C. 根本原因の特定

### C.1 文字化けパターン

電流値カラム（µA）に以下の文字が混入:
- `&` (アンパサンド)
- `$` (ドル記号)
- `#` (シャープ)
- `%` (パーセント)
- `!` (感嘆符)
- `"` (ダブルクォート)
- `'` (シングルクォート)

例: `05&200` は本来 `056200` (56,200 µA) であるべき

### C.2 原因

**UART通信エラー**（ボーレート不一致またはノイズ）

TXSDファームウェアの E_total_mJ 計算は p_mW カラムを積分しているが、
文字化けにより p_mW = 0.0 となった行は積分に寄与しない。

結果として **E_total_mJ が実際の 1/5 〜 1/10 に過小評価**されている。

### C.3 新ONが正常な理由

`1m_1130_on_02` (新ON) のみエラー率 0.0%。

考えられる理由:
1. 2025-11-29 の配線修正後に計測された
2. UARTボーレートが 230400 → 115200 に変更された可能性
3. ノイズ対策が施された可能性

**確認事項**: docs/フェーズ0-0/decision_log_2025-11-29.md を参照

### C.4 旧データの P_off = 22.1 mW の解釈

`docs/フェーズ1/results/delta_energy_row1120_row1123_off.md` の P_off = 22.106 mW は、
**文字化けで過小評価された E_total_mJ から計算された値**であり、
実際の消費電力（~230 mW）とは大きく異なる。

**旧データのΔE/adv計算は、ON/OFF両方が同程度に過小評価されていたため、
差分としては妥当な値が得られていた可能性がある**（偶然の相殺）。

---

## 付録D. OFFファームのコード所見（esp32_firmware/baseline_off）

- `esp32_firmware/baseline_off/TX_BLE_OFF/TX_BLE_OFF.ino`
  - 無線OFFでも 10ms 周期で INA219 読み取り＋UART送信を常時実行し、`vTaskDelay(1)` のみでスリープしない。計測タスク自体の負荷で 56mA 級の電流が流れる設計で、真のアイドルベースラインにはならない。
  - ベースラインを測るには、TX側は計測タスクを停止・deep/light sleep化し、計測は外部ロガーに任せる運用に切り替えるべき。
- `esp32_firmware/baseline_off/TXSD_PowerLogger/TXSD_PowerLogger.ino`
  - diag の `mean_p_mW` は `mv*uA/1000` で計算しており、本来は `/1e6` が正しく 1000倍ずれる（既知の mean_p_mW 1000倍問題の根源）。
  - UART化けで行が落ちると dt が伸び、その長い dt を次の有効行の p_mW に掛けて積分するため、欠損が多いと E_total_mJ 誤差が大きくなる。
  - 受信バッファ/ライン長は拡張しているが、p_mW 列は送信元の品質に依存する。p_mW を信用せず mV/µA から再計算するほうが安全。

まとめ: 現行 OFF ファームは「低消費OFF」ではなく「計測タスク常時稼働」の設計。ベースライン用途なら計測負荷を外に逃がし、p_mW計算を修正した上で UART化け耐性を確保する必要がある。

## 10. 結論（更新）

### 10.1 根本原因

**UART文字化けによる p_mW パースエラー**

- 新ON (1m_1130_on_02): エラー率 **0.0%** → E_total_mJ 正確
- 新OFF (1m_off_1129_1): エラー率 **84.0%** → E_total_mJ 過小
- 旧ON (row_1120): エラー率 **79.6%** → E_total_mJ 過小
- 旧OFF (row_1123_off): エラー率 **100.0%** → E_total_mJ 過小

### 10.2 ΔE/advが負値になる直接原因

新ON は正確な E_total_mJ を持つが、新OFF は過小評価されている。
結果として E_on > E_off のように見えるが、実際は逆。p_mW列を使わず µA×mV から再計算すると新OFFの P_off ≈ **240 mW** / E_off ≈ **14.4 J**（60s）となり、ONと同等レベルであることを確認。

### 10.3 旧データのΔE/advが妥当に見えた理由

旧ON/旧OFF 両方が同程度に過小評価されていたため、
差分（ΔE）は偶然近い値になっていた。

### 10.4 今後の対応

1. **OFF計測を再実施**（文字化けなしの条件で）
2. **新ON + 新OFF（再計測）でΔE/advを再計算**
3. **UARTエラー対策**を恒久化（ボーレート、シールド等）

---

## 11. 追記: 修正方針と実装（2025-11-30）

- 実装場所: `esp32_firmware/baseline_off/TXSD_PowerLogger/TXSD_PowerLogger.ino`, `esp32_firmware/baseline_off/TX_BLE_OFF/TX_BLE_OFF.ino`
- 修正内容（OFFパワーロガー）
  1. パーサを「完全一致」に変更し、ゴミ付き行を拒否。オプションで 0x2x→0x3x の digit repair も実装（`ENABLE_DIGIT_REPAIR`）。
  2. エネルギー計算を「平均P[mW]×計測時間[s]」に変更。UART化けでdtが伸びても積分が暴れないようにした。
  3. `mean_p_mW` の1000倍バグを修正（mv*uA/1e6 のまま出力）。
  4. 行修復後にパース、p_mWの積分はやめてサンプル平均のみを保持。summaryの E_total_mJ が生データ再計算と一致するようにした。
- 修正内容（TX_BLE_OFF）
  - ボーレートコメントを115200bpsに整合。計測タスク常時稼働で約70mA流れる「計測込みベースライン」である旨の注意書きを追加。
- 追補（ONパワーロガー）: `esp32_firmware/baseline_on/TXSD_PowerLogger/TXSD_PowerLogger.ino` にも同じ修正を適用（digit repairオプション、厳密パース、平均P×durationでE_total算出、mean_p_mWスケール修正）。ON/OFF両系で summary と生データ再計算が一致する体制に統一。
- 今後の進め方
  - OFF/ON を同一セッション・同条件で再計測し、修正版ロガーで ΔE/adv を再算出する。
  - 同じ修正（厳密パース＋平均P方式）を ON 側 `TXSD_PowerLogger_PASS_THRU_ON_v2` にも適用して再現性を揃える。

### 11.1 新OFF再計測 (2025-12-01) — 修正版ロガーで取得

- データ: `data/実験データ/研究室/1m_off_1201_01/trial_001_off.csv` ～ `trial_010_off.csv`
- パーサ: 修正版（厳密パース＋digit repair ON）、p_mW も生データから計算
- サマリ（mV/µA→P再計算、p_mW列非依存）:

| file | good lines | total | valid率 | mean_p_mW | E_mJ | duration_s |
|------|------------|-------|---------|-----------|------|------------|
| trial_001_off.csv | 5,979 | 5,980 | 100.0% | 179.86 | 10,752.19 | 59.78 |
| trial_002_off.csv | 5,972 | 5,973 | 100.0% | 180.03 | 10,749.66 | 59.71 |
| trial_003_off.csv | 5,966 | 5,967 | 100.0% | 180.11 | 10,743.36 | 59.65 |
| trial_004_off.csv | 5,959 | 5,960 | 100.0% | 180.22 | 10,737.30 | 59.58 |
| trial_005_off.csv | 5,951 | 5,952 | 100.0% | 180.30 | 10,727.84 | 59.50 |
| trial_006_off.csv | 5,945 | 5,946 | 100.0% | 180.19 | 10,710.52 | 59.44 |
| trial_007_off.csv | 5,940 | 5,941 | 100.0% | 180.29 | 10,707.19 | 59.39 |
| trial_008_off.csv | 5,933 | 5,934 | 100.0% | 180.32 | 10,696.60 | 59.32 |
| trial_009_off.csv | 5,926 | 5,927 | 100.0% | 180.30 | 10,683.04 | 59.25 |
| trial_010_off.csv | 5,919 | 5,920 | 100.0% | 180.25 | 10,667.32 | 59.18 |

**平均**: mean_p_mW = 180.19 mW, mean_E_mJ = 10,717.50 mJ, mean_duration = 59.48 s  
**所見**: 化けゼロ（valid率=100%）、P_off ≈180 mW に収束。旧OFF 240 mW と比較して低下したが、計測タスク常駐分を含む「計測込みベースライン」として安定。  
**次**: 同条件で ON を取得し、同じパーサ/平均P方式で ΔE/adv を再計算する。

---

*作成: 2025-11-30*
*更新: 2025-11-30 - 文字化け問題の特定*
*データパス: data/実験データ/研究室/1m_1130_on_02/, 1m_off_1129_1/*
