# 計測系 TODO 対応ログ（2025-11-20）

- 目的: A系止血（解析対象の確定と単位健全性チェック）を進めた作業ログ。

## 実施内容

- Manifest 起票: `experiments_manifest.yaml` を新設し、`1m_on_05`（trial_015_on を high_current_outlier として除外、016-019 を良品）と `1m_off_05`（021-025 を有効）を記入。`cluster_id` と `exclude_reason` を明示。
- パイプライン対応: `scripts/compute_power_and_pdr.py` に `--manifest` を追加し、manifest の include=false を自動スキップ・理由表示するようにした。
- 単位監査スクリプト: `scripts/check_units.py` を新規追加。I1/I2/I3（E再積分 vs summary, mean_pレンジ）を試験し、manifest除外を考慮。
- I2 定義修正とパーサ互換化:
  - diag の `mean_p_mW` 値が実質 µW スケールである前提で `/1000` 補正して I2 を計算。
  - オフライン積分は TXSD と同じ軽量パーサ（先頭数字採用）を使いつつ、`p_mW` 列があればそれを優先して積分する形に変更。
- Manifest横展開:
  - `1m_on_04`（trial_014_on）、`1m_off_04`（013/014_off）を追加（すべて include=true）。
  - 既知の外れを exclude: `1m_on_100_01/trial_065_on`, `1m_on_1000_01/trial_044_on`, `1m_on_500_03/trial_095_on`, `trial_096_on`。
- 全データセットへの Manifest 自動生成:
  - `experiments_manifest.yaml` を全trial 101件で再生成（meta除外）。interval_ms 推定、cluster_id 付与、既知外れは include=false。
- TX出力の固定桁化:
  - `esp32/TX_BLE_Adv_Meter_blocking.ino`, `TX_BLE_Adv_Meter_ON_10ms.ino`, `TX_BLE_Adv_Meter_OFF_10ms.ino`, `TX_BLE_Adv_Meter_ON_nonblocking.ino`, `esp32_sweep/TX_BLE_Adv_Meter_ON_sweep.ino` で UART 出力を固定幅（mv=4桁, uA=6桁、p_mW付きはそのまま）に変更。
- ΔE/adv パイプライン雛形:
  - `scripts/compute_delta_energy.py` を追加。manifest遵守で ON/OFF を集計し、ΔE/adv を Markdown 出力するスクリプト。

## チェック結果（1m_on_05, manifest適用）

- 実行: `python3 scripts/check_units.py --data-dir data/実験データ/研究室/1m_on_05 --manifest experiments_manifest.yaml --abs-tol-pct 1.0`
- 結果概要:
  - `trial_015_on.csv` は manifest で除外。
  - 016-019 で I1 差分 ≈ 0%（±0.004%）、I2 差分 ≈ −0.76%（±0.69%）。mean_p_mW=293,198 などの値は diag 上 µW スケールと解釈し `/1000` で mW 換算すると整合。
  - uA列の文字化けは残るが、TXSD互換パーサ＋`p_mW`列優先で再積分すると summary と一致する状態まで到達。

## 次の一手（提案）

- Manifest を他セット（on/off_04, 500 ms 系）にも拡張し、集計の足場を固める。
- TX出力の固定桁化＋解析パーサの非数字除去を適用し、`check_units.py` で I1/I2 を ±1% 内に収める。
- 500 ms 系でクラスタリング（mean_i, E_total_mJ）を走らせ、Manifest に cluster_id と include=false を反映する。

- Sweep版LED/SYNC常時HIGHを廃止し、開始100msパルスのみ（ベースライン差解消）。
