以下は、**BLE省電力実験における電力計測・受信評価システムの健全化プロセス**をまとめた技術トピックです。  
フェーズ0-0で発生した「広告OFFの方がONより消費が大きい」という異常を出発点として、**何を、なぜ、どのような順序で行い、今どうなっているか**を整理します。

---

# 1. 背景と課題（発端）

フェーズ0-0のデータ取得において、**広告OFF（ベースライン）の消費電力が広告ON時より高い**という物理的に矛盾した現象が発生しました。

- 代表例: `data/実験データ/研究室/1m_off_02/`（OFF_02）
  - 平均電流 ≈ **59 mA**
  - サンプリングレート ≈ **150 Hz**（設計値 500 Hz に対して大幅低下）
  - `parse_drop`（パース失敗行数）が **1万行以上**（全行の10%以上）
- 一方、ON側（`data/実験データ/研究室/1m_ad/` や再試行 `1m_ad_retry`）では、平均電流 ≈ **10 mA** 程度で推移しており、**OFF > ON** という逆転現象になっていた。

**原因仮説**：

- 計測ハードウェア（INA219）の不具合ではなく、**PowerLogger（受信・記録側）のI/Oボトルネック**が主因と判断した。
  - UART受信バッファ溢れ
  - 浮動小数点演算（`printf`/`sscanf`）の負荷
  - SDカードへの行ごとの書き込み
- これらにより、**計測データの欠落と dt（時間差）の歪み**が発生し、エネルギー積分 `E_total` が不正確になっていた。

このフェーズの詳細なトラブルシナリオは `docs/トラブルシューティング/OFF高消費電力_トラブルシューティング.md` に記録されている。本トピックでは、その後の「解決プロセス」と「最終的な評価系」の確立に焦点を当てる。

---

# 2. 実施した修正アプローチ（The Fix）

異常な ΔE（E_ON − E_OFF）を正し、物理的に妥当なエネルギー差を観測できるようにするため、以下の3段階で修正した。

## 2.1 送信側（TX）の軽量化：整数CSV化

- **目的**：
  - 送信データ量と文字列処理コストを削減し、UARTまわりのボトルネックを緩和する。
  - PowerLogger側が、**数値行のみ**を前提に単純・高速なパーサを利用できるようにする。

- **主な変更**：
  - TX（計測対象）の UART 出力を、従来の浮動小数点表現（例: `3.300,0.059,...`）から、**整数表現（例: `3300,59000` = mV, µA）** に変更。
  - UART1 上の診断行（`# diag`, `# sys` など）を**送信しない**ようにし、**「mv,uA」の2カラムのみ**を送る構成に統一。

## 2.2 受信側（PowerLogger）の構造改革：パススルー＆塊書き込み

最もクリティカルな修正は PowerLogger（TXSD）の構造見直しである。

- **対象スケッチ**：`esp32_sweep/TXSD_PowerLogger_PASS_THRU_ON_v2.ino`

- **主な変更点**：
  - **パススルー実装**：
    - 重い `sscanf`／浮動小数点フォーマット処理を廃止。
    - 受信した1行を軽量な整数パーサで `mv,uA` にだけ変換し、**必要最小限の計算**（p_mW, E_mJ）だけを行う。
  - **非同期・塊（Chunk）書き込み**：
    - SDカードへの書き込みを「1行ごと」から、「**16 KB バッファ単位**」の塊書き込みに変更。
    - 受信中はバッファに追記し、バッファが埋まったタイミングまたは trial 終了時に一括書き込みすることで、I/O ブロック時間を最小化。
  - **積分ロジックの適正化**：
    - エネルギー計算を `E_mJ += p_mW * (dt / 1000.0)` に統一。
    - `p_mW = (mv * uA) / 1000000.0`（mV×µA → mW）とし、**単位換算バグ（/1000）を修正**。
    - `dt` は PowerLogger側の `millis()` 差分で算出し、サンプリングレートの揺らぎも含めて正しく積分できるようにした。

- **成果**：
  - 実効サンプリングレートが **約500 Hz**（ON時、SAMPLE_US=2000 µs）に復帰。
  - OFF側でも設計どおり **約100 Hz**（SAMPLE_US=10000 µs）で安定。
  - `parse_drop` は **ほぼ0** となり、計測データの欠落が事実上消失。

## 2.3 計測条件の標準化（Phase-1 要件準拠）

フェーズ1要件で想定していた **「ON時はTICKで広告回数をカウント、OFF時は無線スタックを完全停止」** という構成に合わせて、ON/OFF の条件を整理した。

- **ON（広告ON, 100 ms）**：
  - TX: `esp32/TX_BLE_Adv_Meter_blocking.ino`
    - BLE広告 100 ms 固定。
    - INA219 は 2 ms 周期でサンプリング（約500 Hz）。
    - GPIO27 から **TICKパルス**を出力し、PowerLogger 側で `adv_count` を物理カウント。
- **OFF（ベースライン, 広告OFF）**：
  - TX: `esp32/TX_BLE_Adv_Meter_OFF_10ms.ino`
    - Wi‑Fi/BLE スタックを明示的に OFF。
    - INA219 は 10 ms 周期でサンプリング（約100 Hz）。
    - TICK は未配線（`adv_count=0`）。
- **PowerLogger（ON/OFF共通）**：
  - `esp32_sweep/TXSD_PowerLogger_PASS_THRU_ON_v2.ino`
  - ON時は TICK_IN=33 で `adv_count` をカウント、OFF時は未接続。
- **RX Logger**：
  - `esp32/RX_BLE_to_SD_SYNC_B.ino`
  - SYNC信号で trial を区切り、`/logs/rx_trial_XXX.csv` に PDR/TL評価用ログを保存。

---

# 3. 検証結果と現状（Evidence）

修正後の構成を用いて実施した `1m_on_05` / `1m_off_05` 実験（E2, 1 m, 100 ms, 60 s）により、以下が確認できた。詳細な数値は `results/summary_1m_E2_100ms_on_off_05.md` を参照。

## 3.1 エネルギー整合性（ΔE > 0）

- ON 良品セット（`data/実験データ/研究室/1m_on_05`, trial_016〜019）：
  - `E_total_mJ` 平均 ≈ **17528.1 mJ**（≈ **17.53 J/60 s**）
  - ばらつき ≈ 0.5%
- OFF セット（`data/実験データ/研究室/1m_off_05`, trial_021〜025）：
  - `E_total_mJ` 平均 ≈ **14900.5 mJ**（≈ **14.90 J/60 s**）
  - ばらつき ≈ 0.07%
- 差分：

```text
ΔE = E_on − E_off ≈ 2627.7 mJ ≈ +2.63 J/60 s
```

- これにより、**「広告を出すとエネルギー消費が増える（E_ON > E_OFF）」** という物理的に正しい関係が確認できた。

## 3.2 指標の確立（ΔE/adv）

- ON 側の `adv_count = 600`（TICK カウント）を分母として、

```text
ΔE/adv ≈ 2627.7 mJ / 600 ≈ 4.38 mJ/adv
```

- この値は、「測定系（INA219＋TXSD）のベース負荷がON/OFFで共通である」という前提のもと、**「広告をONにしたことで追加で消費されるエネルギー（1 advあたり）」** を意味する。
- フェーズ0-0および今後のフェーズでは、**電力評価の主指標を ΔE/adv とし、平均電流[mA]は補助的な指標**として扱う。

## 3.3 サンプリングレート間の互換性

- 別途実施した 10 ms サンプリング（100 Hz）ベースの ON実験（例: `1m_on_06`）でも、60 s 換算の `E_total_mJ` は `1m_on_05` の結果と整合している。
- これにより、
  - サンプリング周期を変えても、dtを正しく積分する限り **総エネルギーは安定して再現できる** こと。
  - PowerLoggerの現実装（PASS_THRU + 正しい dt処理）が、少なくとも 100〜500 Hz の範囲で**エネルギー積分として十分に堅牢**であること。
  が確認できた。

## 3.4 条件拡張時に判明したLEDベースライン差（100 ms vs 500 ms）

- フェーズ0-0の後半では、**アドバタイズ間隔を 100 ms → 500 ms → 1000 ms に拡張**するため、スイープ版コード（`esp32_sweep/TX_BLE_Adv_Meter_ON_sweep.ino`）を導入した。
- その結果、以下の現象が観測された。
  - 100 ms（旧 `TX_BLE_Adv_Meter_blocking.ino`）よりも、500 ms（スイープ版）の方が **見かけ上 E_total が大きい**。
  - ただし、500 ms と 1000 ms を **同じスイープ版コード内で比較**すると、期待どおり 1000 ms の方が小さい（省電力）という「階段」は確認できていた。
- 調査の結果、**LED（GPIO2）と SYNC 出力の扱いの違い**が主因であることが分かった。
  - 旧 100 ms 用コード（`TX_BLE_Adv_Meter_blocking.ino`）では、`syncPulse()` で **起動直後に100 msだけLED/SYNCを点灯**し、その後は計測中LED消灯。
  - スイープ版コード（`TX_BLE_Adv_Meter_ON_sweep.ino`）では、`startTrial()`〜`endTrial()` の間、**LEDと SYNC_OUT を常時HIGH** としており、trial中ずっとLED点灯分の消費が上乗せされていた。
- このため、
  - 「100 ms（旧） vs 500 ms（新）」の比較は、**LEDベースラインが異なる2つのコード**を比較していたことになり、純粋なアドバタイズ間隔の差ではなく LED オフセットを含んだ差分となっていた。
  - 一方、「500 ms vs 1000 ms」の比較は**同一コード内**でLED条件も同じであるため、正しい階段（500 ms > 1000 ms）が確認できていた。
- 対応方針：
  - 条件を跨いだ比較（100/500/1000 ms）を行う際は、**LED/SYNC の扱いを統一した同一コード**のみによるデータを基準とする（旧コードとスイープ版コードの混在比較は行わない）。
  - スイープ版コード側の SYNC 出力は、今後 **「trial中常時HIGH」から「短いパルス（syncPulse相当）」へ揃える**ことを検討中（LED点灯の有無を含め、ベースラインを揃えるため）。

---

# 4. システム構成要素（現時点の「正解」）

現時点で、フェーズ0-0の E2/1 m/100 ms 条件の ON/OFF 実験を再現するための「正解構成（Golden Master）」は以下の通り。

| 役割 | ファイル | 要約 |
| :--- | :--- | :--- |
| **TX (ON用)** | `esp32/TX_BLE_Adv_Meter_blocking.ino` | 100 ms BLE広告、INA219 2 ms サンプリング、整数CSV `mv,uA` 出力、TICK付き |
| **TX (OFF用)** | `esp32/TX_BLE_Adv_Meter_OFF_10ms.ino` | 無線完全停止、INA219 10 ms サンプリング、整数CSV `mv,uA` 出力、TICKなし |
| **PowerLogger** | `esp32_sweep/TXSD_PowerLogger_PASS_THRU_ON_v2.ino` | PASS_THRU版。ON/OFF共通。`ms,mv,uA,p_mW` をSDに記録しつつ E_mJ を積分、TICK入力で `adv_count` カウント |
| **RX Logger** | `esp32/RX_BLE_to_SD_SYNC_B.ino` | SYNC入力で trial を区切り、PDR/TL 評価用の `rx_trial_XXX.csv` を記録 |

この構成と `results/summary_1m_E2_100ms_on_off_05.md` により、当該条件での ΔE/adv ≈ **4.4 mJ/adv** を「代表値」として再現できる（※旧 v2 rig の暫定値。正式な比較・設計では v3 rig 再計測の Mode A/B/C 系データを使用する）。

---

# 5. 将来フェーズへの橋渡し（簡易）

本トピックで行った修正は、単なるバグ修正ではなく、**今後のフェーズ1/2/3に共通で流用できる計測基盤の整備**でもある。

- **PowerLoggerの役割の明確化**：
  - 「電圧・電流・時間」をできるだけ素直に記録する**土管（Pipe）**に徹し、アプリケーションロジック（HAR/MAB/Safe‑MAB）は TX 側に閉じ込める。
  - これにより、TX 側の方策（固定間隔 → MAB → Safe‑MAB）が変わっても、**計測系はそのまま再利用**できる。
- **KPIの互換性**：
  - 本トピックで確立した **ΔE/adv, PDR, TL, Pout(τ)** は、そのままフェーズ1要件定義書で述べている KPI と整合しており、**学習・評価時の報酬／制約指標として直接利用可能**である。
- **データ品質の保証**：
  - `parse_drop ≈ 0`、`rate_hz` の安定、E_total の再現性（±0.5〜1%）を満たすことで、**学習データとしての品質基準（QA）** を満たしている。

---

# 6. 結論

- フェーズ0-0における「広告OFFの方が電力が大きい」という異常は、**PowerLogger側のI/Oボトルネックと単位換算ミス**による計測系の破綻が原因だった。
- TXの整数CSV化、PowerLoggerのPASS_THRU化（塊書き込み＋正しい dt積分）、ON/OFF条件の標準化により、
  - **E_ON > E_OFF**
  - **ΔE/adv ≈ 4.4 mJ/adv**
  を安定して再現できる状態に到達した。
- 現在の計測システムは、**フェーズ1で要求される電力・受信品質評価を実施できる水準**にあり、その上で MAB/Safe‑MAB などの方策を評価していくための基盤として利用可能である。
