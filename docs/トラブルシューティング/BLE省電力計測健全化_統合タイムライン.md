# BLE省電力計測システム健全化_統合タイムライン

- 作成日: 2025-11-19
- 目的: BLE省電力実験における **計測系の不具合解消〜評価指標確立〜コード差分の整理** までを、時系列で一望できる形にまとめる。
- 関連ドキュメント:
  - `docs/トラブルシューティング/OFF高消費電力_トラブルシューティング.md`
  - `docs/フェーズ0-0/実験ログ_E2_1m_2025-11-09.md`
  - `docs/フェーズ0-0/技術トピック_電力計測健全化.md`

---

## 1. 【発端】「OFFの方が電流が高い」異常の検知

- **現象**:
  - 広告OFF（ベースライン）の平均電流が **約59 mA**、広告ON時が **約10 mA** となり、物理的矛盾が発生。
  - 代表例: `data/実験データ/研究室/1m_off_02/`（OFF_02）で `mean_i ≈ 59 mA`, `rate_hz ≈ 150.8 Hz`, `parse_drop ≈ 1.1e4`。
- **原因特定**:
  - INA219や配線ではなく、**PowerLogger（受信側）の処理能力不足**に起因。
  - SDカード書き込みと浮動小数点演算（`printf`/`sscanf`）が重く、計測ループが遅延。
  - その結果として、
    - データ欠落（`parse_drop > 10,000`）
    - 実効レート低下（設計 500 Hz → 実測 100〜150 Hz）
    が起き、エネルギー積分 `E_total` が正しく計算できていなかった。

※ 本フェーズの詳細は `docs/トラブルシューティング/OFF高消費電力_トラブルシューティング.md` を参照。

---

## 2. 【修正フェーズ1】計測システムの構造改革（パススルー化）

- **実施内容**:
  - PowerLogger を **パススルー＋塊書き込み**構成に変更（`esp32_sweep/TXSD_PowerLogger_PASS_THRU_ON_v2.ino`）。
  - 主な変更点:
    - オンボードでの `sscanf` や複雑な浮動小数点計算を停止。
    - UART受信データを大きなバッファに貯め、**16 KB チャンク単位**で SD へ書き込み。
    - エネルギー積分は「整数mv, µA → p_mW → E_mJ」を軽量に処理。
- **成果**:
  - `parse_drop = 0`（欠損なし）を達成。
  - 実効サンプリングレートが設計値近傍（ON時 ≈500 Hz, OFF時 ≈100 Hz）へ回復。
  - 「測定系として成立していない」状態からの脱出に成功。

---

## 3. 【修正フェーズ2】単位換算バグの発見と修正

- **発覚**:
  - CSV解析中、電力列 `p_mW` の桁が不自然であることに気づく。
- **原因**:
  - 整数化対応（mV, µA）に伴う計算式更新時のミス。
  - 誤実装: `p_mW = (mv * uA) / 1000.0`
  - 正式な定義: `p_mW = (mv * uA) / 1000000.0`（mV×µA → mW なので 1000×1000 で割る）
- **対応**:
  - PowerLogger 側（`TXSD_PowerLogger_PASS_THRU_ON_v2.ino`）の式を `/1e6` に修正（P0案件）。
  - 過去ログはオフライン解析時に修正後の式で再計算することで、再測定なしに正しい値へ復元。

---

## 4. 【戦略策定】評価指標（KPI）の再定義

- **課題**:
  - 測定系（ESP32 + INA219 + UART/SD）のベース消費が **約59 mA** と高く、単純な「平均電流[mA]」だけでは無線部分のコストが見えにくい。
- **決定事項**:
  - 主要KPIとして、**「イベントあたりのエネルギー増加分（ΔE/adv）」** を採用。
  - 定義:

    ```text
    ΔE/adv = (E_ON − E_OFF) / N_adv
    ```

- **効果**:
  - 測定系の定常負荷（CPU/I2C/UARTなど）を相殺しつつ、**「無線1回あたりの純粋なコスト」** を評価できる。
  - フェーズ0-0およびフェーズ1以降の報告では、
    - 平均電流[mA]は補助的な指標
    - 電力評価の主語は ΔE/adv（mJ/adv）
    として扱う方針とした。

---

## 5. 【検証】ΔE/adv の妥当性確認（1m_on_05 / 1m_off_05）

- **条件**:
  - E2 / 距離1 m / 窓60 s / TxPower=0 dBm / adv_interval=100 ms（ON時）
  - ON: `data/実験データ/研究室/1m_on_05`（良品 trial_016〜019）
  - OFF: `data/実験データ/研究室/1m_off_05`（trial_021〜025）
  - サマリ: `results/summary_1m_E2_100ms_on_off_05.md`

- **結果（抜粋）**:
  - ON 側（良品セット）:
    - `E_total_mJ` 平均 ≈ **17528.1 mJ**（≈17.53 J/60 s）
  - OFF 側:
    - `E_total_mJ` 平均 ≈ **14900.5 mJ**（≈14.90 J/60 s）
  - 差分:

    ```text
    ΔE = E_on − E_off ≈ 2627.7 mJ ≈ +2.63 J/60 s
    ΔE/adv ≈ 2627.7 mJ / 600 ≈ 4.38 mJ/adv
    ```

- **解釈**:
  - ΔE > 0 となり、「広告ONの方が電力が増える」という物理的整合性が回復。
  - `ΔE/adv ≈ 4.4 mJ/adv` を、「測定系のベース負荷を差し引いた上での、1広告あたりのエネルギー増分」として解釈できる。

---

## 6. 【展開と新たな発見】条件拡張時のLEDベースライン差（100 ms vs 500 ms）

- **背景**:
  - 100 ms 条件に加え、**500 ms / 1000 ms 条件へ実験を拡張**するため、スイープ版コード `esp32_sweep/TX_BLE_Adv_Meter_ON_sweep.ino` を導入。
- **発生した現象**:
  - 100 ms（旧 `TX_BLE_Adv_Meter_blocking.ino`）よりも、500 ms（スイープ版）の方が **見かけ上の E_total が大きい** という逆転現象。
  - しかし、500 ms と 1000 ms を **スイープ版コード内で比較**すると、期待通り 1000 ms の方が省電力（E_total が小さい）。
- **原因特定**:
  - 旧 100 ms 用コード（`TX_BLE_Adv_Meter_blocking.ino`）:
    - `syncPulse()` で **起動直後に LED/SYNC を ~100 ms だけ点灯**し、その後は計測中LED消灯。
  - スイープ版コード（`TX_BLE_Adv_Meter_ON_sweep.ino`）:
    - `startTrial()`〜`endTrial()` の間、**LED と SYNC_OUT を trial中ずっと HIGH** に維持。
  - つまり、「100 ms（旧） vs 500 ms（新）」の比較は、**LEDベースラインが異なる2つのコード**での比較になっていた。
- **結論**:
  - 100 ms 条件で有利に見えていた差分のかなりの部分は、**LED常時点灯分のオフセット**であり、アドバタイズ間隔そのものの違いではなかった。
  - 一方で、500 ms vs 1000 ms の比較は同一コード内でLED条件も一致していたため、こちらは正しい階段構造（500 ms > 1000 ms）として解釈してよい。

---

## 7. 現在のステータスと Next Step

### 7.1 現在の到達点

1. **データの完全性**：
   - PASS_THRU 化と塊書き込みにより、`parse_drop ≈ 0`・レート安定を達成。
2. **評価の信頼性**：
   - ΔE/adv を主指標とすることで、ベース電流やLED点灯などの実装差の影響を相殺し、無線コストだけを切り出せる評価ロジックを確立。
3. **物理的妥当性**：
   - 100 ms の ON/OFF 比較で ΔE > 0 を確認。
   - 500 ms → 1000 ms でも、アドバタイズ間隔の増加に応じた省電力効果を確認。

### 7.2 Next Step（コード・実験整備）

1. **コード側のベースライン統一**:
   - スイープ版コード（`TX_BLE_Adv_Meter_ON_sweep.ino`）の SYNC/LED 処理を、旧 100 ms コードの `syncPulse()` に揃える。
     - 例: trial 開始時に短いパルスを出すだけにし、trial中常時点灯はやめる。
2. **再計測**:
   - 修正版コードで 100 / 500 / 1000 ms 条件を撮り直し、**「ベースラインが完全に揃った階段データ」**（100 > 500 > 1000）を取得する。
3. **Phase‑1 以降への展開**:
   - 現在の計測系（TX + TXSD + RX）の構成を固定し、その上で Policy（固定→MAB→Safe‑MAB）だけを差し替える形で評価実験に移行する。

---

## 8. 本トピックの位置づけ

- 本タイムラインは、プロジェクトにおける
  - **技術的負債の解消**（計測系のI/Oボトルネック、単位換算バグ）
  - **評価系の確立**（ΔE/adv を中心としたKPI）
  - **コード仕様差による見かけの矛盾の整理**（LEDベースライン差）
  を一つのストーリーとしてまとめたものである。
- 詳細な仕様や数式は、次のドキュメントに委ねる。
  - 測定装置の仕様: `docs/フェーズ0-0/実験装置最終仕様書.md`
  - ΔE評価系の詳細: `docs/フェーズ0-0/技術トピック_電力計測健全化.md`
  - フェーズ0-0 要件全体: `docs/フェーズ0-0/要件定義.md`

