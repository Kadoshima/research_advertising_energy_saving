以下は **ESP32三ノード実験装置 最終仕様書（フェーズ0-0）** です。  
BLE広告の電力と受信品質（Pout, TL, PDR）を測るための **TX / TXSD / RX の3台構成**について、回路・配線・コード挙動を現状仕様として固定します。  
将来のHARやMABなど制御側の設計は別ドキュメントに分離し、本書には記載しません。

---

# 1. 文書メタ

- **文書ID**：ADV-PWR-RIG-PH0-0-v1.0
- **対象フェーズ**：Phase 0-0（ΔEベースライン計測）
- **対象モジュール**：
  - `TX`：送信＋電流測定ノード（esp32_sweep/TX_BLE_Adv_Meter_ON_sweep.ino）
  - `TXSD`：電力ロガノード（esp32_sweep/TXSD_PowerLogger_PASS_THRU_ON_v2.ino）
  - `RX`：受信ロガノード（esp32_sweep/RX_BLE_to_SD_SYNC_B.ino）
- **スコープ**：
  - 回路・配線・電源条件
  - GPIOピン割り当て
  - 計測シーケンスとログ仕様

---

# 2. システム全体構成

目的：  
BLE広告の電力と品質（Pout, TL, PDR）を測るために、以下の3ノード構成とする。

- **TX**：BLE広告を送信しつつ、INA219で自ノード電流を測定し UART で出力する。
- **TXSD**：TX からの UART を受信し、**電流ログ＋イベント電荷**を SD に記録する。
- **RX**：空間中の BLE広告をパッシブスキャンし、**受信ログ**を SD に記録する。

**共通の重要ポイント**：

- **3台すべての GND を外部電源の GND と共通化する（直結）**。
  - 外部電源GND ↔ TX.GND ↔ INA219.GND ↔ TXSD.GND ↔ RX.GND を1点接続で共有する。

---

# 3. 回路・配線仕様

## 3.1 TX（送信＋電流測定）

- **ファイル**：`esp32_sweep/TX_BLE_Adv_Meter_ON_sweep.ino`
- **役割**：
  - BLE広告を一定間隔（`ADV_INTERVAL_MS`）で送信する。
  - INA219 で TXボード全体の電流/電圧を測定し、UART1 から `"mv,uA"` 形式で出力する。
  - トライアル開始～終了を SYNC信号で示し、TXSD/RX のログ区切りに使う。
  - 各広告イベントごとに TICKパルスを出力し、TXSDで ADV回数をカウントできるようにする。

### 3.1.1 電源

- 外部電源（例：PMM25 等）から **3.3V** を供給する。
- 推奨配線：
  - 外部電源 +3.3V → **INA219 VIN+**
  - INA219 VIN− → **ESP32 TX の 3V3ピン**
  - 外部電源 GND → **ESP32 TX の GNDピン** ＋ **INA219 GND**
  - 上記 GND を TXSD・RX 側の GND と共通化する。
- 注意事項：
  - ESP32 DevKit の **VINピンに3.3Vを入力しない**。オンボードLDOでさらに降圧されるため、**3V3ピンに直接給電**する。
  - INA219 のシャント抵抗は **0.1Ω（`RSHUNT_MILLIOHM = 100`）** を前提とする。

### 3.1.2 GPIOピン割り当て

```cpp
static const int SYNC_OUT_PIN = 25;
static const int TICK_OUT_PIN = 27;
static const int LED_PIN      = 2;
static const int I2C_SDA      = 21;
static const int I2C_SCL      = 22;
static const int UART_TX      = 4;
```

- **GPIO25 (`SYNC_OUT_PIN`)**
  - トライアル開始〜終了の間 HIGH を出力する。
  - 接続先：
    - TXSD の **GPIO26 (`SYNC_IN`)**
    - RX の **GPIO26 (`SYNC_IN`)**
- **GPIO27 (`TICK_OUT_PIN`)**
  - 各アドバタイズ更新時に **約200µsの HIGH パルス（3.3 Vレベル）** を出力する。
  - 割込みで確実に検出するには、受信側のサンプリングや割込み遅延を踏まえ、200µs以上のパルス幅を確保する。
  - 接続先：
    - TXSD の **GPIO33 (`TICK_IN`)**
- **GPIO2 (`LED_PIN`)**
  - `syncStart()` 呼び出し時に HIGH（点灯）、`syncEnd()` で LOW（消灯）。
  - トライアル中のインジケータとして使用する。
- **GPIO21 / GPIO22（`I2C_SDA` / `I2C_SCL`）**
  - INA219 との I2C 通信に使用する。
- **GPIO4 (`UART_TX`)**
  - `HardwareSerial uart1(1)` の TX ピン。
  - 接続先：
    - TXSD の **GPIO34 (`RX_PIN`)**

### 3.1.3 主なソフトウェア定数

```cpp
static const uint16_t ADV_INTERVAL_MS   = 100;    // 100 / 500 / 1000 / 2000 ...
static const uint32_t SAMPLE_US         = 10000;  // 10ms ≒ 100Hz（INAサンプル周期）
static const uint16_t N_ADV_PER_TRIAL   = 300;    // 1トライアルあたり広告回数
static const uint8_t  N_TRIALS          = 10;     // トライアル回数
static const uint32_t GAP_BETWEEN_TRIALS_MS = 5000;
static const uint8_t  RUN_GROUP_ID      = 1;      // 条件ID（例: 1=100ms, 2=500ms ...）
static const bool     USE_TICK_OUT      = true;
```

---

## 3.2 TXSD（PowerLogger）

- **ファイル**：`esp32_sweep/TXSD_PowerLogger_PASS_THRU_ON_v2.ino`
- **役割**：
  - TX からの UART (`"mv,uA"`) を受信し、**「ms,mV,µA,p_mW」形式のCSV**として SD に記録する。
  - SYNC信号で trial 開始/終了を検出する。
  - TICK信号で ADV回数を厳密カウントし、エネルギーを **「1広告イベントあたりの平均エネルギー（µJ）」** まで集計する。

### 3.2.1 電源

- ESP32 DevKit を **USB 5V給電**する。
- GNDは **外部電源GND（TX/INA219側）と共通**にする。
  - 外部GNDをブレッドボードなどで引き回し、TXSD.GND と直結する。

### 3.2.2 GPIOピン割り当て

```cpp
static const int RX_PIN   = 34;
static const int SD_CS    = 5;
static const int SYNC_IN  = 26;
static const int TICK_IN  = 33;
```

コメント（コード内）：

```cpp
// UART RX=34 ← ② TX=4（クロス、GPIO34は入力専用ピンに注意）
// SYNC_IN=26 ← ② SYNC_OUT=25
// TICK_IN=33 ← ② TICK_OUT=27（推奨）
// SD: CS=5, SCK=18, MISO=19, MOSI=23
```

- **GPIO34 (`RX_PIN`)**
  - TX の GPIO4 (`UART_TX`) からの `"mv,uA"` CSV を受信する。
  - UART1 設定：`baud=230400, SERIAL_8N1, RX=34, TX=-1`。
- **GPIO26 (`SYNC_IN`)**
  - TX の GPIO25 (`SYNC_OUT`) から入力する。
  - 立ち上がりエッジで `startTrial()`、立ち下がりエッジで `endTrial()` を呼び出す。
- **GPIO33 (`TICK_IN`)**
  - TX の GPIO27 (`TICK_OUT`) から入力する。
  - 割込みハンドラ `onTick()` で RISINGエッジごとに `advCountISR++` する。
- **SPI / SDカード**
  - `SPI.begin(18,19,23,SD_CS);`（SCK=18, MISO=19, MOSI=23, CS=5）
  - `/logs/trial_XXX_on.csv` として SD 直下に保存する。

---

## 3.3 RX（BLE受信ロガ）

- **ファイル**：`esp32_sweep/RX_BLE_to_SD_SYNC_B.ino`
- **役割**：
  - TX の BLE広告（ManufacturerData `"MFxxxx"`）をパッシブスキャンで受信する。
  - SYNC信号に合わせて、**「時刻、RSSI、アドレス、MFD」** を SD に記録する。
  - trial終端で簡易的な PDR を推定する。

### 3.3.1 電源

- ESP32 DevKit を **USB給電**する。
- GNDは TX / TXSD と同じ外部GNDに合流させる。

### 3.3.2 GPIOピン割り当て

```cpp
static const int SD_CS   = 5;
static const int SYNC_IN = 26;
...
SPI.begin(18,19,23,SD_CS);
```

コメント（コード内）：

```cpp
// SYNC_IN=26 ← ①の SYNC_OUT=25
// SD: CS=5, SCK=18, MISO=19, MOSI=23
```

- **GPIO26 (`SYNC_IN`)**
  - TX の GPIO25 (`SYNC_OUT`) から入力する。
  - TXSD と並列接続とし、同一の SYNC信号で trial を同期する。
- **SPI / SDカード**
  - ピン配置は TXSD と同一（CS=5, SCK=18, MISO=19, MOSI=23）。
  - `/logs/rx_trial_XXX.csv` として SD に保存する。

---

# 4. コード挙動仕様

## 4.1 TX：`TX_BLE_Adv_Meter_ON_sweep.ino`

### 4.1.1 基本挙動

- BLEデバイス名：`"TXM_ESP32"`。
- 送信電力：`TX_PWR = ESP_PWR_LVL_N0`（0 dBm）。
- アドバタイズ間隔：
  - `ADV_INTERVAL_MS` [ms] を **BLE interval単位（0.625ms）** に変換して設定する。
  - `itv = (uint16_t)(ADV_INTERVAL_MS / 0.625f);`

### 4.1.2 トライアル制御

- `setup()`：
  - GPIO（LED/SYNC/TICK）初期化。
  - BLE初期化、初期Advertise開始。
  - INA219 初期化（I2C）。
  - UART1 初期化（TX=GPIO4, 230400bps）。
  - `delay(2000)` 後に `trialIndex=0; startTrial();` を呼ぶ。
- `startTrial()`：
  - `advCountInTrial=0; seq=0; hold0=8; trialRunning=true;` をセットする。
  - `nextSampleUs = micros() + SAMPLE_US;`
  - `nextAdvMs    = nowMs + ADV_INTERVAL_MS;`
  - `syncStart()` を呼び、**LED点灯＋SYNC_OUT=HIGH** とする。
  - `Serial` に開始ログ（グループID、trial番号、adv_interval_ms）を出力する。
- `loop()`（`trialRunning == true` の間）：
  - `SAMPLE_US`（デフォルト10ms）ごとに INA219 をサンプリングし、`"mv,uA\n"` を UART1 に出力する。
  - `nowMs >= nextAdvMs` となったタイミングでアドバタイズ更新を行う。
- アドバタイズ更新時の挙動：
  - `sendSeq = (hold0>0) ? 0 : seq;`
  - ManufacturerData を `"MF%04X"`（seq）に更新する。
  - `hold0` が 0 になるまでは `"MF0000"` を送信し続ける。
  - `USE_TICK_OUT == true` の場合、TICK_OUTに **約200µsのHIGHパルス**を出力する。
  - `advCountInTrial++` し、`advCountInTrial >= N_ADV_PER_TRIAL` で `endTrial()` を呼ぶ。
- `endTrial()`：
  - `trialRunning=false; trialEndMs=millis();` をセットし、`syncEnd()` で SYNC_OUT=LOW・LED消灯とする。
  - `Serial` に trial終了ログ（adv_sent, dur_ms など）を出力する。
- トライアル間の制御：
  - `trialRunning == false` の間は `GAP_BETWEEN_TRIALS_MS` 経過後に `startTrial()` を再実行する（`trialIndex++`）。
  - `trialIndex + 1 >= N_TRIALS` の場合は全トライアル終了状態となり、`vTaskDelay(10)` でアイドル動作を維持する。

---

## 4.2 TXSD：`TXSD_PowerLogger_PASS_THRU_ON_v2.ino`

### 4.2.1 トライアル制御

- SYNC割込み：

```cpp
void IRAM_ATTR onSync(){
  bool s = digitalRead(SYNC_IN);
  if (s != syncLvl){ syncLvl=s; syncEdge=true; }
}
```

- `loop()` 内での処理：
  - `syncEdge == true` のときに SYNCレベルを読み取り、状態遷移を行う。
  - `s == HIGH` かつ `logging == false` の場合 `startTrial()` を呼ぶ。
  - `s == LOW` かつ `logging == true` の場合 `endTrial()` を呼ぶ。

### 4.2.2 startTrial()

- 次のパスを `/logs/trial_XXX_on.csv` 形式で生成し、SD にオープンする。
- 1行目にヘッダを書き出す：

```csv
ms,mv,uA,p_mW
```

- `trialIndex++` と `# meta` 行を出力する。
- 状態を初期化する：
  - `logging=true;`
  - `t0_ms = millis(); tPrev = t0_ms;`
  - `E_mJ=0.0; sampN=0; sum_mv=sum_uA=0;`
  - `sumDt=sumDt2=0.0; dtMin=0xFFFFFFFF; dtMax=0;`
  - `advCountISR=0;`
- UARTバッファを空にしてから計測を開始する。

### 4.2.3 UART受信・SD書き出し・集計

- UART1 から1文字ずつ読み取り、`'\n'` で1行として確定する。
- 行バッファ `lineBuf` を `"mv,uA"` 形式として `parse_mvuA()` でパースする。
- パースに成功した場合：
  - `tNow = millis(); dt = tNow - tPrev; tPrev = tNow;`
  - サンプル数・電圧・電流・時間間隔を集計する。
  - `p_mW = mv * uA / 1e6` として電力[mW]を計算する。
  - `E_mJ += p_mW * (dt / 1000.0);` としてエネルギー[mJ]を積分する。
  - SDには `"ms,mv,uA,p_mW\r\n"` 形式で書き出す（msは `tNow - t0_ms`）。
- SD書き込みは内部バッファ `sdBuf` にため、一定サイズ（`SD_CHUNK_BYTES`）ごとに `sd_flush_chunk()` でまとめて書く。

### 4.2.4 endTrial()

- `logging == true` のときのみ実行する。
- trial全体時間 `t_ms = millis() - t0_ms` を計算する。
- ADV回数の推定：

```cpp
uint32_t Nadv = USE_TICK_INPUT ? advCountISR
                               : (uint32_t)((t_ms / (double)ADV_INTERVAL_MS) + 0.5);
```

- `Eper_uJ = (Nadv>0) ? (E_mJ * 1000.0 / Nadv) : 0.0;` を計算する。
- SDに summary 行を出力する：

```text
# summary, ms_total=..., adv_count=..., E_total_mJ=..., E_per_adv_uJ=...
```

- 併せて diag 行・sys 行を出力する：
  - `# diag`：サンプル数、サンプリングレート、平均電圧/電流/電力、dt統計、パース失敗行数。
  - `# sys`：CPU周波数、WiFiモード、free_heap。
- 最後に `flush()` と `close()` を呼び、`Serial` に trial終了ログを出力する。

---

## 4.3 RX：`RX_BLE_to_SD_SYNC_B.ino`

### 4.3.1 トライアル制御

- SYNC割込み：

```cpp
void IRAM_ATTR onSync(){
  bool s=digitalRead(SYNC_IN);
  if (s!=syncLvl){ syncLvl=s; syncEdge=true; }
}
```

- `loop()` 内での処理：
  - `syncEdge == true` のとき SYNCレベルを読み取り、状態遷移を行う。
  - `s == HIGH` かつ `trial == false` の場合 `startTrial()` を呼ぶ。
  - `s == LOW` かつ `trial == true` の場合 `endTrial()` を呼ぶ。

### 4.3.2 startTrial()

- `/logs/rx_trial_XXX.csv` 形式で次のパスを探索し、SD にオープンする。
- ヘッダを書き出す：

```csv
ms,event,rssi,addr,mfd
```

- `trialIndex++` と `# meta` 行を出力する。
- `t0Ms = millis(); trial = true; txLock = ""; rxCount = 0;` をセットし、`Serial` に開始ログを出力する。

### 4.3.3 BLEスキャンとログ

- NimBLE または Arduino BLEライブラリを用いて、**パッシブスキャン（`activeScan=false`）** を実行する。
- コールバックでは以下の条件でログ記録する：
  - ManufacturerData 文字列を取り出し、`parseMFD()` で `"MFxxxx"` 形式かを確認する。
  - 最初に受信した送信機のアドレスを `txLock` に保存し、それ以外の送信機からの広告は無視する。
  - trial中であれば `ms = millis() - t0Ms;` を計算し、以下の形式で1行を出力する。

```csv
ms,ADV,RSSI,addr,mfd
```

- `rxCount` は trial中に受信した有効広告の行数としてカウントする。

### 4.3.4 endTrial()

- `trial == true` のときのみ実行する。
- `trial = false` とし、ファイルを `flush()` / `close()` する。
- `t_ms = millis() - t0Ms` から以下を計算する：
  - `dur_s = t_ms / 1000.0`
  - `rate_hz = rxCount / dur_s`（受信レート）
  - `expected = t_ms / ADV_INTERVAL_MS`（期待受信回数、ADV_INTERVAL_MS は RX 側定義）
  - `pdr = rxCount / expected`（期待値に対する比としての PDR 推定）
- `Serial` に summary 行（ms_total, rx, rate_hz, est_pdr）と `[RX] end` を出力する。

---

# 5. 計測シーケンス

## 5.1 事前確認

- **GND配線**：
  - 外部電源GND ↔ TX.GND ↔ INA219.GND ↔ TXSD.GND ↔ RX.GND がすべて導通していること。
- **信号配線**：
  - TX.GPIO25 (`SYNC_OUT`) → TXSD.GPIO26 (`SYNC_IN`) および RX.GPIO26 (`SYNC_IN`)。
  - TX.GPIO27 (`TICK_OUT`) → TXSD.GPIO33 (`TICK_IN`)。
  - TX.GPIO4 (`UART_TX`) → TXSD.GPIO34 (`RX_PIN`)。
- **SDカード**：
  - TXSD・RX の両方に適切にフォーマットされた SDカードが挿入されていること。

## 5.2 計測手順

1. **RX と TXSD を USB で PC に接続する。**  
   - 必要に応じてシリアルモニタを開き、ログ開始を確認できる状態にしておく。
2. **外部電源 ON → TX 起動。**  
   - 約2秒後、TX の GPIO2 の LED が点灯し、`startTrial()` 実行と SYNC_OUT=HIGH を示す。
   - これに同期して、RX 側に `[RX] start ...`、TXSD 側に `[PWR] start ...` が出力される。
3. **trial中の動作。**
   - TX は `ADV_INTERVAL_MS` 間隔で BLE広告 `"MFxxxx"` を送信し、各送信ごとに TICK_OUT パルスを出力する。
   - RX は広告を受信し、`/logs/rx_trial_XXX.csv` に RSSI を含むログを記録する。
   - TXSD は UART (`"mv,uA"`) を読み取り、`/logs/trial_XXX_on.csv` に電流ログ＋p_mW を記録しつつ、エネルギーを積分する。
4. **所定の `N_ADV_PER_TRIAL` に到達。**
   - TX は `endTrial()` を呼び出し、`syncEnd()` で SYNC_OUT=LOW・LED消灯とする。
   - RX/TXSD は SYNC下降エッジを検出し、それぞれ `endTrial()` を呼び、CSV をクローズして summary を出力する。
5. **トライアルの繰り返し。**
   - TX は `GAP_BETWEEN_TRIALS_MS` 経過後に次の trial を自動開始する。
   - RX/TXSD も SYNC信号に従って自動的に次の trial を開始し、ログを継続する。

---

本仕様書は、ESP32三ノード構成による BLE広告電力・受信品質計測の **現行実装の固定版** として扱う。  
配線変更やスケッチ差し替えを行った場合は、本書を更新し、計測条件との対応関係を明示すること。
