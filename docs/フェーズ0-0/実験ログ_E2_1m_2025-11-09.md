# フェーズ0-0 実験ログ（E2, 1 m, 100 ms）

- 日付: 2025-11-09
- 現在フェーズ: フェーズ0-0（ベースライン）
- 目的: 100 ms固定のベースラインで電力と受信品質の基準値を取得し、計測系の安定性を確認する。

## 実施条件（要約）
- 距離 1 m / 環境 E2（干渉強）/ 窓 60 s × 6本
- adv_interval=100 ms / TxPower=0 dBm
- 使用コード（ON/OFF非分離の共通版）
  - TX+計測: `esp32/TX_BLE_Adv_Meter_blocking.ino`（旧 `Combined_TX_Meter_UART_B.ino`）
  - 電力ロガ: `esp32/TXSD_PowerLogger_PASS_THRU_ON_v2.ino`（旧 `PowerLogger_UART_to_SD_SYNC_TICK_B.ino`）
  - 受信ロガ: `esp32/RX_BLE_to_SD_SYNC_B.ino`（旧 `RxLogger_BLE_to_SD_SYNC_B.ino`）
- データ: `data/実験データ/研究室/1m_ad/`

## 記録後の状況
- 電力（V×I積分）
  - `E_total_mJ` 平均 1933.47 mJ（±10.06 mJ）
  - `E_per_adv_uJ` 平均 3222.45 μJ（±16.75 μJ）
- 受信品質
  - `PDR` 平均 0.858（±0.009）
  - `RSSI` 中央値 −35 dBm

## 記録からわかったこと
- 電力計測の再現性は良好（±0.6%程度）。
- E2環境でも PDR≈0.86 程度を維持しており、ベースライン品質として妥当。
- `adv_count` は TICK未配線のため t/100ms 近似（=600）。厳密化にはTICK配線を推奨。

## 次アクション（フェーズ移行に向けて）
- 広告OFF（60 s）を同条件で取得し、ΔE = E_on − E_off を算出。
- TICK配線（27→33）＋ `USE_TICK_INPUT=true` で `adv_count` を厳密化。
- TL分布・Pout(τ)の算出スクリプトを当該データに適用し、受入基準（Pout(1 s), TL p95）の確認を開始。

## 追加: OFF取得とΔE（2025-11-09）
- OFFデータ: `data/実験データ/研究室/1m_off/`（広告OFF, 60 s × 6本）
- 集計（OFF）: `E_total_mJ` 平均 5511.02 mJ（±111.55）
- ΔE = ON − OFF = −3577.55 mJ（60 sあたり）
  - 想定外（OFF>ON）のため、配線・レンジ・供給系・無線停止状態の点検を推奨（詳細は `results/フェーズ0-0_E2_1m_100ms_deltaE_2025-11-09.md` 参照）。

### 追記（ON再試行: data/実験データ/研究室/1m_ad_retry/）
- 集計（ON再試行）: `E_total_mJ` 平均 1664.99 mJ（±240.26）, `E_per_adv_uJ` 平均 2775.00 μJ
- 受信（ON再試行）: `PDR` 平均 0.865（±0.000）, `RSSI` 中央値 −28 dBm
- ΔE（ON再試行 − OFF）: −3846.04 mJ（60 sあたり）。OFF>ONは継続。`results/フェーズ0-0_E2_1m_100ms_retry_latest_2025-11-09.md` 参照。

### 追記（OFF再取得: data/実験データ/研究室/1m_off_02/）
- 集計（OFF_02）: `E_total_mJ` 平均 11732.93 mJ（±9.26）。rate_hz ≈ 150.8 Hz, mean_i ≈ 59.18 mA。
- ΔE（ON再試行 − OFF_02）: −10067.94 mJ（60 sあたり）。詳細は `results/フェーズ0-0_E2_1m_100ms_off_02_2025-11-09.md` と `results/summary_1m_E2_100ms_deltaE_retry_off02.md` を参照。

### 追記（OFF再取得: data/実験データ/研究室/1m_off_03/）
- 集計（OFF_03）: `E_total_mJ` 平均 11825.47 mJ（±0.86）。rate_hz ≈ 105.7 Hz, mean_i ≈ 59.34 mA。
- ΔE（ON再試行 − OFF_03）: −10160.48 mJ（60 sあたり）。詳細は `results/フェーズ0-0_E2_1m_100ms_off_03_2025-11-09.md` と `results/summary_1m_E2_100ms_deltaE_retry_off03.md` を参照。

### 追記（OFF再取得: data/実験データ/研究室/1m_off_04/）
- ダイアグ: rate_hz ≈ 339.6 Hz（parse_drop ≈ 0）, dt_mean ≈ 2.94 ms
- オフライン積分: `E_total_mJ` ≈ 11773.60 mJ（±0.57）
- 参考: `results/フェーズ0-0_E2_1m_100ms_off_04_2025-11-09.md`

### 追記（評価指標と結論の更新: 2025-11-09）
- 上記 OFF/ON 系列のうち、**OFF/ OFF_02/ OFF_03** は `parse_drop ≫ 0` かつ `rate_hz` が大きく劣化しており、**PowerLogger の処理遅延による測定系破綻が原因**で ΔE<0（OFF>ON）となっていたことが確定した。
- PowerLogger を **パススルー化（PASS_THRU）** し、OFF_04 系列では `parse_drop ≈ 0` かつ安定したサンプリングが得られている。
- ON 側も同じパイプラインで再取得した結果、代表的な 60 s 窓で
  - E_ON ≈ 14.2 J/60 s
  - E_OFF（OFF_04） ≈ 11.8 J/60 s
 となり、**E_ON > E_OFF** という物理的に妥当な関係に復帰した。
- これにより、本ログ前半で報告している ΔE（ON−OFF）が負となる集計は、**「旧PowerLogger構成による異常値」**として扱い、以後の評価・レポートでは **OFF_04＋ON(PASS_THRU) 系列のみを有効なΔE計測として採用する。**

### 追記（ΔE/adv を主指標とする方針: 2025-11-09）
- 測定系（ESP32 + INA219 + UART/SD）のベース電流が高く、**単純な平均電流[mA]だけではBLE広告の省電力性が見えにくい**ことが分かった。
- フェーズ0-0 の電力評価では、以下の指標を使い分ける。
  - **ΔE（60 sあたり）**: ONとOFFの総エネルギー差の符号・オーダー確認（物理的整合性チェック用）。
  - **ΔE/adv**: `ΔE/adv = (E_ON − E_OFF) / N_adv` を **主指標（KPI）** とし、「無線1回あたりのエネルギー増分」を評価する。
  - **平均電流[mA]**: 補助的な指標としてログに残すが、最適化の主語には用いない。
- 以後のレポートおよびスクリプト（`results/summary_*.md`）では、**電力関連の議論を ΔE/adv（mJ/adv）中心に行う**ことを基本方針とする。

### 再計算手順（スクリプト）
- 依存: Python 3.8+（標準ライブラリのみ）
- 実行:
  - 現セット（ONのみ）の要約
    `python scripts/compute_power_and_pdr.py --data-dir data/実験データ/研究室/1m_ad --expected-adv-per-trial 600 --out results/summary_1m_E2_100ms.md`
  - OFF取得後のΔE計算
    `python scripts/compute_power_and_pdr.py --data-dir data/実験データ/研究室/1m_ad_on --off-dir data/実験データ/研究室/1m_ad_off --expected-adv-per-trial 600 --out results/summary_1m_E2_100ms_deltaE.md`

## メタ情報
- SYNC: GPIO25（100 ms High）→ SYNC_IN=26（立上り開始・固定窓終了）
- 受信: ρ=1の受動スキャン（MFD `MFxxxx` 抽出, 最初に見えたTXにロック）
- チェックサム: `data/実験データ/SHA256.txt` に統合
- 参考: 結果サマリ `results/フェーズ0-0_E2_1m_100ms_2025-11-09.md`
