# ESP32三ノード実験装置 仕様書 v2.0

BLE広告の電力と受信品質（Pout, TL, PDR）を測るための **TX / TXSD / RX の3台構成**について、回路・配線・コード挙動を現状仕様として固定します。

---

## 1. 文書メタ

| 項目 | 内容 |
|------|------|
| 文書ID | ADV-PWR-RIG-v2.0 |
| 作成日 | 2025-11-29 |
| 対象フェーズ | Phase 0-0 / Phase 0-1 ベースライン計測 |
| 前版からの主な変更 | ディレクトリ再編、INA219配線修正、ボーレート変更、マルチinterval対応 |

### 対象ファームウェア

| モード | TX | TXSD | RX |
|--------|-----|------|-----|
| baseline_on | `baseline_on/TX_BLE_Adv.ino` | `baseline_on/TXSD_PowerLogger.ino` | `baseline_on/RX_BLE_to_SD.ino` |
| baseline_off | `baseline_off/TX_BLE_OFF.ino` | `baseline_off/TXSD_PowerLogger.ino` | N/A |
| ccs_mode | `ccs_mode/TX_BLE_Adv_CCS_Mode.ino` | `ccs_mode/TXSD_PowerLogger_CCS_Mode.ino` | `ccs_mode/RX_BLE_to_SD.ino` |

---

## 2. ハードウェア構成

### 2.1 使用機材

| ノード | ボード | 役割 |
|--------|--------|------|
| TX | ESP32-WROVER-E (ESP32-DevKitC-VE) | BLE広告送信 + INA219電流測定 + UART送信 |
| TXSD | ESP32-WROVER-E (ESP32-DevKitC-VE) | 電力ログ記録 (SD) |
| RX | ESP32-WROVER-E (ESP32-DevKitC-VE) | BLE受信ログ記録 (SD) |
| 電流センサ | INA219 (シャント抵抗 0.1Ω = R100) | TX電流測定 |
| 外部電源 | PMM25-1TR など | 3.3V安定化電源 |

### 2.2 消費電力参考値 (ESP32-WROVER-E)

| 状態 | 電流 (実測) | 電力 @ 3.3V |
|------|-------------|-------------|
| BLE OFF (WiFi OFF) | 約40 mA | 約132 mW |
| BLE ON (100ms interval) | TBD | TBD |

※ WROVER-EはPSRAM搭載のため、通常のWROOMより消費電力が高い

---

## 3. 回路・配線仕様

### 3.1 システム全体図

```
┌─────────────────────────────────────────────────────────────────┐
│                        外部電源 (PMM25等)                        │
│                     3.3V (+) ─────┬──────── GND (-)             │
└───────────────────────────────────┼──────────────┼──────────────┘
                                    │              │
                    ┌───────────────┼──────────────┼───────────────┐
                    │               ▼              ▼               │
                    │         ┌─────────────────────────┐          │
                    │         │       INA219            │          │
                    │         │  Vin+ ◄── 外部3.3V      │          │
                    │         │  Vin- ──► TX 3V3       │          │
                    │         │  VCC  ◄── 外部3.3V ★   │          │
                    │         │  GND  ◄── 共通GND      │          │
                    │         │  SDA  ◄──► TX GPIO21   │          │
                    │         │  SCL  ◄──► TX GPIO22   │          │
                    │         └─────────────────────────┘          │
                    │                      │                       │
┌───────────────────┼──────────────────────┼───────────────────────┼────────────────┐
│                   │                      ▼                       │                │
│  ┌────────────────┴────────────┐    ┌─────────────────┐    ┌─────┴──────────┐     │
│  │         RX (受信)           │    │    TX (送信)    │    │  TXSD (ロガー) │     │
│  │  ┌──────────────────────┐   │    │                 │    │                │     │
│  │  │ ESP32 + SD           │   │    │  ESP32 + INA219 │    │  ESP32 + SD    │     │
│  │  │                      │   │    │                 │    │                │     │
│  │  │ GPIO26 ◄─ SYNC ──────┼───┼────┼─ GPIO25 SYNC ───┼────┼─► GPIO26       │     │
│  │  │ GND    ◄─────────────┼───┼────┼─ GND ───────────┼────┼─► GND          │     │
│  │  │                      │   │    │ GPIO27 TICK ────┼────┼─► GPIO33       │     │
│  │  │ USB給電              │   │    │ GPIO4  UART ────┼────┼─► GPIO34       │     │
│  │  └──────────────────────┘   │    │                 │    │                │     │
│  └─────────────────────────────┘    │ INA219経由給電  │    │  USB給電       │     │
│                                     └─────────────────┘    └────────────────┘     │
└───────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 INA219配線 (重要)

**正しい配線:**
```
外部3.3V ─┬─► INA219 Vin+ ─► INA219 Vin- ─► ESP32 TX 3V3ピン
          │
          └─► INA219 VCC  ★ 外部電源から直接取る

外部GND ──┬─► INA219 GND
          ├─► ESP32 TX GND
          ├─► ESP32 TXSD GND
          └─► ESP32 RX GND
```

**間違った配線 (過去の問題):**
```
外部3.3V ─► INA219 Vin+ ─► INA219 Vin- ─┬► ESP32 TX 3V3ピン
                                        │
                                        └► INA219 VCC  ✗ Vin-側から取るとブラウンアウト発生
```

### 3.3 GPIOピン割り当て

#### TX (送信ノード)

| GPIO | 機能 | 接続先 |
|------|------|--------|
| 25 | SYNC_OUT | TXSD GPIO26, RX GPIO26 |
| 27 | TICK_OUT | TXSD GPIO33 |
| 4 | UART_TX | TXSD GPIO34 |
| 21 | I2C SDA | INA219 SDA |
| 22 | I2C SCL | INA219 SCL |
| 2 | LED | (内蔵LED) |

#### TXSD (電力ロガー)

| GPIO | 機能 | 接続先 |
|------|------|--------|
| 26 | SYNC_IN | TX GPIO25 |
| 33 | TICK_IN | TX GPIO27 |
| 34 | UART_RX | TX GPIO4 |
| 5 | SD_CS | SDカード |
| 18 | SD_SCK | SDカード |
| 19 | SD_MISO | SDカード |
| 23 | SD_MOSI | SDカード |

#### RX (受信ロガー)

| GPIO | 機能 | 接続先 |
|------|------|--------|
| 26 | SYNC_IN | TX GPIO25 |
| 5 | SD_CS | SDカード |
| 18 | SD_SCK | SDカード |
| 19 | SD_MISO | SDカード |
| 23 | SD_MOSI | SDカード |

---

## 4. ソフトウェア仕様

### 4.1 共通設定

| パラメータ | 値 | 備考 |
|-----------|-----|------|
| UART_BAUD | 115200 | v1.0の230400から変更（ノイズ耐性向上） |
| SAMPLE_US | 10000 | INA219サンプリング周期 10ms = 100Hz |
| I2C_CLOCK | 400000 | I2C 400kHz |

### 4.2 baseline_on モード

#### TX_BLE_Adv.ino 設定

```cpp
// マルチinterval自動実行
static const uint16_t intervals[]      = {100, 500, 1000, 2000};
static const uint8_t  trialsPerGroup[] = {10,  10,  5,    5};
static const uint8_t  N_GROUPS         = 4;
static const uint8_t  START_GROUP_INDEX = 0;  // 開始グループ (0-3)

static const uint16_t N_ADV_PER_TRIAL        = 300;    // 広告回数/トライアル (固定)
static const uint32_t GAP_BETWEEN_TRIALS_MS  = 5000;   // トライアル間隔
static const uint32_t GAP_BETWEEN_GROUPS_MS  = 10000;  // グループ間隔
```

#### 実行時間見積もり

| Group | Interval | Trials | Trial長 | Group計 |
|-------|----------|--------|---------|---------|
| 1 | 100ms | 10 | 30s | ~5分 |
| 2 | 500ms | 10 | 150s | ~25分 |
| 3 | 1000ms | 5 | 300s | ~25分 |
| 4 | 2000ms | 5 | 600s | ~50分 |
| **合計** | | **30** | | **~105分** |

### 4.3 baseline_off モード

#### TX_BLE_OFF.ino 設定

```cpp
static const uint32_t TRIAL_DURATION_MS    = 60000;   // 60秒/トライアル
static const uint8_t  N_TRIALS             = 10;      // トライアル回数
static const uint32_t GAP_BETWEEN_TRIALS_MS = 5000;   // トライアル間隔
```

- WiFi/BLEは明示的にOFF
- 実行時間: 約11分 (60s × 10 + 5s × 9)

### 4.4 SYNC信号仕様

#### 信号タイミング

```
TX (SYNC_OUT GPIO25):
        Trial開始            Trial終了
           │                    │
           ▼                    ▼
    ───────┐                    ┌───────
   LOW     │        HIGH       │   LOW
           └────────────────────┘
           │◄── Trial実行中 ──►│
```

#### 動作

| イベント | TX (SYNC_OUT) | TXSD/RX (SYNC_IN) |
|----------|---------------|-------------------|
| Trial開始 | HIGH に設定 (維持) | HIGH検出 → startTrial() |
| Trial中 | HIGH 継続 | ログ記録中 |
| Trial終了 | LOW に設定 | LOW検出 → endTrial() |

**注意**: v1.0では100msパルスのみ出力していたが、v2.0ではTrial中はHIGH維持に変更。

### 4.5 RX設定 (baseline_on)

```cpp
// RX_BLE_to_SD.ino
static const uint32_t TRIAL_MS        = 660000; // フォールバック (11分)
static const bool USE_SYNC_END        = true;   // SYNC立ち下がりで終了 ★v2.0変更
```

- `USE_SYNC_END=true`: TXのSYNC信号に追従してTrial終了
- `TRIAL_MS`: SYNCが来なかった場合のタイムアウト（フォールバック）

---

## 5. 出力ファイル形式

### 5.1 電力ログ (TXSD)

**ファイル名:** `/logs/trial_XXX_on.csv` または `/logs/trial_XXX_off.csv`

```csv
ms,mV,µA,p_mW
# meta, firmware=TXSD_PowerLogger_PASS_THRU_ON_v2, trial_index=1, adv_interval_ms=100
10,3272,052400,170.8
20,3276,059100,193.6
...
# summary, ms_total=30000, adv_count=300, E_total_mJ=5123.456, E_per_adv_uJ=17078.2
# diag, samples=3000, rate_hz=100.00, mean_v=3.273, mean_i=52.34, mean_p_mW=171.3
# diag, dt_ms_mean=10.000, dt_ms_std=0.5, dt_ms_min=9, dt_ms_max=12, parse_drop=0
# sys, cpu_mhz=240, wifi_mode=OFF, free_heap=256680
```

### 5.2 受信ログ (RX)

**ファイル名:** `/logs/rx_trial_XXX.csv`

```csv
ms,event,rssi,addr,mfd
# meta, firmware=RX_BLE_to_SD_SYNC_B, trial_index=1, adv_interval_ms=100
123,ADV,-45,aa:bb:cc:dd:ee:ff,MF0000
234,ADV,-42,aa:bb:cc:dd:ee:ff,MF0001
...
```

---

## 6. 計測手順

### 6.1 OFF計測 (P_off測定)

1. TX に `baseline_off/TX_BLE_OFF.ino` をフラッシュ
2. TXSD に `baseline_off/TXSD_PowerLogger.ino` をフラッシュ
3. TXSD を USB接続、SDカード挿入
4. 外部電源ON → TX起動
5. 10トライアル自動実行 (約11分)
6. SDカードから `trial_XXX_off.csv` を回収

### 6.2 ON計測 (ΔE/adv測定)

1. TX に `baseline_on/TX_BLE_Adv.ino` をフラッシュ
2. TXSD に `baseline_on/TXSD_PowerLogger.ino` をフラッシュ
3. (任意) RX に `baseline_on/RX_BLE_to_SD.ino` をフラッシュ
4. 全ノードを接続、SDカード挿入
5. 外部電源ON → TX起動
6. 4グループ×複数トライアル自動実行 (約105分)
7. SDカードから `trial_XXX_on.csv`, `rx_trial_XXX.csv` を回収

### 6.3 途中から再開する場合

`TX_BLE_Adv.ino` の `START_GROUP_INDEX` を変更:

| 値 | 開始interval | 実行されるGroup |
|----|-------------|----------------|
| 0 | 100ms | 100 → 500 → 1000 → 2000 |
| 1 | 500ms | 500 → 1000 → 2000 |
| 2 | 1000ms | 1000 → 2000 |
| 3 | 2000ms | 2000 のみ |

---

## 7. ΔE/adv 算出方法

```
ΔE/adv = (E_total_ON - P_off × T) / N_adv
```

| 変数 | 説明 | 取得元 |
|------|------|--------|
| E_total_ON | ON計測の総エネルギー [mJ] | summary行の E_total_mJ |
| P_off | OFF計測の平均電力 [mW] | OFF計測のmean_p_mW |
| T | ON計測の総時間 [s] | summary行の ms_total / 1000 |
| N_adv | 広告送信回数 | summary行の adv_count (TICK計測) |

---

## 8. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-11-20 | v1.0 | 初版 (フェーズ0-0) |
| 2025-11-29 | v2.0 | ディレクトリ再編、INA219配線修正、ボーレート115200化、マルチinterval対応 |

### v2.0 主な変更点

1. **ディレクトリ構成変更**
   - `esp32_sweep/` → `esp32_firmware/{baseline_on, baseline_off, ccs_mode}/`

2. **INA219 VCC配線修正**
   - Vin-側からの分岐 → 外部電源から直接取る（ブラウンアウト対策）

3. **UARTボーレート変更**
   - 230400 → 115200 (ノイズ耐性向上)

4. **マルチinterval自動実行**
   - 100ms → 500ms → 1000ms → 2000ms を自動で順次実行
   - START_GROUP_INDEX で開始位置を指定可能

5. **ハードウェア明記**
   - ESP32-WROVER-E (ESP32-DevKitC-VE) を使用
   - INA219シャント抵抗 R100 (0.1Ω)

---

## 9. v3.0 案（計測系外出し構成）

### 9.1 変更概要
- INA219 の SDA/SCL を **TX ではなく TXSD に接続**し、TX は「被測定体」として電源を受けるだけにする。
- TXSD が INA219 を直接 I²C で読み、SD に記録（UARTでの受け渡しを不要化）。
- TX は BLE 広告と SYNC/TICK だけを担当。計測タスク負荷を TX から切り離し、ベースラインをクリーンにする。

### 9.2 回路ポイント（v2.1想定）
- 電源: 外部3.3V → INA219 Vin+ → Vin− → TX 3V3。INA219 VCC は必ず外部3.3Vから直接供給。GNDは全ノード共通。
- I²C: INA219 SDA/SCL → TXSD GPIO21/22。プルアップは INA219 側の VCC（外部3.3V）に接続。TX は I²C未使用。
- 信号: SYNC_OUT=TX GPIO25 → TXSD GPIO26, RX GPIO26。TICK_OUT=TX GPIO27 → TXSD GPIO33。旧TX→TXSD UART線は原則不要（デバッグのみ任意）。

### 9.3 ソフト変更方針
- TXSD_PowerLogger を I²C 版に置き換え、`getBusVoltage_V()/getCurrent_mA()` を直接ログ出力。フォーマットは従来の `ms,mV,µA,p_mW` を維持。
- TX は計測タスクを外し、BLE広告＋SYNC/TICKのみ。OFFベースラインを真に測りたい場合は TX を light/deep sleep 前提のファームに分岐させる。

### 9.4 期待効果と注意点
- 効果: 計測タスク由来の消費がベースラインに乗らず、「TX素のベースライン＋BLE広告コスト」の評価が可能。ON/OFF比較の分解能が上がる。
- 注意: I²C配線は短く、シールド/ツイスト推奨。外部3.3VとTXSDの3.3Vで電位差が出ないよう、GNDは一点で堅牢に共通化し、必要なら3.3Vもジャンパで一点接続。

### 9.5 実験ステップ例
1. 配線変更（SDA/SCLをTX→TXSDへ、TX→TXSD UARTは外す／無効化）。
2. TXSD_PowerLogger を I²C 版に更新し、ログ形式は現行維持。
3. OFF: TXを BLE/OFF＋sleep版で計測し「真のアイドル」を取得。ON: 現行TX_BLE_Advで広告を出し ΔE/adv を再計算。
4. 比較は「計測込み版」と「計測外出し＋sleep版」を別枠で提示し、公平性を担保。
