# ESP32三ノード実験装置 仕様書 v3.0（計測外出し版）

BLE広告の電力・受信品質を測る三ノード構成を、計測系をTXから分離した新回路前提でまとめる。

---

## 1. 文書メタ

| 項目 | 内容 |
|------|------|
| 文書ID | ADV-PWR-RIG-v3.0 |
| 作成日 | 2025-12-01 |
| 対象フェーズ | Phase 0-0 / 0-1 基盤再計測 |
| 主な変更 | INAのI²CをTXSDに移し、TXを被測定体に徹する構成に変更 |

対象ファームウェア（最新修正版）
- TX: `baseline_on/TX_BLE_Adv.ino`（計測負荷なし、BLE広告＋SYNC/TICKのみ）
- TXSD: `baseline_on/TXSD_PowerLogger/TXSD_PowerLogger.ino`（I²CでINA直読み、平均P×duration方式、厳密パース＋digit repair）
- RX: `baseline_on/RX_BLE_to_SD/RX_BLE_to_SD.ino`（SYNC追従、リングバッファ＋SD flush）
- OFF系: `baseline_off/TX_BLE_OFF.ino`（計測タスクなし版を別途用意推奨）、`baseline_off/TXSD_PowerLogger.ino`（同じI²C/パーサ修正済み）

---

## 2. 回路・配線（v3.0）

- 電源経路: 外部3.3V → INA219 Vin+ → Vin− → TX 3V3。INA VCCは外部3.3Vから直接供給。GNDはTX/TXSD/RX/INAで一点共通。
- I²C: INA219 SDA/SCL → TXSD GPIO21/22（プルアップはINAのVCC側）。TXはI²C非接続。
- 信号: SYNC_OUT=TX GPIO25 → TXSD/RX GPIO26。TICK_OUT=TX GPIO27 → TXSD GPIO33。
- UART: 電流計測には不使用。デバッグ用途のみ任意。

---

## 3. ハード役割

| ノード | 役割 | 主配線 |
|--------|------|--------|
| TX | 被測定体（BLE広告） | 3V3/GND（INA経由）, SYNC_OUT=25, TICK_OUT=27, LED=2 |
| TXSD | 電力ロガー（INA直読み＋SD） | SDA=21, SCL=22, SYNC_IN=26, TICK_IN=33, SD: CS=5/18/19/23 |
| RX | 受信ロガー（パッシブスキャン） | SYNC_IN=26, SD: CS=5/18/19/23 |

---

## 4. ソフト要点

- パーサ: 厳密パース＋オプションdigit repair（`ENABLE_DIGIT_REPAIR`）。ゴミ付き行は拒否。
- エネルギー計算: サンプル平均P[mW]×duration[s]。dt×p逐次積分は廃止。
- `mean_p_mW`: mv*uA/1e6 の正しいスケールで出力。
- 100ms SYNC問題対策: RXの`USE_SYNC_END`は短パルスで即終了するため、配線健全性確認＋必要なら固定窓フォールバック/最低試行時間ガードを検討。

---

## 5. 計測ステップ（推奨）

1. 配線確認（SDA/SCLをTXSDへ、外部3.3VからINA VCC、GND共通）。
2. TXSDをI²C版パワーロガーで運用し、ON/OFFとも同一回路・同条件で計測。
3. OFF: BLE/OFF＋可能ならlight/deep sleep版で「真のアイドル」を取得。
4. ON: `TX_BLE_Adv`で intervalごとに計測。ΔE/adv = (E_on − P_off×T)/N_adv で再算出。P_off は v3 rig 再計測の Mode B 待機ベース（≈23 mW）を基準とし、理論下限として Mode A（≈11.8 mW）も併記。
5. 比較は「計測込み旧構成」と「計測外出し＋sleep構成」を別枠で提示し、公平性を担保。

---

## 6. 参考メモ（期待される効果）

- 計測タスク由来の消費がベースラインから外れ、ON/OFF差分が明確化。
- 長いinterval（1000/2000ms）では sleep 併用で平均電力が大きく低下し、省電力効果を強調しやすい。
- p_mW列に依存せず mV/µA から再計算しても summary と一致するログ設計。
