# mHealth 高遷移セッション合成仕様 v1.0 (2025-12-12)

## 目的
- mHealth 生センサ断片を切り貼りして遷移回数を増やし、HAR 推論から U（不確実性）/CCS（変化度）を得る。
- 固定間隔（100/500/1000/2000ms）と U/CCS 駆動制御の比較用データセットを、再現性のある形で生成する。
- 評価系（TRUTH_DT_MS=100ms）と整合した truth・ログ形式を固定し、短期でベースラインを作る。

## 前提・入力
- 入力: mHealth 生センサ波形、サンプルラベル、subject ID。
- 評価グリッド: TRUTH_DT_MS=100ms 固定。
- HAR モデルは推論窓ごとに確率分布 p_t(c) を出力できること（温度スケーリングは Val で調整可）。

## データ分割
- subject split を厳守（Train/Val から断片を抜かない）。合成セッションは Test subjects の断片のみで作る。
- クラス集合は現行運用クラスで固定し、生成途中で変更しない（精度崩れによる U 高止まりを防ぐ）。

## 断片ライブラリ（15s・多様性担保）
- 断片長: 15s（サンプリング fs から N=round(15×fs) を切り出す）。
- 開始点: 同一ラベル連続区間内で開始点間隔 ≥15s（非重複）。区間長が 15s 未満は除外。
- 類似度フィルタ: 各断片の簡易特徴（チャネル mean/std、RMS、主要周波数ピークなど）で類似度>0.95 を除外。
- 目標数: ラベルごとに 10 断片（不足する場合は欠損許容、重複採用しない）。
- メタ保存: segment_id, subject, source_file, start_s, end_s, label, fs, feature_hash を必ず記録。

## 前処理・境界処理
- 正規化: Train 統計のグローバル mean/std で全断片を正規化（断片単独正規化のみは不可）。
- 端点処理: 先頭/末尾 0.2s をなだらかにする（窓関数前提）。境界クロスフェード前提の下ごしらえ。
- クロスフェード: 境界 0.5s を線形ブレンド（デフォルト ON）。
- 評価除外: 境界 ±1.0s は mask_eval=0 とし、後段の U/CCS/TL/Pout 集計から除外。

## 遷移スクリプト（高遷移セッション）
- セッション長: 15 分。推奨 3 本 × seed 3（計 9 本）で統計を安定化。
- 遷移ルール: 次ラベルは current と異なるラベルを一様サンプル（隣接制約は本仕様では未使用）。同一セッション内で同一断片は再利用しない（枯渇時のみ例外をログ）。
- 滞在時間: 15s 固定（v1.0）。将来は {10,15,20}s ランダムを検討するが、本版は固定で再現性優先。

## truth・推論ログ生成
- truth: 合成セッションを 100ms グリッドで離散化し truth_label[t] を作成。境界 ±1s は mask_eval[t]=0。
- HAR 推論: 窓長 1.0s / ストライド 0.5s を推奨（実際の設定をログヘッダに記録する）。
- U 定義: 正規化エントロピー `U_t = -Σ p_t(c) log p_t(c) / log|C|` （範囲 0–1）。温度スケーリング後の分布を推奨。
- CCS 定義: 直前分布との内積から `CCS_t = 1 − Σ p_t(c)·p_{t-1}(c)` （範囲 0–1 目安）。
- 平滑化: 制御入力には EMA (α=0.2 目安) を推奨。生値も併せて保存。

## 出力ファイル（最小セット）
- 合成センサ: `synthetic_<dataset>_<classset>_<sessid>.csv`（t, センサチャネル..., truth_label_100ms, mask_eval_100ms, seed, fs）。
- スクリプト: `script_<sessid>.csv`（seg_idx, label, segment_id, start_s, end_s, source_subject, source_file, source_start_s, seed）。
- HAR 推論: `har_<sessid>.csv`（t_center, p(c1)..p(cK), y_hat, U, CCS, mask_eval_window, window_len, stride, seed）。

## 品質ゲート（不合格は破棄）
- 遷移数: 15s 滞在×15 分で遷移 ≈59 が目安。大きく外れたら生成ロジックを確認。
- U/CCS 妥当性: 境界から 2s 以上離れた安定区間で median(U) が境界近傍より低いこと（逆なら境界処理や温度を見直す）。
- リークなし: script 内 segment_id が Train/Val 由来でないことを自動チェック。

## 位置づけと今後
- 本仕様は「実センサ断片ベースの遷移ストレステスト」用。通信制御（固定 vs U/CCS 駆動）の相対比較を安定化する目的で使用する。
- 同じ script を“台本”として実測を撮れば、合成→実測のブリッジになる。まずは本仕様で 15 分セッションを生成し、U/CCS 分布と遷移回数を確認する。
