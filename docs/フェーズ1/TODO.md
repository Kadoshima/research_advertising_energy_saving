## 0) ゴールの再確認（Definition of Done）

- **省電力効果**：固定100msベースライン比で**平均電流 ≥5–10%改善**（両環境 E1/E2）を実測で証明。**Pout(1s)** の悪化は +1.0%pt以内、**p95(TL)** の悪化は +10%以内であること。集計CSV・図表・ログ一式を納品。
    
- **再現性/可搬性**：KPIの**±5%再現性**、ログ/スキーマが Phase‑2/3 へ**列追加のみ**で流用可能。
    

---

## 1) プロジェクト立ち上げ（Day 0–1）

-  **リポジトリ/Issue ボード**作成（Docs/Config/Logs/KPI の4ディレクトリ構成）。
    
-  **バージョン管理**：要件/設計/Configに版番号とGitハッシュを付与、DecisionLogに埋め込む。
    
-  **RACI確定**（実験設計＝あなた、計測＝HW、受信＝GW、解析＝解析担当、承認＝PM）。
    

---

## 2) ラボ・計測系のセットアップ（Day 1–2）

-  **電力計**（PPK‑II / Joulescope / Otii）をVBAT直列で配線、**≥100 kS/s**、**電圧同時取得**。GPIOで**広告イベント境界マーク**を出す配線を追加。**ゼロ/ゲイン校正**と**気温記録**の手順確立。
    
-  **ゲートウェイ端末**（Android）を **LOW_LATENCY** スキャン固定、NTP同期。デュープ除去ロジック（addr×時間窓）を有効化。
    
-  **環境定義**：E1（干渉弱：Wi‑Fi最小）/ E2（干渉強：2.4GHz 1/6/11稼働）をセット、切替手順をRunbookに記載。
    
-  **同期マーカー**：セッション先頭に**LED 3秒**でDUT/GW双方に印を残す。
    

**DoD**：校正ログ・配線写真・イベント境界が波形に出ているスクリーンショットを保存。

---

## 3) ログ/スキーマの確定（Day 2）

-  **送信ログ（Tx）**：`adv_interval_ms, ch_mask='111', tx_dbm, state, U, S, CCS, thresholds, hysteresis, calib_T, window_len=1.0, overlap=0.5, W_sec=10` を出力。
    
-  **決定ログ（Decision）**：`old_interval, new_interval, reason{TH_UP|TH_DOWN|FALLBACK|RATE_LIMIT}, CCS_at_decision, dwell/rate_limit/hars_health/apply_success`。**切替毎に必ず1行**。
    
-  **受信ログ（Rx）**：`t_gateway, phone_model, scan_mode, adv_addr, rx_uuid, rssi, dedup_flag`。
    
-  **電力波形（Power）**：`current_mA, voltage_V, event_marker` ストリーム。
    

**DoD**：スキーマのダミーレコードを生成してバリデーション（値域・単調性・集合外の拒否）。

---

## 4) 実装① Sensing & HAR（Day 3）

-  IMU≥50 Hzを**1.0 s窓/50%重畳**で前処理→モデル出力`p_k`。
    
-  **U**（正規化エントロピー）、**S**（直近W=10 sの遷移回数から安定度）、**CCS = 0.6U + 0.4(1−S)** を0.5 s毎に算出。温度スケーリング **T**をログ。
    
-  **HAR欠落検知**（>1.0 s）をポリシへ通知するヘルスフラグを出す。
    

**DoD**：U/S/CCSのトレンドが出力され、値域[0,1]・窓仕様に一致。Edge実装方針はTinyMLの一般指針に適合（低消費・遅延の両立）。

---

## 5) 実装② Policy Engine（Phase‑1：決め打ち写像）（Day 3–4）

-  **段階写像**：`CCS ≥ 0.70 → 100ms`、`0.40 ≤ CCS < 0.70 → 500ms`、`<0.40 → 2000ms`。**ヒステリシス±0.05**、**最小滞在2s**、**切替レート上限1Hz**。
    
-  **FALLBACK**：HAR欠落/異常時は**1000ms**・3chへ即時復帰（DecisionLogに理由）。
    
-  **状態機械**：`QUIET(2000) ↔ UNCERTAIN(500) ↔ ACTIVE(100)`＋`FALLBACK(1000)`、昇降別閾値・レート/滞在ガードを実装。
    

**DoD**：全遷移枝がテストでき、DecisionLogに根拠が残る（理由・CCS・ガード充足）。

---

## 6) 実装③ BLE Advertiser（Day 4）

-  **interval集合** `{100, 500, 1000, 2000}ms` をサポート（運用は {100, 500, 2000}ms）。**ch_mask=111固定**、Tx dBmは地域上限内固定。
    
-  `apply_interval()` は**BLE送信直後に判定**→**次イベントから**新設定をアトミック適用。失敗時は再適用、3回連続失敗で**SAFE=500ms**。
    

**DoD**：切替イベントのタイミングずれがない（過渡二重設定なし）、成否がDecisionLogに出る。

---

## 7) 実装④ Telemetry & KPI（Day 4–5）

-  **Tx/Rx/Power/Decision** ロガーを非同期化、**フラッシュ≤500 ms**、溢れ時は通常ログを間引き（Decisionは間引き禁止）。
    
-  **KPIビルド**：イベント電荷（μC）、平均電流、PDR、TLのp50/p95、**Pout(τ=1/2/3s)** を自動集計CSVに出力。
    

**DoD**：ダミーセッションでKPI CSVが生成・可視化（箱ひげ/CDF/棒グラフ）。

---

## 8) 予備計測：成分分離（Day 5）

-  **広告のみ／推論のみ／アイドル**の各条件を1回ずつ測定し背景値取得（将来の報酬分離に使用）。
    
-  **1ch/2ch** のイベント電荷も参考取得（制御には使わない）（将来のチャネル最適化の基準に）。
    

---

## 9) 本番計測①：固定ベースライン（Day 6–8）

-  条件：`100/500/1000/2000 ms`（各15分）、**各環境×3反復**。座位5分→歩行5分→座位5分、セッション順はランダム化。
    
-  各セッションで**LED同期**、受信・電力・Decision（固定は遷移なし）を収録。
    

**DoD**：4条件×2環境×3反復＝**24セッション**（端末2機種なら×2）。ログ欠損<1%。

---

## 10) 本番計測②：不確実度駆動（Day 8–10）

-  **HAR較正**（T有/無）それぞれで**不確実度駆動**を実施（各15分）、**各環境×3反復**。
    
-  **ヒステリシス/最小滞在/レート制限**が効いていることをDecisionLogで観測。
    

**DoD**：計 **6セッション/環境** を完了（T有/無×3反復）。合計本数＝（ベースライン24＋不確実度6×2環境）＝**36セッション**（端末2機種なら72）。

---

## 11) 解析・受入判定（Day 10–11）

-  KPI集計：`avg_current, event_charge(mean/std), PDR, TL_p50/p95, Pout_1s/_2s/_3s` を**条件×環境×反復**で出力。
    
-  **受入基準**判定：
    
    - 省電力：不確実度駆動が**≥5–10%改善**（平均電流）。
        
    - QoS：Pout(1s) の悪化 ≤ **+1.0%pt**、p95(TL) の悪化 ≤ **+10%**。
        
-  **再現性**：主要KPIの**±5%**内に収まることを確認。
    

---

## 12) QA・データ完全性チェック（自動）（Day 11）

-  欠損率<1%、時刻の単調性、U/S/CCS∈[0,1]、interval集合外の検出、イベント電荷の±3σ外れ警告。
    
-  受信ユニーク数が期待比<基準で**警告**→E1/E2別の再試行ルールに従う。
    

---

## 13) チューニング枠（必要時1回）（Day 12）

-  もし受入未達なら、**閾値±0.05** or **ヒステリシス強化** or **QUIET下限2000→1000ms**の**いずれか1つ**だけ調整→条件代表で再計測。
    

---

## 14) レポート/成果物のパッケージング（Day 13）

-  **要件適合レポート**（KPI合否、図表、考察）
    
-  **ログ一式**（Tx/Rx/Power/集計CSV）と**可視化**（箱ひげ/CDF/棒グラフ）
    
-  **決め打ち写像表CSV**（ヒステリシス境界含む）
    
-  **イベント電荷リファレンス**（3ch基準＋参考1/2ch）
    
-  **Runbook**（配線・同期・QA・リカバリ）を添付。
    

---

## 15) リスクと即応（常時）

- **切替振動**：ヒステリシス/最小滞在/レート制限で抑制（DecisionLogで監査）。
    
- **HAR誤判定**：温度スケーリングT、Sの窓W拡大で頑健化。
    
- **受信端末の不安定**：LOW_LATENCY固定、再起動手順、バックアップ端末。
    
- **計測ノイズ**：GPIO境界×高サンプル×校正ログの三点セットで吸収。
    

---

## 16) Phase‑2/3 に向けたバックログ（並行で設計だけ進める）

-  **Policy差し替え I/F を固定**（`decide_interval()` の入出力はそのまま）：MAB/Safe‑MAB化に備え `arm_id/reward/context{U,S,env}` を**列追加**だけで拡張。
    
-  **MABの腕設計**：`arm=(interval, ch_mask)`、報酬=**低電力（μC↓）−制約違反ペナルティ（Pout(τ)超過）**。BLE広告では**チャネル数/間隔**の両面最適化が効く（実機でも~35–40%節電実証）。
    
-  **rxチャネル同定**（スマホ側のスキャン窓から**37/38/39**を当てる）：距離推定/受信安定化や**チャネル別ASR**推定に有効、MABの状態量に追加。
    
-  **遅延制約モデリング**：**Pout(τ)** の下界とエッセンシャル条件（スキャンDuty・窓長）で設計領域を制約（τ=1/2/3s用途）。
    
-  **Edge HARの省電化知見の棚卸し**（モデル圧縮/量子化/オンデバイス推論の枠組み）—将来、HAR側のμCも最小化。
    
-  **AHAR系の適応CNN**（早期Exit/出力ブロック選択）をHARに応用する検討（Edge実装と相性良し）。
    

---

## 17) 参考：モジュール分割と契約の要点（実装時の落とし穴防止）

- **C1**：`HarOut` は 0.5 s 周期、`U/S/CCS∈[0,1]`、欠落時は `HAR_Health=false` をセット。
    
- **C2**：**ヒステリシス/最小滞在/レート制限**がなければ振動→省電力悪化に直結（必須）。
    
- **C3**：適用は**次イベントから**。同一イベント内の再設定は不可。失敗3回でSAFE=500ms。
    
- **C4**：Decisionは**破棄禁止**。Powerは**イベント境界**で積分。KPIは**自動CSV**。
    
- **C5**：100 kS/s未満や境界なしは**μCの再現性劣化**に直結—受入れ不可。
    

---

## 18) 実行カレンダー（目安）

- **Day 0–2**：セットアップ（計測/受信/スキーマ）
    
- **Day 3–5**：実装（C1–C5）＋ダミー検証
    
- **Day 5**：成分分離
    
- **Day 6–10**：本番計測（固定→不確実度）
    
- **Day 10–12**：解析・QA・（必要なら1回だけ）調整
    
- **Day 13**：納品物作成
    

---

### 補足

- 仕様・KPI・運用は、すべて**既存の要件/詳細要件/設計/詳細設計**にトレースできるようにしてあります（本文中の根拠参照）。不明点が出たら該当ログ項目・KPI定義・ガード条件のどれかに立ち戻れば収束します。
    

---

**参考文献（設計の背景となる知見）**

- TinyMLの省電力実装/ワークフロー概観。
    
- Edge HARの適応CNN（早期Exit）発想。
    
- BLE広告のMAB最適化（**チャネル×間隔**で最大 ~35–40%省電力が現実的）。
    
- スマホでの**受信チャネル同定**（距離推定/ASR補正）。
    
- **遅延制約**つき広告受信の**Pout(τ)** モデル（設計の安全側パラメータに）。
    

このTODOに沿って進めれば、**Phase‑1の合否判定まで**を一気通貫で回せます。次の一歩として、Issueボードを切って「2)〜4)」のセットアップ/実装タスクから着手しましょう。