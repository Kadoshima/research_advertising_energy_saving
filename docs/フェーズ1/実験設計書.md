# Phase 1 実験設計書: 決め打ちルールの評価

## 1. 実験の目的

1. **CCS制御の省エネ効果**を固定間隔と比較して定量化
2. **Pout(τ)モデルの妥当性**を実測で検証
3. **Pout-μCトレードオフ曲線**を描く

---

## 2. 実験条件

### 2.1 環境条件

| 項目 | 値 | 備考 |
|------|-----|------|
| 環境 | E1（干渉弱）, E2（干渉強） | 2環境で評価 |
| 距離 | 1m | フェーズ0-0と同条件 |
| Tx Power | 0 dBm | 固定 |
| スキャンモード | Android LOW_LATENCY | 固定 |

### 2.2 制御条件（3条件）

| 条件ID | 条件名 | T_adv | 説明 |
|--------|--------|-------|------|
| C1 | FIXED-100 | 100ms固定 | 高エネルギー・低遅延ベースライン |
| C2 | FIXED-2000 | 2000ms固定 | 低エネルギー・高遅延ベースライン |
| C3 | CCS | 100/500/2000ms可変 | 提案手法 |

### 2.3 反復設計

```
3条件 × 2環境 × 10セッション = 60セッション
```

- 各条件・環境の組み合わせで10回反復
- 総実験時間: 60 × 10分 = 10時間

---

## 3. セッション構成

### 3.1 1セッションの流れ（10分）

| 時間 | 活動 | 期待CCS | 期待T_adv（CCS条件） |
|------|------|---------|---------------------|
| 0-5分 | 座位（Stationary） | 高（≥0.70） | 2000ms |
| 5-10分 | 歩行（Locomotion） | 中〜低 | 500ms or 100ms |

*実データは mHealth 由来の10分ウィンドウを再生するため、遷移回数・区間長は manifest 記載の値に従う（例: transitions=13/32/66）。ファームウェアのフェイルセーフ/自動実行では 1000ms 出力も混在しうるため、解析側は {100, 500, 1000, 2000}ms を許容。基本写像は 100/500/2000ms で設計。*

### 3.2 活動遷移イベント

1セッションで**複数回の活動遷移**が発生する（manifestの transitions カウントを正とする）。
- 例: transitions = 13 / 32 / 66（10分セッション選定結果）

**評価対象**: 各遷移時点での Pout(τ) と TL。分母は manifest 記載の遷移数（N_event）を用いる。

### 3.3 データソース

- **mHealth CCS時系列**を事前計算し、ESP32で再生
- 実際の人間の動きではなく、**CCS時系列のリプレイ**で再現性を確保

---

## 4. 計測項目

### 4.1 計測機器

| 項目 | 機器 | 計測対象 |
|------|------|---------|
| 電力 | INA219 + TXSD (I²Cロガー) | ESP32のVBAT電流 |
| 送信ログ | ESP32 SD | timestamp, T_adv, CCS, U, S |
| 受信ログ | Android | timestamp, RSSI, seq |
| 同期マーカー | LED/GPIO | セッション開始・終了 |

### 4.2 ログスキーマ

**Txログ（ESP32）**:
```
timestamp_ms, session_id, seq, T_adv, CCS, U, S, activity_label
```

**Rxログ（Android）**:
```
timestamp_ms, session_id, seq, rssi, rx_channel
```

**Powerログ（INA219 + TXSD (I²Cロガー)）**:
```
timestamp_ms, current_uA, voltage_mV
```

---

## 5. データ処理

### 5.1 μC/event算出

```
μC_event = (E_on - P_baseline × T_on) / N_event
```

| 変数 | 定義 | 取得方法 |
|------|------|---------|
| E_on | セッション総エネルギー [μJ] | INA219 + TXSD (I²Cロガー)積分 |
| P_baseline | ベースライン電力 [mW] | 再計測値（INA構成；旧22.1mWは参考） |
| T_on | セッション時間 [s] | 600s |
| N_event | 活動遷移イベント数 | manifest記載の遷移数（例: 13/32/66） |

### 5.2 Pout(τ)算出

```
TL_j = t_rx_first(j) - t_event_start(j)
Pout(τ) = count(TL_j > τ) / N_event
```

| 変数 | 定義 |
|------|------|
| t_event_start(j) | 活動遷移jの開始時刻（CCS変化点） |
| t_rx_first(j) | 遷移j後の最初の受信時刻 |
| TL_j | 遷移jのTime-to-first-Receive |
| τ | 許容遅延（1s, 2s, 3sで評価） |

### 5.3 理論値との比較

**Pout(τ)の理論モデル**:
```
Pout_theory(τ | T_adv) = (1 - p_d)^⌊τ / T_adv⌋
```

- p_d = 0.85（フェーズ0-0実測）
- 理論値と実測値のトレンド一致を検証

---

## 6. 評価指標

### 6.1 一次指標

| 指標 | 計算式 | 比較方法 |
|------|--------|---------|
| μC/event | mean(μC_event) per session | 3条件で比較、95%CI付き |
| Pout(τ) | 上記、τ=1,2,3s | 3条件で比較 |
| TL_p50, TL_p95 | percentile(TL_j) | 分布比較 |

### 6.2 二次指標

| 指標 | 計算式 | 目的 |
|------|--------|------|
| 省エネ率 | 1 - μC_CCS / μC_FIXED100 | 提案手法の効果 |
| Pout改善率 | 1 - Pout_CCS / Pout_FIXED2000 | QoS改善効果 |
| PDR | N_rx / N_tx | 参考値 |

### 6.3 トレードオフ曲線

- **X軸**: μC/event
- **Y軸**: Pout(τ=2s)
- **プロット**: 3条件（FIXED-100, FIXED-2000, CCS）
- **重ね書き**: 理論曲線

---

## 7. 成功基準

### 7.1 最低ライン（レター成立）

| 基準 | 条件 |
|------|------|
| 省エネ効果 | μC_CCS < μC_FIXED100 (p < 0.05) |
| QoS維持 | Pout_CCS(2s) ≤ Pout_FIXED100(2s) + 0.01 |
| モデル妥当性 | 理論と実測のトレンド一致（相関係数 ≥ 0.8） |

### 7.2 理想ライン（強いレター）

| 基準 | 条件 |
|------|------|
| 省エネ率 | ≥ 30% |
| Uの有用性 | CCS制御 vs 活動種別のみ制御 のアブレーション |
| オフラインSim | Safe-UCBシミュレーション1図 |

---

## 8. 実験手順

### 8.1 準備

1. mHealth CCS時系列を生成（3条件分）
2. ESP32ファームウェアにCCS→T_adv写像を実装
3. Android受信アプリを準備
4. INA219 + TXSD (I²Cロガー)の計測環境を構築

### 8.2 セッション実行

```
1. 機器接続・同期確認
2. セッション開始（LED点灯）
3. CCS時系列再生開始
4. 10分待機
5. セッション終了（LED消灯）
6. データ保存・バックアップ
```

### 8.3 データ集約

```
1. Tx/Rx/Powerログを時刻同期
2. 活動遷移イベントを抽出
3. TL, μC, Poutを算出
4. 条件・環境ごとに集計
```

---

## 9. 実験スケジュール（案）

| Week | タスク | 成果物 |
|------|--------|--------|
| 1 | mHealth CCS時系列生成、ESP32ファームウェア準備 | CCS再生スクリプト、ファームウェア |
| 2 | E1環境で30セッション実施 | 生データ（E1） |
| 3 | E2環境で30セッション実施 + データ処理 | 生データ（E2）、集計結果 |
| 4 | 分析・図表作成・執筆 | レター原稿 |

---

## 10. リスクと対策

| リスク | 兆候 | 対策 |
|--------|------|------|
| 同期ずれ | TLが負値 | NTPまたはGPIO同期マーカー |
| BLE干渉 | PDR急落 | E2条件として記録、解析時に考慮 |
| データ欠損 | ログ途切れ | セッション後に即時確認、再実施 |
| 機器故障 | 計測異常 | 予備機器準備 |

---

## 11. 成果物

| 成果物 | 形式 | 用途 |
|--------|------|------|
| 生データ | CSV | 再現用アーカイブ |
| 集計結果 | JSON/CSV | 分析・図表生成 |
| トレードオフ曲線 | PNG/PDF | レター掲載 |
| 統計検定結果 | テキスト | レター記載 |

---

## 12. Phase 2への接続

Phase 1実験データは、Phase 2で以下のように活用:

| Phase 1成果物 | Phase 2での利用 |
|---------------|----------------|
| μC実測値（条件別） | 報酬正規化辞書 |
| Pout(τ)実測値 | 制約関数の較正 |
| CCS時系列 | オフラインシミュレーション入力 |
| p_d推定値 | Poutモデルパラメータ |

---

*Last updated: 2025-11-27*
