# Phase 1 要件定義: 決め打ちルールの実装と評価指標の確立

## 1. 概要

### 1.1 位置づけ

Phase 1はPhase 2（Safe Contextual Bandit）の**前段階**として以下を確立する:

- Safe-MABの「warm-start用ベースライン」を作る
- 評価指標（Pout(τ), μC）の測定系を確立する
- 単純なルールでも「効果がある」ことを示し、将来の学習ベース手法の土台を作る

### 1.2 主張

> 「HAR不確実度に基づくBLE広告間隔の適応制御において、単純な閾値ルールでも固定間隔と比較して省電力効果が得られることを示した。提案手法は、将来のSafe Contextual Banditによるオンライン最適化の基盤となる。」

---

## 2. スコープ

### 2.1 IN（Phase 1でやること）

| 項目 | 内容 |
|------|------|
| 問題定式化 | Pout(τ)制約下でのエネルギー最小化問題（Safe Bandit形式） |
| 決め打ち方策 | CCS→T_adv の閾値写像（Safe Banditのwarm-start用） |
| 評価指標 | Pout(τ), μC/event の測定系確立 |
| 実験評価 | 固定100ms / 固定2000ms / CCS制御 の比較 |
| モデル検証 | Pout(τ)の理論値と実測の比較 |
| Future Work | Safe Contextual Banditへの拡張を記載 |

### 2.2 OUT（Phase 1でやらないこと）

| 項目 | 理由 |
|------|------|
| Safe-UCBの実装 | Phase 2で実施 |
| オンライン学習 | Phase 2で実施 |
| HAR誤認識の統合（RoME） | スコープ外、BLE側に集中 |
| 複数データセット評価 | 概念実証として十分 |
| Tx電力・PHY最適化 | スコープ外 |

---

## 3. 問題定式化（Phase 2への橋渡し）

### 3.1 最適化問題

```
minimize   E[μC(a)]           # エネルギー最小化
subject to Pout(τ | a) ≤ δ    # QoS制約
where      a = π(U, S)        # 方策：コンテキストから行動を選択
```

### 3.2 構成要素

| 要素 | 記号 | 定義 | Phase 1での値 |
|------|------|------|--------------|
| **コンテキスト** | (U, S) | HAR不確実度、安定度 | [0,1] × [0,1] |
| **行動** | a ∈ A | 広告間隔 T_adv | {100, 500, 1000, 2000} ms |
| **報酬** | r(a) | -μC(a) | 負のエネルギー |
| **制約** | g(a) | Pout(τ \| a) | トレードオフ曲線で評価 |
| **方策** | π(U, S) | コンテキスト→行動 | 閾値ルール（固定） |

---

## 4. コンテキスト定義

### 4.1 不確実度 U

```
U = -Σ p_k log(p_k) / log(K)  ∈ [0, 1]
```

- p_k: クラスkの事後確率
- K: クラス数（4-class: sitting, standing, walking, lying）
- U=0: 確信度100%、U=1: 完全に不確実

### 4.2 安定度 S

```
S = 1 - min(1, n_trans / W)  ∈ [0, 1]
```

- n_trans: 過去W窓での予測ラベル遷移回数
- W: 窓数（5窓 = 2.5秒 @ 0.5秒/窓）
- S=1: 安定、S=0: 頻繁に遷移

### 4.3 複合スコア CCS

```
CCS = 0.7 × (1 - U) + 0.3 × S  ∈ [0, 1]
     = 0.7 × confidence + 0.3 × stability
```

**根拠**（docs/全体像.md 参照）:
1. CCS = Composite Confidence Score。高い値が「確信がある」という解釈と一致
2. CCS高い → 確信あり → 長い間隔OK → 省電力。単調な写像で直感的
3. confidence（瞬時の推論品質）を主成分、stability（時間的一貫性）を補助

---

## 5. 決め打ち方策

### 5.1 CCS→T_adv写像

```
T_adv(CCS) =
    2000ms  if CCS ≥ θ_high (0.90)    # 確信高い→省電力優先
    500ms   if θ_low ≤ CCS < θ_high   # 中間
    100ms   if CCS < θ_low (0.80)     # 確信低い→QoS優先
```

**閾値の根拠**: mHealthのCCS分布が高め(0.84–0.93)のため、間隔多様性を確保する目的で θ_high=0.90 / θ_low=0.80 に調整済み。旧初期案 (0.70/0.40) は歴史的参照。

### 5.2 ヒステリシス

- 上り閾値: θ_high=0.90, θ_low=0.80
- 下り閾値: θ_high-0.05=0.85, θ_low-0.05=0.75
- 最小滞在時間: 2秒

**目的**: 切替振動の抑制

---

## 6. 評価指標（KPI）

### 6.1 一次KPI

| KPI | 定義 | 測定方法 | 成功基準 |
|-----|------|---------|---------|
| **Pout(τ)** | P(TL > τ) | Android受信ログからTL算出 | 固定100msと同等以下 |
| **μC_adv** | 1広告あたり電荷 ΔE/adv | INA219/TXSD実測 | 固定100ms比で削減 |
| **TL_p95** | 遅延の95パーセンタイル | Android受信ログ | 参考値 |

### 6.2 二次KPI

| KPI | 定義 | 算出方法 |
|-----|------|---------|
| **省エネ率** | 1 - μC_CCS / μC_100ms | 計算 |
| **PDR** | 受信成功率 | 参考値 |
| **平均電流** | 平均消費電流 [mA] | INA219/TXSD |

### 6.3 Pout(τ)の理論モデル

```
Pout(τ | T_adv) ≈ (1 - p_d)^⌊τ / T_adv⌋
```

- p_d: 1広告の受信成功確率（≈0.85、フェーズ0-0実測）
- τ: 許容遅延（評価では τ = 1, 2, 3秒）

**Phase 1での検証**: 理論値と実測のトレンド一致を確認

---

## 7. 実験計画

### 7.1 条件

| 条件 | T_adv | 説明 |
|------|-------|------|
| Baseline-Short | 100ms固定 | QoS最良、エネルギー最大 |
| Baseline-Long | 2000ms固定 | エネルギー最小、QoS最悪 |
| CCS-Control | CCS写像 | 提案手法 |

*備考: ファームウェアのフェイルセーフ/自動実行では 1000ms が出力される場合があるため、解析は {100, 500, 1000, 2000}ms を許容する。必要に応じて 500ms 固定の基準計測も追加する。*

### 7.2 環境

- E1: 低干渉環境
- E2: 高Wi-Fi干渉環境（オプション）

### 7.3 繰り返し

- 各条件 × 各環境 で ≥3回

---

## 8. 成功基準

### 8.1 最低ライン（レターとして成立）

1. CCS制御が固定100msより省エネ（μC削減）
2. CCS制御が固定2000msよりPout(τ)改善
3. Pout(τ)の理論モデルと実測がトレンド一致

### 8.2 理想ライン（強いレター）

1. 上記 + Uの有用性を示すアブレーション（CCS制御 vs 活動種別のみ制御）
2. 上記 + Safe-UCBのオフラインシミュレーション1図

---

## 9. 成果物

| 成果物 | 説明 |
|--------|------|
| 評価指標の確立 | Pout(τ), μC/event の測定パイプライン |
| warm-start用ベースライン | CCS→T_adv写像テーブル |
| KPIパイプライン | ログ→KPI算出スクリプト |
| レター論文 | 問題定式化、実験結果、Future Work |

---

## 10. Phase 2への接続

Phase 1の成果物は、Phase 2（Safe Contextual Bandit）で以下のように活用:

| Phase 1成果物 | Phase 2での利用 |
|---------------|----------------|
| CCS→T_adv写像 | Warm-Start初期方策 |
| μC実測値 | 報酬正規化の辞書 |
| Pout(τ)実測値 | 制約関数の較正 |
| ログスキーマ | arm, reward, context列を追加して拡張 |

---

*Last updated: 2025-11-27*
