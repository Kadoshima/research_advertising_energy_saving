以下は、**フェーズ1（弱い構成）要件定義書**です。コードは一切含まず、**目的／範囲／用語／機能・非機能要件／KPI・受入基準／実験プロトコル／計測・ログ仕様／成果物／リスク／次フェーズ接続**までを“そのまま運用できる粒度”でまとめています。

---

# フェーズ1 要件定義書（弱い構成）

**文書ID**: ReFormHAR‑Tiny/REQ‑PH1‑v1.0
**作成日**: 2025-11-08
**対象**: BLEアドバタイジングの**固定基準**および**不確実度駆動（決め打ち写像）**による省電力評価

---

## 1. 目的（Purpose）

1. **最低限の省電力効果**を、**再現可能なKPI**（イベント電荷μC、平均電流mA、Pout(τ)、遅延TL分布、PDR）で定量化する。
2. **HAR不確実度**（U）と**安定度**（S）に基づく**決め打ち写像**（CCS→adv間隔）を定義し、**ベースライン（固定間隔）**と比較する。
3. フェーズ2（中位構成：MAB導入）以降へ**そのまま移植**できるデータ構造・ログ・計測系・写像表を確立する。

---

## 2. スコープ（Scope）と境界

* **対象機能**

  * BLE **Legacy** Advertising（非接続・非指向、3チャネル 37/38/39）
  * **アドバタイズ間隔（adv_interval）**の制御（**100/500/1000/2000 ms**）
  * **チャネル集合は3ch固定**（111）。※イベント電荷の基礎測定のみ1ch/2chも取得（制御には使わない）
  * HAR推論（端末内）から得る**不確実度U**、**安定度S**、**複合スコアCCS**の算出と**段階写像**
* **除外**

* MAB/バンディット学習、Safe/Constrained Bandit、Androidスキャン非理想性の方策注入、Tx電力/PHY/アドバタイズ長の最適化
  * 個人最適化のオンライン学習（モデルパラメタ更新）
* **適用環境**

  * 屋内（干渉弱／Wi‑Fi干渉強）2条件
  * 受信側は**Android 1–2機種**（**LOW_LATENCY**スキャン推奨）
  * 端末（DUT）1機種（BLE5 SoC搭載デバイス）

---

## 3. 用語・指標定義

* **U（不確実度）**：出力確率 (p_k) のエントロピー正規化 (U = -\sum_k p_k\log p_k / \log K \in [0,1])。
* **S（安定度）**：直近 (W) 秒の状態遷移回数に基づく安定度。例：( S = 1 - \min(1,, n_{\text{trans}}/\tau) \in [0,1])。
* **confidence（確信度）**：`confidence = 1 − U`。
* **CCS（複合スコア）［統一］**： ( \mathrm{CCS} = 0.7\,\mathrm{confidence} + 0.3\,\mathrm{stability} \in [0,1] )。

> しきい値の再較正：定義変更に伴い、従来の {0.40, 0.70} をそのまま使用せず、P1（validation）で ROC/PR に基づき新しきい値 {θ_low, θ_high} を決定し、Runbook に置換表として記録する。
* **TL（初回到達遅延）**：イベント検知→最初のアドバタイズ受信までの遅延。
* **Pout(τ)**：期限 τ（例1/2/3秒）以内に**初回受信できない**確率。
* **イベント電荷（μC/event）**：1 度のアドバタイズイベント（3チャネル送出）の電流積分値。
* **PDR/ASR**：受信成功率（重複除去後のユニーク・アドバタイズ単位）。

---

## 4. 機能要件（Functional Requirements, FR）

**FR‑1 ベースライン制御**

* 固定 adv_interval ∈ {100, 500, 1000, 2000} ms、**ch_mask=111**、Tx電力=既定（例 0 dBm）。
* それぞれ独立セッションで計測（同一環境条件で≥3反復）。

**FR‑2 不確実度駆動（決め打ち写像）**

* CCSに応じて adv_interval を**段階切替**。既定（変更可・ログ化必須）。
  注：以下の閾値は初期値。P1で再較正し、{θ_low, θ_high} に置換して運用する。

  * **ACTIVE（高緊急）**：CCS ≥ 0.70 → **100 ms**
  * **UNCERTAIN（中）**：0.40 ≤ CCS < 0.70 → **500 ms**
  * **QUIET（低緊急）**：CCS < 0.40 → **2000 ms**
* 切替ヒステリシス（抑振動）を**±0.05**付与（昇降で閾値差を設ける）。
* 状態推定は**窓長 1.0 s / 50% オーバーラップ**。(W=10) sでSを更新。

**FR‑3 HAR較正（任意・推奨）**

* 温度スケーリング等でUのキャリブレーションを1回実施し、**較正係数T**をログ（数値のみ保存）。
* 較正有/無の両条件でFR‑2を評価。

**FR‑4 計測・ログ**

* 送信側：adv_interval、ch_mask、state（ACTIVE/UNCERTAIN/QUIET）、U、S、CCS、タイムスタンプ。
* 受信側：受信時刻（ゲートウェイ時刻）、RSSI、重複除去後ユニークID、スキャンモード。
* 電力：**イベント波形**を記録し、**イベント電荷（μC）**を算出。平均電流、mWh/日も保存。
* **同期**：セッション先頭でLED点滅（3秒）等の**同期マーカー**を両ログに記録。

**FR‑5 KPI算出**

* **TL分布**（p50/p95）、**Pout(τ)**（τ=1/2/3 s）、**PDR/ASR**、**イベント電荷**、**平均電流**。
* 条件 × 環境 × 反復ごとに自動出力（CSV/図）。

---

## 5. 非機能要件（NFR）

**NFR‑1 再現性**：同条件で**±5%以内**の再現性（平均電流、イベント電荷、Pout(τ)）。
**NFR‑2 観測可能性**：すべての状態遷移・閾値・間隔変更に**根拠ログ（U,S,CCS,境界超過）**を付与。
**NFR‑3 可搬性**：ログスキーマはPhase2/3でも**列追加のみ**で互換。
**NFR‑4 安全・規格**：BLE規格と地域規制の**送信電力/ Duty**を順守。
**NFR‑5 プライバシ**：生IMUは端末内完結。送信はラベル/メタのみ。

---

## 6. KPIと受入基準（Acceptance Criteria）

**KPI‑1 省電力**

* 固定100 ms（ベースライン）に対し、不確実度駆動（FR‑2）が**平均電流で ≥ 5–10% 改善**（両環境で達成）。

**KPI‑2 品質維持（遅延・到達）**

* **Pout(1 s)** の悪化が**ベースライン比 +1.0%pt 以内**。
* **p95(TL)** が**ベースライン比 +10% 以内**（もしくは同等以下）。

**KPI‑3 計測整合**

* イベント電荷（3ch）・平均電流の**再現性 ±5%以内**。
* ログ欠損・同期ずれ**< 1%**。

**合否**：KPI‑1〜3を**全て**満たすこと。未達の場合はチューニング（閾値、ヒステリシス、窓長）を**1回**まで許容し再試行。

---

## 7. 実験設計（被験・環境・反復）

* **環境**：

  * **E1: 干渉弱**（Wi‑Fi最小）
  * **E2: 干渉強**（2.4GHz Wi‑Fi稼働、1/6/11を高占有）
* **受信端末**：Android **LOW_LATENCY**固定（端末1–2機種）。
* **セッション**：各条件（固定4種類＋不確実度1種類=計5）× **各環境で3反復**。
* **アクティビティ**（例）：座位5分→歩行5分→座位5分（合計15分/セッション）。
* **総本数**：5条件 × 2環境 × 3反復 = **30セッション**（端末2機種なら60）。

**補助評価（追加・任意）**

* **P0 校正（推奨）**：Arena使用量、`t_inf`（1000反復、S3@240 MHz目安）、ベース電流を取得し、運用前に健全性を確認。
* **早期出口のA/B（任意）**：Exit‑0条件（例：`max_softmax≥0.90` かつ 温度スケーリング後≥0.85）をON/OFFで比較し、平均`t_inf`短縮とKPI（Pout(1 s), TL p95）の維持を確認（劣化は受入基準内）。

---

## 8. 計測仕様（電力・受信・同期）

**電力**

* **装置**：PPK‑II / Joulescope / Otii（いずれか）。
* **接続**：VBAT直列、**サンプリング ≥ 100 kS/s**。
* **ブレークダウン**：

  * **アドバタイズのみ**／**推論のみ**／**アイドル**の分離測定を**各1回**実施し背景値を得る。
  * **イベント電荷**：アドバタイズイベント毎（3チャネル一括）の電流積分（μC）。
* **校正**：ゼロ補正・ゲイン補正をセッション前後に実施し**温度・ドリフト**を記録。

**受信**

* **重複除去**：アドバタイズPDUのアドレス＋タイム窓で除重。
* **PDR**：秒あたりユニーク・アドバタイズ数の比率。
* **TL/Pout**：アクティビティ変化（端末側ラベル）起点→最初の受信まで。**τ=1/2/3 s**でPout算出。

**同期**

* **開始マーカー**：端末LED点滅（3秒）、ゲートウェイ側スクリーン録画/ログ印。
* **時刻**：ゲートウェイNTP同期、端末RTCは相対時間で補正。

---

## 9. ログ仕様（スキーマ）

* **送信ログ（DUT）**

  ```
  t_local, session_id, device_id,
  adv_interval_ms, ch_mask, tx_dbm,
  state{ACTIVE|UNCERTAIN|QUIET}, U, S, CCS,
  model_id, calib_T(optional), window_len, overlap, W_sec,
  note
  ```
* **受信ログ（Gateway）**

  ```
  t_gateway, session_id, gateway_id, phone_model, scan_mode,
  adv_addr, rx_uuid, rssi, dedup_flag
  ```
* **計測ログ（Power）**

  ```
  t_probe, session_id, current_mA, voltage_V, event_marker
  ```
* **導出KPI（集計CSV）**

  ```
  session_id, condition(baseline_100|...|uncertainty),
  env(E1|E2), run_id,
  avg_current_mA, energy_mWh_per_day,
  event_charge_uC_mean, event_charge_uC_std,
  PDR, TL_p50_ms, TL_p95_ms,
  Pout_1s, Pout_2s, Pout_3s
  ```

---

## 10. 解析・可視化（最低限）

* **箱ひげ**：avg_current、event_charge（条件×環境）
* **CDF**：TLのCDF（条件別）
* **曲線**：Pout(τ) vs τ（条件別、E1/E2）
* **棒グラフ**：PDR、Pout(1s)の比較
* **テーブル**：KPIまとめ（ベースライン100msとの比較差［%/pt］）

---

## 11. 成果物（Deliverables）

1. **要件適合レポート**（本ドキュメント準拠でKPI合否を記載）
2. **ログ一式**（送信・受信・電力・導出KPI）と**図表（PNG/PDF）**
3. **決め打ち写像表（CCS→adv_interval）**（数値版・ヒステリシス込み）
4. **イベント電荷リファレンス**（3ch基準、参考として1ch/2chの値も掲載）
5. **再現手順書**（環境構築・配線・同期・解析のRunbook、バージョン付き）

---

## 12. リスクと緩和

* **R‑1 IMU/HARノイズで状態遷移が過多** → **ヒステリシス**強化、窓長・Wの調整、Uの温度スケーリング適用。
* **R‑2 Poutが悪化** → QUIETの下限を**2000→1000 ms**へ暫定短縮（再試行は1回まで）。
* **R‑3 電力計測の再現性不足** → 校正頻度増、温度ログ記録、イベント境界のデジタルマーカー導入。
* **R‑4 受信端末の不安定** → **LOW_LATENCY固定**、バックアップ端末準備。
* **R‑5 ログ欠損** → ストレージ監視、セッション前の容量チェック、ローテーション設定。

---

## 13. 移行（Phase‑2/3 への接続要件）

* **写像表**は**初期方策（warm‑start）**としてMABに投入可能な**CSV形式**で出力。
* **イベント電荷辞書**（条件→μC）はMABの**報酬正規化**に流用。
* **ログスキーマ**は**arm/reward/context**列を**列追加**するだけで拡張可能。
* **KPI算出スクリプト**は**Pout(τ)制約判定**の呼び出し口を空けておく（関数インタフェース定義のみ）。

---

## 14. 役割と責任（RACI）

* **実験設計・運用**（R/A）：あなた
* **電力計測治具の校正**（R）：ハード担当
* **受信ログと重複除去**（R）：ゲートウェイ担当
* **KPI集計＆レポート**（R）：解析担当
* **最終承認**（A）：プロジェクト責任者
* **支援/相談**（C/I）：全員

---

## 15. 変更管理

* **小変更**（閾値±0.05、ヒステリシス調整）：再実験**不要**、ログに差分記録
* **中変更**（窓長、W）：主要条件**1セット再計測**
* **大変更**（intervalセット変更、ch_mask変更）：要審査・承認

---

### 付記：既定パラメータ（初期値）

* 窓長=**1.0 s**、オーバーラップ=**50%**、W=**10 s**
* CCS閾値=**0.40/0.70**、ヒステリシス=**±0.05**
  - 注：上記は初期値。P1で{θ_low, θ_high}に再較正し置換する。
* adv_interval（ms）=**100/500/2000**、基準比較に**100/500/1000/2000**
* ch_mask=**111**（3ch固定）
* スキャンモード=**LOW_LATENCY**
* Pout評価 τ=**1/2/3 s**

---

### 付記：HW/Runtime 制約（Phase‑1 実装）

* **SoC**：ESP32‑S3/C3、**TFLM int8**固定（S3は`esp‑nn`最適化を推奨）
* **入力**：IMU 50 Hz／窓1.0 s／重畳50%
* **推論制約**：`Arena ≤ 80 KB`（運用開始は64 KB目安）、`Flash ≤ 200 KB`、`FLOPs ≤ 8 M`、`t_inf ≤ 20 ms/窓`
* **評価**：`t_inf`は`esp_timer`等で1000反復計測し、条件とバイナリのハッシュを記録

---

この要件定義に従えば、**弱い構成の成果物がそのまま中位・強い構成の“部品”**（初期方策・イベント電荷辞書・KPIパイプライン）として流用できます。
実装や数式の詳細設計は不要ですが、**ログ・KPI・閾値の“約束”**だけは厳密に守って運用してください。
