# 実験モード計画 (2025-12-02)

## 目的

- HARデバイスの電力・通信・計算コストをモード別に分離し、論文で説得力のある比較軸を揃える。  
- 「理論下限」から「実運用」まで連続した評価軸を用意し、各モードの計測データを一貫フォーマットで収集する。

---

## モード定義

| モード | 位置づけ | MCU状態 | センサ | BLE | 終了条件 | 目的/利用シーン |
|-------|---------|--------|-------|-----|---------|---------------|
| A (理論下限) | 最小電力の下限を示す | Deep Sleep（基本起床なし） | OFF | OFF | 時間終了 (例: 300s) | ハード構成の物理下限を提示 |
| A' (疑似OFF) | 旧OFFの再現 | Deep Sleep→1Hz起床→TICK1発 | OFF | OFF | TICK 300発 | 旧データとの比較用 |
| B (待機ベース) | 実運用の待機 | Light Sleep＋低頻度ポーリング | 低ODR＋内蔵検出ON | OFFまたは超低頻度 | 時間終了 | 「1日の大半」を占める待機電力を把握 |
| C1 (HARのみ) | 計算コスト分離 | Light Sleep＋周期起床 | 既定ODR | OFF | 時間終了 | センサ＋特徴量＋分類のみの電力を取得 |
| C2 (HAR＋固定BLE) | ベースライン | C1＋固定広告 (100/500/1000/2000ms) | 既定ODR | 固定間隔広告 | TICK 300発 | 固定広告実装の基準値（HAR ON/OFF両方計測） |
| C2' (HARラベル再生＋固定BLE) | 精度×遅延ベースライン | C1の計算はPC側/オフライン、TXはラベル再生のみ | 既定ODR | 固定間隔広告 | TICK 300発 | HARラベルの遅延/ミス率を固定intervalで測る |
| C3 (HAR＋可変BLE) | 研究本丸 | C1＋適応広告（状態依存） | 既定ODR | 可変・イベント駆動 | ロジック依存 | 提案手法の評価 |
| D (不確実性ルール) | Phase1決め打ち | C1＋静的閾値写像（例: U>H→100ms, M→500ms, L→2000ms） | 既定ODR | 固定3ステート | TICK 300発 | レターで比較する決め打ちポリシ |

---

## ファームウェア割り当てと計測ルール

- **Mode A / A'**  
  - TX: `esp32_firmware/1201/OFF/TX_OFF_1201.ino` をベースに、Aでは起床なし・時間終了、A'では1Hz TICK×300。  
  - TXSD: `esp32_firmware/1201/OFF/TXSD_OFF_1201.ino`（INA直読、時間終了 or TICK終了）。  
  - RX: 不要。  
  - 収集: `ms_total, mean_v, mean_i, mean_p_mW, E_total_mJ`。Aは理論下限としてグラフ最下段に配置。

- **Mode B**  
  - TX: 新規ライトスリープ待機ファームを準備（センサ低ODR・割り込み待ち、BLE OFF）。  
  - TXSD: OFF系と同じロガーで時間終了。  
  - RX: 不要。  
  - 収集: 待機時の実用的 P_off を取得（後の重み付き平均計算に使用）。

- **Mode C1**  
  - TX: HARアルゴリズムのみ（BLE OFF、センサON、特徴量＋分類）。  
  - TXSD: ON系ロガー（TICK不要／時間終了）。  
  - RX: 不要。  
  - 収集: サンプリング周波数・モデル重さを変えたときの電力スケール。

- **Mode C2**  
  - TX: `esp32_firmware/1201/TX_1201.ino`（interval={100,500,1000,2000}, N_ADV=300, SYNC/TICK出力）。  
  - TXSD: `esp32_firmware/1201/TXSD_1201.ino`（TICK 300で終了、INA直読）。  
  - RX: `esp32_firmware/1201/RX_1201.ino`（seqロガー、SYNC未使用、オフラインでtrial復元）。  
  - 収集: `E_total_mJ, adv_count, ms_total`（TXSD）、`seq, rssi`（RX）から PDR, E/adv, ΔE/adv を算出。現行データ `data/1202配線変更後/1m_on_1202` が該当（HAR OFF）。HAR ON 版を追加取得する場合はラベルを乗せたまま送信して電力差分を見る。

- **Mode C2'（HARラベル再生＋固定間隔）**  
  - TX: HAR計算はPC/オフラインで生成したラベル・不確実性の時系列を再生し、固定intervalで広告（payloadにラベルを載せるだけ）。  
  - TXSD/RX: C2と同じ。  
  - 収集: E/adv, PDRに加え、RXログと真ラベル列を突き合わせた遅延・ミス率。固定intervalにおける精度×遅延ベースラインを得る。

- **Mode C3**  
  - TX: C2を拡張し、状態依存で広告間隔を可変（例: 安定時は長周期、イベント時はバースト）。  
  - TXSD: C2と同じ。  
  - RX: C2と同じ。  
  - 収集: 平均 adv rate, PDR, E_total, E/adv を C2 と比較して省エネ／情報量を評価。

- **Mode D（不確実性ルール）**  
  - TX: C1に静的閾値写像を追加（例: 不確実性 U > H→100ms, M→500ms, L→2000ms）。  
  - TXSD/RX: C2と同じ（TICK 300, seqロガー）。  
  - 収集: 固定100/2000msやC2固定広告との比較（μC/event, PDR/TL/Pout）。Phase1レターで提示する決め打ちポリシの実体。

---

## 計測と解析の流れ（共通）

1. **記録**  
   - TXSD: `ms,mV,µA,p_mW` + summary/diag（TICK 300 もしくは時間終了）。  
   - RX: `ms,event,rssi,seq,addr,mfd`（単一CSV、seq巻き戻りでtrial復元）。
2. **オフライン解析**  
   - スクリプトで `adv_count=300` を前提に interval推定、PDR計算、`E/adv` 算出。  
   - 不完全試行（途中終了）があっても seq 巻き戻りと `ms_total` から部分試行として処理する。
3. **出力指標**  
   - `P_off`（mode別）、`E_total`, `E/adv`, `ΔE/adv = E_on - P_off×T`、PDR、必要に応じて `TL, RSSI` 分布。

---

## データ配置ルール

- 新データ: `data/1202配線変更後/` 以下にモード別サブフォルダ（例: `A_off_deepsleep/`, `B_wait/`, `C2_on/`）。  
- 結果: `results/` に日付入りサマリ（例: `results/modeA_off_2025-12-xx.md`）。  
- 解析スクリプト: `scripts/analyze_1202.py` を拡張し、モードフラグで処理分岐させる。

---

## 今後のToDo（優先度順）

1. Mode A 本当のOFF（起床なし）を取得し、理論下限を確定。  
2. Mode B 待機ベースのライトスリープ＋センサONファームを作成し、P_off(realistic) を取得。  
3. Mode C1 (HARのみ) の電力を取り、計算コストを分離。  
4. Mode C2 固定広告（HAR OFF/ONの最小セット）を追加取得し、固定100/2000msベースラインを明示。  
5. Mode C2'（HARラベル再生）で遅延・ミス率の基準線を取得。  
6. Mode D 静的閾値ポリシ（CCS→T_adv決め打ち）を実装・計測し、固定広告と比較。  
7. Mode C3 適応広告ロジックの実装・計測を着手し、C2/C2'/Dとの比較グラフを準備。  
8. 解析スクリプトをモード対応に拡張し、部分試行も扱えることを確認。  
9. 論文用図: モード別 P_off / E/adv / PDR / HAR遅延・ミス率 を一枚の図に統合し、評価軸の連続性を示す。

---

## フェーズ対応と推奨実施順
- Phase 0-0（計測系健全化・ベースライン）: A → B → C1 → C2(固定広告, HAR OFF)  
- Phase 1（レター: 決め打ちルール評価）: C2(固定, HAR ON/OFF少数) → C2'(HARラベル再生で遅延・ミス率ベースライン) → D (静的閾値) → C3(適応)  
- Phase 2（Safe-MAB 拡張）: C3 をベースに Safe Contextual Bandit を追加評価  

推奨順: A → B → C1 → C2(固定) → C2(HAR ON 100/2000ms) → C2'(HARラベル再生で精度・遅延) → D(静的閾値) → C3(適応)。

---

## Phase 2 (Safe-MAB) 実験構想（ドラフト）
- 目的: μC/event 最小化かつ Pout(τ)≤δ を保証。コンテキスト x=[U,S,CCS,...]。アーム=interval×channel_mask。  
- 安全性: Safety Filter/Action Mask で危険アームをマスク、fallback=短interval×3ch。  
- 実験レイヤー:  
  1) オフラインシミュレータ（トレース駆動で Bandit を評価）  
  2) Hardware-in-the-Loop（MCU上にBandit実装、環境はトレース再生）  
  3) 実機オンライン（Android/iOS実挙動下で学習、制約違反率を監視）  
- アルゴリズム候補: 非コンテキストMAB(UCB1/ε-Greedy)、LinUCB(小d)、Rewardペナルティ型、安全マスク+Bandit。  
- 比較軸: 固定100/2000ms、Phase1静的閾値ルール(D)、単純ヒューリスティック、C2'の精度ベースライン。  
