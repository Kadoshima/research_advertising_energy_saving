以下は、**フェーズ1（弱い構成）_詳細要件定義書**です。
※実装コード・詳細設計は含みません。実験・計測・評価を“そのまま運用できる”粒度で要件化しています。

---

# ReFormHAR‑Tiny / フェーズ1 詳細要件定義書（弱い構成）

**文書ID**: RHT‑REQ‑PH1‑D1.0
**版**: v1.0（起案）
**作成日**: 2025-11-08
**作成/責任**: 研究代表（A）、実験リード（B）、計測リード（C）、解析リード（D）

---

## 1. 目的／達成像

* **最小実行可能な省電力効果**を、**再現可能なKPI**（イベント電荷μC、平均電流mA、Pout(τ)、p50/p95遅延TL、PDR）で**統一手順**により定量化する。
* **HAR不確実度（U）・安定度（S）**から得る**複合スコア（CCS）**に基づき、**決め打ち写像**で**アドバタイズ間隔**を切替え、**固定ベースライン**と比較する。
* フェーズ2以降（MAB/Safe‑MAB）に**そのまま移植**できる**データスキーマ・KPI計算・写像表**を確立する。

---

## 2. スコープ／非スコープ

**２.１ スコープ**

* BLE **Legacy Advertising**（非接続・非指向、Ch 37/38/39）
* **アドバタイズ間隔（adv_interval）**の制御
* **HAR推論（オンデバイス）**から得る U, S, CCS を用いた**段階写像**
* **イベント電荷（μC）**の計測／**Pout(τ)**・**TL分布**の算出／**PDR**の算出
* **再現性の担保**（校正・同期・ログ・QA）

**２.２ 非スコープ**

* MAB/Safe‑MAB の学習・制約導入
* Androidスキャン非理想性のアルゴリズム注入（観測は次フェーズ）

* Tx電力/PHY/アドバタイズ長の最適化、オンライン重み更新、モデル再学習

---

### 2.3 実装制約（HW/Runtime）

* **プラットフォーム**：ESP32‑S3/C3、**TFLM int8**を使用（S3は`esp‑nn`最適化を推奨）
* **推論制約**：`Arena ≤ 80 KB`（開始64 KB目安）、`Flash ≤ 200 KB`、`FLOPs ≤ 8 M`、`t_inf ≤ 20 ms/窓`
* **入力仕様**：IMU 50 Hz、窓1.0 s、重畳50%（SはW=10 s）
* **計測**：`t_inf`は`esp_timer`等で1000反復、バイナリと条件をログ

---

## 3. 成果物（Deliverables）

1. **要件適合レポート**（KPI合否・グラフ・考察）
2. **ログ一式**（送信・受信・電力・導出KPI；統一スキーマ）
3. **決め打ち写像表（CCS→adv_interval）**（CSV、ヒステリシス含む）
4. **イベント電荷リファレンス**（3ch基準、参考：1/2ch測定）
5. **実験Runbook**（配線・手順・チェックリスト・失敗時復旧手順）

---

## 4. 用語・記号（定義）

* **U（不確実度）**: (U=-\sum_k p_k\log p_k / \log K \in [0,1])
* **S（安定度）**: 直近 (W) 秒の状態遷移回数から算出、(S\in[0,1])（大きいほど安定）
* **confidence（確信度）**：`confidence = 1 − U`
* **CCS（統一）**: ( \mathrm{CCS} = 0.7\,\mathrm{confidence} + 0.3\,\mathrm{stability} \in[0,1])

> しきい値の再較正：定義変更に伴い、従来の {0.40, 0.70} はそのまま使用せず、P1（validation）で ROC/PR に基づき新しきい値 {θ_low, θ_high} を決定し、Runbook に置換表として記録する。
* **adv_interval**: アドバタイズイベントの周期（ms）
* **TL**: イベント検知→初回受信までの遅延（ms）
* **Pout(τ)**: 期限 τ 内に初回受信が無い確率
* **イベント電荷（μC）**: アドバタイズ**1イベント**（3ch送信）に要した電流積分値

---

## 5. システム構成とデータフロー（概念）

```
IMU → 前処理(1.0s窓/50%重畳) → HAR推論(p_k)
                          └→ U(不確実度), S(安定度) → CCS → [決め打ち写像] → adv_interval設定
BLE Stack(3ch) → 送信 → 受信(ゲートウェイ/Android) → 重複除去 → PDR/TL/Pout算出
                                       ↑
電力計測(イベント電流波形) → 積分(μC) → 電力KPI
```

---

## 6. 機能要件（FR：Functional Requirements）

**FR‑1 固定ベースライン制御**

* adv_interval ∈ {**100**, **500**, **1000**, **2000**} ms（各独立セッション）
* ch_mask = **111**（3ch固定）、Tx dBm = 既定（例: 0 dBm）

**FR‑2 決め打ち写像（CCS→間隔）**

* 窓長=**1.0 s**、オーバーラップ=**50%**、安定判定窓 (W=10,s)
* **ヒステリシス**: 閾値±**0.05**（昇降で別閾値）
* 既定写像（**変更可**・変更時はログ必須）。以下の閾値は初期値であり、P1で{θ_low, θ_high}に再較正する。

  * **ACTIVE**: CCS ≥ **0.70** → **100 ms**
  * **UNCERTAIN**: **0.40** ≤ CCS < **0.70** → **500 ms**
  * **QUIET**: CCS < **0.40** → **2000 ms**

**FR‑3 Uの較正（推奨）**

* 温度スケーリング等の**単一係数**による較正を1回実施
* 込み／無し両条件を比較、**calib_T**をログ

**FR‑4 受信・重複除去**

* ゲートウェイ（Android/Low‑Latency推奨）がアドバタイズを**重複除去**しユニーク系列化
* 受信時刻・RSSI・端末モデル・スキャンモードをログ

**FR‑5 電力計測**

* **イベント波形**を取得（イベント境界マーキング）
* 各イベントの**電荷（μC）**を算出
* 平均電流・mWh/日も算出（ベースライン比較用）

**FR‑6 同期**

* セッション先頭に**LED 3秒点滅**で**送受ログ**に共通マーカー
* ゲートウェイは**NTP同期**、DUTは相対時刻で補正

**FR‑7 KPI導出**

* **TL分布**（p50/p95）、**Pout(τ=1/2/3s)**、**PDR**、**平均電流**、**イベント電荷**を条件×環境×反復ごとに自動出力

**FR‑8 実験条件**

* **環境**: E1=干渉弱、E2=干渉強（2.4GHz Wi‑Fi 1/6/11稼働）
* **受信端末**: Android 1–2機種（**LOW_LATENCY**固定）
* **セッション**: 各条件×各環境 **≥3反復**（合計≥30セッション）
* **アクティビティ**: 座位5分→歩行5分→座位5分（計15分/セッション）

---

## 7. 非機能要件（NFR）

* **NFR‑1 再現性**: 同条件で**±5%以内**（平均電流、イベント電荷、Pout）
* **NFR‑2 観測可能性**: 状態遷移・閾値超過・間隔変更の**根拠ログ**付与（U,S,CCS,閾値方向）
* **NFR‑3 可搬性**: ログスキーマはPhase2/3でも**列追加のみ**で互換
* **NFR‑4 安全・規格**: BLE規格／地域規制の**Tx・Duty**遵守
* **NFR‑5 プライバシ**: 生IMUを外部送信しない（メタデータのみ）

---

## 8. インタフェース要件（IF）

**IF‑A（HAR→ポリシ）**

* 入力: (p_k)（確率）、窓長=1.0s/50%重畳
* 出力: U（[0,1]）、S（[0,1]）、CCS（[0,1]）
* 周期: 0.5sごと（重畳のため）
* 付帯: **calib_T**（スカラー）・**W**（s）・**遷移カウント**

**IF‑B（ポリシ→BLE制御）**

* 入力: CCS、ヒステリシス状態、現在のadv_interval
* 出力: 新adv_interval（{100,500,2000}ms）
* 付帯: **切替イベントログ**（旧→新、理由：閾値方向/値）

**IF‑C（DUT→ゲートウェイ）**

* 送信: BLEレガシー・アドバタイジング（3チャネル）
* 受信ログ: t_gateway、端末モデル、scan_mode、rx_uuid、RSSI、dup_flag

**IF‑D（電力計測）**

* 入力: DUT VBATライン
* 出力: 電流波形、生電圧、イベントマーク（on/off）
* 分解能: ≥100 kS/s

---

## 9. KPI定義（数式／算出手順）

* **イベント電荷（μC）**: (\textstyle Q=\int_{t_s}^{t_e} I(t),dt)（1イベント=3ch送信期間）
* **平均電流（mA）**: 期間平均（ベースライン比較用）
* **PDR**: ユニーク・アドバタイズ数／期待アドバタイズ数（ウィンドウ基準）
* **TL**: アクティビティ変化（端末内ラベル時刻）→ゲートウェイで**最初に受信**したアドバタイズまで
* **Pout(τ)**: ( \Pr[TL>\tau] = 1 - \hat{F}_{TL}(\tau) )（τ∈{1,2,3}s）
* **統計**: 各KPIは**平均±95%CI**、**p50/p95**、環境別に提示

---

## 10. 受入基準（Acceptance）

* **省電力**: 固定100ms対比で、不確実度駆動が**平均電流 ≥ 5–10% 改善**（E1/E2とも）
* **品質維持**: Pout(1s)の悪化が**+1.0%pt以内**、p95(TL)が**+10%以内**
* **整合性**: 主要KPIの再現性**±5%以内**、ログ欠損<1%
* **表記**: KPIは**95% CI**を併記（E1/E2別）
* **満たない場合**: **閾値±0.05**、ヒステリシス強化、QUIET下限**2000→1000ms**へ一度だけチューニング許容

**補助基準（任意：早期出口ONの場合）**

* **平均`t_inf`がOFF比で**≥20%短縮**し、かつKPIの劣化（Pout(1 s)・TL p95）が**受入基準内**であること
* 学習側の**F1（validation）**低下が**≤1.0 pt**であること（参考指標、ログ化推奨）

---

## 11. 実験プロトコル（運用）

**11.1 セッション前チェック（抜粋）**

* 電力計測器校正OK／気温記録／バッテリ残量>80%
* ゲートウェイ時刻NTP同期／ストレージ空き>5GB
* DUT: 固定条件→不確実度条件の順で**ランダム化**（順序効果抑制）

**11.2 実行**

1. LED同期（3秒）→セッション開始
2. 15分アクティビティ（座位→歩行→座位）
3. 受信・電力波形の**同時取得**
4. 終了後、簡易QA（ドロップ率・電力波形有無）

**11.3 エラー時**

* 受信ドロップ>10%: スキャン再起動→再試行
* 波形欠損: ケーブル再接続→再試行
* 2回失敗で**セッション中止**・原因記録

---

### 同期・重複除去（再現規約）

* **同期**：セッション開始時に Sync ADV（`seq=0`）を1回送信し、同時にLEDを**500 ms**点灯する。評価はSync以降のデータのみを用いる。
* **重複除去**：`{seq, ts_tx}` をキーに、**判定窓=3×adv_interval**で同一イベントを定義し、最初に到達した1件を採用する。
* **評価窓**：A/B比較では開始・終了端の**0.5 s**を評価対象から除外する。

### 再現性担保（運用）

* 条件順序は**Latin方格**で割付。
* 受信端末は機種/OS/ビルド/スキャン設定を固定し、**Doze無効化**。
* **距離・姿勢**の写真エビデンスと、E1/E2の**時間帯メタ**を記録する。
* 各環境で**≥2反復**から**95% CI**を併記する。

---

### 付記：P0 校正（推奨）

* **目的**：推論リソース（Arena/t_inf）と電力計測系の健全性確認
* **内容**：静的/動的3分×2、`Arena`実測、`t_inf`（1000反復）、推論のみ/アドバタイズのみ/同時のμC分離
* **出力**：`Arena_kB`, `t_inf_ms`分布、ベース電流、計測校正ログ

---

## 12. ログ仕様（データ辞書）

**送信ログ（DUT）**

| 項目              | 型         | 単位/範囲                  | 必須 | 備考     |
| --------------- | --------- | ---------------------- | -- | ------ |
| t_local         | float(ms) | 単調増加                   | ●  | 起点0で良い |
| session_id      | string    | —                      | ●  | 一意     |
| device_id       | string    | —                      | ●  | —      |
| adv_interval_ms | int       | {100,500,1000,2000}    | ●  | —      |
| ch_mask         | string    | ‘111’固定                | ●  | —      |
| tx_dbm          | int       | 例 0                    | ●  | —      |
| state           | string    | ACTIVE/UNCERTAIN/QUIET | ●  | —      |
| U               | float     | [0,1]                  | ●  | —      |
| S               | float     | [0,1]                  | ●  | —      |
| CCS             | float     | [0,1]                  | ●  | —      |
| calib_T         | float     | >0                     | ○  | 較正時のみ  |
| window_len      | float     | 秒                      | ●  | 1.0    |
| overlap         | float     | 0–1                    | ●  | 0.5    |
| W_sec           | float     | 秒                      | ●  | 10     |

**受信ログ（GW）**

| 項目          | 型         | 説明                    |
| ----------- | --------- | --------------------- |
| t_gateway   | float(ms) | NTP同期時刻               |
| session_id  | str       | 一致必須                  |
| gateway_id  | str       | —                     |
| phone_model | str       | —                     |
| scan_mode   | str       | LOW_LATENCY固定（Phase1） |
| adv_addr    | str       | —                     |
| rx_uuid     | str       | ユニーク受信ID              |
| rssi        | int       | dBm                   |
| dedup_flag  | bool      | 重複除去後=1               |

**電力ログ（Power）**

| 項目           | 型         | 説明          |
| ------------ | --------- | ----------- |
| t_probe      | float(ms) | —           |
| current_mA   | float     | —           |
| voltage_V    | float     | —           |
| event_marker | int       | 0/1（イベント境界） |

**導出KPI（集計CSV）**

| 項目                                | 型     | 説明 |
| --------------------------------- | ----- | -- |
| session_id/condition/env/run_id   | —     | —  |
| avg_current_mA/energy_mWh_per_day | float | —  |
| event_charge_uC_mean/std          | float | —  |
| PDR                               | float | —  |
| TL_p50_ms/TL_p95_ms               | float | —  |
| Pout_1s/_2s/_3s                   | float | —  |

---

## 13. QA／データ完全性（自動チェック）

* 欠損率<1%、時刻の単調性、範囲外値（U,S,CCS∉[0,1]）、adv_intervalセット外の検出
* イベント電荷の分布外れ（外れ値>±3σ）警告
* 受信ユニーク数が期待値の一定割合未満（例<30%）で**警告**

---

## 14. リスクと緩和

| リスク        | 影響      | 緩和策                          |
| ---------- | ------- | ---------------------------- |
| Uの過信（誤高信頼） | 通信暴発    | 温度スケーリング、ヒステリシス強化、QUIET下限短縮  |
| 受信端末の不安定   | PDR低下   | LOW_LATENCY固定、バックアップ端末、再起動手順 |
| 電力計測誤差     | μC再現性低下 | ゼロ/ゲイン校正、温度記録、イベント境界マーク      |
| 干渉過多       | Pout劣化  | E1/E2分離評価、再試行条件の明確化          |

---

## 15. 変更管理

* **小変更**（閾値±0.05、ヒステリシス±0.02）: 実験継続OK、差分記録
* **中変更**（窓長、W）: 代表条件1セット再計測
* **大変更**（adv_intervalセット/ch_mask）: 要承認・計画更新

---

## 16. Traceability（目的⇔要件⇔検証）

| 目的       | 要件ID        | 検証手段                         |
| -------- | ----------- | ---------------------------- |
| 省電力定量    | FR‑1/2/5    | avg_current、event_charge、比較図 |
| QoS維持    | FR‑4/7      | Pout(τ)、TL p95、PDR           |
| 再現性確保    | NFR‑1       | 再現性±5%テスト                    |
| Phase2移行 | FR‑2/7、ログ仕様 | 写像表CSV、スキーマ互換、KPI自動計算        |

---

## 17. 次フェーズ接続（インタフェース保証）

* **写像表CSV**は**初期方策（warm‑start）**としてMABに投入可能
* **イベント電荷辞書**は**報酬正規化**に直結
* **ログスキーマ**は**arm/reward/context**列を追加するだけで拡張可能
* **KPI関数**に**Pout制約判定**用フック（引数τ, θ）をあけておく

---

## 18. スケジュール／マイルストーン（例）

* **M1**: 計測治具校正・Runbook完成（W1）
* **M2**: E1環境で固定4条件×3反復完了（W2–3）
* **M3**: E2環境で固定4条件×3反復完了（W3–4）
* **M4**: 不確実度写像条件（E1/E2×各3反復）完了（W4–5）
* **M5**: 解析・KPIレポート・要件適合判定（W6）

---

## 19. チェックリスト（抜粋）

**事前**: NTP同期/ストレージ空き/電力計校正/ケーブル固定/LED同期確認
**実行**: 条件順序表の確認/ヒステリシス有効/ラベル付け開始時刻記録
**終了**: ログ欠損確認/イベント電荷の波形確認/TLの粗集計/バックアップ保存

---

### 付録A：既定パラメータ（初期値）

* 窓長=**1.0 s**、重畳=**50%**、W=**10 s**
* 閾値=**0.40/0.70**、ヒステリシス=**±0.05**
  - 注：上記は初期値。P1で{θ_low, θ_high}に再較正し置換する。
* adv_intervalセット=**{100, 500, 1000, 2000}**（比較）、写像は**{100, 500, 2000}**
* ch_mask=**111**、Tx dBm=**既定（0 dBm）**
* スキャンモード=**LOW_LATENCY**
* Pout評価 τ=**1/2/3 s**
