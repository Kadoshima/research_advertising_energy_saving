以下は **ReFormHAR‑Tiny / フェーズ1（弱い構成）_詳細設計定義書** です。
※実装コードは一切含みません。要件定義・設計定義で合意した内容を、**モジュール粒度・状態遷移・データ設計・タイミング設計・誤動作対策・試験観点**まで落とし込んでいます。Phase‑2/3 へそのまま橋渡しできる**拡張フック**も明示しています。

---

## 0. 文書メタ

* **文書ID**：RHT‑DDD‑PH1‑v1.0
* **対象**：Phase‑1（固定ベースライン＋不確実度に基づく決め打ち写像）
* **前提文書**：要件定義書（REQ‑PH1）、詳細要件定義書（RHT‑REQ‑PH1‑D1.0）
* **非対象**：MAB/Safe‑MAB、チャネル集合可変、Tx電力/PHY最適化（Phase‑2/3で扱う）

---

## 1. システム全体像（コンテキスト & 分割）

### 1.1 コンポーネント分割

* **C1. Sensing & HAR**：IMU→前処理（1.0 s窓/50%重畳）→分類（pₖ）→**U**（不確実度）・**S**（安定度）・**CCS**算出
* **C2. Policy Engine（Rule）**：**CCS→adv_interval**の段階写像＋ヒステリシス＋**最小滞在時間**＋**切替レート制限**＋**フォールバック**
* **C3. BLE Advertiser**：**interval適用**、3チャネル（37/38/39）でアドバタイズ、適用成否をイベント化
* **C4. Telemetry & KPI**：送信/受信/電力/決定根拠の**統合ログ**、**KPI生成**（TL、Pout(τ)、PDR、平均電流、イベント電荷）
* **C5. Power Meter I/F**：VBAT直列計測、**イベント境界マーク**、**μC算出**

### 1.2 データフロー（DFD 概念図）

```
IMU --> C1(HAR) --> {U,S,CCS} --> C2(Policy) --> adv_interval --> C3(BLE)
         |                                 |             |
         |                                 +--> C4(Decision Rationale Log)
         v                                               v
      C4(Tx Log)                                  C4(Rx Log) <== Gateway
         ^
         |                              C5(Power Waveform) --> μC --> C4(KPI)
         +----------------------------- 時刻/同期 ----------------------------+
```

---

## 2. 前提・制約（Assumptions & Constraints）

* **Legacy Advertising固定**、**ch_mask=111**（3ch）
* **adv_interval集合**：{100, 500, 1000, 2000} ms（比較用）、写像で用いるのは {100, 500, 2000} ms
* **推論窓**：1.0 s、オーバーラップ50%（**0.5 s周期**でU/S/CCS更新）
* **Sの窓**：W=10 s、遷移カウント正規化
* **ヒステリシス帯**：±0.05（上り閾 0.70/0.40、下り閾 0.65/0.35）
* **最小滞在時間**：2 s、**切替レート上限**：1 Hz
* **フォールバック**：HAR欠落・異常時は **1000 ms**・3ch
* **受信側**：Android **LOW_LATENCY** 固定（端末差の影響を抑える）。Opportunistic Scan で実効スキャンは非定常である前提とし、評価は端末内A/B比較で完結させる。
* **計測**：Power ≥100 kS/s、イベント境界は**GPIO**でマーキング推奨
* **KPI**：イベント電荷（μC）、平均電流、PDR、TL分布（p50/p95）、**Pout(τ=1/2/3 s)**、**ΔE/adv（E_ON − E_OFF のイベントあたりエネルギー増分）**
* **実装制約（HW/Runtime）**：**TFLM int8**、`Arena ≤ 80 KB`（開始64 KB目安）、`Flash ≤ 200 KB`、`FLOPs ≤ 8 M`、`t_inf ≤ 20 ms/窓`（S3は`esp‑nn`最適化推奨）

---

## 3. 詳細モジュール設計

### 3.1 C1: Sensing & HAR

* **入力**：IMU ≥50 Hz（加速度/ジャイロ）
* **前処理**：固定窓 1.0 s、50%重畳、正規化
* **推論**：pₖ（Kクラス）を出力
* **U（不確実度）**：(U = -\sum_k p_k \log p_k / \log K)（[0,1]）
* **S（安定度）**：直近 W=10 s の**状態遷移回数** n_trans から ( S = 1 - \min(1, n_{\text{trans}}/\tau ))（τは設計値。初期は**5**を推奨）
* **confidence**：`confidence = 1 − U`
* **CCS（統一）**：( \mathrm{CCS} = 0.7\,\mathrm{confidence} + 0.3\,S )。 しきい値{0.40,0.70}はP1で{θ_low, θ_high}に再較正。
* **較正（任意）**：温度スケーリング T（>0）をメタとして保持（**calib_T**）
* **出力周期**：0.5 s
* **早期出口（任意）**：`max_softmax≥0.90` かつ 温度スケーリング後≥0.85 で**Exit‑0**を採用（平均`t_inf`短縮を狙う）。有効/無効をA/Bで比較・ログ化。
* **エラーハンドリング**：pₖが壊れている・欠測 → `HAR_Health=false`（C2へ通知）

**出力イベント（HarOut）**
`{ t_local, label_hat, p_k[], U, S, CCS, calib_T, window_len=1.0, overlap=0.5, W_sec=10 }`

---

### 3.2 C2: Policy Engine（Rule）

* **責務**：HarOutを取り込み、**adv_interval**を段階写像で決定。
* **入力**：`HarOut`、`current_interval`、内部状態（現在STATE、滞在開始時刻）
* **出力**：`Decision{ new_interval, reason, thresholds_used, hysteresis_band, min_dwell_hit, fallback_flag }`

**3.2.1 状態モデル**

* **STATE**：`QUIET (2000ms)`, `UNCERTAIN (500ms)`, `ACTIVE (100ms)`, `FALLBACK (1000ms)`
* **ガード**：

  * **上り判定**：`CCS >= 0.70`（ACTIVE）, `CCS >= 0.40`（UNCERTAIN）
  * **下り判定**：`CCS < 0.65`（ACTIVE→UNCERTAIN）, `CCS < 0.35`（UNCERTAIN→QUIET）
  * **ヒステリシス**：昇降でしきい値が異なる
  * **最小滞在**：前回切替から **≥2 s**
  * **切替レート**：直近 1 s に切替なし
  * **フォールバック**：`HAR_Health=false` or `HarOut timeout > 1.0 s`

**3.2.2 遷移表（再掲・厳密化）**

| 現STATE    | ガード条件                            | 次STATE    | new_interval | reason     |
| --------- | -------------------------------- | --------- | ------------ | ---------- |
| QUIET     | CCS≥0.70 ∧ dwellOK ∧ rateOK      | ACTIVE    | 100          | TH_UP      |
| QUIET     | 0.40≤CCS<0.70 ∧ dwellOK ∧ rateOK | UNCERTAIN | 500          | TH_UP      |
| ANY       | HAR_Health=false ∨ timeout>1.0s  | FALLBACK  | 1000         | FALLBACK   |
| ACTIVE    | CCS<0.65 ∧ dwellOK ∧ rateOK      | UNCERTAIN | 500          | TH_DOWN    |
| UNCERTAIN | CCS<0.35 ∧ dwellOK ∧ rateOK      | QUIET     | 2000         | TH_DOWN    |
| UNCERTAIN | CCS≥0.75 ∧ dwellOK ∧ rateOK      | ACTIVE    | 100          | TH_UP      |
| ANY       | ¬rateOK ∨ ¬dwellOK               | 現STATE    | 現interval    | RATE_LIMIT |

**3.2.3 例外・整合性**

* 連続3回 `FALLBACK` 発動時：**SAFEモード**（500 ms固定）でセッション完走、アラート発報
* `new_interval` が集合外 → 拒否し**SAFEモード**
* 閾値の設定矛盾（上り≤下り）→ 起動時に検出し**SAFEモード**

---

### 3.3 C3: BLE Advertiser

* **責務**：`apply_interval(new_interval)` を**アトミック**に実行
* **制約**：ch_mask=111、Tx dBm固定（地域規制内）
* **副作用**：適用成功/失敗を**Decision Rationale Log**へイベント出力
* **タイミング**：**BLE送信直後**にPolicy評価→次イベントから新interval適用（過渡の二重設定を避ける）

---

### 3.4 C4: Telemetry & KPI

* **サブモジュール**：

  * **TxLogger**：送信側メタ（interval, state, U, S, CCS, thresholds, reason）
  * **RxLogger**（GW側）：`t_gateway, phone_model, scan_mode, rx_uuid, rssi, dedup_flag`
  * **DecisionLog**：切替ごとに1行（根拠追跡用）
  * **PowerLogger**：イベント境界（GPIO）、波形→**μC**化
  * **KPI Builder**：TL分布、Pout(τ)、PDR、平均電流、イベント電荷の集計CSVを出力（任意で`t_inf`分布と`exit_used`率を追加）

**実装ポリシ**

* **非同期書き出し**（バッファリング）／**優先度**：Tx/Rx>Decision>Power（波形は連続ストリーム）
* **落ち穂拾い**：バッファ溢れ時は**最古の通常ログ**から破棄。**DecisionLog**は破棄禁止
* **完全性**：セッション末尾に**インデックス**（件数/欠損/範囲）を付与

---

### 3.5 C5: Power Meter I/F

* **接続**：VBAT直列（シャント内蔵計）、GNDループ回避
* **サンプリング**：≥100 kS/s、**電圧**も併記
* **イベント境界**：GPIOで**アドバタイズイベント開始/終了**をマーキング
* **前後校正**：ゼロ/ゲイン、温度ログ
* **導出**：各イベントの**μC**を算出し、平均/分散をKPIへ

---

## 4. タイミング設計（実時間要件）

| 項目         | 目標/上限             |
| ---------- | ----------------- |
| HAR出力周期    | 0.5 s（窓1.0 s/50%） |
| Policy評価時間 | ≤1 ms/回           |
| 決定→BLE適用   | **次の**アドバタイズイベントから反映   |
| 最小滞在時間     | ≥2 s              |
| 切替レート      | ≤1回/秒             |
| ログフラッシュ    | ≤500 ms           |
| Power波形遅延  | 0（ストリーミング）        |

**優先度**：BLE Tx（高）＞ HAR（中）＞ Logger（低）
**ジッタ**：Policy評価のトリガは**BLE送信直後**に合わせて実行（競合・振動回避）

---

## 5. データ設計（スキーマ & 妥当性）

### 5.1 送信ログ（Tx）

```
t_local(ms), session_id, device_id,
adv_interval_ms{100|500|1000|2000}, ch_mask='111', tx_dbm,
state{ACTIVE|UNCERTAIN|QUIET|FALLBACK}, U[0..1], S[0..1], CCS[0..1],
thresholds{upA,upU,downA,downU}, hysteresis=0.05,
calib_T?, window_len=1.0, overlap=0.5, W_sec=10
```

**検証**：値域、単調時刻、集合外intervalの禁止

### 5.2 受信ログ（Rx, GW）

```
t_gateway(ms), session_id, gateway_id, phone_model, scan_mode='LOW_LATENCY',
adv_addr, rx_uuid, rssi(dBm), dedup_flag{0|1}
```

### 5.3 決定ログ（Decision）

```
t_local(ms), session_id, old_interval, new_interval, reason{TH_UP|TH_DOWN|FALLBACK|RATE_LIMIT},
CCS_at_decision, min_dwell_hit{0|1}, rate_limit_hit{0|1}, har_health{0|1}, apply_success{0|1}
```

### 5.4 電力波形（Power）

```
t_probe(us), current_mA, voltage_V, event_marker{0|1}
```

### 5.5 導出KPI（Aggregated CSV）

```
session_id, condition, env(E1|E2), run_id,
avg_current_mA, energy_mWh_per_day,
event_charge_uC_mean, event_charge_uC_std,
PDR, TL_p50_ms, TL_p95_ms, Pout_1s, Pout_2s, Pout_3s
```

**命名規約**：`RHT_{date}_{session}_{condition}_{env}.csv`
**時刻基準**：DUTは相対（セッション起点0 ms）、GWはNTP（同期マーカーで整合）

---

## 6. シーケンス（代表ケース）

### 6.1 不確実度上昇→ACTIVE遷移

```
HarOut(U,S,CCS=0.74)      -> C2.set_context()
C2.decide_interval()       -> dwellOK & rateOK & CCS>=0.70 → ACTIVE
C3.apply_interval(100ms)   -> success
C4.DecisionLog             -> reason=TH_UP, CCS=0.74, min_dwell=1
C4.TxLog                   -> state=ACTIVE, adv_interval=100
C5.Power                   -> 次イベント区間をevent_markerで取得
```

### 6.2 HAR欠落→FALLBACK

```
HarOut timeout>1.0s        -> C2.fallback()
C3.apply_interval(1000ms)  -> success
C4.DecisionLog             -> reason=FALLBACK, fallback_flag=1
```

---

## 7. エラー/例外設計（FMEA 抜粋）

| 事象        | 原因        | 検出           | 影響        | 緩和/回復                     |
| --------- | --------- | ------------ | --------- | ------------------------- |
| HAR欠落     | センサ/推論停止  | HarOutタイムアウト | CCS無効     | FALLBACK=1000ms、アラート、復帰監視 |
| しきい値設定矛盾  | 設定ミス      | 起動時検証        | 異常遷移      | SAFE=500ms固定、設定拒否         |
| 切替振動      | U/Sノイズ    | 切替頻度監視       | QoS・電力悪化  | ヒステリシス/最小滞在/レート制限         |
| Power波形欠損 | ケーブル/記録停止 | QAスクリプト      | μC不明      | 再試行、セッション無効化              |
| 受信側ドロップ過多 | 干渉/端末不良   | PDR監視        | TL/Pout劣化 | 端末再起動/再試行、E1/E2分離評価       |

---

## 8. 設定管理（Config 仕様）

* **policy.thresholds**：`{ up_active:0.70, up_uncertain:0.40, down_active:0.65, down_uncertain:0.35 }`
* **policy.hysteresis**：0.05
* **policy.min_dwell_sec**：2
* **policy.switch_rate_limit_hz**：1
* **policy.fallback_interval_ms**：1000
* **har.window_sec/overlap/W_sec**：1.0 / 0.5 / 10
* **ble.ch_mask/tx_dbm**：`0b111` / `0`
* **logging.flush_period_ms**：500

**バリデーション**：上り閾 > 下り閾、interval集合の単調増加、数値範囲チェック
**バージョン**：`config_version` と **Gitハッシュ**をDecisionLogへ同時出力

---

## 9. セキュリティ/プライバシ/規格

* 生IMUは**外部送信しない**。アドバタイジング内容は**アクティビティ種別/統計メタ**に限定（フェーズ1は固定ビーコンでも可）
* BLE出力は**地域規制**（Tx/EIRP）を順守
* ログには個人識別子を入れず、**匿名ID**で管理

---

## 10. 検証設計（試験観点と可視化）

* **機能**：状態遷移（すべての枝）、フォールバック、ヒステリシス・最小滞在・レート制限の発火を**DecisionLog**で確認
* **性能**：avg_current・μC・PDR・TL（p50/p95）・Pout(τ) を**環境E1/E2×条件**で比較
* **再現性**：主要KPIが**±5%以内**（同条件3反復）
* **可視化**：

  * TLの**CDF**（条件別）
  * **Pout(τ)**（τ=1/2/3 s）棒グラフ
  * 事件電荷（μC）の**箱ひげ**
  * 状態遷移タイムライン（state/interval over time）

---

## 11. Phase‑2/3 への拡張フック

* **Policy IFは固定**：`decide_interval()` を **MAB / Safe‑MAB** に差し替え
* **DecisionMeta拡張**：`arm_id`, `reward`, `context{U,S,env}` を**列追加**で後方互換
* **Safety Hook**：`is_feasible(arm, τ, θ)` を空実装で先行定義（Phase‑3 で有効化）
* **Rx拡張**：将来の**rx_channel同定**や**scan_mode可変**は**別列**で追加可能
* **電力辞書**：Phase‑1で得た**interval→μC**をMAB報酬の正規化に再利用

---

## 12. チェックリスト（運用/品質）

* 起動時：Config検証OK／時刻同期OK／Power校正OK／ストレージ空き>5 GB
* 走行中：切替頻度≤1 Hz／最小滞在違反なし／DecisionLogに根拠が記録されている
* 終了時：ログ欠損<1%／Power波形のイベント境界が明瞭／KPI CSVが自動出力

---

## 付録A：代表しきい値・区分

* ACTIVE：`CCS ≥ 0.70` → 100 ms
* UNCERTAIN：`0.40 ≤ CCS < 0.70` → 500 ms
* QUIET：`CCS < 0.40` → 2000 ms
* 下り閾：ACTIVE→0.65、UNCERTAIN→0.35（ヒステリシス±0.05）

## 付録B：代表KPI算出フロー（数式のみ）

* **μC**：イベント区間の ( \int I(t),dt )
* **平均電流**：( \bar{I} = \frac{1}{T}\int_0^T I(t),dt )
* **TL**：イベント時刻差（DUTラベル→GW初回受信）
* **Pout(τ)**：( \Pr[TL>\tau] )（TLの経験CDFから）

---

### 結語

本**詳細設計定義書**により、Phase‑1 を **実装なしに運用準備**でき、得られた**写像・ログ・KPI**は **Phase‑2/3** の **初期方策・報酬正規化・制約フック**へ**無改造で継承**できます。設計の**差し替え点**（Policy IF / Safety Hook / DecisionMeta拡張）を明示したため、以降の複雑化に対しても**最小変更**で対応可能です。
