以下は **ReFormHAR‑Tiny / フェーズ1（弱い構成） 設計定義書** です。
※実装コードは含みません。要求仕様に対して、**アーキテクチャ／モジュール分割／インタフェース契約／状態機械／データ設計／運用・計測設計／試験設計との整合**を明確にします。フェーズ2（MAB化）、フェーズ3（Safe‑MAB化）への拡張を前提に、**差し替え可能な設計**にしています。

---

# 1. 文書メタ

* **文書ID**：RHT‑DES‑PH1‑v1.0
* **対象フェーズ**：Phase‑1（固定ベースライン＋不確実度に基づく決め打ち写像）
* **前提文書**：要件定義書／詳細要件定義書（前回合意済み）

---

# 2. 設計方針（Design Principles）

1. **分離（Separation of Concerns）**：

   * **Sensing/HAR**（推論）／**Policy Engine**（写像）／**BLE Advertiser**（送信）／**Telemetry & Power**（観測）を疎結合化。
2. **プラグイン化**：

   * **Policy Engine**を**インタフェース化**（Phase‑2でMAB、Phase‑3でSafe‑MABに差し替え）。
3. **観測駆動**：

   * すべての意思決定に**根拠ログ**（U,S,CCS,境界超過, 旧→新interval）を必ず残す。
4. **最小限のリアルタイム制約**：

   * HAR出力周期0.5 sで十分／広告間隔は100–2000 msの離散値。スレッド優先度は**無線＞推論＞ログ**。
5. **安全側フォールバック**：

   * U/Sが無効・欠落時は**1000 ms・3ch**へ復帰。切替頻繁化を防ぐ**ヒステリシス＋最小滞在時間**を持たせる。
6. **将来拡張**：

   * **rx_channel同定**や**Pout(τ)制約**用のフックを先に定義しておく（未使用でも空実装）。

---

# 3. システム構成（High‑Level Architecture）

```
+-------------------+        +----------------------+        +------------------+
|   Sensing & HAR   | -----> |  Policy Engine (PH1) | -----> |  BLE Advertiser  |
|  (IMU → model)    |  U,S   |  (Rule-based mapping)|  Adv   | (Interval & 3ch) |
|  p_k → U,S,CCS    |  CCS   |  + Hysteresis        |  set   |  Tx dBm fixed    |
+-------------------+        +----------------------+        +------------------+
         |                               |                              |
         v                               v                              v
+-------------------+        +----------------------+        +------------------+
| Telemetry Logger  | <----- |  Decision Rationale  | <----- | Power Meter I/F  |
| (Tx/Rx/Power/KPI) |        | (Why/When switched)  |        | (Event charge)   |
+-------------------+        +----------------------+        +------------------+
```

---

# 4. モジュール設計

## 4.1 Sensing & HAR モジュール

* **役割**：1.0 s窓・50%重畳で推論、U（不確実度）、S（安定度）を算出。
* **入出力**：

  * 入力：IMUストリーム（≥50 Hz）
  * 出力：`HAR_Output{ t, label_hat, p_k[K], U∈[0,1], S∈[0,1], CCS∈[0,1] }`（0.5 s毎）
* **アルゴリズム仕様**：

  * `U = -Σ p_k log p_k / log K`
  * `S = 1 - min(1, n_transitions(W)/τ)`（W=10 s；τは設計値）
  * `CCS = 0.6 U + 0.4 (1−S)`
* **較正（任意）**：温度スケーリングTを係数として保持（ログに記録）。

## 4.2 Policy Engine（PH1：決め打ち写像）

* **役割**：CCSに基づき広告間隔を離散切替。
* **IF（フェーズ横断）**：

  * `set_context(HAR_Output)`
  * `decide_interval(current_interval) -> NewInterval, DecisionMeta`
* **写像仕様**（既定、変更可）：

  * ACTIVE：CCS ≥ 0.70 → 100 ms
  * UNCERTAIN：0.40 ≤ CCS < 0.70 → 500 ms
  * QUIET：CCS < 0.40 → 2000 ms
* **アンチスラッシング**：

  * **ヒステリシス**：±0.05
  * **最小滞在時間**：各区分**≥2 s**（滞在満了まで再切替禁止）
  * **レート制限**：**1 sあたり最大1回**の切替
* **フォールバック**：U/S/CCSが欠損・NaN・異常域 → `1000 ms`へ、理由をDecisionMetaに記録。

> **将来差し替え点**：`decide_interval()`の実装のみ置換で**MAB**／**Safe‑MAB**へ移行可能。入出力とメタは維持。

## 4.3 BLE Advertiser

* **役割**：与えられたintervalを設定し、3チャネル（37/38/39）で送出。
* **仕様**：

  * `apply_interval(ms)` はアトミックに設定（OS/BLE Stack API準拠）
  * **ch_mask=111固定**（Phase‑1は評価の一貫性重視）
  * **Tx dBm固定**（規格・地域上限内）
* **観測**：切替タイムスタンプ、旧→新interval、適用成否をログ。

## 4.4 Telemetry & Power

* **役割**：送受・電力・決定根拠を統合ログ化し、KPI生成に必要なデータ完全性を担保。
* **サブ構成**：

  * **Tx Logger**：`{t, session_id, adv_interval, ch_mask, tx_dbm, state, U, S, CCS, calib_T}`
  * **Rx Logger（GW側）**：`{t_gateway, session_id, phone_model, scan_mode, rx_uuid, rssi, dedup_flag}`
  * **Power Logger**：イベント境界マーク付き波形（≥100 kS/s）、イベント電荷μCを算出
  * **Decision Rationale**：`{t, old_interval, new_interval, reason(TH_UP/DOWN/FALLBACK), CCS_at_decision, dwell_time_ok}`

---

# 5. インタフェース契約（Contract）

## 5.1 データ型（抽象）

* `HAR_Output`：前述（floatは[0,1]制約、K>1）
* `DecisionMeta`：`{ reason, threshold_used, hysteresis_band, min_dwell_hit(bool), fallback_flag(bool) }`
* `TxLogRecord`／`RxLogRecord`／`PowerEvent`：詳細要件のスキーマに準拠

## 5.2 タイミング契約

* HAR出力周期：0.5 s
* Policy反映：HAR出力から**≤100 ms**以内に`decide_interval`評価、必要なら次の広告イベントに**即反映**
* 切替最小間隔：1 s
* 最小滞在時間：2 s

## 5.3 エラーハンドリング

* **HAR欠落**（タイムアウト>1.0 s）：`fallback_flag=true`で1000 msへ復帰
* **BLE設定失敗**：直前設定を再適用、連続失敗3回で**安全側（500 ms）**に設定しアラート
* **パラメタ異常**（閾値入替、負のinterval等）：設定を拒否し保守モード（500 ms）

---

# 6. 状態機械（Policy Engine）

**状態**：`QUIET`, `UNCERTAIN`, `ACTIVE`, `FALLBACK`
**入力イベント**：`CCS↑閾値超過`, `CCS↓閾値下回り`, `HAR欠落`, `滞在満了`, `RateLimit超過`

| 現状態       | 入力                    | 遷移先       | 動作                           |
| --------- | --------------------- | --------- | ---------------------------- |
| QUIET     | CCS≥0.70 かつ 滞在満了      | ACTIVE    | interval=100ms, reason=TH_UP |
| QUIET     | 0.40≤CCS<0.70 かつ 滞在満了 | UNCERTAIN | 500ms, TH_UP                 |
| ANY       | HAR欠落                 | FALLBACK  | 1000ms, FALLBACK             |
| ACTIVE    | CCS<0.65 かつ 滞在満了      | UNCERTAIN | 500ms, TH_DOWN               |
| UNCERTAIN | CCS<0.35 かつ 滞在満了      | QUIET     | 2000ms, TH_DOWN              |
| UNCERTAIN | CCS≥0.75 かつ 滞在満了      | ACTIVE    | 100ms, TH_UP                 |
| ANY       | RateLimit超過           | 現状態       | 変更なし（理由=RATE_LIMIT）          |

注：0.70/0.40は上り閾値、0.65/0.35は下り閾値（ヒステリシス=±0.05）。

---

# 7. データ設計（ログ／KPI）

## 7.1 ログスキーマ（再掲＋設計注）

* **送信ログ**の`state`は**状態機械の状態**と一致させる。
* **Decision Rationale**は**切替のたびに1行**必ず出す（監査可能性）。
* **Power**は**イベント境界**のマークを確実に記録（広告3chの区間に一致させる）。

## 7.2 KPI生成フロー

1. Power波形 → **イベント電荷μC**に積分 → セッション平均・分散
2. Rxログ＋アクティビティラベル → **TL**（初回到達遅延）→ **Pout(τ)**=Pr[TL>τ]
3. Tx/Rx統合 → **PDR**, **平均電流**（Power総和/時間）
4. 条件×環境×反復の**集計CSV**を自動書き出し

---

# 8. タイミング・スケジューリング設計

* **スレッド優先度**：`BLE Tx (High)` > `HAR (Mid)` > `Logger (Low)`
* **実行周期**：HAR＝2 Hz、Policy評価＝2 Hz、BLEイベント＝interval依存
* **競合回避**：Policy評価は**BLE送信直後**のタイミングで行い、**最小滞在時間**と**レート制限**でスラッシング防止。
* **時間予算**（目安）：Policy判定≦1 ms、ログ出力≦5 ms/回（非同期・バッファリング）

---

# 9. 構成・パラメタ管理（Config）

* **config.yml（例）**

  * `intervals: [100, 500, 2000]`
  * `thresholds: { up_active: 0.70, up_uncertain: 0.40, down_active: 0.65, down_uncertain: 0.35 }`
  * `hysteresis: 0.05`
  * `min_dwell_sec: 2`
  * `switch_rate_limit_hz: 1`
  * `fallback_interval_ms: 1000`
  * `har: { window_sec: 1.0, overlap: 0.5, W_sec: 10, temp_scale_T: 1.0 }`
  * `ble: { ch_mask: 0b111, tx_dbm: 0 }`
  * `logging: { level: INFO, flush_period_ms: 500 }`

> Phase‑2 以降は `policy: { type: RULE | MAB | SAFE_MAB, params: ... }` を追加するだけで切替。

---

# 10. 電力計測・受信系設計

## 10.1 電力計測

* **配線**：VBAT直列・シャント内蔵計へ。グラウンドループ防止。
* **サンプリング**：≥100 kS/s、時刻同期は開始時LEDマーク＋ソフトマーク。
* **イベント境界**：広告イベント開始/終了を**GPIOトグル**で書き出し（観測器で同時取得）推奨。
* **校正**：ゼロ／ゲイン、気温記録、校正ログを別ファイル管理。

## 10.2 受信系

* **スキャンモード**：Phase‑1は**LOW_LATENCY**固定（端末差要因を抑制）
* **重複除去**：`(addr, time_window)`でユニーク化
* **TL算出**：アクティビティ遷移タイムスタンプ（DUT起点）と受信時刻（GW起点）を**同期マーカー**で整合

---

# 11. 品質設計（QA & フェイルセーフ）

* **Self‑Check**：起動時にConfig妥当性検査（閾値順序、interval集合の単調増加、値域）
* **Watchdog**：HAR出力タイムアウト>1 sでFALLBACKへ、復帰時に`fallback_flag=false`で記録
* **ドロップ対策**：ログキューにバックプレッシャ、溢れ時は**最古を間引き**（切替イベントは必ず保持）
* **セッション完了チェック**：ログ欠損率＜1%、イベント電荷の外れ値警告（±3σ）

---

# 12. 試験設計との整合（Traceability）

| 要件ID   | 設計要素                            | 試験観点                       |
| ------ | ------------------------------- | -------------------------- |
| FR‑1/2 | Policy Engine（Rule）・状態機械・ヒステリシス | 切替動作、RateLimit、最小滞在検証      |
| FR‑4   | Rx Logger・重複除去                  | PDR/TLの再現                  |
| FR‑5   | Power Logger・GPIOマーク            | イベント電荷の再現性±5%              |
| FR‑7   | KPIパイプライン                       | Pout(τ), TL p95, 平均電流の自動算出 |
| NFR‑1  | 校正・再現性手順                        | 同条件±5%検証                   |
| NFR‑3  | IF契約・Config                     | Phase‑2/3での差し替え試験          |

---

# 13. リスク & デザイン緩和

* **切替振動**：ヒステリシス＋最小滞在＋レート制限で抑制。
* **HAR誤検知**：温度スケーリング導入・Sの窓W拡大。
* **受信端末差による変動**：Phase‑1はLOW_LATENCY固定、Phase‑2でチャネル同定導入予定。
* **計測ノイズ**：GPIO境界マーク・高サンプル・校正の3点セットで吸収。

---

# 14. フェーズ移行のための“差し替え点”明示

* **Policy Engine**：`decide_interval()`を**MAB**（arm=(interval, ch_mask)）へ差し替え。
* **DecisionMeta**：`arm`, `reward`, `context` を拡張フィールドとして追加（後方互換）。
* **Telemtry**：既存ログに `arm_id`, `reward_est` 列を追加。
* **Safety Hook**（Phase‑3）：`is_feasible(arm, τ, θ)`フックをPolicyに追加（初期は常にtrue）。

---

# 15. 展開・運用（Runbook要点）

1. 設備点検（電力計校正、NTP同期、ストレージ空き）
2. Config配布・起動・自己診断OK確認
3. LED同期→セッション開始
4. 実験終了→自動KPI出力→要件合否判定

---

# 16. 変更管理（設計）

* 閾値・ヒステリシス・滞在時間：**小変更**（ログにバージョン注記）
* interval集合変更・ch_mask可変化：**中〜大変更**（Phase‑2で実施予定）
* IF破壊変更は禁止（後方互換を維持）

---

## 付録A：主要パラメタ一覧（初期値）

| 項目                   | 値                                                                        | 用途                        |
| -------------------- | ------------------------------------------------------------------------ | ------------------------- |
| intervals            | [100, 500, 2000] ms                                                      | 写像用（比較は100/500/1000/2000） |
| thresholds           | up_active=0.70, up_uncertain=0.40, down_active=0.65, down_uncertain=0.35 | ヒステリシス±0.05               |
| min_dwell_sec        | 2                                                                        | 最小滞在時間                    |
| switch_rate_limit_hz | 1                                                                        | 切替頻度制限                    |
| fallback_interval_ms | 1000                                                                     | フォールバック                   |
| har.window_sec       | 1.0                                                                      | 推論窓                       |
| har.overlap          | 0.5                                                                      | 重畳                        |
| har.W_sec            | 10                                                                       | 安定度窓                      |
| ble.ch_mask          | 0b111                                                                    | 3ch固定                     |
| ble.tx_dbm           | 0                                                                        | 固定出力                      |

---

**本設計定義書に従うことで**、Phase‑1の運用で得た写像・ログ・KPIを、Phase‑2/3に**無改造で橋渡し**できます。設計上の差し替え点（Policy Engine, Safety Hook）を明示済みのため、以降の拡張も低コストで可能です。