# フェーズ1 実験運用 Runbook（再現性重視）

## 0. ESP32系スケッチの命名ルール
- 役割別に接頭辞を固定する：受信ロガは `RX_*`, DUT/送信側は `TX_*`, 送信側電力ロガ（PowerLogger/SD書き込み側）は `TXSD_*`。
- 新しいスケッチや派生版を追加する場合は必ずこの接頭辞ルールを守り、既存資料（README, 実験ログ, Runbook）の参照名も同時に更新する。

## 1. 実験前チェック
- NTP同期（ゲートウェイ）／バッテリ残量>80%／電力計校正ログ記録
- 端末・OS・ビルド・スキャン設定（LOW_LATENCY）固定、Doze無効化
- 距離・姿勢を写真で記録（再現用）。E1/E2の時間帯メタを記録

## 2. 条件割付（順序効果の抑制）
- 各セッションの条件順序は Latin 方格で割付
- 固定4条件＋不確実度1条件（計5）を、環境E1/E2で各≥2反復

## 3. 同期・重複除去・評価窓
- 同期: セッション開始時に Sync ADV（seq=0）を1回送信し、LEDを500 ms点灯
- 重複除去: {seq, ts_tx} をキー、判定窓=3×adv_interval。最初の到達を採用
- 評価窓: A/B比較は開始・終了端の0.5 sを除外

## 4. 早期出口（任意、既定OFF）
- 有効化条件（例）: max_softmax≥0.90 かつ 温度スケーリング後≥0.85（Exit‑0）
- 合格基準: 平均t_infがOFF比≥20%短縮、F1低下≤1.0pt、Pout(1 s)/TL p95の劣化が受入基準内
- 速度不足時の縮退: B枝ch数↓ or dilation段削減（C3で顕著な場合）

## 5. P0 校正（推奨）
- 静的/動的3分×2。Arena実測、t_inf（1000反復）、推論のみ/アドバタイズのみ/同時のμC分離
- 取得: Arena_kB, t_inf_ms分布, ベース電流, 校正ログ

## 6. 記録・可視化・受入
- KPI: avg_current, event_charge_uC, PDR, TL（p50/p95）, Pout(τ)
- CI/手元チェック: markdownリンク検査、CSVスキーマ検査（ts単調・値域）
- 併記: 環境ごとに95% CIを併記。P1で{θ_low, θ_high}を確定し、旧{0.40,0.70}を置換

### 6.1 エネルギーKPIとΔE/adv
- 定義: ΔE/adv = (E_ON − E_OFF) / N_adv [mJ/adv] とし、電力評価は原則としてこの指標を主語にする。
- ねらい: 測定系の定常負荷（CPU/I2C/UART/LED等）を相殺し、無線1回あたりの純粋コストを比較可能にする。
- レポート: 平均電流[mA]は補助指標として併記し、ΔE/advとセットで解釈する。

### 6.2 スキャン環境の実務上の注意
- Android: 実験時は `SCAN_MODE_LOW_LATENCY` を原則とし、Doze/App Standby やベンダ独自の省電力機能は無効化する。
- iOS: バックグラウンドでは Duplicate Filtering が強制されるため、連続観測は不可前提とし、前景スキャンまたは接続モードでの観測に限定する。
- Opportunistic Scan: 他アプリのスキャンに合流するため実効スキャンウィンドウは非定常となる。必ず同一端末・同一条件内で A/B 比較を完結させる。

### 6.3 受入基準（品質）
- PowerLogger: parse_drop=0、rate_hz は設計値±10%以内、E_total_mJ 再現性は10分×2反復で±1%以内。
- 受信系: 重複除去窓=3×adv_interval とし、Pout(1 s)・TL p95 の差分が受入基準内かを確認する（95% CIを併記）。
- ログ健全性: ts単調、負値なし、欠損<1%、前処理・設定ハッシュを必須メタとして記録する。

### 6.4 端末別トレースとBlender検証（任意）
- 端末ごとに scan_interval/window の推定トレースを取得し、非理想スキャン条件（Opportunistic Scan含む）を明示する。
- trace-driven の Blender 検証で TL分布・Pout(τ)・Valley Area を事前確認し、ポリシが特定位相で「穴」に落ちないことを確認する。
