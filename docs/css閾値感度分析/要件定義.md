# CCSしきい値感度分析 要件定義

## 1. 概要と位置づけ

- 目的: 「CCS→広告間隔の閾値を変えても、広い範囲で Pout(τ) を壊さず、省電力も維持できる」ことをオフラインシミュレーションで定量化する。
- 役割: Phase 1で確立した閾値ルールの頑健性を示し、Phase 2（Safe Contextual Bandit）の初期ポリシ/可行領域の知見を与えるサブセクション（約0.5〜0.75ページ）として執筆。
- スコープ: 実機再測定なしのシミュレーション限定。入力は mHealth 由来の U,S,CCS 時系列と Phase 0-0 実測の ΔE/adv, PDR。出力は表・図と設計ガイドライン。

## 2. スコープ

| 区分 | 内容 |
|------|------|
| IN | CCS→T_adv 3値写像のしきい値グリッドスイープ（θ_low, θ_high）、Pout(τ)・μC/event 推定、滞在比率の算出、表・ヒートマップ・トレードオフ図の作成 |
| IN | イベント定義（Stationary↔Loc/Trans 遷移）、理想スキャナ + p_d を前提にした遅延モデル、mHealth時系列のみを入力としたオフライン計算 |
| IN | 固定100/2000msのベースライン点との比較、省エネ率算出、Safe-Banditへの示唆（可行領域・sweet spotの提示） |
| OUT | 新規センサーデータ収集、HARモデルの改修、ESP32ファームの更新、Phase 0-1 原本の変更 |
| OUT | Online 学習・Safe-UCB の実装、実機ベンチの再実行、PHY/Tx電力最適化 |

## 3. 研究質問

- RQ1: しきい値を動かすと Pout(τ)–μC のトレードオフはどう変化するか。
- RQ2: Pout(τ) 制約（例: Pout(2s) ≤ 5%）を満たしつつ μC/event を最小化するしきい値領域はどこか。
- RQ3: 最適近傍から θ を ±Δ ずらしても性能が大きく悪化しないロバスト領域はどこか。

## 4. 前提・入力

- コンテキスト: mHealth ベースの U(t), S(t), CCS(t) （サンプリング間隔 Δt = 0.5–1s 想定）。CCS(t) = 0.6 U(t) + 0.4 (1 − S(t))。
- 広告間隔集合: T_adv ∈ {100, 500, 2000} ms。
- エネルギー: Phase 0-0 実測の ΔE/adv から 1広告あたり電荷 q_adv を利用（E2/1m/100ms基準）。μC/event は総消費電荷をイベント数で割る。
- 受信成功率: p_d ≈ 0.85 を下限として Pout(τ | T_adv) ≈ (1 − p_d)^⌊τ / T_adv⌋ を用いる。
- イベント定義: Stationary→(Locomotion|Transition) および (Locomotion|Transition)→Stationary の遷移時刻。ラベルはモードフィルタ等でノイズ除去済み前提。
- 切替ロジック: 解析はヒステリシスなし（純粋なしきい値写像）。実機との差分は考察で補足。

## 5. パラメタ設計

- しきい値グリッド: θ_low ∈ {0.70, 0.75, 0.80, 0.85}, θ_high ∈ {0.82, 0.86, 0.90, 0.94}。制約: θ_high − θ_low ≥ 0.06。想定有効組合せ 12〜14。
- 写像: CCS ≥ θ_high → 100 ms, θ_low ≤ CCS < θ_high → 500 ms, CCS < θ_low → 2000 ms。
- τ: 主報告 2s、補助で 1s/3s を表に掲載（図は 2s 固定）。

## 6. 評価指標・判定

| KPI | 定義/算出 | 判定・読み方 |
|-----|-----------|-------------|
| Pout(τ) | P(TL > τ)、理想スキャナ + p_d で τ ∈ {1,2,3}s | 2sで ≤5% を主条件とし、固定100ms同等以下を目標 |
| μC/event | 総電荷 / イベント数（q_adv × N_adv / N_event） | 固定100ms比で削減率を算出 |
| 滞在比率 | time@100/500/2000 [%] | 閾値が実質どの領域を選ぶかの直感を与える |
| 省エネ率 | 1 − μC/μC_fixed100 | 図2のカラー軸に利用 |

## 7. 成果物

- 表: (θ_low, θ_high) ごとの KPI（μC/event, Pout(τ), time@各間隔）。
- 図1: Pout–μC 散布図（固定100/2000ms点と Pout 制約線付き）。
- 図2: しきい値平面ヒートマップ（省エネ率）。必要なら Pout(2s) の別図。
- テキスト: ロバスト領域の言語化（θ を ±0.05 動かしても許容内、など）、Safe-Bandit での初期アーム候補の提案。
- 納め先: 本ディレクトリ配下のドラフト（論文の subsection 素材）＋図表のPNG/SVG。

## 8. 手順フロー（実装不要の計算タスク）

1. mHealth 時系列読み込み・イベント抽出（Stationary↔Loc/Trans 遷移）。
2. しきい値グリッド生成 → CCS→T_adv(t) シーケンス生成。
3. 各ペアで広告回数 N_adv を積算し μC/event を計算。
4. 各ペアで TL_j を計算し Pout(τ) を推定（理想スキャナ+p_d）。
5. KPI 集計表を作成し、図1・図2を描画。
6. 結果を文章化し、固定100/2000msとの比較と設計ガイドラインを記述。

## 9. リスク・依存

- q_adv, p_d の代表値が Phase 0-0 条件（E2/1m/100ms）に依存。条件差異は感度分析または補足で明記。
- mHealth ラベルのバイアスで滞在比率が極端になる可能性。必要なら分位ベースのしきい値設定を補助として検討。
- ヒステリシスを無視しているため、実機挙動との差異は考察で補足。
- Phase 0-1 原本（docs/フェーズ0-1/）は参照専用。派生は本ディレクトリで管理。

## 10. マイルストン（目安）

- M1: データ読み込み・イベント抽出完了
- M2: しきい値グリッド計算・KPI表生成
- M3: 図1/図2 完成
- M4: サブセクション草案作成（本章への編入準備）
