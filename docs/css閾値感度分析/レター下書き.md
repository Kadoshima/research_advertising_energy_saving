## X.Y CCSしきい値の感度分析

### X.Y.1 目的と位置づけ

本節の目的は，HAR 推論から導出される複合スコア CCS (Composite Confidence–Stability Score) を用いた BLE アドバタイズ間隔制御において，**しきい値 (\theta_{\text{low}}, \theta_{\text{high}})** の選び方が QoS 指標 (P_{\mathrm{out}}(\tau)) とエネルギー指標 (\mu C/\mathrm{event}) に与える影響を，**オフラインで体系的に評価すること**である。

本研究の要件定義では，CCS は確信度（(1-U)）と安定度 S の線形結合として定義され，HAR→ポリシ→BLE 制御のインタフェースを貫く共通指標として位置付けられている。また，Phase 1 の機能要件では，BLE 側の KPI として初回到達遅延 TL，期限超過率 (P_{\mathrm{out}}(\tau))（\tau=1/2/3\ \mathrm{s}），イベント電荷 (\mu C/\mathrm{event}) が明示されている。

これらを踏まえ，本節では

* アプリ層（HAR）の不確実性 U/S → CCS → BLE 間隔 adv_interval
* adv_interval → (P_{\mathrm{out}}(\tau)), (\mu C/\mathrm{event})

という因果チェーンを，mHealth データセットとフェーズ0-0の電力・PDRベースラインに基づく**数値シミュレーションで接続する。**本節の結果は，次節の HIL 実験で用いる「代表的なしきい値ペア」の選定根拠であると同時に，将来的な Safe Contextual Bandit における**制約付き報酬設計の設計空間**を示すものとなる。

---

### X.Y.2 解析条件と設計選択

#### (1) CCS 定義と時間分解能

CCS は要件定義に従い，HAR 出力の確信度と安定度から次式で定義する。

[
\mathrm{CCS}(t) = 0.7\,(1-U(t)) + 0.3\,S(t) \in [0,1]
]

* 不確実度 U(t)：K クラスの事後確率 p_k(t) からのエントロピー正規化
  [
  U(t) = -\frac{\sum_k p_k(t)\log p_k(t)}{\log K}
  ]
* 安定度 S(t)：直近 W 秒のラベル遷移回数 n_{\mathrm{trans}} から
  [
  S(t) = 1 - \min\!\left(1, \frac{n_{\mathrm{trans}}}{W}\right)
  ]

HAR 推論は mHealth データセットの胸部 IMU に対して，窓長 1.0 s，50% オーバラップで実行し，0.5 s ごとに CCS を評価する。

#### (2) しきい値グリッドの設計

決め打ち写像（ACTIVE/UNCERTAIN/QUIET）は，CCS を 3 区間に分割し，それぞれ adv_interval \in \{100, 500, 2000\}\,\mathrm{ms} に対応付ける。

[
\mathrm{CCS}(t) =
\begin{cases}
\ge \theta_{\mathrm{high}} &\Rightarrow T_{\mathrm{adv}}(t) = 100\,\mathrm{ms}\\
\in [\theta_{\mathrm{low}}, \theta_{\mathrm{high}}) &\Rightarrow T_{\mathrm{adv}}(t) = 500\,\mathrm{ms}\\
< \theta_{\mathrm{low}} &\Rightarrow T_{\mathrm{adv}}(t) = 2000\,\mathrm{ms}
\end{cases}
]

要件定義では，旧しきい値 \{0.40, 0.70\} を出発点とし，HAR 側の ROC/PR 解析に基づき新しい (\theta_{\mathrm{low}},\theta_{\mathrm{high}}) を決定することが合意されている。しかし，本研究の HAR モデルに対する mHealth ベースの CCS 分布を実際に観測すると，

* CCS の主分布は 0.7〜0.95 付近に集中し，
* 0.4 未満の領域はほとんど出現しない，

という事実が確認された（詳細は実験ログ参照）。これは，**実際の運用では「QUIET（2000ms）」と「ACTIVE（100ms）」の境界が 0.4/0.7 よりも高い領域に移動している**ことを示唆する。

そこで，本節の感度分析では，HAR 側の ROC/PR 解析で得られる最適しきい値の周辺をカバーするように，以下のグリッドを定義する。

* \theta_{\mathrm{low}} \in \{0.70, 0.75, 0.80, 0.85\}
* \theta_{\mathrm{high}} \in \{0.82, 0.86, 0.90, 0.94\}
* 制約：\theta_{\mathrm{high}} \ge \theta_{\mathrm{low}} + 0.06

このレンジは，

1. 旧設定 \{0.40, 0.70\} を大きく逸脱せず，
2. 実測の CCS 分布の中心（約 0.8〜0.9）を含み，
3. ROC/PR 解析で得られる最適しきい値（Validation 上の F1 最大点）の ±0.05〜0.1 をカバーする

という 3 条件を満たすように選定している（HAR 要件定義の「温度スケーリング＋ROC/PR によるしきい値決定」設計と整合）。

#### (3) ヒステリシスの扱い

実機ポリシ・エンジンは，CCS のノイズによる振動を抑制するため，ヒステリシス（閾値±0.05）と最小滞在時間 2 s を持つ仕様となっている。一方，本節の感度分析では，しきい値自体の影響を純粋に捉えるために，

* 解析モデルではヒステリシスを無効化し，
* 各 0.5 s サンプルについて CCS の値だけに基づき即時に T_{\mathrm{adv}} を切り替える

という簡約化を行う。この選択により，(\theta_{\mathrm{low}},\theta_{\mathrm{high}}) のみによる Pout–\mu C の変化を可視化しやすくなり，実装側のヒステリシス設計とは独立に解析結果を再利用できる。実機評価節では，「解析はヒステリシス無しモデル，実装はヒステリシスあり」であることを明示し，差分は「切替頻度の抑制」として定性的に議論する。

---

### X.Y.3 解析アルゴリズム

感度分析の処理パイプラインを，以下の 4 段階に整理する。

#### Step 1: CCS 時系列の生成

1. mHealth データセットの胸部センサから，全被験者に対して IMU 窓（1.0 s，50% 重畳）を生成する。
2. Phase0-1 で学習・較正した DSCNN ベース HAR モデルを適用し，各窓のクラス確率 p_k(t) を得る。
3. エントロピー正規化から不確実度 U(t) を計算し，ラベル遷移カウントから安定度 S(t) を算出する。
4. 上記より CCS(t) を算出し，0.5 s ごとの時系列として保存する。

#### Step 2: しきい値グリッドの適用

各しきい値ペア (\theta_{\mathrm{low}},\theta_{\mathrm{high}}) について：

1. CCS(t) に対して前述の決め打ち写像を適用し，T_{\mathrm{adv}}(t) \in \{100, 500, 2000\}\,\mathrm{ms} の時系列を生成する。
2. 解析上はヒステリシス無しとし，CCS の変動がそのまま interval シーケンスの変動として反映される。

#### Step 3: エネルギーと Pout の推定

エネルギー側は，Phase0-0 の実測イベント電荷を再利用する。

* 3チャネル広告 1 イベントあたりの電荷 q_{\mathrm{adv}} を固定値（フェーズ0-0 での \Delta E/adv から推定）とし，各区間の平均イベント電荷 \mu C(a) を adv_interval に応じて割り当てる。
* 各しきい値ペアについて，観測された interval シーケンス T_{\mathrm{adv}}(t) の時間割合をもとに，
  [
  \overline{\mu C/\mathrm{event}} = \sum_a w_a \,\mu C(a)
  ]
  を計算する（w_a は interval a の出現時間比率）。

Pout 側は，Phase0-0で得られている PDR から 1イベント成功確率 p_d を推定し，簡約モデルとして幾何分布に基づく遅延分布を用いる。

* 各 interval a に対して，
  [
  P_{\mathrm{out}}(\tau \mid a) \approx (1-p_d)^{\lfloor \tau / a \rfloor}
  ]
* しきい値ペアに対する P_{\mathrm{out}}(\tau) は，同様に interval 出現比率で重み付けした
  [
  P_{\mathrm{out}}(\tau) = \sum_a w_a \,P_{\mathrm{out}}(\tau \mid a), \quad \tau \in \{1,2,3\}\,\mathrm{s}
  ]

このモデルは BLE スキャナの非理想性（チャネルホッピングやスキャン周期性）を無視した理想化であるが，「しきい値変更が Pout–\mu C トレードオフ曲線をどの方向へ押し動かすか」という一階的な感度を把握するには十分と判断した。

#### Step 4: 指標の集約と Pareto フロンティア

すべてのしきい値ペアについて (\overline{\mu C/\mathrm{event}}, P_{\mathrm{out}}(\tau)) を計算し，

* 横軸：\overline{\mu C/\mathrm{event}}（小さいほど良い）
* 縦軸：P_{\mathrm{out}}(\tau)（小さいほど良い）

の 2 次元平面上にプロットする。各 \tau=1/2/3\ \mathrm{s} について別々に図を描き，Pareto 劣解に支配されない点の集合を Pareto フロンティアとして抽出する。このフロンティア上から，

* 省エネ寄りの設計点（「攻め」のしきい値）
* QoS 寄りの設計点（「守り」のしきい値）
* 両者のバランス点（本研究で実機実験に用いる代表ペア）

の 3 点を選択し，次節の HIL 実験で検証する。

---

### X.Y.4 この節の意図と限界

本節の設計は，あくまで **「しきい値そのものの感度」を分離して評価するためのオフライン解析**である。

* 実機システムでは，U/S のノイズや Android スキャナの非理想性により，ここで用いた単純な幾何モデルからの乖離が生じることは想定済みである。
* しかし，Phase0-0 で確立した BLE イベント電荷リファレンスと PDR ベースラインを再利用することで，**「HAR 側の閾値変更が BLE 層の KPI にどの程度影響しうるか」を手元のデータだけで素早くスキャンできる**という利点がある。

また，しきい値グリッドを明示的に定義し，その上で Pareto フロンティアを抽出することで，

* 後続の Safe Contextual Bandit では，このフロンティア上の点を「安全側アーム集合」として利用し，
* 学習は「フロンティア内での重み付け（どのしきい値ペアをどの頻度で選ぶか）」に集中させる，

という形の段階的設計（決め打ち方策 → Safe-MAB）へ自然に接続できる。

---

### （メタコメント）

* 解析側は **「グリッドスイープ＋ヒステリシス無し」**でスッキリしつつ，実装側のヒステリシス 2s・±0.05 は「ノイズ抑制の実務的工夫」として別節に逃がせる。
* 要件定義に書いてある「ROC/PRで (\theta_{\text{low}},\theta_{\text{high}}) を決める」「Pout(1/2/3s) を KPI とする」と接続している。
* もし代表3点 P1–P3 で十分と判断した場合は，Step 2 のグリッド定義と Step 4 の Pareto 抽出を代表点列挙に置き換えるだけで済む。
