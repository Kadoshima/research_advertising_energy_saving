<repomix>This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.
The content has been processed where content has been formatted for parsing in xml style.<file_summary>This section contains a summary of this file.<purpose>This file contains a packed representation of the entire repository&apos;s contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.</purpose><file_format>The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
4. Repository files, each consisting of:
  - File path as an attribute
  - Full contents of the file</file_format><usage_guidelines>- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.</usage_guidelines><notes>- Some files may have been excluded based on .gitignore rules and Repomix&apos;s configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: 修士論文/**, logs/worklog_2025-12-15_thesis_setup.txt, logs/worklog_2025-12-15_letter_route.txt, logs/worklog_2025-12-13_stress_fixed_metrics_v5.txt, docs/全体像.md, docs/metrics_definition.md, docs/decision_log_2025-12-13_letter_route.md
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Content has been formatted for parsing in xml style
- Files are sorted by Git change count (files with more changes are at the bottom)</notes><additional_info></additional_info></file_summary><directory_structure>docs/
  decision_log_2025-12-13_letter_route.md
  metrics_definition.md
  全体像.md
修士論文/
  chapters/
    acknowledgements.tex
    appx_a_metrics.tex
    appx_b_assets.tex
    appx_c_results.tex
    appx_d_log_schema.tex
    appx_e_runbook.tex
    appx_f_symbols.tex
    appx_g_troubleshooting.tex
    appx_h_ccs_params.tex
    ch0_introduction.tex
    ch1_background.tex
    ch10_implementation.tex
    ch2_background_related.tex
    ch2_proposed.tex
    ch2_related_work.tex
    ch3_oncampus.tex
    ch3_system_and_method.tex
    ch3_system_design.tex
    ch4_measurement_metrics_repro.tex
    ch4_rain.tex
    ch5_evaluation.tex
    ch5_publicroad.tex
    ch6_stress_fixed.tex
    ch7_offline_eval.tex
    ch8_experiment_design.tex
    ch8_measurement_system.tex
    ch9_har_uncertainty.tex
    conclusion.tex
  figures/
    README.md
  frontmatter/
    abstract.tex
  .gitignore
  chubuthesis.sty
  latexmkrc
  main.tex
  meta.tex
  README.md
  references.bib
  WRITING_RULES.md</directory_structure><files>This section contains the contents of the repository&apos;s files.<file path="docs/全体像.md"># ReFormHAR-Tiny: Vision / World Model

&gt; **現在地 (2025-11-30)**: Phase 0-0 ベースライン計測中。ON計測（100/500/1000/2000ms自動遷移）実行中、Group 4 (2000ms) 進行中。配線修正・SYNC信号修正完了。次ステップ: 計測完了後のデータ解析 → Phase 1 CCS制御実装へ。

本ドキュメントは、**ReFormHAR-Tiny** プロジェクトの研究ビジョンと世界観を体系的に記述する。
他のAI・研究者がプロジェクトの方向性を正しく理解し、一貫した判断ができるようにすることを目的とする。

---

## 0) 研究ビジョンの階層構造

### Phase 1: 今回のレター（短期目標）

&gt; **「Safe Contextual Banditの前段階として、決め打ちルールの実装と評価指標の確立」**

**位置づけ**:
- Safe-MABの「warm-start用ベースライン」を作る
- 評価指標（Pout(τ), μC）の測定系を確立する
- 単純なルールでも「効果がある」ことを示し、将来の学習ベース手法の土台を作る

**主張**:
&gt; 「HAR不確実度に基づくBLE広告間隔の適応制御において、単純な閾値ルールでも固定間隔と比較して省電力効果が得られることを示した。提案手法は、将来のSafe Contextual Banditによるオンライン最適化の基盤となる。」

**レターに含めるもの**:
1. 問題定式化: Pout(τ)制約下でのエネルギー最小化問題
2. 評価指標: Pout(τ), μC/eventの定義と測定方法
3. 決め打ちルール: CCS→T_adv写像の実装
4. 実験評価: 固定100ms / 固定2000ms / CCS制御の比較
5. Future Work: Safe Contextual Banditへの拡張

**レターに含めないもの（Future Work）**:
- MAB/RLの学習アルゴリズム
- 非理想スキャンのモデリング
- HAR誤認識の統合評価（RoME）

### Phase 2: 研究テーマ（修論〜博士前期）

&gt; **「HAR不確実度を活用したBLE広告のSafe Contextual Bandit最適化」**

**問題定式化**:
- **コンテキスト**: HAR推論の不確実度 U、安定度 S
- **行動（Arm）**: 広告間隔 T_adv ∈ {100, 500, 1000, 2000ms}
- **報酬**: −μC（エネルギー最小化）
- **制約**: Pout(τ) ≤ δ（QoS保証）

**新規性**:
1. HAR不確実度をContextual Banditの「コンテキスト」として初めて使用
2. Pout(τ)を「制約」として扱うSafe Bandit定式化
3. アプリ層（HAR）→通信層（BLE）のクロスレイヤー最適化

### Phase 3: 究極のゴール（5-10年スパン）

&gt; **「アプリ層のセマンティクスが通信層を自律制御する、エッジAIの新しいパラダイム」**

- TinyMLデバイスが「今この瞬間、どれだけ確信を持っているか」を通信スタックに伝える
- 通信層は、そのセマンティクスに応じてリソース配分を動的に変える
- 人間の介入なく、デバイスが自律的に「省電力」と「QoS保証」を両立する

---

## 1) World Model（世界観の骨格）

### 1.1 役者（Actors）

| Actor | 役割 | 備考 |
|-------|------|------|
| **Edge Node / DUT** | IMU＋MCUでHARをオンデバイス推論。U, S, CCSを生成しBLE広告を制御 | ESP32-S3/C3想定 |
| **Gateway（スマホ/受信機）** | BLE広告の受信主体。スキャンは非理想（チャネル巡回・隙間・モード差） | Android LOW_LATENCY |
| **Observer / Orchestrator** | ログ収集、KPI算出。クラウド常時接続は不要 | 実験・運用時 |
| **Safety Oracle（概念）** | QoS制約（Pout(τ) ≤ δ）を定義。方策が守るべき境界 | 規格書的存在 |
| **Policy Engine** | 通信層の意思決定器。Phase 1はルール、Phase 2でSafe-MAB | 段階的進化 |

### 1.2 能力（Capabilities）— 5つの柱

1. **Perception（知覚）**: IMU → HAR → 確率分布 (p_k) → U（不確実度）、S（安定度）
2. **Decision（意思決定）**: CCS をコンテキストに BLE広告間隔を決定
3. **Communication（通信）**: μC/event最小で、Pout(τ)制約を満たす広告
4. **Safety（安全）**: 常時 Pout(τ) ≤ δ を満たす制約の中で最適化。違反兆候で安全側へ退避
5. **Observability（可観測性）**: すべての意思決定に根拠ログ（U, S, CCS, 閾値, 切替理由）を残す

### 1.3 不変条件（Invariants）

- **オンデバイス優先**: 生センサは外に出さない（プライバシ）
- **QoS優先の最適化**: Pout(τ) を常に制約として扱い、その範囲内で電力最小化
- **後方互換のIF**: `decide_interval(context) → interval` のIFは固定（将来MAB/Safe-MABでも同じ）
- **単一真実のKPI**: μC/event、Pout(τ)、TL分布を一次指標。平均電流やmWh/日は従属

### 1.4 境界条件（Operating Envelope）

- **MCU制約**: RAM ≤ 256KB / Flash ≤ 1MB、INT8演算前提
- **BLE制約**: Legacy Advertising、3ch（37/38/39）、Tx/EIRPとDutyは地域規制遵守
- **受信制約**: スマホは連続スキャンではない（モードで挙動が変化）。理想化しない

---

## 2) Ontology（用語・データ辞書）

### 2.1 概念・変数

| 変数 | 定義 | 範囲 |
|------|------|------|
| **(p_k)** | HARのクラス確率 | Σp_k = 1 |
| **U** | 正規化エントロピー（不確実度） | [0, 1] |
| **S** | 安定度（遷移が少ないほど1に近い） | [0, 1] |
| **confidence** | 1 − U | [0, 1] |
| **CCS** | Composite Confidence Score = 0.7×confidence + 0.3×S | [0, 1] |
| **T_adv / Arm** | 広告間隔。Phase 1: {100, 500, 1000, 2000}ms | ms |
| **TL** | Time-to-first-Receive。イベント検知→初回受信までの遅延 | ms |
| **Pout(τ)** | Outage probability。期限τ内に初回受信できない確率 | [0, 1] |
| **μC/event** | 広告イベント1回あたりの電流積分 | μC |

### 2.2 CCS定義の根拠と感度分析

**採用定義**: CCS = 0.7 × (1 − U) + 0.3 × S = 0.7 × confidence + 0.3 × S

**根拠**:
1. **変数名との整合性**: CCS = Composite Confidence Score。高い値が「確信がある」という解釈と一致
2. **Safe Banditとの整合性**: CCS高い → 確信あり → 長い間隔OK → 省電力。単調な写像で直感的
3. **論文での説明容易性**: &quot;Higher CCS indicates the system can safely extend advertising intervals.&quot;
4. **主成分の重視**: 推論の確信度（confidence）を0.7、時間的安定性（S）を0.3で補助的に扱う

**係数の選択**:
- α=0.7, β=0.3 は経験的初期値
- confidence（瞬時の推論品質）を主成分とし、stability（時間的一貫性）を補助とする設計意図

**感度分析（Future Work）**:
- 係数 (α, β) の変動が KPI（μC, Pout(τ), TL_p95）に与える影響を評価
- 候補: (0.8, 0.2), (0.7, 0.3), (0.6, 0.4), (0.5, 0.5)
- 評価方法: 同一実験データに対して係数を変えた場合の省電力効果とQoS劣化のトレードオフを可視化
- 最適係数はアプリケーション依存（QoS重視 vs 省電力重視）であり、ユースケース毎に調整可能とする

### 2.3 ログスキーマ

| ログ種別 | 主キー |
|----------|--------|
| **Tx** | `t, session_id, adv_interval, ch_mask, tx_dbm, state, U, S, CCS, reason` |
| **Rx** | `t, session_id, phone_model, scan_mode, rx_uuid, rssi, dedup_flag` |
| **Power** | `t, current_mA, voltage_V, event_marker` |
| **KPI** | `avg_current, event_charge_uC, TL_p50, TL_p95, Pout_1s/_2s/_3s, PDR` |

&gt; すべて列追加で拡張可能（後方互換）。将来のMAB拡張時に `arm, reward, context` 列を追加。

---

## 3) 研究の段階（Phases）

### Phase 1: Rule-based（今回のレター）

| 項目 | 内容 |
|------|------|
| **何をするか** | CCSで adv_interval を切替（100/500/1000/2000ms）。ヒステリシス＋滞在時間で安定化 |
| **なぜ意味があるか** | μC/eventと平均電流を削減しつつ、Pout(τ)・TLが基準と同等であることを示せる |
| **成果物** | 評価指標の確立、warm-start用ベースライン、KPIパイプライン |
| **残る課題** | 環境・端末依存性を考慮できない。最適点は状況で変わる |

### Phase 2: Safe Contextual Bandit（修論テーマ）

| 項目 | 内容 |
|------|------|
| **何をするか** | コンテキスト=(U,S)、腕=T_adv、報酬=−μC、制約=Pout(τ)≤δ のSafe Bandit |
| **なぜ意味があるか** | 環境ごとに最適点へ自律収束しつつ、QoS保証を維持 |
| **アルゴリズム候補** | Conservative UCB, SafeOpt, Constrained Thompson Sampling |
| **残る課題** | 先験情報（端末スキャン挙動）の活用、学習初期の後悔 |

### Phase 3: Semantic-driven Communication（長期ビジョン）

| 項目 | 内容 |
|------|------|
| **何をするか** | アプリ層のセマンティクス（確信度、緊急度、価値）が通信層を自律制御 |
| **なぜ意味があるか** | 人間介入なしで省電力とQoS保証を両立。エッジAIの新パラダイム |
| **発展方向** | 知識蒸留によるwarm-start、マルチデバイス協調、アプリ横断の優先度制御 |

---

## 4) 価値の地図（Value Map）

### 4.1 定量KPI

| 区分 | KPI |
|------|-----|
| **一次（Primary）** | μC/event, Pout(τ), TL_p95 |
| **二次（Secondary）** | 平均電流, mWh/日, PDR, F1/Acc |
| **複合（Composite）** | J/decision（1検出あたりエネルギ）, QoS違反率 |

### 4.2 ユースケース枠

| ユースケース | 要件 |
|--------------|------|
| **見守り**（転倒・無動作） | 偽陰性 &lt; 偽陽性、Pout(2s) ≪ δ |
| **労働安全**（急変姿勢通知） | TL_p95 ≤ 500ms、電池寿命30日↑ |
| **スポーツ**（フォーム変化検知） | 遷移期だけ濃く、安定期は薄く |

---

## 5) ガバナンス（Governance Model）

- **規格準拠**: BLE広告・出力規制・Duty規制の上限はPolicyが越えない
- **安全網**: QoS違反兆候 → 安全側へ退避（短間隔×3ch固定）
- **説明責任**: 各ラウンドの Decision Rationale は不可欠ログ
- **データ最小化**: ログは匿名化。生IMUは外に出さない
- **監査可能性**: 実験再現用の Runbook と KPIパイプラインを常備

---

## 6) リスク &amp; フェイルセーフ

| リスク | 兆候 | フェイルセーフ | 恒久対策 |
|--------|------|----------------|----------|
| QoS違反（Pout上昇） | TL分布が右シフト | 短間隔×3ch | Safe-MABの制約強化 |
| 受信端末差 | PDR低下・端末依存 | 端末切替/再起動 | 端末別事前重み |
| 切替振動 | 切替頻発ログ | ヒステリシス/滞在時間 | U/S較正、窓W調整 |
| 学習初期の後悔 | 違反スパイク | Warm-Start | 知識蒸留（禁止腕/初期重み） |

---

## 7) ロードマップ

```
Phase 1 (レター)          Phase 2 (修論)           Phase 3 (長期)
─────────────────────────────────────────────────────────────────
決め打ちルール実装    →   Safe Contextual Bandit  →  Semantic-driven
評価指標確立              Pout(τ)制約保証             Communication
warm-startベースライン    環境適応学習                 マルチデバイス協調
```

---

## 8) 要約（AIが誤読しないための短文仕様）

- **Goal**: Pout(τ)を守りながら、μC/eventを最小化（端末内完結）
- **Signals**: U ∈ [0,1], S ∈ [0,1], CCS = 0.7×(1−U) + 0.3×S
- **Policy IF（不変）**: `context(U, S, CCS) → interval`（将来Safe-MABでも同じ）
- **KPI（一次）**: μC/event, Pout(τ), TL_p95
- **Safety**: Pout(τ) ≤ δ を制約として常時満たす（Phase 2以降）
- **Fallback**: いつでも `interval=短/3ch` に退避可
- **Logs**: Decision Rationale を毎切替で出力
- **Growth**: Phase 1（ルール）→ Phase 2（Safe Bandit）→ Phase 3（セマンティック制御）

---

## 9) 参考リソース

- **TinyML**: A Comprehensive Survey on TinyML
- **BLE受信の非理想性**: スキャン挙動の実機観測・モデル化
- **HAR省電力**: システム最適化の俯瞰

&gt; これらは世界観の根拠としての役割を持つ。必要に応じてKPI式・閾値・境界条件を抽出。

---

*Last updated: 2025-11-30*</file><file path="修士論文/chapters/acknowledgements.tex">% chapters/acknowledgements.tex --- 謝辞（番号なし、目次には載せる）
\chapterwithtoc{謝辞}

本研究を進めるにあたり，ご指導・ご助言を賜った指導教員の先生方に深く感謝申し上げる．また，実験環境の整備や議論にご協力いただいた研究室の皆様に感謝する．最後に，研究活動を支えてくれた家族に感謝する．</file><file path="修士論文/chapters/appx_a_metrics.tex">% chapters/appx_a_metrics.tex --- 付録A 指標定義（詳細）
\section{指標定義（詳細）}
\label{sec:metrics_detail}

本節では，本研究で用いる主要指標の定義をまとめる．本文では要点のみ述べ，詳細はここに集約する．

\subsection{PDR}
PDRは，広告イベント数に対して受信できた割合である．重複受信がある場合，単純な受信行数に基づくPDRは1を超える可能性があるため，seq等でユニーク化した指標も併記する．

\subsubsection{定義}
本研究では，広告イベント数（分母）を$N_{\mathrm{adv}}$，受信ログ行数（重複含む）を$N_{\mathrm{rx}}$，seqでユニーク化した受信数を$N_{\mathrm{rx,uniq}}$とする．
\begin{equation}
  \mathrm{PDR}_{\mathrm{raw}} = \frac{N_{\mathrm{rx}}}{N_{\mathrm{adv}}},\qquad
  \mathrm{PDR}_{\mathrm{unique}} = \frac{N_{\mathrm{rx,uniq}}}{N_{\mathrm{adv}}}
\end{equation}
$\mathrm{PDR}_{\mathrm{raw}}$は重複受信により1を超え得るため，到達性の比較（QoS用途）では$\mathrm{PDR}_{\mathrm{unique}}$を優先する．

\subsubsection{分母（広告イベント数）の扱い}
広告イベント数$N_{\mathrm{adv}}$は，可能な場合はTICKにより物理カウントした値を正とする．TICKが利用できない場合は，試行時間と広告間隔から期待回数を推定するが，動的切替では誤差が入り得るため，解釈には注意する．

\subsection{TLとPout(τ)}
TLは，イベント後に最初に受信されるまでの遅延である．Pout(τ)は，TLが期限$\tau$を超える確率として定義する．TL/Poutの算出では，受信ログの時間軸と真値（truth）の時間軸の一致が必要であり，開始位相ずれがある場合は定数オフセットで補正する（\secref{sec:stress_fixed_metrics}）．

\subsubsection{イベントと遅延}
真値（truth）における状態遷移（イベント）時刻を$t_{\mathrm{event},j}$，その後に初めて正しいラベル（または該当イベントに対応する識別子）が受信される時刻を$t_{\mathrm{rx},j}$とすると，
\begin{equation}
  \mathrm{TL}_j = t_{\mathrm{rx},j} - t_{\mathrm{event},j}
\end{equation}
である．期限$\tau$に対する期限超過率は，
\begin{equation}
  P_{\mathrm{out}}(\tau)=\frac{1}{N_{\mathrm{event}}}\sum_{j=1}^{N_{\mathrm{event}}}\mathbb{I}[\mathrm{TL}_j&gt;\tau]
\end{equation}
で定義する．

\subsubsection{時間同期（定数オフセット補正）}
実機ログでは，RXログの開始が遅れる等の理由で，RXログの時間軸とtruthの時間軸が定数だけずれている場合がある．固定間隔リプレイ（seqが単調増加）を前提に，次の定数オフセットで補正する．広告間隔を$\Delta t$（ms），RXログにおけるseqの初回観測時刻を$\mathrm{first\_ms}(\mathrm{seq})$とすると，
\begin{equation}
  \mathrm{offset\_ms} = \mathrm{median}_{\mathrm{seq}&gt;0}\left(\mathrm{seq}\cdot\Delta t - \mathrm{first\_ms}(\mathrm{seq})\right)
\end{equation}
として推定し，$\mathrm{ms\_aligned}=\mathrm{ms}+\mathrm{offset\_ms}$で補正した時刻を用いてTL/Poutを計算する（\secref{sec:stress_fixed_metrics}）．

\subsubsection{末端遷移と有効長}
試行時間がtruthの全長より短い場合，末端の遷移が試行区間外に出る．この場合，評価対象のイベント数が試行ごとに変化し，Poutの分母が揺れる．本研究では，TX側のクランプ長と同様にtruth側も有効長（EFFECTIVE\_LEN）でクリップし，イベント抽出範囲を揃える．

\subsection{電荷と$q_{\mathrm{event}}$（$\si{\micro\coulomb}/\text{event}$）}
本研究の一次KPIである$q_{\mathrm{event}}$は，セッション中の電荷消費をイベント数で正規化した指標である．電力やエネルギーは電圧に依存するため，バッテリ消費の観点では電荷（Coulomb count）で整理すると解釈が容易である．

\subsubsection{総電荷（Coulomb count）}
電流を$I(t)$とすると，総電荷$Q$は
\begin{equation}
  Q=\int I(t)\,dt
\end{equation}
で定義できる．TXSDログでは電流が$\mu$A，時刻がmsで記録されるため，離散近似として
\begin{equation}
  Q_{\si{\micro\coulomb}} \approx \sum_{i} I_{\si{\micro\ampere},i}\cdot \frac{\Delta t_{\si{\milli\second},i}}{1000}
\end{equation}
により$\si{\micro\coulomb}$単位の電荷を算出できる．

\subsubsection{基準補正（ON/OFF差分）}
計測系の定常負荷（ロギング，LED等）が大きい場合，広告間隔による差分が総電荷に埋もれる．このため，広告ONとOFFの差分
\begin{equation}
  \Delta Q = Q_{\mathrm{on}}-Q_{\mathrm{off}}
\end{equation}
を用いて，広告による増分を評価する．OFF計測では，sleep状態や無線スタック状態がONと一致するよう，同一コード系列で条件を固定する必要がある（\secref{sec:runbook}）．

\subsubsection{イベント当たり電荷（$\si{\micro\coulomb}/\text{event}$）}
TL/Poutの評価起点となるイベント数を$N_{\mathrm{event}}$とすると，
\begin{equation}
  q_{\mathrm{event}}=\frac{\Delta Q}{N_{\mathrm{event}}}
\end{equation}
で定義する．$\Delta Q$の代わりに$Q_{\mathrm{on}}$を用いる場合は，基準補正が入らないため，条件間比較の解釈に注意する．

\subsection{平均電力とエネルギー}
平均電力は，試行期間における総エネルギーを時間で割ることで算出する．ログの生データ（mV/µA）から再積分した値と，summaryの整合を監査することで，単位換算や欠損による誤差を抑制する．

\subsubsection{逐次積分}
TXSDログで得られる電圧$V(t)$と電流$I(t)$から瞬時電力$P(t)=V(t)I(t)$を算出し，サンプリング間隔$\Delta t$で逐次積分することで総エネルギー$E$を求める．実装では，単位の一貫性（mV，$\mu$A，ms等）を保つため，生ログから後処理で再計算できる形にし，summaryとの差分を監査する．

\subsubsection{差分指標（ON-OFF）}
計測系の定常負荷が大きい場合，広告間隔による差分が平均電力に埋もれる．そのため，広告ONとOFFの差分$\Delta E=E_{\mathrm{on}}-E_{\mathrm{off}}$を広告イベント数$N_{\mathrm{adv}}$で正規化した$\Delta E/N_{\mathrm{adv}}$を併用し，「無線1回当たりの増分」として評価する．</file><file path="修士論文/chapters/appx_b_assets.tex">% chapters/appx_b_assets.tex --- 付録B 実験資産一覧（ファイル・ディレクトリ）
\section{実験資産一覧}
\label{sec:assets}

\subsection{図の管理}
図は原則として\texttt{\detokenize{修士論文/figures/}}に集約し，本文から拡張子なしで参照する．本リポジトリでは，既存の解析結果図を相対パスで参照している箇所もあるため，提出用に固める際は\texttt{\detokenize{figures/}}へコピーしてパスを固定する．

\subsection{主要な出力先（例）}
\begin{itemize}
  \item 固定間隔の電力テーブル：\texttt{\detokenize{results/mhealth_policy_eval/power_table_sleep_eval_2025-12-14_interval_sweep_sleep_on_n9_10.csv}}
  \item オフライン評価（δ帯）：\texttt{\detokenize{results/mhealth_policy_eval/letter_v4_scan90_v5_delta_tight_sleep_on_n9_10_actions_100_500/}}
  \item ストレス固定（v5図）：\texttt{\detokenize{results/stress_fixed/figures_v5/}}
\end{itemize}

\subsection{実機評価（例：D2）}
実機の動的切替の例として，D2（scan90）では次のディレクトリ構成でログと指標を管理する．
\begin{itemize}
  \item 実験ルート：\texttt{\detokenize{uccs_d2_scan90/}}
  \item 入力（RX）：\texttt{\detokenize{uccs_d2_scan90/data/RX/}}
  \item 入力（TXSD）：\texttt{\detokenize{uccs_d2_scan90/data/TX/}}
  \item 出力（指標）：\texttt{\detokenize{uccs_d2_scan90/metrics/01/summary.md}}
\end{itemize}

\subsection{解析スクリプト（例）}
解析は，1回で完結する巨大スクリプトではなく，「trial集計」「集約」「図表化」に分割して再現可能にする．代表例を以下に示す．
\begin{itemize}
  \item ストレス固定（trial集計）：\texttt{\detokenize{scripts/analyze_stress_causal_real.py}}
  \item ストレス固定（集約）：\texttt{\detokenize{scripts/aggregate_stress_causal_real_summary.py}}
  \item ストレス固定（v5図生成）：\texttt{\detokenize{scripts/plot_stress_fixed_figures_v5.py}}
  \item D2集計：\texttt{\detokenize{uccs_d2_scan90/analysis/summarize_d2_run.py}}
\end{itemize}</file><file path="修士論文/chapters/appx_c_results.tex">% chapters/appx_c_results.tex --- 付録C 追加結果（図表）
\section{追加結果}
\label{sec:extra_results}

\subsection{オフライン評価の比較表}
図\ref{fig:policy_table}に，固定とルールベース方策の比較表（例）を示す．

\begin{figure}[tb]
  \centering
  \includegraphics[width=0.95\linewidth]{../results/mhealth_policy_eval/policy_table.png}
  \caption{方策の比較表（例）}
  \label{fig:policy_table}
\end{figure}

\subsection{Paretoプロット（追加）}
図\ref{fig:pareto_plots_appx}に，オフライン評価のParetoプロットの例を示す．本文ではδ帯プロットを主張図として用いたが，探索空間全体の分布を併せて示すことで，候補集合の位置づけが明確になる．

\begin{figure}[tb]
  \centering
  \includegraphics[width=0.95\linewidth]{../results/mhealth_policy_eval/pareto_front_v8_power_table_scan90_v5_sleep_on_n9_10_actions_100_500/pareto_plots.png}
  \caption{Paretoプロット（例）}
  \label{fig:pareto_plots_appx}
\end{figure}

\subsection{ストレス固定：実測と簡易モデル}
図\ref{fig:stress_fixed_real_vs_sim_appx}に，ストレス固定における実測と簡易モデルの比較図を再掲する（\secref{sec:stress_fixed_metrics}）．

\begin{figure}[tb]
  \centering
  \includegraphics[width=0.95\linewidth]{../results/stress_fixed/compare/stress_causal_real_vs_sim.png}
  \caption{ストレス固定における実測と簡易モデルの比較（例）}
  \label{fig:stress_fixed_real_vs_sim_appx}
\end{figure}

\subsection{備考}
本節の図表は，本文の主張に直接必要でないが，読者が条件や比較対象を追跡できるように掲載する．</file><file path="修士論文/chapters/appx_d_log_schema.tex">% chapters/appx_d_log_schema.tex --- 付録D ログスキーマ（詳細）
\section{ログスキーマ（詳細）}
\label{sec:log_schema}

本節では，本研究で扱うログ（TXSD/RX/TX）の列定義をまとめる．解析スクリプトは列追加に対して後方互換で拡張可能であるが，指標計算に必須な列は固定する．

\subsection{TXSD（電力）ログ}
TXSDログは，電流・電圧系列と，末尾のsummaryから構成される．生系列は後処理で再積分できるように保持し，summaryはquick checkとして利用する．

\begin{longtable}{p{0.22\linewidth}p{0.18\linewidth}p{0.52\linewidth}}
  \caption{TXSDログ（例）の列定義}\label{tab:txsd_schema}\\
  \toprule
  列 &amp; 単位 &amp; 意味 \\
  \midrule
  \endfirsthead
  \toprule
  列 &amp; 単位 &amp; 意味 \\
  \midrule
  \endhead
  ms &amp; ms &amp; 試行開始からの相対時刻 \\
  mv &amp; mV &amp; 計測電圧（整数） \\
  uA &amp; $\mu$A &amp; 計測電流（整数） \\
  p\_mW &amp; mW &amp; 瞬時電力（派生列，後処理で再計算可能） \\
  \midrule
  \multicolumn{3}{l}{summary（末尾に出力する集約値の例）} \\
  \midrule
  ms\_total &amp; ms &amp; 試行時間 \\
  adv\_count &amp; 回 &amp; 広告イベント数（TICK物理カウント等） \\
  E\_total\_mJ &amp; mJ &amp; 総エネルギー（積分値） \\
  avg\_power\_mW &amp; mW &amp; 平均電力（$E/T$） \\
  \bottomrule
\end{longtable}

\subsection{RX（受信）ログ}
RXログは，受信時刻とペイロード識別子（seq等）を保持する．PDR\_unique，TL，$P_{\mathrm{out}}(\tau)$の算出に必須である．

\begin{longtable}{p{0.22\linewidth}p{0.18\linewidth}p{0.52\linewidth}}
  \caption{RXログ（例）の列定義}\label{tab:rx_schema}\\
  \toprule
  列 &amp; 単位 &amp; 意味 \\
  \midrule
  \endfirsthead
  \toprule
  列 &amp; 単位 &amp; 意味 \\
  \midrule
  \endhead
  t\_ms &amp; ms &amp; 受信時刻（試行開始からの相対，または端末時刻） \\
  seq &amp; --- &amp; ペイロードに埋め込んだ識別子（広告イベント由来） \\
  rssi &amp; dBm &amp; 受信RSSI \\
  dedup\_flag &amp; --- &amp; 重複除外のためのフラグ（ある場合） \\
  \bottomrule
\end{longtable}

\subsection{TX（送信）ログ}
TXログは，方策の状態（$U,S,\mathrm{CCS},a$等）を保持する．オフライン評価と実機評価を接続するため，方策の根拠（切替理由）を残すことが望ましい．

\begin{longtable}{p{0.22\linewidth}p{0.18\linewidth}p{0.52\linewidth}}
  \caption{TXログ（例）の列定義}\label{tab:tx_schema}\\
  \toprule
  列 &amp; 単位 &amp; 意味 \\
  \midrule
  \endfirsthead
  \toprule
  列 &amp; 単位 &amp; 意味 \\
  \midrule
  \endhead
  t\_ms &amp; ms &amp; 時刻 \\
  U &amp; --- &amp; 不確実度 \\
  S &amp; --- &amp; 安定度 \\
  CCS &amp; --- &amp; 複合スコア \\
  adv\_interval\_ms &amp; ms &amp; 選択した広告間隔 \\
  reason &amp; --- &amp; 切替理由（閾値越え等） \\
  \bottomrule
\end{longtable}

\subsection{ファイル命名と配置}
ログは，試行（trial）単位でファイルを分割し，\texttt{\detokenize{trial_XXX.csv}}等の連番で管理する．このとき，条件IDや実験日付をパスまたはファイル名に含め，作業ログに生成コマンドと出力先を残す（\secref{sec:runbook}）．</file><file path="修士論文/chapters/appx_e_runbook.tex">% chapters/appx_e_runbook.tex --- 付録E 実験Runbook（チェックリスト）
\section{実験Runbook（チェックリスト）}
\label{sec:runbook}

本節では，実験の再現性を担保するための最小チェックリストを示す．運用中に発見された落とし穴（条件混在，欠損，単位不整合など）を避けることを目的とする．

\subsection{実験前チェック}
\begin{itemize}
  \item 役割の確認：TX/RX/TXSDでスケッチが正しい（接頭辞，設定値）．
  \item 配線の確認：GND共通，SYNC入力，必要ならTICK入力（GPIO番号）．
  \item 受信端末の状態：スキャンモード，画面状態，省電力設定を固定し，端末内比較の前提を守る．
  \item SD空き容量：試行本数に対して十分な空きがある．
  \item ログ命名：\texttt{\detokenize{trial_XXX.csv}}の連番と，条件IDの対応が追跡できる．
\end{itemize}

\subsection{試行（trial）実行}
\begin{enumerate}
  \item SYNCで試行開始が一致していることを目視（LED等）で確認する．
  \item 試行中は条件（広告間隔，スキャン設定）を変更しない．
  \item 試行終了後，TXSDログ末尾のsummary（ms\_total, adv\_count, E\_total等）を確認する．
  \item 明らかな異常（rate低下，欠損，桁ズレ）があれば，その場で再試行し，除外理由を作業ログに残す．
\end{enumerate}

\subsection{データ整理}
\begin{itemize}
  \item 生データの退避：\texttt{\detokenize{data/}}へコピーし，取得条件と紐付ける．
  \item 解析対象の選別：含めるtrialと除外trialを明示し，理由（欠損，条件混在等）を記録する．
  \item ハッシュ記録：重要データセットはSHA256を記録し，後から同一入力で再現できるようにする．
  \item 作業ログ追記：生成物のパスと実行コマンドを\texttt{\detokenize{logs/worklog_YYYY-MM-DD_*.txt}}へ追記する．
\end{itemize}

\subsection{解析と図表生成}
\begin{itemize}
  \item trial集計：ログを読み込み，欠損と単位を監査し，指標（PDR, TL, Pout, 平均電力）を算出する．
  \item 集約：条件ごとに平均と分散を計算し，図表（固定点，δ帯，Pareto等）を生成する．
  \item 再現確認：同一入力・同一コマンドで同じ図表が出ることを確認する（乱数がある場合はseed固定）．
  \item 図の固定：提出用には\texttt{\detokenize{修士論文/figures/}}へコピーし，相対パス参照を解消する（\secref{sec:assets}）．
\end{itemize}

\subsection{既知の注意点}
\begin{itemize}
  \item 文字列中の\texttt{\detokenize{_}}（アンダースコア）は，LaTeX本文では\texttt{\detokenize{\texttt{\detokenize{...}}}}等で扱う（\secref{sec:assets}）．
  \item TL/Poutは開始位相ずれで歪むため，定数オフセット補正を適用した定義（v5）を基準にする（\secref{sec:stress_fixed_metrics}）．
  \item 条件混在（LED/SYNCの扱いの違い等）は定常オフセットとなるため，比較は同一コード系列に限定する（\secref{sec:measurement_system}）．
\end{itemize}</file><file path="修士論文/chapters/appx_f_symbols.tex">% chapters/appx_f_symbols.tex --- 付録F 記号表・略語
\section{記号表・略語}
\label{sec:symbols}

本節では，本論文で用いる記号と略語をまとめる．

\subsection{記号表}
\begin{longtable}{p{0.28\linewidth}p{0.16\linewidth}p{0.50\linewidth}}
  \caption{記号表}\label{tab:symbols}\\
  \toprule
  記号 &amp; 単位 &amp; 意味 \\
  \midrule
  \endfirsthead
  \toprule
  記号 &amp; 単位 &amp; 意味 \\
  \midrule
  \endhead
  $a,\;a(t)$ &amp; ms &amp; 広告間隔（方策が選択する行動） \\
  $T_{\mathrm{adv}}$ &amp; ms &amp; 広告間隔（説明用の表記） \\
  $T_{\mathrm{scan}}$ &amp; ms &amp; スキャン周期 \\
  $d_{\mathrm{scan}}$ &amp; ms &amp; スキャンウィンドウ \\
  $\delta$ &amp; --- &amp; スキャンデューティ比（$d_{\mathrm{scan}}/T_{\mathrm{scan}}$） \\
  $\mathbf{p}(t)$ &amp; --- &amp; HAR出力のクラス確率分布 \\
  $U(t)$ &amp; --- &amp; 不確実度（正規化エントロピー） \\
  $S(t)$ &amp; --- &amp; 安定度（時間的一貫性） \\
  $\mathrm{CCS}(t)$ &amp; --- &amp; 複合スコア（$U$と$S$の結合） \\
  $\alpha$ &amp; --- &amp; CCSの重み係数 \\
  $W$ &amp; --- &amp; 安定度の窓長（サンプル数等） \\
  $\theta_{\mathrm{low}},\theta_{\mathrm{high}}$ &amp; --- &amp; CCSの閾値（ヒステリシス） \\
  $t_{\mathrm{event},j}$ &amp; ms &amp; イベント$j$の真値（truth）時刻 \\
  $t_{\mathrm{rx},j}$ &amp; ms &amp; イベント$j$に対応する初回受信時刻 \\
  $\mathrm{TL}_j$ &amp; s &amp; イベント$j$の遅延（Time-to-first-Receive） \\
  $\mathrm{TL}_{p95}$ &amp; s &amp; TL分布の95パーセンタイル \\
  $P_{\mathrm{out}}(\tau)$ &amp; --- &amp; 期限$\tau$に対する期限超過率 \\
  $\tau$ &amp; s &amp; 遅延期限（outage判定の基準） \\
  $N_{\mathrm{event}}$ &amp; 回 &amp; 評価対象のイベント数 \\
  $N_{\mathrm{adv}}$ &amp; 回 &amp; 広告イベント数（adv\_count等） \\
  $\mathrm{PDR}_{\mathrm{raw}}$ &amp; --- &amp; 受信行数に基づくPDR（重複含む） \\
  $\mathrm{PDR}_{\mathrm{unique}}$ &amp; --- &amp; seqでユニーク化したPDR（重複除外） \\
  $Q$ &amp; $\si{\micro\coulomb}$ &amp; 試行区間の総電荷（電流積分） \\
  $\Delta Q$ &amp; $\si{\micro\coulomb}$ &amp; 電荷差分（ON$-$OFF） \\
  $q_{\mathrm{event}}$ &amp; $\si{\micro\coulomb}/\text{event}$ &amp; イベント当たり電荷（$\Delta Q/N_{\mathrm{event}}$） \\
  $E$ &amp; mJ &amp; 試行区間の総エネルギー \\
  $\Delta E$ &amp; mJ &amp; エネルギー差分（ON$-$OFF） \\
  $\overline{P}$ &amp; mW &amp; 平均電力（$E/T$） \\
  $p_d$ &amp; --- &amp; 1広告の受信成功確率（近似モデル） \\
  RSSI &amp; dBm &amp; 受信強度（Received Signal Strength Indicator） \\
  $t_{\mathrm{inf}}$ &amp; ms &amp; 推論時間（TinyML実機計測） \\
  \bottomrule
\end{longtable}

\subsection{略語}
\begin{longtable}{p{0.26\linewidth}p{0.68\linewidth}}
  \caption{略語}\label{tab:acronyms}\\
  \toprule
  略語 &amp; 意味 \\
  \midrule
  \endfirsthead
  \toprule
  略語 &amp; 意味 \\
  \midrule
  \endhead
  BLE &amp; Bluetooth Low Energy \\
  HAR &amp; Human Activity Recognition（人間活動認識） \\
  MCU &amp; Microcontroller Unit（マイコン） \\
  QoS &amp; Quality of Service（サービス品質） \\
  PDR &amp; Packet Delivery Ratio \\
  RSSI &amp; Received Signal Strength Indicator \\
  TL &amp; Time-to-first-Receive（発見遅延） \\
  outage &amp; 期限超過（$P_{\mathrm{out}}(\tau)$） \\
  PTQ &amp; Post-Training Quantization \\
  TFLite &amp; TensorFlow Lite \\
  SD &amp; Secure Digital（SDカード） \\
  UART &amp; Universal Asynchronous Receiver-Transmitter \\
  SPI &amp; Serial Peripheral Interface \\
  I\textsuperscript{2}C &amp; Inter-Integrated Circuit \\
  DUT &amp; Device Under Test（被測定対象） \\
  TX &amp; 送信側（DUT） \\
  RX &amp; 受信側（ロガ） \\
  TXSD &amp; 電力ロガ（送信側の電力計測） \\
  SYNC/TICK &amp; 試行境界・広告回数の同期信号 \\
  \bottomrule
\end{longtable}</file><file path="修士論文/chapters/appx_g_troubleshooting.tex">% chapters/appx_g_troubleshooting.tex --- 付録G トラブルシューティング集
\section{トラブルシューティング集}
\label{sec:troubleshooting}

本節では，実験運用で経験した代表的なトラブルを整理し，原因の切り分けと対策をまとめる．目的は，欠損や時間軸不整合によって結論が崩壊することを避け，再現性を高めることである．

\subsection{症状からの切り分け}
\begin{longtable}{p{0.28\linewidth}p{0.32\linewidth}p{0.34\linewidth}}
  \caption{症状からの切り分け（例）}\label{tab:troubleshooting_by_symptom}\\
  \toprule
  症状 &amp; 疑う箇所 &amp; まず確認すること \\
  \midrule
  \endfirsthead
  \toprule
  症状 &amp; 疑う箇所 &amp; まず確認すること \\
  \midrule
  \endhead
  OFFがONより大きい（$\Delta E&lt;0$） &amp; 欠損，単位換算，条件混在 &amp; 生ログ再積分とsummaryの一致，コード系列の統一 \\
  TL/Poutが不自然に小さい &amp; RXとtruthの時間軸ずれ &amp; 定数オフセット補正（v5）を適用したか \\
  PDRが1を超える &amp; 重複受信の混入 &amp; seqユニーク化（PDR\_unique）を優先 \\
  adv\_countが期待値と乖離 &amp; TICK未接続，推定の誤差 &amp; TICK物理カウントの有無，推定式の前提 \\
  SDログが途中で途切れる &amp; SD I/O，電源，ファイルopen &amp; 末尾summaryの有無，open/initエラー \\
  数値列に文字が混入する &amp; UART品質，ボーレート過大 &amp; ボーレート低下，厳密パース，配線見直し \\
  \bottomrule
\end{longtable}

\subsection{代表的トラブル}
\subsubsection{広告OFFの方が消費が大きい（$\Delta E&lt;0$）}
広告OFFが広告ONより大きい結果は，物理的に矛盾して見えるため，最優先で切り分ける必要がある．本研究では，無線スタックの影響を議論する前に，計測・解析起因の破綻を疑う．
\begin{itemize}
  \item 主要因候補：I/Oボトルネックによる欠損，単位換算ミス，条件混在（コード系列の違い）．
  \item 対策：生ログ（mV/µA）から再積分し，summaryと一致することを監査する．比較は同一コード系列で統一し，sleepの有無も条件として明示する．
  \item 判断：監査を通過した上で$\Delta E&lt;0$が再現する場合，電源ドメインや無線状態遷移など物理要因を再検討する．
\end{itemize}

\subsubsection{TL/Poutの過小評価（開始位相ずれ）}
RXログの開始がtruthより遅れる等の理由で，RXの時間軸とtruthの時間軸が一致しない場合がある．このずれを補正しないと，TLや$P_{\mathrm{out}}(\tau)$が過小評価される．本研究ではv5として，seqから定数オフセットを推定して補正する手順を採用する（\secref{sec:stress_fixed_metrics}）．

\subsubsection{UARTデータ化け（数値列への文字混入）}
UARTログが壊れると，欠損や桁ズレが連鎖し，積分と分母（試行時間・広告回数）が不整合になる．
\begin{itemize}
  \item 兆候：パーサの例外，行数不足，msが単調増加しない，0埋め行の増加．
  \item 対策：ボーレートを下げる，出力列を最小化する，パース失敗は試行ごと除外し理由を記録する．
  \item 再発防止：末尾summaryの生成を必須とし，欠損率が閾値を超えた試行は自動で失格にする．
\end{itemize}

\subsubsection{SYNC検出失敗（短パルス）}
SYNCが短パルスとして出力されると，受信側で取りこぼす可能性がある．境界が崩れると，TL/Poutの定義（イベント時刻）と電力積分区間が一致しなくなる．
\begin{itemize}
  \item 対策：SYNCをHIGH保持する，受信側でラッチする，開始と終了の両方を同期する．
  \item 監査：TXSD summaryのms\_totalが想定長と一致すること，RXの試行数が一致することを確認する．
\end{itemize}

\subsubsection{SD I/O失敗（open/init）}
SDカード初期化やファイルopenに失敗した状態で試行を継続すると，欠損が増え，評価が不能になる．
\begin{itemize}
  \item 対策：SPIクロック調整，塊書き込み，open/init失敗時の即時停止と再試行．
  \item 監査：各trialファイルの末尾summaryの存在と整合を確認する．
\end{itemize}

\subsection{解析前の最終監査}
解析を自動化しても，入力が壊れていると結論が壊れる．したがって，解析前に以下を最低限チェックする．
\begin{itemize}
  \item 末尾summary（ms\_total, adv\_count, E\_total等）が存在し，桁が妥当である．
  \item 生ログの再積分がsummaryと整合し，単位換算が一貫している．
  \item RXの試行数・条件IDがTXSDと一致し，条件混在がない．
  \item 重要データはSHA256を記録し，同一入力で再現できる．
\end{itemize}</file><file path="修士論文/chapters/appx_h_ccs_params.tex">% chapters/appx_h_ccs_params.tex --- 付録H CCS写像とパラメータ（版管理）
\section{CCS写像とパラメータ（版管理）}
\label{sec:ccs_params}

本節では，Phase 1（ルールベース）で用いるCCS写像と主要パラメータを一覧化し，モデル更新時の再キャリブレーション対象を明確化する．評価の再現性のため，パラメータは実験ログ（TX）に保存し，作業ログに変更履歴を残す．

\subsection{3状態写像（ACTIVE/UNCERTAIN/QUIET）}
本研究のルールベース方策は，CCSを3状態へ写像し，広告間隔を段階的に切り替える．表\ref{tab:ccs_state_mapping}に概念整理を示す．

\begin{table}[tb]
  \centering
  \caption{CCS状態と広告間隔の写像（概念）}
  \label{tab:ccs_state_mapping}
  \begin{tabular}{p{0.22\linewidth}p{0.22\linewidth}p{0.46\linewidth}}
    \toprule
    状態 &amp; 広告間隔 $a$ &amp; 意図 \\
    \midrule
    ACTIVE &amp; \SI{100}{\milli\second} &amp; 不確実または遷移期：QoS優先（短間隔） \\
    UNCERTAIN &amp; \SI{500}{\milli\second} &amp; 中間：過渡の揺らぎを吸収しつつ省電力化 \\
    QUIET &amp; \SI{2000}{\milli\second} &amp; 安定期：省電力優先（長間隔） \\
    \bottomrule
  \end{tabular}
\end{table}

\subsection{主要パラメータ（Phase 1既定値）}
表\ref{tab:ccs_params_phase1}に，Phase 1で用いる代表的パラメータを示す．これらはモデルの出力分布や量子化誤差に依存するため，モデル更新時には再キャリブレーションが必要となる．

\begin{table}[tb]
  \centering
  \caption{CCS写像と安定化の主要パラメータ（例）}
  \label{tab:ccs_params_phase1}
  \begin{tabular}{p{0.28\linewidth}p{0.18\linewidth}p{0.44\linewidth}}
    \toprule
    パラメータ &amp; 値（例） &amp; 説明 \\
    \midrule
    $\alpha$ &amp; 0.7 &amp; $\mathrm{CCS}=\alpha(1-U)+(1-\alpha)S$ の重み \\
    $W$ &amp; 5 &amp; 安定度$S$の窓長（遷移回数の正規化） \\
    $\theta_{\mathrm{low}}$ &amp; 0.80 &amp; ACTIVE$\leftrightarrow$UNCERTAINの閾値（上り） \\
    $\theta_{\mathrm{high}}$ &amp; 0.90 &amp; UNCERTAIN$\leftrightarrow$QUIETの閾値（上り） \\
    $h$ &amp; 0.05 &amp; ヒステリシス幅（下りは$\theta-h$） \\
    $t_{\min}$ &amp; \SI{2}{\second} &amp; 最小滞在時間（切替の振動抑制） \\
    行動集合 &amp; $\{100,500,2000\}$ ms &amp; Phase 1の最小構成（拡張候補は$\{100,500,1000,2000\}$） \\
    \bottomrule
  \end{tabular}
\end{table}

\subsection{ログへの記録項目}
方策の説明可能性と再現性のため，少なくとも以下をTXログに記録する．
\begin{itemize}
  \item $U,S,\mathrm{CCS}$と，選択した広告間隔$a$
  \item $\theta_{\mathrm{low/high}}$，ヒステリシス幅$h$，最小滞在時間$t_{\min}$
  \item 切替理由（\texttt{\detokenize{reason}}）
\end{itemize}
これにより，結果図表の背後にある意思決定とパラメータを監査できる．</file><file path="修士論文/chapters/ch0_introduction.tex">% chapters/ch0_introduction.tex --- 第1章 序論
\chapter{序論}
\clearpage

\section{研究背景と社会的文脈}
ウェアラブル端末やエッジデバイスにおいて，推論結果を近傍のスマートフォンへ低遅延に通知する仕組みは，見守りや労働安全など多くの応用で重要である．一方で，常時高頻度に通信を行うと電力消費が増大し，小型バッテリでの長時間運用が困難となる．Bluetooth Low Energy（BLE）の広告（Advertising）は接続を前提としない軽量な近傍通信手段として広く利用されているが，受信側（スマートフォン）のスキャン動作はOSや端末状態に依存し，連続スキャンが保証されない．

\section{課題設定と狙い}
本研究は，アプリケーション層（HAR）で得られる推論不確実度を通信層の制御に利用し，QoS制約（一定時間以内に受信されること）を満たしながら省電力化する枠組みを扱う．推論不確実度と時間的安定度から複合スコアCCSを構成し，その値に応じて広告間隔を段階的に切り替えるルールベース方策を定義する．さらに，送信・受信・電力計測を統合した計測基盤を整備し，電力指標とQoS指標を同一試行で評価できる形に整理する．

\section{問題意識：エッジHARの「推論」と「通信」のねじれ}
ウェアラブル端末やエッジデバイスは，慣性センサ等から人の状態を推定し，異常や重要な変化を近傍のスマートフォンへ通知する用途で用いられる．このとき，アプリケーション層では「推論ができた瞬間に，できるだけ早く届けたい」という要求がある一方，通信層では「常に高頻度に送ると電力が増える」というトレードオフがある．

さらに，BLE広告は送信側の制御が容易である反面，受信側（スマートフォン）のスキャン挙動はOSや端末状態に依存し，連続スキャンが保証されない．したがって，広告間隔を固定して設計した場合，環境変化により「必要なときに届かない」か「届くが電力を使いすぎる」状況が生じ得る．

本研究は，このねじれを緩和するために，アプリケーション層（HAR）で得られる推論不確実度を通信制御に利用し，「いま確信が高いか低いか」に応じて送信頻度を調整する枠組みを扱う．

\section{本研究の核となる主張}
本研究の核となる主張は，次のとおりである．
\begin{quote}
HAR不確実度に基づくBLE広告間隔の適応制御において，単純な閾値ルールでも固定間隔より省電力になりうることを示し，将来のSafe Contextual Bandit最適化の基盤を与える．
\end{quote}

\section{研究課題：QoS制約下での省電力化}
本研究の目的は，受信遅延に基づくQoS制約を満たしつつ，電力消費を抑制することである．代表的なQoSとして，イベント発生後に最初に受信されるまでの遅延（TL）を用い，期限$\tau$を超える確率を
\begin{equation}
  P_{\mathrm{out}}(\tau)=P(\mathrm{TL}&gt;\tau)
\end{equation}
として定義する（詳細は\secref{sec:metrics_detail}）．このとき，広告間隔$a$の選択（固定または動的切替）を含む方策$\pi$に対して，以下の形で整理できる．
\begin{equation}
  \text{minimize}\quad \mathbb{E}[q_{\mathrm{event}}(\pi)]
  \quad \text{subject to}\quad P_{\mathrm{out}}(\tau;\pi)\le \delta
\end{equation}
ここで$q_{\mathrm{event}}$（単位：$\si{\micro\coulomb}/\text{event}$）は，セッション中の電荷消費をイベント数で正規化した指標である．平均電力$\overline{P}$や$\Delta E/N_{\mathrm{adv}}$等は従属指標として併用し，単位監査や原因切り分けに用いる（\secref{sec:metrics_detail}）．

\section{本研究の貢献}
本研究の貢献を以下にまとめる．
\begin{enumerate}
  \item 推論不確実度$U$と安定度$S$から複合スコアCCSを構成し，広告間隔を段階的に切り替えるルールベース方策として定義した．
  \item 送信（TX）・電力（TXSD）・受信（RX）の三ノード構成と同期信号（SYNC/TICK）により，同一試行で電力とQoS（TL，$P_{\mathrm{out}}(\tau)$）を評価できる計測基盤を整備した．
  \item TL/Poutの算出において開始位相ずれが結果を歪め得ることを示し，定数オフセット補正（v5）として指標定義を固定した．
  \item オフライン評価（mHealth合成）により，固定間隔点と候補方策点のトレードオフ（δ帯・Pareto）を可視化し，実機実験の探索空間を縮小する枠組みを示した．
  \item Phase 2の拡張として，$U,S$をコンテキスト，広告間隔を行動，$P_{\mathrm{out}}(\tau)$を制約とするSafe Contextual Banditへ接続できる形で問題設定を整理した．
\end{enumerate}

\section{スコープと前提（Phase 1 / Phase 2）}
本研究は，Phase 2でのSafe Contextual Bandit最適化を見据えつつ，Phase 1として「決め打ちルールで評価指標と計測系を確立する」段階に焦点を当てる．したがって，本論文のスコープは次のとおりである．

\subsection{IN（本論文で扱うこと）}
\begin{itemize}
  \item $U,S,\mathrm{CCS}$の定義とログ化（推論不確実度を通信制御へ接続するための最小要素）．
  \item ルールベース方策（閾値，ヒステリシス，最小滞在時間）と，実機での動作確認．
  \item 一次KPI（$\si{\micro\coulomb}/\text{event}$，$P_{\mathrm{out}}(\tau)$，TL\_p95）の測定方法と再現性の確立．
\end{itemize}

\subsection{OUT（本論文では深掘りしないこと）}
\begin{itemize}
  \item Safe Banditの学習アルゴリズムそのものの実装・オンライン学習（将来課題として定式化までを示す）．
  \item スキャン窓の推定など，受信側OS挙動の同定（非理想スキャン前提で端末内比較を行う）．
  \item HARモデルの最終性能の到達（TinyMLの未完タスクは明示し，評価系の枠組みを主張する）．
\end{itemize}

\section{本論文の構成}
本論文は，章数を抑えつつ各章を厚くし，特に再現性確保（ログ設計・指標定義・運用手順・破綻モード）を本文内で明示する構成を採用する．第2章では背景と関連研究を統合し，BLE広告・非理想スキャン・sleepの位置づけと関連アプローチを整理する．第3章ではシステム設計と提案手法をまとめ，World Model，一次KPI，HAR不確実度，CCS写像とパラメータを整理する．第4章では計測系・ログ設計・指標定義・Runbook・トラブルシューティングを統合し，再現性のための前提を固定する．第5章ではストレス固定，オフライン評価，実機評価結果をまとめ，固定点と提案方策の比較を示す．第6章では考察として，非理想スキャン下での解釈，sleepの扱い，失敗・未完タスクの位置づけ，およびPhase 2（Safe Contextual Bandit）への展望を述べる．最後におわりにで全体をまとめる．</file><file path="修士論文/chapters/ch1_background.tex">% chapters/ch1_background.tex --- 第2章 背景
\section{背景}

\subsection{BLEアドバタイズとスキャンの基礎}
Bluetooth Low Energy（BLE）の広告は，接続を確立せずに情報をブロードキャストでき，端末側の実装が容易である\scite{bluetooth_core_spec}．一方で，広告は受信側のスキャン窓に依存して観測されるため，送信側がどれだけ制御しても「確実に届く」とは限らない．本節では，広告とスキャンの基本要素を整理する．

\subsubsection{広告イベントと3チャネル}
広告は，規格上の広告チャネル（37/38/39）を用いて送信される．送信側は，広告間隔を$T_{\mathrm{adv}}$として，概ね$T_{\mathrm{adv}}$ごとに広告イベントを発生させる．広告イベントは複数チャネルに送信されるが，周波数ホッピングや干渉により，受信側で観測される成否は確率的になる．

\subsubsection{スキャン間隔・ウィンドウとデューティ比}
受信側は，スキャン間隔$T_{\mathrm{scan}}$ごとに，スキャンウィンドウ$d_{\mathrm{scan}}$の間だけ受信機を有効化する．スキャンのデューティ比$\delta$は
\begin{equation}
  \delta=\frac{d_{\mathrm{scan}}}{T_{\mathrm{scan}}}
\end{equation}
で定義できる．$\delta$が小さいほど受信側は省電力になるが，広告イベントとの重なりが起きにくくなり，発見遅延が増える．

\subsubsection{発見遅延（TL）の概念}
イベント発生後，最初に広告が受信されるまでの遅延をTL（Time-to-first-Receive）とする．TLは，広告間隔とスキャン窓の相互作用（位相差）で分布が決まるため，平均受信率だけではQoSを十分に表現できない．本研究では，一次KPIとして省電力指標$q_{\mathrm{event}}$（$\si{\micro\coulomb}/\text{event}$），TL分布の裾（TL\_p95），および期限超過率$P_{\mathrm{out}}(\tau)$を採用する．

\subsection{``非理想スキャン&apos;&apos;という現実}
スマートフォンのスキャン挙動は，端末機種，OSバージョン，画面状態，省電力機構，および他アプリの利用状況に依存して変化する．Androidでは，アプリケーションがスキャンを要求しても，OSが内部的にスキャンの間欠化やスロットリングを行う可能性がある\scite{android_ble_scanner}．このため，本研究ではスキャンを理想的な一定窓として仮定せず，「非理想で観測できない内部状態がある」前提で送信側の制御を議論する．

\subsubsection{Valley Area（ブラインドスポット）}
広告間隔とスキャン周期が高調波関係に近い場合，広告イベントが系統的にスキャン窓の外側へ入り続け，発見遅延が極端に悪化する領域が生じ得る．このような領域は，平均的な受信率が同程度でもTLの裾を悪化させるため，$P_{\mathrm{out}}(\tau)$により議論する必要がある．

\subsubsection{Androidのスキャンモードと前提条件}
AndroidのBLEスキャンは，アプリケーションが要求するスキャンモード（例：LOW\_LATENCY）だけで挙動が一意に定まるとは限らない\scite{android_ble_scanner}．画面状態や電源管理の影響により，アプリケーションが意図したとおりに連続スキャンできない場合がある．したがって，本研究は「受信側スキャンは非理想である」前提で，送信側が取り得る適応制御の範囲を議論する．

\subsubsection{OS側のスロットリングとオポチュニスティック・スキャン}
スマートフォン側では，複数アプリのスキャン要求を統合するような挙動や，バックグラウンド制約に起因するスロットリングが生じ得る．これらはアプリケーション側から直接観測・制御できないため，評価では端末内比較と運用条件の固定（スキャンモード，画面状態等）が重要となる．

\subsubsection{端末内比較という評価姿勢}
スキャン挙動が端末・OS状態に依存する以上，異なる端末間の比較は外的要因が支配的になりやすい．本研究は，固定条件と提案条件を同一端末・同一設定で取得し，同一パイプラインで集計する端末内比較を基本とする．

\subsection{sleepをどう捉えるか}
本研究の評価は，送信側の電力と受信側のQoSを同時に扱う．このとき，sleep（間欠動作）の扱いは，受信側と送信側で意味が異なるため，整理が必要である．

\subsubsection{スキャナ側のsleep（scan dutyの縮退）}
受信側のsleepは，スキャンデューティ比$\delta$の低下として観測される．これはOSの省電力機構に起因し，アプリケーション側から直接制御できない場合が多い．スキャナ側のsleepは，TL分布の右裾を伸ばし，$P_{\mathrm{out}}(\tau)$を悪化させる方向に作用する．

\subsubsection{アドバタイザ側のsleep（平均電力の低下）}
送信側（DUT）のsleepは，CPUや無線を低消費電力状態に移行させることで平均電力を下げる．広告間隔を長くすると無線イベント回数が減るだけでなく，sleepに入れる時間が増えるため，平均電力が低下しやすい．本研究の予備計測（sleep\_eval\_scan90）では，固定\SI{100}{\milli\second}から固定\SI{500}{\milli\second}への変更で平均電力が大きく低下する一方，\SI{500}{\milli\second}以上では改善幅が小さくなる傾向が確認されている（詳細は\secref{sec:evaluation_results}）．

\subsubsection{広告が支配的コストになりやすい理由}
広告イベントは，無線送信に加えてスタック処理や割り込み等を伴うため，完全なスタンバイsleepより高コストになりやすい．そのため，広告間隔の制御は「通信頻度そのものの削減」と「sleep時間の増加」という2つの経路で省電力に寄与する．

\subsection{不確実度$U$・安定度$S$・CCSの基礎}
端末内推論（HAR）は，クラス確率分布として出力を持つことが多い．この確率分布から不確実度$U$を導出すると，「いまの推論がどの程度信頼できるか」を定量化できる．一方で，確率は瞬間的に揺らぐため，時間的一貫性を表す安定度$S$も併用する設計が有効である．

\subsubsection{CCSの直感}
複合スコアCCSは，確信度$(1-U)$と安定度$S$を組み合わせた指標であり，「確信が高く，かつ安定しているほど長間隔を選びやすい」という単調な解釈を与える．この単調性は，ルールベース方策の説明容易性に寄与する．

\subsubsection{感度分析の必要性}
CCSは係数（例：$\alpha$）や窓長$W$に依存するため，分布が変わると閾値の意味が変化する．本研究では，Phase 1では説明容易性を優先し，固定の係数でルールベース評価を行う．係数感度や較正は，今後の課題として整理する（関連研究・TinyML章を参照）．

\subsection{まとめ}
本節では，BLE広告とスキャンの基本要素，非理想スキャン，sleepの二面性，および不確実度指標の位置づけを整理した．次節では，これらを踏まえて関連研究を整理し，本研究の新規性と立脚点を明確化する．</file><file path="修士論文/chapters/ch10_implementation.tex">% chapters/ch10_implementation.tex --- 第10章 実装（ファームウェア・解析パイプライン）
\section{実装：ファームウェアと解析パイプライン}

\subsection{目的}
本研究では，方策の比較を可能にするため，計測系と解析パイプラインを共通化した．本節では，実装の要点（ログ設計，同期，解析フロー）を整理する．

\subsection{ファームウェア構成}
ファームウェアは役割ごとに送信（TX），受信（RX），電力ロガ（TXSD）に分割する．各スケッチは，役割がファイル名から判別できるよう命名し，試行境界の同期とログ出力形式を統一する．

\subsubsection{命名規約}
実験の再現性を担保するため，スケッチ名は役割別に接頭辞を付与する．
\begin{itemize}
  \item RX\_*：受信ロガ（RX）
  \item TX\_*：送信・被測定対象（TX）
  \item TXSD\_*：送信側の電力ロガ（TXSD）
\end{itemize}
この規約により，ファイル名だけで役割が判別でき，Runbookや作業ログから参照しやすくなる．

\subsection{ログ形式}
本研究の解析は，TXSDログ（電力）とRXログ（受信）を中心に行う．特に，広告回数（adv\_count）や試行時間（ms\_total）の扱いは，指標の分母・分子に直結するため，ログ末尾のsummaryを正として扱う．

\subsubsection{解析で重要な列}
TXSDログでは，時刻（ms）と計測値（mV，$\mu$A）が一次情報であり，平均電力や総エネルギーはここから再計算できる．RXログでは，受信時刻とseqがTL/PoutおよびPDR\_uniqueの計算に必須である．したがって，ログ設計では「後から復元できる列」を優先し，表示用の派生列は監査可能な形で保持する．

\subsection{解析パイプラインの流れ}
解析は，概ね以下の段階で行う．
\begin{enumerate}
  \item trialごとのログを読み込み，欠損や単位の整合をチェックする．
  \item TXSDから平均電力・総エネルギー等を算出する．
  \item RXからPDR，TL，Pout(τ)を算出する（必要に応じて時間同期を行う）．
  \item 条件ごとに集約し，図表を生成する．
\end{enumerate}

\subsubsection{代表的なスクリプト}
解析は，試行ごとの集計，条件ごとの集約，図表生成に分割することで，再実行と検証を容易にする．例えばストレス固定の解析では，時間同期を含む集計と，集約・図表化を分離して実行できるように整備した．

\subsection{再現性のための運用}
解析対象の選別（除外理由），生成コマンド，入力データの出典・ハッシュ等を記録し，再現可能な形で結果を残す．作業ログとインデックスを併用して，後から辿れる状態を維持する．

\subsection{まとめ}
本節では，ファームウェアと解析パイプラインの要点を整理した．これにより，固定間隔と動的制御を同一基盤で比較できる．</file><file path="修士論文/chapters/ch2_background_related.tex">% chapters/ch2_background_related.tex --- 第2章 背景・関連研究（統合）
\chapter{背景・関連研究}
\clearpage

本章では，本研究の前提となるBLE近隣発見の基礎，非理想スキャン，sleepの二面性，不確実度指標の位置づけを整理する．続いて関連研究を概観し，本研究の立脚点と新規性を明確化する．

\input{chapters/ch1_background}
\input{chapters/ch2_related_work}</file><file path="修士論文/chapters/ch2_proposed.tex">% chapters/ch2_proposed.tex --- 第6章 提案手法（CCS→広告間隔制御）
\section{提案手法：CCSに基づくBLE広告間隔制御}
\label{sec:proposed_method}

\subsection{問題設定}
本研究では，広告間隔 $a$ を選択して送信を行うとき，一次KPIである$q_{\mathrm{event}}$（$\si{\micro\coulomb}/\text{event}$）を小さくしつつ，受信遅延に基づくQoS制約を満たすことを目的とする．代表的には，初回受信遅延TLに対して，期限$\tau$を超える確率を$P_{\mathrm{out}}(\tau)=P(\mathrm{TL}&gt;\tau)$として定義し，$P_{\mathrm{out}}(\tau)\le \delta$を制約とする．

\subsubsection{目的関数（$\si{\micro\coulomb}/\text{event}$）}
本研究では，セッション中の電荷消費をイベント数で正規化した$q_{\mathrm{event}}$（$\si{\micro\coulomb}/\text{event}$）を一次指標とする．ここでイベントは，TL/Poutの評価起点となる状態遷移（活動の切替）である．電荷消費はTXSDログの電流系列から積分し，必要に応じて広告OFF（同一コード系列・同一sleep条件）の基準を差し引く（詳細は\secref{sec:metrics_detail}）．

平均電力$\overline{P}$や総エネルギー$E$，および広告回数で正規化した$\Delta E/N_{\mathrm{adv}}$等は，単位監査や原因切り分けのための従属指標として併用する．

\subsubsection{制約（期限超過率）}
QoSは「状態遷移（イベント）後に一定時間以内に受信されること」として定義する．$j$番目のイベントの初回受信遅延を$\mathrm{TL}_j$とすると，
\begin{equation}
  P_{\mathrm{out}}(\tau)=\frac{1}{N_{\mathrm{event}}}\sum_{j=1}^{N_{\mathrm{event}}}\mathbb{I}[\mathrm{TL}_j&gt;\tau]
\end{equation}
で表せる．本研究では，$\tau=\SI{1}{\second},\SI{2}{\second},\SI{3}{\second}$等の代表値で評価し，$P_{\mathrm{out}}(\tau)\le \delta$を制約として扱う．

\subsection{不確実度と安定度}
HARモデルの出力確率分布から不確実度$U\in[0,1]$を導出し，過去一定窓におけるラベル遷移回数から安定度$S\in[0,1]$を導出する．具体的な算出方法（窓長，正規化，較正など）は，HAR推論部の\secref{sec:har_uncertainty}で整理する．

\subsubsection{不確実度U}
HARのクラス事後確率を$p_k$（$k=1,\dots,K$）とすると，不確実度$U$は正規化エントロピーとして定義できる\scite{shannon1948}．
\begin{equation}
  U = -\frac{\sum_{k=1}^{K} p_k \log p_k}{\log K}\,,
\end{equation}
ここで$U=0$は確信度が高い状態，$U=1$は不確実な状態に対応する．

\subsubsection{安定度S}
安定度$S$は，直近の時間窓におけるラベル遷移回数に基づき定義する．窓長を$W$，遷移回数を$n_{\mathrm{trans}}$とすると，簡単な定義の一例は以下である．
\begin{equation}
  S = 1-\min\!\left(1,\frac{n_{\mathrm{trans}}}{W}\right)\,.
\end{equation}
安定期では$S$が1に近く，遷移期では$S$が小さくなる．

\subsection{複合スコアに基づく広告間隔制御}
不確実度と安定度から複合スコア（Composite Confidence Score：CCS）を構成し，その値に応じて広告間隔を段階的に切り替える．本研究では，実装の単純性と説明容易性のためにルールベース方策を採用し，閾値とヒステリシス，最小滞在時間により切替の振動を抑制する．

\subsubsection{複合スコアCCS}
本研究では，不確実度$U$と安定度$S$から，以下の線形結合で複合スコアCCSを構成する．
\begin{equation}
  \mathrm{CCS} = \alpha\,(1-U) + (1-\alpha)\,S\,.
\end{equation}
ここで$\alpha\in[0,1]$は重みである．$\alpha$を大きくすると確信度（$1-U$）を重視し，小さくすると安定度$S$を重視する．

\subsubsection{閾値写像}
CCSを3段階に分け，広告間隔$a\in\{100,500,2000\}\,\si{\milli\second}$へ写像する．閾値を$\theta_{\mathrm{low}}$，$\theta_{\mathrm{high}}$（$\theta_{\mathrm{low}}&lt;\theta_{\mathrm{high}}$）とすると，
\begin{equation}
  a(\mathrm{CCS}) =
  \begin{cases}
    2000\,\si{\milli\second} &amp; (\mathrm{CCS}\ge\theta_{\mathrm{high}})\\
    500\,\si{\milli\second}  &amp; (\theta_{\mathrm{low}}\le\mathrm{CCS}&lt;\theta_{\mathrm{high}})\\
    100\,\si{\milli\second}  &amp; (\mathrm{CCS}&lt;\theta_{\mathrm{low}})
  \end{cases}
\end{equation}
と定義する．

\subsubsection{ヒステリシスと最小滞在時間}
CCSは推論誤差やセンサノイズにより揺らぐため，単純な閾値写像では切替が過度に発生しうる．そこで，閾値にヒステリシス（上下で異なる閾値）を持たせる．また，最小滞在時間を設け，滞在時間が一定値未満の間は切替を抑制する．

なお，Phase 1で用いる代表的なパラメータ（$\alpha,W,\theta_{\mathrm{low/high}}$，ヒステリシス幅，最小滞在時間）は\secref{sec:ccs_params}に一覧化する．

\subsubsection{切替規則（実装上の要点）}
実装は，現在の間隔$a_t$とCCSの観測値$\mathrm{CCS}_t$から次の間隔$a_{t+1}$を決定する有限状態機械として表せる．本研究では以下を満たす設計とする．
\begin{itemize}
  \item \textbf{単調性}：CCSが高いほど長間隔側を選びやすい．
  \item \textbf{安全側への退避}：QoS悪化の兆候がある場合は短間隔へ戻す余地を残す．
  \item \textbf{振動抑制}：ヒステリシスと最小滞在時間で切替頻度を抑える．
\end{itemize}
切替規則の例は，実験装置・計測方式（\secref{sec:measurement_setup}）および実験設計（\secref{sec:experiment_design}）で示す条件（閾値，滞在時間）と併せて具体化する．

\subsection{ログと説明可能性（Observability）}
動的制御の評価では，「なぜその間隔を選んだか」を後から説明できることが重要である．特に，本研究は非理想スキャンを前提とするため，受信品質の変動をすべて送信側のせいにできない．したがって，方策の意思決定（$U,S,\mathrm{CCS}$）と，使用したパラメータ（閾値，ヒステリシス，最小滞在時間等）をログとして残し，観測可能性を担保する．

\subsubsection{切替理由（reason）を毎回残す}
切替のたびに，閾値越え，ヒステリシス判定，最小滞在時間による抑制，フェイルセーフ退避などの理由を\texttt{\detokenize{reason}}として記録する．これにより，結果図表の背後にある「切替の根拠」を監査できる．

\subsubsection{Tx/Rx/Powerのスキーマ}
TXログは方策の内側（$U,S,\mathrm{CCS}$と選択した$a$），RXログは受信時刻とseq，TXSDログは電流・電圧系列とsummaryを保持する．ログ列の詳細は\secref{sec:log_schema}に示し，\secref{sec:runbook}に従って運用条件（端末，スキャン設定，sleepの有無）を固定する．

\subsection{動的切替の最小構成（2値制御）}
実機実験の初期段階では，電力低下の主効果が短間隔滞在の削減にあることを踏まえ，広告間隔を\SI{100}{\milli\second}と\SI{500}{\milli\second}の2値に限定した動的切替を用いる．この最小構成により，計測系の同期とログ整合を保ちつつ，動的切替が期待通りに動作することを確認する．

\subsubsection{2値制御の目的}
2値制御は，行動空間を小さくすることで，実装・解析の複雑性を抑える目的がある．また，\SI{100}{\milli\second}と\SI{500}{\milli\second}の差は平均電力の主効果になりやすく，省電力化の寄与を説明しやすい．

\subsection{評価システム概要（TX/TXSD/RX）}
評価系は，送信（TX），電力ロガ（TXSD），受信（RX）の三ノードで構成する．TXは広告間隔を制御しつつ，必要なメタ情報をペイロードに埋め込む．TXSDはINA219により電流・電圧を計測して平均電力等を算出する．RXは受信ログを蓄積し，PDR，TL，$P_{\mathrm{out}}(\tau)$を評価する．

\begin{figure}[tb]
  \centering
  \fbox{\begin{minipage}{0.9\linewidth}
    \vspace{1mm}
    \begin{center}
      \textbf{TX（DUT）}\hspace{6mm}$\rightarrow$\hspace{6mm}\textbf{RX（スマートフォン）}
    \end{center}
    \vspace{1mm}
    \begin{itemize}
      \item TX：HARの出力から$U,S,\mathrm{CCS}$を計算し，広告間隔$a$を切替．ペイロードにseqや状態を埋め込む．
      \item RX：受信時刻・RSSI・seqを記録し，PDR/TL/$P_{\mathrm{out}}(\tau)$を算出．
      \item TXSD：TXの電流・電圧を計測し，$E$と$\overline{P}$を算出（必要に応じてTICKで$N_{\mathrm{adv}}$をカウント）．
    \end{itemize}
    \vspace{1mm}
  \end{minipage}}
  \caption{評価システム概要（TX/TXSD/RX）}
  \label{fig:system_overview}
\end{figure}

本文中では \figref{fig:system_overview} のように参照する．</file><file path="修士論文/chapters/ch2_related_work.tex">% chapters/ch2_related_work.tex --- 第3章 関連研究
\section{関連研究}

\subsection{BLE広告・近隣発見の最適化}
BLE広告における主要設計パラメータは，広告間隔，送信チャネル数，送信電力等である．これらは到達性（受信率・遅延）と電力のトレードオフに直結するため，固定値の最適化や，状況に応じた動的制御が検討されてきた．

\subsubsection{MABでintervalを選ぶ考え方}
広告間隔の動的制御は，混雑度推定や直近の受信状況に基づくルールとして実装されることが多い．一方で，未知・非定常な環境では，有限個の行動集合からオンラインで運用点を学習する枠組み（マルチアーム・バンディット）も候補となる\scite{lattimore2020bandit}．本研究はPhase 2での拡張可能性を残しつつ，Phase 1では学習以前の前提（指標・計測）を確立する立場を採る．

\subsubsection{3チャネル送信と電力}
BLE広告は広告チャネル（37/38/39）で送信されるため，チャネル数や送信回数は到達性と電力に影響する．本研究はPhase 1ではチャネルマスク等を固定し，広告間隔の効果と不確実度駆動制御の枠組みに焦点を当てる．

\subsubsection{学習しない設計（多重化等）}
学習を用いないアプローチとしては，複数の間隔や送信パターンを組み合わせ，Valley Areaの影響を平均化する設計も考えられる．ただし，受信側スキャンが非理想である場合，無線側のパラメータだけで性能が決まらないため，アプリケーション層の状態（遷移期／安定期）を併用した説明が必要となる．

\subsection{遅延制約・Outage解析}
近隣発見では，平均遅延だけでなく，期限超過率$P_{\mathrm{out}}(\tau)$や遅延分布の裾（例：TL\_p95）が重要である．スキャン窓のデューティ比が低い場合，平均受信率が一定でも遅延分布が右に伸び，$P_{\mathrm{out}}(\tau)$が支配的な評価軸になる．

理想化した周期モデルでは，広告イベントとスキャン窓の相互作用から遅延分布を解析できるが，実際のスマートフォンはOSの省電力機構によりスキャンが間欠化し，観測できない内部状態が存在する．したがって，本研究では解析モデルによる厳密導出ではなく，実測ログに基づき$P_{\mathrm{out}}(\tau)$と電力のトレードオフを描き，方策比較を端末内比較として解釈する．

\subsubsection{scan duty・sleepとoutageの関係}
受信側のsleepは，スキャンデューティ比の縮退として現れ，TL分布の裾を悪化させる方向に作用する．一方で送信側のsleepは，広告間隔の延伸と組み合わせることで平均電力を下げる．この二面性を踏まえ，sleepは背景・装置・考察に分散して扱う必要がある．

\subsection{不確実度駆動の通信制御（クロスレイヤー）}
推論モデルが出力する確率分布は，不確実度として定量化できる．不確実度に基づいて「重要なときだけ通信する」「確信が低いときだけサンプリングや送信を増やす」といった制御は，エッジAIにおける省電力化の代表的な戦略である．

ただし，不確実度の定義や較正が不適切であると，確信が過大評価されて長間隔に偏り，QoS違反が増える危険がある．本研究では，確率較正の必要性を踏まえつつ（将来課題），まずは確率分布から導出した$U$と時間的一貫性$S$を組み合わせ，説明可能な複合スコアCCSとして通信制御へ接続する．

\subsection{TinyML環境での制約付き学習・実装論}
MCU上で学習・制御を実装する場合，RAMや演算資源の制約により，実装可能なアルゴリズムが制限される．現実的には，学習器そのものは単純な最適化に徹し，その外側にSafety Filter（Action Masking等）を置いてハード制約を担保する構造が採られることが多い．

本研究の行動集合（広告間隔）は小さいため，Phase 2での拡張としては，低次元のコンテキストに対する軽量なContextual Banditが候補となる．一方，Phase 1の段階では，実験計測と指標定義がボトルネックになるため，まずはルールベース方策で再現性の高いデータを取得することが重要である．

\subsection{オンライン最適化（バンディット）と安全制約}
医療・見守り等の用途ではQoS違反が許容されにくく，探索の過程で制約を破るリスクが課題となる．このため，本研究は，Phase 1として安全側のルールベース方策と評価指標を確立した上で，将来課題として安全制約付きのContextual Bandit（Safe Contextual Bandit）へ接続する方針を採る．

\subsection{本研究の位置づけ}
表\ref{tab:related_work_positioning}に，本研究と関連アプローチの整理を示す．本研究は，「不確実度を用いた動的制御」と「電力＋QoSの同時実測」を同一の評価系で統合し，Phase 2の安全制約付きオンライン最適化へ接続できる形に整理する点に特徴がある．

\begin{table}[tb]
  \centering
  \caption{関連アプローチと本研究の位置づけ（概念整理）}
  \label{tab:related_work_positioning}
  \begin{tabular}{p{0.22\linewidth}p{0.22\linewidth}p{0.22\linewidth}p{0.22\linewidth}}
    \toprule
    区分 &amp; 主な入力 &amp; 制御の形式 &amp; 評価の主軸 \\
    \midrule
    固定設計 &amp; 規格・経験値 &amp; 固定$a$ &amp; 平均電流，PDR \\
    ルールベース &amp; 混雑度・直近受信 &amp; 閾値で切替 &amp; 平均電力，遅延 \\
    バンディット &amp; 観測（報酬） &amp; 探索＋活用 &amp; 報酬最大化 \\
    本研究 &amp; $U,S,\mathrm{CCS}$ &amp; ルール（Phase 1） &amp; $\overline{P}$，$P_{\mathrm{out}}(\tau)$，TL\_p95 \\
    \bottomrule
  \end{tabular}
\end{table}</file><file path="修士論文/chapters/ch3_oncampus.tex">% chapters/ch3_oncampus.tex --- 第7章 実験装置・計測方式
\section{実験装置・計測方式}
\label{sec:measurement_setup}

\subsection{概要}
本研究の一次KPIは，省電力指標$q_{\mathrm{event}}$（$\si{\micro\coulomb}/\text{event}$）とQoS（TL，$P_{\mathrm{out}}(\tau)$）である．これらを同一試行で評価するため，送信（TX），電力（TXSD），受信（RX）の三ノード構成を採用し，同期信号で試行区間を揃える．本節では，計測方式とログ設計を「再現できる手順」として整理する．

\subsection{三ノード構成（TX/TXSD/RX）}
各ノードの役割を表\ref{tab:nodes}に示す．

\begin{table}[tb]
  \centering
  \caption{評価系のノード構成}
  \label{tab:nodes}
  \begin{tabular}{lll}
    \toprule
    ノード &amp; 役割 &amp; 主なログ \\
    \midrule
    TX &amp; BLE広告送信・間隔制御 &amp; ペイロード（時刻/タグ），制御状態 \\
    TXSD &amp; 電力計測（INA219） &amp; 電圧・電流系列，集約指標 \\
    RX &amp; 受信ログ取得 &amp; 受信時刻，RSSI，ペイロード \\
    \bottomrule
  \end{tabular}
\end{table}

\subsubsection{機材と計測パラメータ}
本研究の計測は，汎用マイコン（ESP32系）と電流センサ（INA219）を中心に構成する．表\ref{tab:hw}に，主要な構成要素と役割を示す．

\begin{table}[tb]
  \centering
  \caption{計測システムの主要構成}
  \label{tab:hw}
  \begin{tabular}{ll}
    \toprule
    要素 &amp; 役割 \\
    \midrule
    ESP32（TX） &amp; BLE広告送信，広告間隔制御，ペイロード生成 \\
    ESP32（TXSD） &amp; INA219計測データの収集，SD保存，エネルギー集約 \\
    ESP32（RX）/スマートフォン &amp; 受信ログの取得（時刻，RSSI，seq） \\
    INA219 &amp; 電流・電圧の計測（サンプリング周期は試行条件に依存） \\
    SYNC/TICK &amp; 試行区間の同期，広告回数の物理カウント \\
    \bottomrule
  \end{tabular}
\end{table}

\subsection{同期設計（SYNC/TICK）}
\subsubsection{SYNC（試行区間の整列）}
試行（trial）の開始・終了を揃えるために，同期信号（SYNC）を用いる．TXは試行区間の境界でSYNC信号を出力し，TXSDおよびRXはこの信号に同期してログ取得区間を区切る．SYNCにより，「どの区間の電力・受信ログを比較するか」を明確化できる．

\subsubsection{TICK（広告回数の物理カウント）}
広告イベント数$N_{\mathrm{adv}}$は，到達性指標の分母として重要である．可能であれば，TXがTICK信号を出力し，TXSD側で割り込みにより広告回数を物理カウントする．TICKが利用できない場合は，試行時間と広告間隔から期待回数を推定するが，動的切替では誤差が入り得るため解釈に注意する．

\subsubsection{配線例（UCCS評価）}
本研究で用いた配線例を表\ref{tab:wiring_example}に示す（実験ディレクトリのREADMEに準拠）．ピン番号は実装に依存するため，運用時はRunbookに記録して固定する（\secref{sec:runbook}）．

\begin{table}[tb]
  \centering
  \caption{配線例（UCCS評価）}
  \label{tab:wiring_example}
  \begin{tabular}{lll}
    \toprule
    信号 &amp; TX（GPIO） &amp; 受け側（GPIO） \\
    \midrule
    SYNC &amp; 25 &amp; RX:26, TXSD:26 \\
    TICK &amp; 27 &amp; TXSD:33 \\
    \bottomrule
  \end{tabular}
\end{table}

\subsection{ログ設計とスキーマ}
解析の再現性を担保するため，ログの列（カラム）を固定する．本研究では，TXSDログ末尾のsummary（例：$N_{\mathrm{adv}}$，$E$，$\overline{P}$）を一次情報として扱い，RXログはPDR/TL評価の基礎とする．ログスキーマの詳細は\secref{sec:log_schema}に示す．

\subsubsection{TXSD（電力）ログ}
TXSDログは，時刻と計測値（電圧・電流）を行ごとに保持し，末尾に集約値を出力する．積分は$\Delta t$を用いた逐次積分とし，後処理でも再積分して監査する（計測系の健全化は\secref{sec:measurement_system}で述べる）．

\subsubsection{RX（受信）ログ}
RXログは，受信時刻，RSSI，ペイロード（seq等）を保持する．重複受信があるため，seqでユニーク化した件数を併記する（\secref{sec:metrics_detail}）．また，TL/Pout算出にはRXログとtruthの時間軸整合が必要であり，定数オフセット補正を用いる（定義と実装は\secref{sec:stress_fixed_metrics}で述べる）．

\subsubsection{ファイル命名}
ログは試行単位で分割し，\texttt{\detokenize{trial_XXX.csv}}等の連番で管理する．条件IDやスキャン設定の違いは，preambleの条件ID（TICKパルス等）と作業ログにより追跡する．

\subsection{計測方針（電力とQoSの同時評価）}
本研究では，電力とQoSを同一試行で同時に評価する．電力はTXSD，QoSはRXを主に用いる．ただし，動的切替では「イベント時刻の定義」と「時間同期」が結果を左右するため，指標定義（特にTL/Pout）は\secref{sec:stress_fixed_metrics}で固定する．

\subsubsection{ON/OFF差分とsleep}
省電力指標$q_{\mathrm{event}}$は，電荷積分に基づくため，ログ欠損や単位不整合の影響を強く受ける．そのため，広告ON/OFF差分による基準補正や，生ログからの再積分監査が重要となる．また，送信側がlight sleep等に入れる条件では，広告間隔を伸ばすことが平均電力低下に直結する．sleepの有無は条件として明示し，同一コード系列で比較する（運用手順は\secref{sec:runbook}）．

\subsection{受信端末の運用（スマートフォン側）}
受信側のスキャン挙動は端末・OS状態に依存するため，実験では運用手順を固定する必要がある．特に，スキャンモード，画面状態，電源状態等を統一し，端末内比較の前提を守る．実験前のチェックリストは\secref{sec:runbook}に示す．

\subsubsection{スキャンアプリと設定例}
受信ログは，BLEスキャナアプリ（例：nRF Connect）等を用いて取得する．再現性の観点から，以下を固定する．
\begin{itemize}
  \item スキャンモード：LOW\_LATENCY相当（可能な範囲で最も積極的なスキャン）
  \item フィルタ：対象UUID等でフィルタする場合は条件として明記し，条件間で統一する
  \item 画面：試行中は画面ONを維持し，アプリを前面に置く
\end{itemize}

\subsubsection{端末状態の固定（端末内比較の前提）}
OSの省電力機構によりバックグラウンド制約やスロットリングが生じ得るため，試行間で端末状態を揃えることが重要である．具体的には，省電力設定の固定，機内モード・Wi-Fi状態の固定，バックグラウンド制限の解除等をRunbookに従って統一する．

\subsection{データ処理の概要}
本研究の解析は，ログを読み込んで指標を算出し，条件ごとに集約して図表を生成する流れである．最小構成として，以下を満たすことを解析の合格条件とする．
\begin{itemize}
  \item 試行区間がSYNCで正しく切れている（期間$T$が想定と一致する）．
  \item TXSDの集約値と後処理の再積分が同程度である（単位・欠損が健全）．
  \item RXのPDR\_uniqueが0付近にならない（受信系が動作している）．
  \item TL/Poutの算出に時間同期（定数オフセット補正）を適用できる．
\end{itemize}

\subsection{まとめ}
本節では，実験装置の構成，同期設計，ログ設計，および運用上の前提を整理した．以降の節では，計測系の破綻モードと修正履歴を体系化し（\secref{sec:measurement_system}），切り分け手順をトラブルシューティング集として整理する（\secref{sec:troubleshooting}）．</file><file path="修士論文/chapters/ch3_system_and_method.tex">% chapters/ch3_system_and_method.tex --- 第3章 システム設計と提案手法（統合）
\chapter{システム設計と提案手法}
\clearpage

本章では，問題設定（World Model，一次KPI，制約）と，HAR推論部から得る不確実度・安定度を用いた広告間隔制御（CCS）を統合して述べる．さらに，CCS写像・パラメータを版管理の観点で整理し，Phase 2（Safe Contextual Bandit）へ接続できる形で前提を固定する．

\input{chapters/ch3_system_design}
\input{chapters/ch9_har_uncertainty}
\input{chapters/ch2_proposed}
\input{chapters/appx_h_ccs_params}</file><file path="修士論文/chapters/ch3_system_design.tex">% chapters/ch3_system_design.tex --- 第4章 問題設定とシステム設計
\section{問題設定とシステム設計}

\subsection{World Model}
本研究は，アプリケーション層（HAR）と通信層（BLE広告）を跨ぐクロスレイヤー制御である．このため，単に広告間隔を調整するだけでなく，「どの情報がどこで生成され，どこで観測されるか」を明確にする必要がある．本節では，役者（Actors）と能力（Capabilities）を整理し，議論の前提を固定する．

\subsubsection{Actors}
表\ref{tab:actors}に，本研究で扱う役者を示す．

\begin{table}[tb]
  \centering
  \caption{Actors（役者）}
  \label{tab:actors}
  \begin{tabular}{p{0.28\linewidth}p{0.62\linewidth}}
    \toprule
    Actor &amp; 役割 \\
    \midrule
    Edge Node / DUT &amp; IMU等からHARを推論し，不確実度$U$・安定度$S$・CCSを生成して広告間隔を制御する（送信側） \\
    Gateway（スマートフォン） &amp; BLE広告を受信する主体．スキャン挙動はOS依存で非理想とみなす（受信側） \\
    Observer（計測系） &amp; 電力（TXSD）と受信（RX）を収集し，一次KPIを算出する（実験時の観測者） \\
    Safety Oracle（概念） &amp; QoS制約$P_{\mathrm{out}}(\tau)\le\delta$を規定する境界（設計上の規格） \\
    Policy Engine &amp; コンテキストから広告間隔を決定する意思決定器（Phase 1はルール，Phase 2でSafe Bandit） \\
    \bottomrule
  \end{tabular}
\end{table}

\subsubsection{Capabilities（5つの柱）}
本研究の設計で重要となる能力を以下にまとめる．
\begin{enumerate}
  \item Perception：HAR推論から確率分布を得て，不確実度$U$と安定度$S$を計算する．
  \item Decision：$U,S$からCCSを構成し，広告間隔$a$を決定する．
  \item Communication：BLE広告として送信し，受信側の非理想スキャン下で到達する．
  \item Safety：QoS制約を守るため，危険兆候では短間隔へ退避できる．
  \item Observability：意思決定の根拠（$U,S,\mathrm{CCS}$，閾値，切替理由）をログに残す．
\end{enumerate}

\subsection{一次KPIと不変条件}
本研究では，議論がぶれないように一次KPIを固定する．表\ref{tab:kpi}に一次・二次KPIを示す．一次KPIは「省電力」と「期限超過」の同時評価を担い，二次KPIは補助指標として扱う．

\begin{table}[tb]
  \centering
  \caption{KPIの整理}
  \label{tab:kpi}
  \begin{tabular}{p{0.22\linewidth}p{0.68\linewidth}}
    \toprule
    区分 &amp; 指標 \\
    \midrule
    一次（Primary） &amp; $\si{\micro\coulomb}/\text{event}$，$P_{\mathrm{out}}(\tau)$，TL\_p95 \\
    二次（Secondary） &amp; 平均電力$\overline{P}$，PDR（unique），RSSI，切替頻度（switch\_rate），平均広告レート（adv\_rate） \\
    \bottomrule
  \end{tabular}
\end{table}

また，設計上の不変条件として以下を採用する．
\begin{itemize}
  \item 後方互換のIF：\texttt{decide\_interval(context) -&gt; interval} の構造を保ち，ルールから学習へ差し替え可能にする．
  \item 端末内比較：受信端末・設定を固定し，OS依存の影響は端末内で相殺して解釈する．
  \item ログ優先：KPI算出に必要な列を必ず残し，派生値は後処理で再計算できる形にする．
\end{itemize}

\subsection{目的関数と制約}
本研究の問題設定は，広告間隔制御により電力（電荷消費）を下げつつ，期限超過率を制約することである．動的制御の方策$\pi$に対し，
\begin{equation}
  \text{minimize}\quad \mathbb{E}[q_{\mathrm{event}}(\pi)]
  \quad \text{subject to}\quad P_{\mathrm{out}}(\tau;\pi)\le \delta
\end{equation}
として表せる．ここで$q_{\mathrm{event}}$（単位：$\si{\micro\coulomb}/\text{event}$）は，セッション中の電荷消費をイベント数で正規化した指標である（定義は\secref{sec:metrics_detail}）．コンテキストとしては$U,S$（またはCCS）を用い，Phase 1ではルール$\pi_{\mathrm{rule}}$，Phase 2では学習$\pi_{\mathrm{safe\_mab}}$を想定する．

\subsection{フェイルセーフと運用設計}
非理想スキャン環境では，受信品質が瞬間的に悪化する可能性がある．このため，実装では安全側への退避（短間隔）を設けることが望ましい．本研究では，切替規則の設計とログ化により，安全側に寄せた挙動を説明可能にする．

\begin{figure}[tb]
  \centering
  \fbox{\begin{minipage}{0.9\linewidth}
    \vspace{1mm}
    \begin{center}
      \textbf{フェイルセーフ（概念）}
    \end{center}
    \vspace{1mm}
    \begin{itemize}
      \item 通常：CCSに応じて$a\in\{100,500,1000,2000\}\,\si{\milli\second}$を選択
      \item 兆候：受信品質悪化や不確実度急増などの兆候で短間隔へ退避
      \item 監査：退避の根拠をログ（reason）として保存
    \end{itemize}
    \vspace{1mm}
  \end{minipage}}
  \caption{フェイルセーフ設計の概念図}
  \label{fig:failsafe_concept}
\end{figure}

\subsection{フェーズ設計（Phase 1 → Phase 2）}
Phase 1では，ルールベース方策で「計測・指標・実機実装」を成立させることを優先する．特に，TL/Poutの定義と時間同期，電力計測の健全化は，学習以前に必須である．Phase 2では，コンテキスト（$U,S$）と行動（広告間隔）の選択をSafe Contextual Banditとして定式化し，環境差に適応しつつQoS制約を守る枠組みを検証する．</file><file path="修士論文/chapters/ch4_measurement_metrics_repro.tex">% chapters/ch4_measurement_metrics_repro.tex --- 第4章 計測系・ログ設計・指標定義（再現性）（統合）
\chapter{計測系・ログ設計・指標定義（再現性）}
\clearpage

本研究は，非理想スキャン環境と実機ログに依存するため，条件混在や欠損により結論が逆転し得る．そのため，本章では再現性確保（計測系，ログ設計，指標定義，運用手順，破綻モード）を本文に統合して明示し，評価の前提を固定する．

\input{chapters/ch3_oncampus}
\input{chapters/ch8_measurement_system}
\input{chapters/ch8_experiment_design}
\input{chapters/ch10_implementation}

% 付録だった内容を本文に吸収（章は増やさない）
\input{chapters/appx_d_log_schema}
\input{chapters/appx_a_metrics}
\input{chapters/appx_e_runbook}
\input{chapters/appx_f_symbols}
\input{chapters/appx_b_assets}
\input{chapters/appx_g_troubleshooting}</file><file path="修士論文/chapters/ch4_rain.tex">% chapters/ch4_rain.tex --- 第4章 評価結果
\section{評価結果}
\label{sec:evaluation_results}

\subsection{固定間隔の基準特性}
固定間隔における$q_{\mathrm{event}}$（$\si{\micro\coulomb}/\text{event}$）と受信品質を基準として整理する．ただし，本節では説明の都合上，電力の従属指標として平均電力の例も併記する．特に，\SI{100}{\milli\second}から\SI{500}{\milli\second}への変更により電力が低下する一方で，受信率や遅延分布が変化するため，制約$\delta$に対する可行性が境界条件として現れる．

\subsubsection{固定間隔の平均電力（例）}
本研究では，固定間隔の平均電力を実測し，オフライン評価で用いる電力テーブルとして利用する．表\ref{tab:power_table_example}に，\SI{100}{\milli\second}から\SI{2000}{\milli\second}までの固定間隔における平均電力の一例を示す．

\begin{table}[tb]
  \centering
  \caption{固定間隔の平均電力（例）}
  \label{tab:power_table_example}
  \begin{tabular}{lll}
    \toprule
    広告間隔 [ms] &amp; 平均電力 [mW] &amp; 備考 \\
    \midrule
    100  &amp; 198.56 &amp; n=10（sleep\_on） \\
    500  &amp; 180.80 &amp; n=9（sleep\_on） \\
    1000 &amp; 178.62 &amp; n=9（sleep\_on） \\
    2000 &amp; 177.47 &amp; n=9（sleep\_on） \\
    \bottomrule
  \end{tabular}
\end{table}

\subsubsection{主効果の観察}
表\ref{tab:power_table_example}の例では，\SI{100}{\milli\second}から\SI{500}{\milli\second}への変更で平均電力が大きく低下する．一方で，\SI{500}{\milli\second}以上では改善幅が小さくなる．この傾向は，動的制御において短間隔の滞在時間を抑制する設計が有効であることを示唆する．

\subsection{動的切替（2値制御）の実機確認}
動的制御の最小構成として，\SI{100}{\milli\second}と\SI{500}{\milli\second}の切替を実装し，固定\SI{100}{\milli\second}および固定\SI{500}{\milli\second}と比較する．平均電力が両固定条件の中間に位置し，受信率も中間的になることを確認することで，切替が成立していることを検証する．

本研究の実測例として，固定\SI{100}{\milli\second}（n=3），固定\SI{500}{\milli\second}（n=3），動的（n=3）における平均電力と受信率のサマリを表\ref{tab:d1_summary}に示す．数値は実装・環境に依存するため，本文執筆時点のログに基づき更新する．

\begin{table}[tb]
  \centering
  \caption{動的切替（2値制御）の実測例（サマリ）}
  \label{tab:d1_summary}
  \begin{tabular}{llll}
    \toprule
    条件 &amp; 平均電力 [mW] &amp; 受信率の目安 [Hz] &amp; 備考 \\
    \midrule
    固定100 &amp; 205.10 $\pm$ 2.79 &amp; 7.94 $\pm$ 0.21 &amp; scan90 \\
    固定500 &amp; 185.50 $\pm$ 0.98 &amp; 1.63 $\pm$ 0.09 &amp; scan90 \\
    動的（100/500） &amp; 192.17 $\pm$ 0.55 &amp; 3.71 $\pm$ 0.11 &amp; 切替動作確認 \\
    \bottomrule
  \end{tabular}
\end{table}

\subsection{実測のQoS指標（TLとPout）}
本研究では，受信品質をPDRだけでなく，遅延分布と期限超過率$P_{\mathrm{out}}(\tau)$で評価する．特に，非理想スキャン環境では平均受信率が同程度でも，遅延の裾が悪化する場合があるため，$P_{\mathrm{out}}(\tau)$が重要となる（\secref{sec:metrics_detail}）．

\subsubsection{実測例（D2，scan90）}
表\ref{tab:d2_summary}に，D2（scan90）における実測例を示す．本表は，S1/S4の2条件について，固定\SI{100}{\milli\second}，固定\SI{500}{\milli\second}，および方策（2値切替）の比較をまとめたものである（各n=3）．

\begin{table}[tb]
  \centering
  \caption{D2（scan90）の実測例（mean$\pm$std, 各n=3）}
  \label{tab:d2_summary}
  \begin{tabular}{lrrrr}
    \toprule
    条件 &amp; $P_{\mathrm{out}}(1\mathrm{s})$ &amp; TL\_mean [s] &amp; PDR\_unique &amp; 平均電力 [mW] \\
    \midrule
    S1\_fixed100 &amp; 0.0833$\pm$0.0289 &amp; 4.200$\pm$1.552 &amp; 0.805$\pm$0.010 &amp; 203.8$\pm$0.1 \\
    S1\_fixed500 &amp; 0.1000$\pm$0.0000 &amp; 5.276$\pm$0.054 &amp; 0.831$\pm$0.014 &amp; 183.8$\pm$0.2 \\
    S1\_policy   &amp; 0.0667$\pm$0.0289 &amp; 3.315$\pm$1.538 &amp; 0.803$\pm$0.003 &amp; 203.7$\pm$0.3 \\
    \midrule
    S4\_fixed100 &amp; 0.0488$\pm$0.0000 &amp; 1.238$\pm$0.006 &amp; 0.805$\pm$0.012 &amp; 203.7$\pm$0.3 \\
    S4\_fixed500 &amp; 0.1301$\pm$0.0563 &amp; 1.946$\pm$0.417 &amp; 0.838$\pm$0.006 &amp; 184.3$\pm$0.2 \\
    S4\_policy   &amp; 0.0569$\pm$0.0141 &amp; 1.316$\pm$0.145 &amp; 0.810$\pm$0.008 &amp; 204.3$\pm$0.5 \\
    \bottomrule
  \end{tabular}
\end{table}

\subsubsection{解釈}
表\ref{tab:d2_summary}より，固定\SI{500}{\milli\second}は平均電力を低下させる一方で，$P_{\mathrm{out}}(1\mathrm{s})$が悪化する条件が存在する．また，方策は固定条件の中間的な特性に位置付くが，滞在比率（短間隔への偏り）により電力・QoSのどちらに寄るかが変化する．したがって，方策評価では，滞在比率と固定点（基準データ）の整合を確認しながら解釈する必要がある．

\subsection{オフライン評価との整合}
オフライン評価で予測される運用点と，実機で得られる平均電力・受信品質の差分を比較し，推定モデルの妥当性と限界を整理する．

\subsubsection{予測と実測の差分}
オフライン評価は，固定間隔の電力テーブルと受信品質推定を合成するため，実環境の非理想性を完全には表現しない．したがって，予測値は「候補探索と説明のための近似」として用い，実測との差分を評価しながらモデルの限界を記述することが重要である．

\subsubsection{δ帯プロット（参考）}
図\ref{fig:delta_band_again}に，オフライン評価の代表例としてδ帯プロットを示す．固定間隔点と候補方策点を同一平面で可視化することで，制約境界付近における省電力運用点の存在を示す．

\begin{figure}[tb]
  \centering
  \includegraphics[width=0.95\linewidth]{../results/mhealth_policy_eval/letter_v4_scan90_v5_delta_tight_sleep_on_n9_10_actions_100_500/fig_delta_band.png}
  \caption{δ帯（例）におけるPout(1s)と平均電力のトレードオフ（オフライン評価）}
  \label{fig:delta_band_again}
\end{figure}

\subsection{まとめ}
本節の結果を，次章の考察に接続するために要点を整理する．</file><file path="修士論文/chapters/ch5_evaluation.tex">% chapters/ch5_evaluation.tex --- 第5章 評価（統合）
\chapter{評価}
\clearpage

本章では，ストレス固定実験に基づくTL/Pout指標の確立，オフライン評価による候補探索，および実機評価結果をまとめる．固定間隔と提案方策を同一の評価指標で比較し，省電力とQoSのトレードオフを示す．

\input{chapters/ch6_stress_fixed}
\input{chapters/ch7_offline_eval}
\input{chapters/ch4_rain}

% 付録だった追加結果は評価章に吸収
\input{chapters/appx_c_results}</file><file path="修士論文/chapters/ch5_publicroad.tex">% chapters/ch5_publicroad.tex --- 第5章 考察
\chapter{考察}
\clearpage

\section{非理想スキャン環境における解釈}
受信側スキャンの非理想性は，平均的な受信率だけでなく，遅延の裾や期限超過に影響する．端末・OS状態に依存する要素を前提として，評価は端末内のA/B比較として解釈する必要がある．

\subsection{評価の前提}
本研究では，端末内比較の前提を守るため，固定条件と提案条件を同一実験系で取得し，同じ処理パイプラインで集計する．また，ログ欠損や同期ずれが評価結果に直結するため，解析対象の選別や単位整合の監査を行う．

\section{制御設計の妥当性と限界}
ルールベース方策は実装が単純であり，安全側のフォールバックを設計しやすい．一方で，環境ごとに最適な運用点は変化するため，固定閾値では追従できない場合がある．また，切替頻度の増加はログ整合や同期の難易度を上げるため，実装面での制約もある．

\subsection{2値制御の位置づけ}
2値制御は，実機検証を最小構成で成立させる上で有効である．一方で，\SI{1000}{\milli\second}や\SI{2000}{\milli\second}など長間隔を含めた最適化は，より大きな省電力の可能性を持つ．今後は，計測・同期の堅牢性を維持した上で行動空間を拡張し，QoS制約の境界をより広い範囲で評価する必要がある．

\subsection{閾値設計と感度}
CCS閾値は，入力データ（活動種別やモデルの確信度分布）に依存する．閾値を厳しくしすぎると短間隔に偏って省電力効果が薄れ，緩くしすぎると長間隔に偏ってQoS違反が増える．したがって，オフライン評価で候補を絞り込んだ上で，実機の端末内比較で境界付近を詰めるアプローチが実務上有効である．

\section{sleepの扱いと計測公平性}
本研究は，広告間隔を制御することで無線イベント回数を減らし，さらに送信側がsleepに入れる時間を増やすことで平均電力を下げることを狙う．一方で，sleepは計測条件そのものでもあるため，条件が混ざると比較が成立しない．本節では，sleepを議論に入れるための前提を整理する．

\subsection{送信側sleep（平均電力への寄与）}
送信側（DUT）がlight sleep等に入る構成では，広告間隔を延ばすほどsleep時間が増え，平均電力が低下しやすい．ただし，周辺回路やロギングの定常負荷が支配的な場合，改善は飽和する．したがって，sleepの有無（ON/OFFを含む）を条件として明示し，同一コード系列・同一設定の端末内比較として評価することが必要である．

\subsection{受信側sleep（scan dutyの縮退）}
受信側（スマートフォン）のスキャンは，OSの省電力機構や端末状態により間欠化し得る．この受信側sleepは，TL分布の裾を伸ばし，$P_{\mathrm{out}}(\tau)$を悪化させる方向に作用する．したがって，本研究の主張は「理想スキャン下の最適性」ではなく，「非理想スキャン下でも端末内比較として省電力な運用点が存在し得る」ことに置く．

\subsection{OFF計測と差分評価}
計測系の定常負荷が大きい場合，平均電力だけでは広告間隔の差が埋もれる．この場合，広告ON/OFF差分$\Delta E$を広告回数で正規化した$\Delta E/N_{\mathrm{adv}}$を併用することで，「無線1回当たりの増分」として議論できる．ただし，OFFのsleep状態やスタック状態がONと異なると差分の解釈が難しくなるため，Runbookに従って条件を固定する必要がある．

\section{Safe Contextual Banditへの拡張}
将来的には，コンテキスト（不確実度，安定度）に応じて行動（広告間隔）を選択し，報酬（省電力）を最大化しながら制約（$P_{\mathrm{out}}(\tau)\le\delta$）を満たすSafe Contextual Banditとして定式化する．ルールベース方策と固定間隔の基準データは，Warm-Startの事前情報として活用できる．

\subsection{Warm-Startの意義}
オンライン学習では，学習初期の探索によってQoS制約を破るリスクがある．ルールベース方策は，安全側の初期方策として利用でき，探索の範囲を制約内に保つ設計に接続しやすい．したがって，Phase 1に相当するルールベース評価は，オンライン最適化の前提条件として重要である．

\section{失敗・未完タスクの位置づけ}
修士論文では，うまくいかなかった点や未完タスクを隠すのではなく，「何が揃っていて，何が揃っていないか」を明示することが再現性に直結する．本研究は，Phase 1として評価系を確立することを目的に置くため，未完点を将来課題として整理し，Phase 2へ接続する材料とする．

\subsection{HARモデル（A\_tiny）の未完点}
A\_tinyは，4クラス性能の未達やTFLite生成・実機計測が未完である．この状態で閾値制御を議論すると，確率出力の較正や量子化誤差により，CCS分布と閾値の意味が変化する危険がある．したがって，本論文では参照モデルA0を土台として不確実度定義を固定し，A\_tinyの改善は今後の課題として明確化する．

\subsection{計測系トラブルの位置づけ}
計測系のトラブル（SYNC取りこぼし，UART欠損，SD失敗など）は，研究の本質ではないが，無視すると結論を逆転させ得る．そのため，本研究では計測系の破綻モードと対策を\secref{sec:measurement_system}で整理し，切り分け手順を\secref{sec:troubleshooting}にまとめた．

\section{脅威と限界（Threats to Validity）}
本研究の評価は，実機の端末内比較と，オフライン合成評価を組み合わせている．したがって，以下の脅威と限界を明示する必要がある．
\begin{itemize}
  \item 外的妥当性：受信端末やOSバージョンが変わると，スキャンの非理想性が変化し，同一方策でもQoSが変化し得る．
  \item 内的妥当性：ログ欠損や単位換算の誤りは結論を逆転させ得るため，計測健全化と監査を必須とする（\secref{sec:measurement_system}）．
  \item モデル近似：オフライン評価は滞在比率に基づく合成であり，切替直後の非定常性や相関は近似に含まれない．
  \item 不確実度較正：確率値が過信されると閾値の意味が崩れるため，較正（温度スケーリング等）の導入が今後の課題となる（\secref{sec:har_uncertainty}）．
\end{itemize}

\section{今後の課題}
本研究で未解決の課題として，スキャン挙動の端末差の系統的整理，動的制御におけるQoS指標（TL分布・$P_{\mathrm{out}}$）の高精度評価，およびオンライン学習導入時の安全側設計が挙げられる．

\subsection{QoS評価の高精度化}
動的制御では，イベント時刻の定義と時間同期が結果を左右する．特に長間隔では，開始位相のずれや受信の間欠性により，TL分布と$P_{\mathrm{out}}(\tau)$が不自然に見える場合がある．今後は，ペイロードにインデックス等を埋め込み，時間軸を確実に復元できるログ設計と解析を統一する．

\subsection{行動集合の拡張}
2値制御は最小構成として有効であるが，運用点の探索範囲を狭める．今後は，$\{100,500,1000,2000\}$のように行動集合を拡張し，制約$\delta$の境界に沿ってより良いトレードオフ点が存在するかを検証する．その際，切替頻度が増えるため，ログ整合と時間同期の堅牢化が前提条件となる．</file><file path="修士論文/chapters/ch6_stress_fixed.tex">% chapters/ch6_stress_fixed.tex --- 第6章 ストレス固定実験と指標定義（scan50/scan90, v5）
\section{ストレス固定実験と指標定義の確立}
\label{sec:stress_fixed_metrics}

\subsection{目的}
本節では，ストレス固定（stress\_fixed）実験を用いて，QoS指標（TLおよびPout(τ)）の定義を「論文で説明できる形」に固定し，実測結果を再現可能に整理する．特に，受信ログの時間軸と真値（truth）の開始位相ずれがTL/Poutに与える影響を明確化し，補正手順を定式化する．

\subsection{実験条件の概要}
ストレス固定実験では，既知のラベル系列（truth）をTX側で再生し，受信側（RX）がそれをどの程度の遅延で観測できるかを測定する．主な比較軸は以下である．
\begin{itemize}
  \item 受信設定：scan50（duty 50\% 相当）とscan90（duty 90\% 相当）
  \item 固定広告間隔：\SI{100}{\milli\second}，\SI{500}{\milli\second}，\SI{1000}{\milli\second}，\SI{2000}{\milli\second}
  \item ストレス列：代表的な2条件（例：S1，S4）を中心に評価
\end{itemize}
各trialについて，TXSDログとRXログを対応付け，PDR，TL，Pout(τ)，平均電力などを出力する．

\subsection{v4で観察された問題}
scan90のv4集計では，固定\SI{2000}{\milli\second}においてPout(1s)が理論下限より小さく見える等，直感に反する挙動が観察された．原因は，RXログの`ms`とtruthの時間軸が一致している前提でTL/Poutを計算していた点にある．実機では試行開始のタイミングがずれ得るため，このずれを補正しないとTL/Poutが過小評価される．

\subsection{v5での時間同期（定数オフセット補正）}
v5では，TL/Pout算出前に定数オフセットを推定し，RXログの時刻を補正する．広告間隔を$\Delta t$（ms），受信ログから得られるseqの初回観測時刻を$\mathrm{first\_ms}(\mathrm{seq})$とすると，seqに対応する期待時刻は$\mathrm{seq}\cdot\Delta t$である．複数のseqに対し，
\begin{equation}
  \mathrm{offset\_ms} = \mathrm{median}_{\mathrm{seq}&gt;0}\left(\mathrm{seq}\cdot\Delta t - \mathrm{first\_ms}(\mathrm{seq})\right)
\end{equation}
としてオフセットを推定し，補正後の時刻を$\mathrm{ms\_aligned}=\mathrm{ms}+\mathrm{offset\_ms}$とする．TL/Poutは$\mathrm{ms\_aligned}$に基づいて算出する．この補正により，開始位相ずれに起因する過小評価を抑制できる．

\subsection{生成物と再現性}
v5では，per-trialの集計に加え，modes/agg/enrichedの集約表を再現可能に生成するパイプラインを整備した．また，scan50とscan90の比較結果も同一の定義で出力し，受信設定の違いがPDRやTL/Poutに与える影響を整理できるようにした．

\subsubsection{PDRの扱い}
PDRは受信ログの行数に基づく指標（重複含む）と，seqでユニーク化した指標（重複除外）の2種類を区別する．QoS比較では，広告イベントの「何割を一度でも拾えたか」を表すPDR\_uniqueを優先する（\secref{sec:metrics_detail}）．

\subsubsection{EFFECTIVE\_LENと末端遷移}
真値（truth）は有限長のラベル系列であり，試行時間のクランプにより末端の遷移が試行区間外に出る場合がある．その場合，末端遷移を含めた評価は不安定になるため，truth側も同じ長さにクリップし，イベント数$N_{\mathrm{event}}$の分母を揃える．この処理は，試行間比較と再現性の観点で重要である．

\subsection{結果（図表）}
\subsubsection{scan90の指標サマリ}
図\ref{fig:stress_fixed_scan90_metrics}に，scan90における主要指標の例を示す．この図は，v5の時間同期を反映したものであり，長間隔側でTL/Poutが不自然に小さくなる問題が緩和される．

\begin{figure}[tb]
  \centering
  \includegraphics[width=0.95\linewidth]{../results/stress_fixed/figures_v5/fig1_scan90_metrics.png}
  \caption{ストレス固定（scan90）の主要指標（v5）}
  \label{fig:stress_fixed_scan90_metrics}
\end{figure}

\subsubsection{実測と簡易モデルの比較}
図\ref{fig:stress_fixed_real_vs_sim}に，ストレス固定における実測と簡易モデル（比較用）の例を示す．簡易モデルは，スキャンの非理想性や開始位相ずれの影響を完全には表現できないため，実測との差分が残る．一方で，固定間隔の相対関係（短間隔ほど遅延が改善しやすい等）のトレンドを説明する補助として利用できる．

\begin{figure}[tb]
  \centering
  \includegraphics[width=0.95\linewidth]{../results/stress_fixed/compare/stress_causal_real_vs_sim.png}
  \caption{ストレス固定における実測と簡易モデルの比較（例）}
  \label{fig:stress_fixed_real_vs_sim}
\end{figure}

\subsubsection{scan50とscan90の比較}
図\ref{fig:stress_fixed_scan50_vs_scan90_pdr}に，scan50とscan90の比較（例：PDR\_unique）を示す．duty比を上げることで短間隔側の受信品質が改善することが確認できる．

\begin{figure}[tb]
  \centering
  \includegraphics[width=0.85\linewidth]{../results/stress_fixed/figures_v5/fig3_scan50_vs_scan90_pdr_unique.png}
  \caption{ストレス固定におけるscan50とscan90の比較（例：PDR\_unique，v5）}
  \label{fig:stress_fixed_scan50_vs_scan90_pdr}
\end{figure}

\subsection{指標の変化例（v4→v5）}
時間同期の導入により，TL/Poutが大きく変化する条件が存在する．例えば，固定\SI{2000}{\milli\second}のPout(1s)や，固定\SI{100}{\milli\second}のTL平均値が大きく更新される場合がある．本研究では，v5を正式な定義として扱い，下流のオフライン評価や図表はv5へ差し替える．

\subsection{まとめ}
本節では，ストレス固定実験を用いてTL/Poutの定義と実装を固定し，開始位相ずれを補正するv5の時間同期手順を示した．以降では，この指標定義を前提として，固定間隔および動的制御の評価を行う．</file><file path="修士論文/chapters/ch7_offline_eval.tex">% chapters/ch7_offline_eval.tex --- 第7章 オフライン評価（mHealth合成 + ルールベース方策）
\section{オフライン評価：mHealth合成とルールベース方策探索}
\label{sec:offline_eval}

\subsection{目的}
実機実験の探索空間を縮小し，説明可能な代表方策を選定するために，オフライン評価を行う．本節では，mHealth由来の時系列（不確実度・安定度・複合スコア）に対してルールベース方策を適用し，固定間隔の電力テーブルと組み合わせて，QoS制約下の省電力運用点を探索する．

\subsection{入力データ（mHealth合成）}
オフライン評価では，実機上でのHAR推論を直接用いる代わりに，既存データセット由来の時系列（mHealth）から$U,S,\mathrm{CCS}$を合成し，方策を適用する\scite{uci_ml_repo}．これにより，実機で高価な全探索を行う前に，閾値やヒステリシスの候補を絞り込める．

\subsection{方策のパラメータ化}
ルールベース方策は，次のパラメータで表せる．
\begin{itemize}
  \item 閾値：$\theta_{\mathrm{low}},\theta_{\mathrm{high}}$
  \item ヒステリシス幅：$\Delta\theta$（上り・下りの閾値差）
  \item 最小滞在時間：$t_{\mathrm{dwell}}$
  \item 行動集合：$A=\{100,500\}$ または $\{100,500,1000,2000\}$
\end{itemize}
オフライン評価では，これらの組合せをスイープし，平均電力とQoS制約の観点からParetoフロントを抽出する．

\subsection{電力テーブル（固定間隔の実測）}
固定間隔ごとの平均電力は，実機計測から得られる．オフライン評価では，この電力テーブルに基づき，「ある方策が各広告間隔にどの程度滞在するか」を合成して平均電力を推定する．

\subsubsection{平均電力の合成}
方策$\pi$が間隔$a\in A$に滞在する比率を$\rho_\pi(a)$とし，固定間隔の平均電力を$P(a)$とすると，方策の平均電力は
\begin{equation}
  \overline{P}_\pi=\sum_{a\in A}\rho_\pi(a)\,P(a)
\end{equation}
で近似できる．ここで$\rho_\pi(a)$は，mHealth時系列に方策を適用した結果の滞在時間比率として求める．

\subsection{QoS制約と境界条件}
オフライン評価では，代表的な期限$\tau$に対するPout(τ)を制約として扱い，$\delta$を満たす運用点を可行集合として抽出する．$\delta$は厳しすぎると可行集合が空になり，緩すぎると省電力とQoSの議論が弱くなるため，境界付近を主張点として設計することが重要である．

\subsubsection{QoSの推定}
オフライン評価におけるQoS推定は，固定間隔の実測から得られる$P_{\mathrm{out}}(\tau\mid a)$等の指標を参照し，方策の滞在比率に基づき合成する（詳細は\secref{sec:metrics_detail}）．動的切替時の非定常性（切替直後の遅延分布など）は近似に含まれないため，実機評価で差分を検証する必要がある．

\subsection{Paretoフロントとδ帯プロット}
図\ref{fig:letter_delta_band}に，オフライン評価の代表例として，Pout(1s)と平均電力のトレードオフを示す．固定間隔点と候補方策点を同一平面で可視化することで，制約$\delta$付近における省電力運用点の存在を示す．

\begin{figure}[tb]
  \centering
  \includegraphics[width=0.95\linewidth]{../results/mhealth_policy_eval/letter_v4_scan90_v5_delta_tight_sleep_on_n9_10_actions_100_500/fig_delta_band.png}
  \caption{δ帯（例）におけるPout(1s)と平均電力のトレードオフ（オフライン評価）}
  \label{fig:letter_delta_band}
\end{figure}

\subsubsection{Paretoプロット（全体像）}
図\ref{fig:pareto_plots}に，スイープ結果の全体像としてParetoプロットの例を示す．ここでは，行動集合を$\{100,500\}$に縮退した評価（実装の単純性を優先）を例とする．

\begin{figure}[tb]
  \centering
  \includegraphics[width=0.95\linewidth]{../results/mhealth_policy_eval/pareto_front_v8_power_table_scan90_v5_sleep_on_n9_10_actions_100_500/pareto_plots.png}
  \caption{Paretoプロット（例）：行動集合$\{100,500\}$に縮退したオフライン評価}
  \label{fig:pareto_plots}
\end{figure}

\subsection{行動空間の縮退（\{100,500\}）}
実機の動的制御を最小構成で成立させるため，行動空間を\{100,500\}に限定して代表方策を再選定する．この縮退により，実機側の実装・解析の複雑性を抑えつつ，電力低下の主効果（短間隔滞在の削減）に整合した比較が可能となる．

\subsection{選定方策の例}
オフライン評価の出力は，単一の最良方策ではなく，「制約$\delta$付近で成立する候補集合」として整理する．その上で，実機実験の本数制約や説明容易性を踏まえて代表点を選定する．代表点の一覧は\secref{sec:extra_results}に示す．

\subsection{まとめ}
本節では，mHealth合成と固定間隔の実測電力テーブルを組み合わせたオフライン評価により，QoS制約下での省電力運用点を探索する枠組みを示した．次節では，実機評価結果（\secref{sec:evaluation_results}）を示す．</file><file path="修士論文/chapters/ch8_experiment_design.tex">% chapters/ch8_experiment_design.tex --- 第9章 実験設計
\section{実験設計}
\label{sec:experiment_design}

\subsection{実験の目的}
Phase 1の実験目的は，ルールベース方策（CCS→広告間隔切替）が，固定間隔に対して省電力とQoSのトレードオフ上で優位な運用点になり得ることを示すことである．具体的には，以下を検証する．
\begin{enumerate}
  \item 省電力：固定\SI{100}{\milli\second}よりも$q_{\mathrm{event}}$（$\si{\micro\coulomb}/\text{event}$）が低い運用点が存在する．
  \item QoS維持：代表的な期限$\tau$に対して$P_{\mathrm{out}}(\tau)$が過度に悪化しない．
  \item トレードオフ：固定点と動的点を同一平面（$P_{\mathrm{out}}(\tau)$--$q_{\mathrm{event}}$）で比較し，Pareto的な位置づけを示す．
\end{enumerate}

\subsection{実験条件}
\subsubsection{環境条件}
実験は，距離，受信端末，スキャン設定等を固定し，端末内比較として実施する．干渉状況の違い（例：E1/E2）は外的要因として扱い，必要に応じて環境を分けて評価する．

\begin{table}[tb]
  \centering
  \caption{環境条件（例）}
  \label{tab:env_conditions}
  \begin{tabular}{ll}
    \toprule
    項目 &amp; 値（例） \\
    \midrule
    距離 &amp; \SI{1}{\meter} \\
    TxPower &amp; \SI{0}{\decibelmilliwatt} \\
    受信端末 &amp; Android（同一端末で統一） \\
    スキャンモード &amp; LOW\_LATENCY（前提条件を固定） \\
    \bottomrule
  \end{tabular}
\end{table}

\subsubsection{制御条件}
制御条件は，固定間隔（ベースライン）と動的制御（提案）を含む．Phase 1の基本方針は，行動集合を$\{100,500,1000,2000\}\,\si{\milli\second}$とし，短間隔（QoS重視）と長間隔（省電力重視）の間を段階的に探索できる形にすることである．

一方で，実機実験の初期段階では，計測系の同期とログ整合を優先し，行動集合を$\{100,500\}\,\si{\milli\second}$に縮退した2値切替で動作成立を確認する．以降，計測の堅牢性が担保できた段階で，$\{100,500,1000,2000\}\,\si{\milli\second}$へ拡張する．

\begin{table}[tb]
  \centering
  \caption{制御条件（例）}
  \label{tab:control_conditions}
  \begin{tabular}{lll}
    \toprule
    条件ID &amp; 条件名 &amp; 広告間隔 \\
    \midrule
    C1 &amp; FIXED-100 &amp; \SI{100}{\milli\second} \\
    C2 &amp; FIXED-500 &amp; \SI{500}{\milli\second} \\
    C3 &amp; FIXED-2000 &amp; \SI{2000}{\milli\second} \\
    C4 &amp; POLICY（2値） &amp; \SI{100}{\milli\second}/\SI{500}{\milli\second} \\
    C5 &amp; POLICY（3値） &amp; \SI{100}{\milli\second}/\SI{500}{\milli\second}/\SI{2000}{\milli\second} \\
    \bottomrule
  \end{tabular}
\end{table}

\subsubsection{反復設計}
統計的な揺らぎと端末状態のばらつきを抑えるため，各条件は複数回反復する．最小の成立確認としては各条件$n\ge3$とし，差が小さい場合に反復数を増やす．

また，運用シナリオに近い評価としては，環境（例：E1/E2）を分け，3条件（例：FIXED-100/FIXED-2000/POLICY）$\times$ 2環境 $\times$ 10セッション＝60セッション程度を計画し，端末内比較の前提を維持しながら分散（端末状態の非定常）を平均化する．

\subsection{セッション構成とイベント定義}
\subsubsection{セッション}
セッションは一定時間の試行（trial）の集合として構成する．実機の動的切替では，短い試行（例：\SI{60}{\second}）を連続して取り，条件間比較を端末内で完結させる設計が有効である．一方，運用シナリオに近い評価として，\SI{10}{\minute}程度の長いセッションを用い，活動遷移イベントでTL/Poutを評価する設計も重要である．

\subsubsection{イベント}
イベントは，状態遷移（活動の切替）など「QoS評価の基準点」となる時刻である．固定間隔では広告イベントの列から遅延分布を評価できるが，動的切替では開始位相ずれや切替タイミングが影響するため，truthに基づくイベント定義と時間同期が必要となる（次章）．

\subsection{指標算出}
\subsubsection{電力指標}
一次KPIの省電力指標は$q_{\mathrm{event}}$（$\si{\micro\coulomb}/\text{event}$）である．$q_{\mathrm{event}}$は，TXSDログの電流系列を積分して得た総電荷を，イベント数$N_{\mathrm{event}}$で正規化して算出する（定義は\secref{sec:metrics_detail}）．必要に応じて広告OFFの基準を差し引き，広告による増分を評価する．

平均電力$\overline{P}$や総エネルギー$E$，および広告回数で正規化した$\Delta E/N_{\mathrm{adv}}$等は従属指標として併用し，計測健全性の監査（単位・欠損）と原因切り分けに用いる．

\subsubsection{TLと$P_{\mathrm{out}}(\tau)$}
イベント$j$の遅延を$\mathrm{TL}_j$とすると，
\begin{equation}
  P_{\mathrm{out}}(\tau)=\frac{1}{N_{\mathrm{event}}}\sum_{j=1}^{N_{\mathrm{event}}}\mathbb{I}[\mathrm{TL}_j&gt;\tau]
\end{equation}
である．実装では，RXログの時刻とtruthの時刻の定数オフセットを補正し，$\mathrm{TL}_j$を計算する（次章）．

\subsubsection{理論モデル（参考）}
固定間隔における$P_{\mathrm{out}}(\tau)$は，1広告の受信成功確率$p_d$を仮定すると，
\begin{equation}
  P_{\mathrm{out}}(\tau\mid a)\approx(1-p_d)^{\lfloor \tau/a \rfloor}
\end{equation}
のように近似できる．ただし，非理想スキャンや開始位相の影響を含むため，本研究では理論値は補助的に用い，主張は実測に基づく．

\subsection{リスクと対策}
実験の主要リスクと対策を以下にまとめる．
\begin{itemize}
  \item 同期ずれ：SYNC/TICKの取りこぼしにより試行区間が崩れる．対策として，preambleで条件IDを通知し，ログ末尾のsummaryで監査する．
  \item 条件混在：LED/SYNCの扱い等が異なるコードを跨いで比較すると定常オフセットが入る．比較は同一コード系列で統一する．
  \item 欠損・単位不整合：UART/SDボトルネックや単位換算ミスは結論を逆転させ得る．パススルー化と再積分監査を行う．
  \item 端末状態の変動：受信端末のOS状態は非定常である．端末内比較を徹底し，実験前チェックリスト（\secref{sec:runbook}）を運用する．
\end{itemize}

\subsection{まとめ}
本節では，Phase 1における実験目的と条件，セッション構成，指標算出，およびリスク対策を整理した．次章では，TL/Poutの定義を実測に基づいて固定し，時間同期の手順（v5）を示す．</file><file path="修士論文/chapters/ch8_measurement_system.tex">% chapters/ch8_measurement_system.tex --- 第8章 計測系の健全化と再現性
\section{計測系の健全化と再現性確保}
\label{sec:measurement_system}

\subsection{目的}
本研究の主張は，電力とQoSを同時に評価した上で，固定間隔より良い運用点が存在することを示す点にある．したがって，計測系が不健全であれば，結論そのものが崩れる．本節では，計測系の構成と，過去に発生した代表的な不具合（異常値）の原因と対策を整理し，再現性確保のための運用ルールを述べる．

\subsection{三ノード構成（TX/TXSD/RX）}
電力計測はTX（被測定対象）の消費電流・電圧を計測し，受信品質はRXログから算出する．両者を同一試行で取得するために，同期信号で区間を揃える．この三ノード構成により，方策（固定/動的/学習）を差し替えても，同一の評価パイプラインで比較できる．

\subsection{計測系の破綻モードと対策}
計測系の問題は，「値が揺れる」だけではなく，結論を逆転させる（例：OFFがONより大きい）形で顕在化し得る．表\ref{tab:measurement_failures}に，代表的な破綻モードと対策をまとめる．

\begin{table}[tb]
  \centering
  \caption{計測系の代表的な破綻モードと対策}
  \label{tab:measurement_failures}
  \begin{tabular}{p{0.30\linewidth}p{0.30\linewidth}p{0.30\linewidth}}
    \toprule
    破綻モード &amp; 兆候 &amp; 代表的対策 \\
    \midrule
    I/Oボトルネック（UART/SD） &amp; 欠損増加，rate低下，dtの歪み &amp; パススルー化，塊書き込み，整数CSV化 \\
    単位換算の誤り &amp; 桁ズレ，ON/OFFの逆転 &amp; 生ログから再積分し監査，式とラベルを固定 \\
    条件混在（LED/SYNCの違い等） &amp; 条件間に定常オフセット &amp; 比較は同一コード系列に限定，条件を明文化 \\
    時間軸不整合（RXとtruth） &amp; TL/Poutが不自然に小さい &amp; 定数オフセットで時間同期（\secref{sec:stress_fixed_metrics}） \\
    \bottomrule
  \end{tabular}
\end{table}

\subsection{代表的な異常：OFFがONより大きい問題}
初期の計測では，「広告OFFの方が広告ONより消費が大きい」という物理的に矛盾した結果が観察された．この問題は，無線スタックそのものではなく，PowerLogger側の処理能力不足（I/Oボトルネック）や，単位換算の不整合，UART通信エラーによる欠損が原因となり得る．

\subsubsection{I/Oボトルネックと欠損}
UART受信とSD書き込みを行ごとに実施すると，処理が追従できず欠損が増える．欠損はdtの歪みを生み，エネルギー積分が破綻する．対策として，受信データをバッファリングし，塊（chunk）で書き込むパススルー方式に移行する．

\subsubsection{単位換算の不整合}
電力$p$は$mV\times\mu A$から算出できるが，単位換算の誤り（例えば$10^3$の桁ずれ）があると，平均電力や総エネルギーが大きく誤る．対策として，ログの生データから再計算した値とsummaryの整合を監査し，表示ラベルと計算式を固定する．

\subsubsection{UART通信エラー}
高ボーレートや配線条件により，数値列に文字が混入する（文字化け）場合がある．この場合，パーサが失敗し，欠損や0値が増える．対策として，固定桁ASCII化，ボーレートの見直し，厳密パース，必要に応じた簡易修復やCRCの導入を検討する．

\subsection{実装トラブルと修正履歴}
本節では，実験の再現性を担保するため，実装上の問題と対策を「問題→症状→対策→再発防止」の観点で整理する．ここで扱う内容は，結果の水増しではなく，欠損や時間軸ずれによる結論の崩壊を避けるための前提条件である．

\begin{table}[tb]
  \centering
  \caption{代表的な実装トラブルと対策（要点）}
  \label{tab:implementation_troubles_summary}
  \begin{tabularx}{\linewidth}{p{0.26\linewidth}X p{0.28\linewidth}}
    \toprule
    問題 &amp; 対策（要点） &amp; 再発防止（監査） \\
    \midrule
    UARTデータ化け &amp; ボーレート低下，厳密パース，欠損を許さないsummary設計 &amp; 行数・欠損率・単位監査 \\
    SYNC検出失敗（短パルス） &amp; HIGH保持やラッチで確実に検出できる信号設計へ変更 &amp; TX/RX/TXSDの境界一致を確認 \\
    試行境界の不一致 &amp; SYNC\_END等で試行区間を一致させる &amp; ms\_totalとadv\_countの整合 \\
    SD I/O失敗 &amp; SPIクロック調整，塊書き込み，open失敗時の即時停止 &amp; 末尾summaryの有無を監査 \\
    \bottomrule
  \end{tabularx}
\end{table}

\subsubsection{UARTデータ化け（高ボーレート）}
UARTは，波形品質と受信側処理能力の両面でボトルネックになり得る．症状としては，ログ行の欠落，桁ズレ，数値列への文字混入により，後処理のパースが失敗する．対策として，必要十分なボーレート（例：\SI{115200}{\bit\per\second}）に下げ，列数を絞った整数CSVで出力し，パーサは厳密に失敗扱いとする．

\subsubsection{SYNC\_OUTの短パルス化と検出失敗}
試行境界を揃えるためのSYNCが短いパルスとして出力されると，受信側（RX/TXSD）が取りこぼす可能性がある．この場合，試行区間がずれ，TL/Poutや積分区間が破綻する．対策として，SYNC\_OUTを一定時間HIGH保持する，または受信側でラッチして確実に境界を確定できる設計に変更する．

\subsubsection{試行境界の不一致（SYNC\_END）}
開始だけ同期しても，終了タイミングがずれると試行時間（ms\_total）が揺れ，平均電力の分母が不安定になる．また，truth側の有効長（EFFECTIVE\_LEN）と不整合があると，末端遷移が試行外に出てTL/Poutの分母が揺れる．対策として，開始と終了の両方を同期し，TXSD summaryのms\_totalと解析側の区間が一致するように設計する．

\subsubsection{SDカードI/O（open/init）}
SDカードI/Oは，初期化失敗やopen失敗として顕在化する．そのまま試行を継続すると欠損が増え，結果の解釈が不能になる．対策として，初期化のSPIクロックを下げる，書き込みを塊にする，open失敗時は即時停止して再試行する，などの運用をRunbookに固定する．

\subsection{Golden Master（最小再現構成）}
比較実験では，ON/OFFや条件間でコード系列が混在すると，LEDや同期信号の扱いの差が定常オフセットとなり，純粋な広告間隔の差分を評価できない．したがって，代表的な再現構成（Golden Master）を定め，これを基準としてデータを蓄積する．本研究では，役割ごとにスケッチを分割し，ファイル名の接頭辞（RX\_/TX\_/TXSD\_）で役割を明確化する．

\subsection{運用ルール}
再現性確保のため，以下を原則とする．
\begin{itemize}
  \item 解析対象の選別はマニフェストで明示し，除外理由を記録する．
  \item 単位監査（再積分とsummaryの一致）を定期的に実行し，桁ずれや欠損を早期に検知する．
  \item 重要な作業は作業ログに追記し，生成物のパスとコマンドを残す．
\end{itemize}

\subsection{まとめ}
本節では，計測系の健全化と再現性確保のための要点を整理した．これにより，固定間隔と動的制御の比較が「同一の評価系で再現可能」であることを担保し，次段階（オンライン最適化）へ接続する基盤とする．</file><file path="修士論文/chapters/ch9_har_uncertainty.tex">% chapters/ch9_har_uncertainty.tex --- 第5章 HAR推論部（TinyML）と不確実度の構成
\section{HAR推論部（TinyML）と不確実度の構成}
\label{sec:har_uncertainty}

\subsection{目的}
本研究の制御は，HARの推論結果そのものではなく，「推論がどの程度信頼できるか」を表す不確実度と，「状態がどの程度安定しているか」を表す安定度に基づいて動作する．本節では，TinyML環境を想定したHAR推論部の位置づけと現状を整理し，端末内推論から不確実度$U$と安定度$S$を得て複合スコアCCSを構成する流れ，および実装上の制約と未完タスクをまとめる．

\subsection{HARモデルと現状}
\subsubsection{入力と出力の概要}
HARは，加速度等の時系列入力を一定窓で切り出し，クラス確率分布を出力する．出力は多クラス（例：12クラス）のまま保持しつつ，通信制御では運用上の粗い状態（例：4クラス）へ集約する場合がある．集約は「制御の行動集合が小さい」「議論を単純化できる」という利点がある一方で，誤認識の影響が集約されるため，評価指標（4クラスBAcc等）を別途監視する必要がある．

\subsubsection{モデル到達点（A0とA\_tiny）}
本研究では，参照モデル（A0）と小型モデル（A\_tiny）を区別する．A0はTFLite int8（PTQ）まで整備されており，TinyML実装の土台となる．一方，A\_tinyは4クラス性能が未達であり，TFLite生成・計測が未完である．表\ref{tab:har_models_status}に，到達点をまとめる．

\begin{table}[tb]
  \centering
  \caption{HARモデルの到達点（例）}
  \label{tab:har_models_status}
  \begin{tabular}{p{0.18\linewidth}p{0.18\linewidth}p{0.18\linewidth}p{0.18\linewidth}p{0.18\linewidth}}
    \toprule
    モデル &amp; 12c BAcc（test） &amp; 4c BAcc（test） &amp; 4c F1（test） &amp; TFLite int8 \\
    \midrule
    A0（参照） &amp; 0.828 &amp; 0.960 &amp; 0.735 &amp; 生成済み（\SI{92.8}{\kilo\byte}） \\
    A\_tiny（現行） &amp; 0.858 &amp; 0.730 &amp; 0.728 &amp; 未生成（未測定） \\
    \bottomrule
  \end{tabular}
\end{table}

数値の根拠は，A0については\texttt{\detokenize{har/004/runs/phase0-1-acc/fold90/metrics.json}}，A\_tinyについては\texttt{\detokenize{har/004/runs/phase0-1-acc-tiny/fold90/metrics.json}}に基づく．A0のTFLiteは\texttt{\detokenize{har/004/export/acc_v1_keras/phase0-1-acc.v1.int8.tflite}}であり，sha256は\texttt{\detokenize{e1c3ff0042...}}である（\texttt{\detokenize{har/004/export/acc_v1_keras/manifest.json}}）．

\subsubsection{性能要件と未完タスクの位置づけ}
Phase 1の主張は「評価指標と計測系を確立し，ルールベース方策が固定より良い運用点になり得ることを示す」ことである．したがって，HARモデルの最終性能到達はPhase 2に跨る未完タスクとして扱い，本論文では未完であること自体を明示する．これは失敗談ではなく，再現性のために「何が揃っていて，何が揃っていないか」を固定するためである．

\subsection{不確実度U}
HARモデルは，各時刻$t$においてクラス確率分布$\mathbf{p}(t)=(p_1(t),\dots,p_K(t))$を出力する．本研究では，この確率分布から不確実度$U(t)$を導出し，通信制御のコンテキストとする．不確実度$U$は，正規化エントロピーとして定義できる\scite{shannon1948}．
\begin{equation}
  U(t) = -\frac{\sum_{k=1}^{K} p_k(t)\log p_k(t)}{\log K}
\end{equation}
ここで$U=0$は確信度が高い状態，$U=1$は不確実な状態に対応する．$U$は1回の推論出力から計算できるため，多回推論を必要とする不確実度推定（例：MC-Dropout）と比較して計算コストが小さい．

\subsubsection{較正（Calibration）の位置づけ}
ソフトマックス確率は，ニューラルネットの過信（overconfidence）により，確率値が実際の正解率を過大評価する場合がある．不確実度$U$を通信制御に用いる場合，この過信は「本来短間隔にすべき局面で長間隔を選ぶ」リスクに直結する．そのため，推論結果の確率較正（例：温度スケーリング）により，$U$と実際の誤り確率の対応を改善することが望ましい\scite{guo2017calibration}．

\subsection{安定度S}
安定度$S$は，直近窓におけるラベル遷移回数や，状態滞在時間に基づいて構成する．例えば，ラベル遷移が少ないほど安定であるという設計意図のもと，$S$を1に近づける．

\subsubsection{窓長と応答性}
安定度は窓長$W$に依存する．$W$が短いと遷移への応答が速い一方でノイズに敏感になり，$W$が長いと安定する一方で過渡期に追従しにくい．本研究では，実装の単純性を優先し，スライディング窓に基づく遷移回数の正規化という形で$S$を構成する（第2章）．

\subsection{複合スコアCCS}
複合スコアCCSは，確信度$(1-U)$と安定度$S$の線形結合として定義する．
\begin{equation}
  \mathrm{CCS}(t)=\alpha\,(1-U(t))+(1-\alpha)\,S(t)
\end{equation}
係数$\alpha$は設計パラメータであり，Phase 1では説明容易性を優先して固定値（例：$\alpha=0.7$）を採用する．ただし，$\alpha$や窓長$W$が変わるとCCS分布が変化し，閾値の意味が変わるため，モデル更新時には閾値再キャリブレーションが必要となる．

\subsubsection{係数設計と解釈}
係数$\alpha$を大きくすると，瞬時の確信度（$1-U$）を重視し，「いま確信があるなら長間隔」という単調な解釈に近づく．一方で$\alpha$を小さくすると，時間的一貫性（安定度$S$）を重視し，短時間の確信度の揺らぎで切替が発生しにくくなる．本研究では，Phase 1の主張（説明容易性）を優先し，確信度を主成分として扱う．

\subsection{時系列生成とログ}
制御に用いる$U(t)$，$S(t)$，$\mathrm{CCS}(t)$は，スライディング窓で逐次計算し，TXログとして保存する．このログは，オフライン評価および実機評価で共通に利用するため，ログ形式と時間軸の整合が重要である．

\subsubsection{計算コストと実装制約}
本研究の想定はバッテリ駆動の小型端末であり，推論・制御・ログの計算コストは制約となる．不確実度$U$は，推論で得られる確率分布からエントロピーを計算するだけであり，追加の推論回数を必要としない．したがって，MC-Dropout等の多回推論を伴う不確実度推定と比較して，計算コストと電力コストが小さい．

\subsection{量子化（PTQ int8）とTFLite整合（参照モデル）}
TinyML環境では，推論コストとメモリを抑えるため，TFLite int8（PTQ）等の量子化が重要となる．A0（参照モデル）では，TFLite int8を生成し，PyTorch出力との整合（argmax一致率，max\_probのMAE）を確認している．これにより，「推論値の揺らぎ」が制御の閾値に与える影響を監査できる．

\begin{table}[tb]
  \centering
  \caption{TFLiteアーティファクト（参照モデルA0，例）}
  \label{tab:tflite_artifact_a0}
  \begin{tabular}{p{0.28\linewidth}p{0.62\linewidth}}
    \toprule
    項目 &amp; 値 \\
    \midrule
    TFLite int8 &amp; \texttt{\detokenize{har/004/export/acc_v1_keras/phase0-1-acc.v1.int8.tflite}} \\
    sha256 &amp; \texttt{\detokenize{e1c3ff0042badac5dd9bb478a17fac79991736c813143b45e5cb981d9db68610}} \\
    サイズ &amp; \SI{92.8}{\kilo\byte} \\
    代表データ &amp; \texttt{\detokenize{har/001/export/acc_v1/rep_data.npy}}（rep\_samples=2000） \\
    PT vs TFLite &amp; argmax一致=0.98，max\_prob MAE=0.0277（200サンプル） \\
    \bottomrule
  \end{tabular}
\end{table}

\subsection{未完タスク（A\_tinyの実機導入に向けて）}
本論文執筆時点で，A\_tinyについては以下が未完である．
\begin{itemize}
  \item 4クラス性能の回復（BAcc\,$\ge0.80$等の要件を満たすまでの改善）．
  \item TFLite生成（PTQ int8）とサイズ・整合の計測（PT↔TFLite誤差，sha256記録）．
  \item ESP32上での推論時間$t_{\mathrm{inf}}$とArenaサイズの計測．
  \item CCS閾値（$\theta_{\mathrm{low/high}}$）の再キャリブレーション（TFLite出力ベース）．
\end{itemize}
これらは，単に精度改善のためだけではなく，「閾値で制御する際の意味づけを安定させる」ために必要である．本研究は，これらを将来課題として明示し，評価系（電力＋QoSの同時測定）がそのままPhase 2へ接続できる形で整備されている点を主張する．

\subsection{まとめ}
本節では，TinyML環境を想定したHAR推論部の現状と，不確実度$U$・安定度$S$・CCSの構成を整理した．また，量子化とTFLite整合の重要性，および未完タスクを明示した．以降の章では，このコンテキストに基づく広告間隔制御と，計測・指標に基づく評価を述べる．</file><file path="修士論文/chapters/conclusion.tex">% chapters/conclusion.tex --- おわりに（番号なし、目次には載せる）
\chapterwithtoc{おわりに}

本研究では，HARの推論不確実度に基づくBLE広告間隔の適応制御を対象とし，ルールベース方策の定義と評価指標の確立，および動的切替の実機検証に取り組んだ．特に，送信・受信・電力計測を統合した計測基盤を整備し，$\si{\micro\coulomb}/\text{event}$と受信遅延に基づく期限超過率を同時に評価できる形に整理した．この結果，単純な閾値ルールでも固定間隔より省電力になりうる運用点が存在し得ることを示し，将来のSafe Contextual Bandit最適化に接続する基盤を与えた．

\section*{本研究のまとめ}
本研究で得られた知見を以下にまとめる．
\begin{itemize}
  \item 不確実度と安定度から複合スコアCCSを構成し，閾値・ヒステリシス・最小滞在時間を用いたルールベース方策として定義した．
  \item 送信（TX），電力（TXSD），受信（RX）の三ノード構成により，同一試行で電力とQoS（TL，$P_{\mathrm{out}}(\tau)$）を評価できる基盤を整備した．
  \item TL/Poutの算出において，開始位相ずれが結果を歪め得ることを示し，定数オフセット補正（v5）として指標定義を固定した．
  \item オフライン評価により，固定間隔点と候補方策点のトレードオフを可視化し，実機実験の探索空間を縮小する枠組みを示した．
\end{itemize}

\section*{今後の課題}
今後は，動的制御に対してTL分布と$P_{\mathrm{out}}(\tau)$を高精度に算出し，オフライン評価の予測と実測の差分を体系的に説明できる形にまとめる．また，行動集合を拡張し，制約$\delta$の境界に沿ってより良い運用点を探索する必要がある．さらに，Safe Contextual Banditによるオンライン最適化へ拡張し，環境変化に対してもQoS制約を維持しながら省電力化できる枠組みを検証する．</file><file path="修士論文/figures/README.md"># figures/

図（PDF/PNG）を置くディレクトリ。

- `\includegraphics{figures/&lt;name&gt;}` のように拡張子なしで参照する。
- 生成物の元（スクリプトや入力データ）は本文側に明記する。</file><file path="修士論文/frontmatter/abstract.tex">% frontmatter/abstract.tex --- 要旨本文
% ここには通常，背景→課題→提案→方法→結果→結論→今後の課題，の順に1ページ程度で書く．

本研究では，Human Activity Recognition（HAR）の推論不確実度に基づいてBluetooth Low Energy（BLE）の広告間隔を適応制御し，省電力化とQuality of Service（QoS）維持を両立する手法を検討する．ウェアラブル端末やエッジデバイスでは，常時通信による電力消費がボトルネックとなる一方，スマートフォン側のスキャンは非理想的であり，広告間隔を単純に長くすると受信遅延や期限超過が増える．

提案手法は，HARの出力確率から得られる不確実度と，時間的安定度から複合スコアCCSを構成し，その値に応じて広告間隔を段階的に切り替えるルールベース方策である．実装・評価のために，送信（TX）・電力ロガ（TXSD）・受信（RX）の三ノード構成を用い，省電力指標$q_{\mathrm{event}}$（$\si{\micro\coulomb}/\text{event}$）と，受信遅延に基づく期限超過率$P_{\mathrm{out}}(\tau)$を同一試行で評価できる計測基盤を整備する．

オフライン評価と実機実験により，単純な閾値ルールでも固定間隔より省電力になりうる運用点が存在することを確認する．さらに，\SI{100}{\milli\second}と\SI{500}{\milli\second}の2値切替を用いた最小構成の動的制御を実装し，固定間隔と比較して中間的な挙動を示すことを確認する．最後に，非理想スキャン環境における限界と，Safe Contextual Banditによるオンライン最適化への拡張方針を議論する．</file><file path="修士論文/.gitignore">build/
*.aux
*.bbl
*.bcf
*.blg
*.fdb_latexmk
*.fls
*.log
*.out
*.run.xml
*.synctex.gz</file><file path="修士論文/chubuthesis.sty">% chubuthesis.sty --- 修士論文テンプレート（LuaLaTeX）
% 例の Word→PDF 修論の体裁を参考に、表紙/要旨/目次/図表キャプション等を整えています。

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{chubuthesis}[2025/12/15 Thesis style]

% --- 日本語（LuaLaTeX） ---
\RequirePackage{luatexja}
\RequirePackage[haranoaji]{luatexja-preset}

% --- レイアウト ---
% Word由来PDFの厳密な余白は推定が難しいため、一般的な学位論文の安全域で設定。
% 研究室/学科で指定があればここを調整してください。
\RequirePackage[a4paper,top=25mm,bottom=25mm,left=30mm,right=25mm]{geometry}

% 段落字下げ（1全角）
% LuaLaTeXでは「zw」単位ではなく \zw を使う（luatexja）
\setlength{\parindent}{1\zw}
\setlength{\parskip}{0pt}

% 目次は section まで（先輩修論の見え方に寄せる）
\setcounter{tocdepth}{1}
\setcounter{secnumdepth}{2}

% --- ページ番号（下右に統一） ---
\RequirePackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyfoot[R]{\thepage}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% chapter開始ページなど plain も同じにする
\fancypagestyle{plain}{%
  \fancyhf{}%
  \fancyfoot[R]{\thepage}%
  \renewcommand{\headrulewidth}{0pt}%
  \renewcommand{\footrulewidth}{0pt}%
}

% --- 章見出し（中央寄せ・太字にしない） ---
\RequirePackage{titlesec}
\titleformat{\chapter}[display]
  {\normalfont\Large\centering}
  {第\thechapter\relax 章}
  {2em}
  {\Large}
\titleformat{name=\chapter,numberless}[display]
  {\normalfont\Large\centering}
  {}
  {0pt}
  {\Large}
\titlespacing*{\chapter}{0pt}{0.33\textheight}{0pt}

% --- 図表 ---
\RequirePackage{graphicx}
\RequirePackage{booktabs}
\RequirePackage{tabularx}
\RequirePackage{longtable}
\RequirePackage{array}

% --- 数式 ---
\RequirePackage{amsmath,amssymb}
\numberwithin{equation}{chapter}

% --- 単位 ---
\RequirePackage{siunitx}
\sisetup{detect-all}
\DeclareSIUnit{\decibelmilliwatt}{dBm}

% --- キャプション：図 4-1 タイトル / 表 4-1 タイトル ---
\RequirePackage{caption}
\renewcommand{\thefigure}{\thechapter-\arabic{figure}}
\renewcommand{\thetable}{\thechapter-\arabic{table}}
\captionsetup{labelsep=space}
\captionsetup[figure]{name=図,justification=centering}
\captionsetup[table]{name=表,justification=centering}

% --- 参照（図/表/式） ---
\newcommand{\figref}[1]{図~\ref{#1}}
\newcommand{\tabref}[1]{表~\ref{#1}}
\newcommand{\eqrefj}[1]{式~(\ref{#1})}
\newcommand{\secref}[1]{\ref{#1}節}

% --- 章（番号なし）でも目次に載せる：はじめに / おわりに / 謝辞 ---
\newcommand{\chapterwithtoc}[1]{%
  \chapter*{#1}%
  \addcontentsline{toc}{chapter}{#1}%
  \clearpage
}

% --- 参考文献（biblatex） ---
\RequirePackage[backend=biber,style=numeric,sorting=none]{biblatex}

% \scite{a,b} で [1][2] 形式を作る（普通の \cite は [1,2]）
\DeclareCiteCommand{\scite}
  {}
  {\mkbibbrackets{\usebibmacro{citeindex}\usebibmacro{cite}}}
  {}
  {}

% URL 表記を簡素化（&quot;url:&quot; / &quot;visited on&quot; を出さない）
\DeclareFieldFormat{url}{\url{#1}}
\renewbibmacro*{url+urldate}{\printfield{url}}

% --- ハイパーリンク（最後の方で読み込み） ---
\RequirePackage[hidelinks]{hyperref}
\RequirePackage{bookmark}

% --- 表紙・要旨ページ ---
% meta.tex で定義するコマンドを使う想定

\newcommand{\makethesistitle}{%
\begin{titlepage}
  \thispagestyle{empty}
  \centering
  \vspace*{20mm}
  {\Large \ThesisYearLabel\par}
  \vspace{25mm}

  \fbox{%
    \parbox{0.85\textwidth}{\centering
      \vspace{6mm}
      {\Large \ThesisTitle\par}
      \vspace{6mm}
    }%
  }

  \vfill
  {\Large \University\ \GraduateSchool\par}
  {\Large \Department\ \Course\par}
  \vspace{10mm}
  {\Large 氏名\hspace{2em}\AuthorFamily\ \AuthorGiven\par}
  \vspace{5mm}
  {\Large 指導教授\hspace{2em}\AdvisorFamily\ \AdvisorGiven\par}
\end{titlepage}
}

\newcommand{\makeabstractpage}{%
\clearpage
\thispagestyle{empty}
\noindent 修士論文題目

\vspace{6mm}
\begin{center}
  {\Large \ThesisTitle\par}
  \vspace{-2mm}
  \rule{0.9\textwidth}{0.4pt}
\end{center}

\vspace{4mm}
\noindent \AbstractDepartment\hspace{2em}氏名\hspace{2em}\AuthorFamily\ \AuthorGiven

\vspace{8mm}
\begin{center}
  論\quad 文\quad 要\quad 旨
\end{center}

\vspace{6mm}
\input{frontmatter/abstract}
\clearpage
}</file><file path="修士論文/latexmkrc">$out_dir = &apos;build&apos;;
$aux_dir = &apos;build&apos;;

# luaotfload/luatexja のキャッシュを書き込み可能な場所に固定する（sandbox対策）
$ENV{TEXMFCACHE}  = &apos;build/texmf-cache&apos;;
$ENV{TEXMFVAR}    = &apos;build/texmf-var&apos;;
$ENV{TEXMFCONFIG} = &apos;build/texmf-config&apos;;
$ENV{LUATEXCACHE} = &apos;build/luatex-cache&apos;;

# LuaLaTeX + biber (biblatex)
$pdf_mode = 4;
$lualatex = &apos;lualatex -interaction=nonstopmode -file-line-error %O %S&apos;;
$bibtex_use = 2;

# Keep going for draft builds; errors still surface in exit code.
$interaction = &apos;nonstopmode&apos;;</file><file path="修士論文/main.tex">% main.tex --- 修士論文テンプレート（LuaLaTeX）
\documentclass[a4paper,12pt,oneside]{ltjsreport}

% 体裁（図表キャプション、目次深さ、表紙/要旨ページ等）
\usepackage{chubuthesis}

% メタ情報（タイトル等）
\input{meta}

% 参考文献ファイル
\addbibresource{references.bib}

\begin{document}

% page anchor の重複警告を避ける（表紙・要旨はページ番号なし）
\hypersetup{pageanchor=false}

% --- 表紙（ページ番号なし） ---
\makethesistitle

% --- 要旨ページ（ページ番号なし） ---
\makeabstractpage

% --- 目次（ローマ数字 i） ---
\pagenumbering{roman}
\setcounter{tocdepth}{1}
\tableofcontents
\clearpage

% --- 本文（アラビア数字 1 から） ---
\hypersetup{pageanchor=true}
\pagenumbering{arabic}
\setcounter{page}{1}

\input{chapters/ch0_introduction}
\input{chapters/ch2_background_related}
\input{chapters/ch3_system_and_method}
\input{chapters/ch4_measurement_metrics_repro}
\input{chapters/ch5_evaluation}
\input{chapters/ch5_publicroad}

\input{chapters/conclusion}
\input{chapters/acknowledgements}

% --- 参考文献・参考URL ---
\printbibliography[heading=bibintoc,title={参考文献・参考 URL}]

\end{document}</file><file path="修士論文/meta.tex">% meta.tex --- 論文メタ情報（ここだけ編集すればOK）
% 全角数字にしたい場合は「２０２５」のように入力してください。

% ===== 表紙に出る情報 =====
\newcommand{\ThesisYearLabel}{２０２５年度修士論文}
\newcommand{\ThesisTitle}{HAR不確実度に基づくBLE広告間隔の適応制御に関する研究}

\newcommand{\University}{中部大学大学院}
\newcommand{\GraduateSchool}{工学研究科}
\newcommand{\Department}{情報工学専攻}
\newcommand{\Course}{博士前期課程}

\newcommand{\AuthorFamily}{姓}
\newcommand{\AuthorGiven}{名}

\newcommand{\AdvisorFamily}{姓}
\newcommand{\AdvisorGiven}{名}

% ===== PDFの「修士論文題目」ページ（要旨ページ）に出る情報 =====
\newcommand{\AbstractDepartment}{情報工学専攻}</file><file path="修士論文/README.md"># 修士論文 LaTeX テンプレート（LuaLaTeX）

Word→PDF の修論の体裁を参考に、表紙・要旨・目次・本文・図表キャプション・参考文献を一式で用意したテンプレートです。

---

## 1) まず編集するファイル

- `meta.tex`（タイトル・氏名など）
- `frontmatter/abstract.tex`（要旨）
- `chapters/*.tex`（本文）
- `references.bib`（参考文献）

---

## 2) コンパイル方法（LuaLaTeX推奨）

### ローカル（TeX Live）
```bash
latexmk main.tex
```

### Overleaf
- Compiler: **LuaLaTeX**
- Bibliography: **Biber**（biblatex使用）

---

## 3) 図の置き場

- `figures/` に入れて、拡張子なしで呼ぶのが楽です（PDF/PNG両対応）
```tex
\includegraphics[width=0.9\linewidth]{figures/fig_system_overview}
```

---

## 4) 引用の書き方

このテンプレートは biblatex です。

- 普通の引用（カンマ区切り）：`\cite{ref1,ref2}` → `[1,2]`
- 括弧を分けたい場合：`\scite{ref1,ref2}` → `[1][2]`

---

## 5) 体裁を変えたいとき

- 余白：`chubuthesis.sty` の `geometry` を編集
- 図表キャプション：`chubuthesis.sty` の `caption` 設定を編集
- 表紙/要旨ページ：`meta.tex`（値）と `chubuthesis.sty`（配置）を編集
- ページ番号（下右統一）：`chubuthesis.sty` の `fancyhdr` 設定を編集
- 章見出し（章扉の中央寄せ等）：`chubuthesis.sty` の `titlesec` 設定を編集
- 参考文献のURL表示：`chubuthesis.sty` の `biblatex` まわりを編集</file><file path="修士論文/references.bib">% references.bib --- 参考文献・参考URL
% biblatex/biber 用。まずは「本文中で引用できる最小セット」を置く。

@online{bluetooth_core_spec,
  title        = {Bluetooth Core Specification},
  organization = {Bluetooth SIG},
  url          = {https://www.bluetooth.com/specifications/bluetooth-core-specification/},
  urldate      = {2025-12-15},
}

@online{android_ble_scanner,
  title        = {BluetoothLeScanner},
  organization = {Android Developers},
  url          = {https://developer.android.com/reference/android/bluetooth/le/BluetoothLeScanner},
  urldate      = {2025-12-15},
}

@online{uci_ml_repo,
  title        = {UCI Machine Learning Repository},
  organization = {University of California, Irvine},
  url          = {https://archive.ics.uci.edu/},
  urldate      = {2025-12-15},
}

@book{lattimore2020bandit,
  title     = {Bandit Algorithms},
  author    = {Lattimore, Tor and Szepesv{\&apos;a}ri, Csaba},
  year      = {2020},
  publisher = {Cambridge University Press},
}

@article{shannon1948,
  author  = {Shannon, Claude E.},
  title   = {A Mathematical Theory of Communication},
  journal = {Bell System Technical Journal},
  year    = {1948},
  volume  = {27},
  pages   = {379--423, 623--656},
}

@inproceedings{guo2017calibration,
  title     = {On Calibration of Modern Neural Networks},
  author    = {Guo, Chuan and Pleiss, Geoff and Sun, Yu and Weinberger, Kilian Q.},
  booktitle = {Proceedings of the 34th International Conference on Machine Learning},
  year      = {2017},
}</file><file path="修士論文/WRITING_RULES.md"># 記述ルール（提案）

Word→PDF の修論（例）を踏まえつつ、LaTeX化で破綻しやすい部分を先に規格化したルールです。

---

## 0. 体裁ルール（守るべき型）

この修論テンプレートは、先輩修論（大学方針の体裁）に寄せる。以下は**ルールとして固定**し、本文側で勝手に崩さない。

1. **表紙**：年度ラベル → 題目（枠で囲う） → 所属（2行） → 氏名（1行） → 指導教授（1行）
2. **要旨ページ**：上部に「修士論文題目」→題目（下線）→「専攻　氏名　〇〇〇〇」（1行）→「論 文 要 旨」→要旨本文
3. **ページ番号**：目次はローマ数字（i から），本文はアラビア数字（1 から）で開始する
4. **ページ番号の位置**：全ページを下右に統一する（章開始ページの `plain` も含む）
5. **章扉**：各章は「章タイトルだけのページ」を挟み、本文は次ページから開始する（`\chapter{...}\clearpage`）
6. **図表キャプション**：図は `図 4-1 タイトル`，表は `表 4-1 タイトル`（章-連番、区切りはスペース）
7. **引用の見た目**：本文中は基本 `[1][2]` 形式（`\scite{a,b}`）を優先する（参考文献では `url:` や `visited on` を表示しない）

テンプレ側で設定済みのため、基本は本文の書き方だけ守ればよい。

---

## A. 文体・表記

1. **文体は「である調」で統一**
2. **句読点は「，」「．」を基本**（※研究室の慣例があればそちら優先）
3. **略語は初出で定義**（例：Bluetooth Low Energy（BLE））
4. **用語の揺れを禁止**（「端末/デバイス」「推定/推測」など）

---

## B. 章立て・見出し

1. **章は `\chapter`、節は `\section`、項は `\subsection`**
2. **各章は章扉を入れる**：`\chapter{...}` の直後に `\clearpage` を置き、本文は次ページから書く
3. **番号なし章（おわりに / 謝辞）は `\chapterwithtoc{...}` を使う**（目次に載せる）
4. **章番号・節番号は手で書かない**：`第X章で述べた` の代わりに `\secref{sec:...}` を使う

---

## C. 図・表

1. **図は `figure`、表は `table` 環境で管理**（手貼り禁止）
2. **本文中で必ず参照してから出す**（例：`…（\figref{fig:hoge}）…`）
3. **他資料から転載する場合はキャプションに明記**（例：`（[1]より引用）`）
4. **`caption` の形式はテンプレート通り**（図：`図 4-1 タイトル`、表：`表 4-1 タイトル`）

---

## D. 引用・参考文献

1. **引用は本文中に番号で示す**（`biblatex`）
2. **複数引用は**
   - `[1,2]`（`\cite{a,b}`）でも一般にはOK
   - 例に合わせたいなら `[1][2]`（`\scite{a,b}`）

3. **Webページは参照日（urldate）を入れる**

---

## E. 数式・単位・記号

1. **単位は SI に寄せる**（`siunitx` を使用）
2. **記号は定義してから使う**（記号表があると強い）

---

## F. AIを併用する前提の運用ルール（重要）

1. **章ごとにファイル分割**（テンプレート通り）
2. **AIに依頼するときのプロンプトを固定化**
   - 「である調」
   - 「句読点は，．」
   - 「図表は必ず `\label` と `\ref`」
   - 「引用は `\cite`/`\scite`」
3. **ビルドエラーをゼロに保つ**
   - 変更したら必ずコンパイル
   - 参照未解決（??）や重複ラベルを放置しない

---

## G. ビルド（ローカル）

このリポジトリでは `latexmk` を使い，生成物は `修士論文/build/` に出力する。

```bash
cd 修士論文
latexmk main.tex
```</file><file path="docs/decision_log_2025-12-13_letter_route.md"># decision_log_2025-12-13_letter_route

- 日付: 2025-12-13
- 目的: レター投稿を最速で成立させるため、「新規性」と「実装/実験リスク」を比較してルートを確定する。

## 前提（いま揃っているもの）
- 実機固定（Mode C2′, scan90%）: `results/stress_fixed/scan90/stress_causal_real_summary_1211_stress_agg_enriched_scan90_v4.csv`
- オフライン（mHealth合成 + U/CCS）: `results/mhealth_policy_eval/`（policy table / Pareto sweep / context mixing）
- 電力テーブル（固定interval）: `results/mhealth_policy_eval/power_table_sleep_eval_2025-12-13.csv`
  - 生成元: `sleep_eval_scan90/metrics/on_off_test_100~2000/txsd_power_summary.csv`（TXSD mean_p_mW, n=2）

## 候補ルート（TODOとの比較）

### ルートA（docs/TODO.mdの主線）
- P0: TL/Pout定義の固定 → scan90固定フルセット図表化（実測vsシミュ説明）
- P1: CCS_causal を実機で取得（S1/S4）→ 固定と比較
- P2: self-UCB（不確実性駆動）をシミュで設計

**長所**
- 既存のMode C2′資産（S1/S4、scan90、解析パイプライン）に直結していてブレが少ない。

**短所（新規性）**
- CCS_causal が「HAR不確実度（U）そのもの」から少し遠く、レターの主張を「不確実性駆動」に寄せにくい。

### ルートB（今回の流れ: U/CCS→interval のオフライン最適化を主線にする）
- mHealth合成から得た U/CCS ログに対して、閾値ルール（ヒステリシス）を評価。
- scan90固定（S1/S4）メトリクスで QoS を、sleep_eval の power table で電力を合成し、Paretoを提示。
- Safe-MABは「Future Work」または「オフライン1図」までに留める。

**長所（新規性×最速）**
- 「HARの不確実度に基づく通信制御」をPhase1（ルールベース）で主張できる。
- power table を入れることで「share100を減らすと電力が下がる」を定量で示せる。

**短所（リスク）**
- 実機の“動的切替そのもの”の実証が薄いと突っ込まれる可能性がある。
  - 対策: 実機は最小セット（固定 + 2値制御）で「切替が成立する」だけ確認し、主結果はオフライン合成で示す。

## 評価（新規性の観点）
レター（Phase 1）の主張は `docs/全体像.md` のとおり「決め打ちルールで固定より良い」を示すこと。
ここでの差は「CCS（擬似安定度）」中心か、「U（不確実度）」中心か。

- 新規性を立てやすいのはルートB（U/CCSを明示できる）。
- ただし、論文化の安全性（再現性・測定系の説明容易性）はルートAの資産を活かす方が高い。

## 決定（Best / Fast）
**ルートBを主線**にして、TODOのP0（指標定義・図表化）は並行で必ず踏む。

具体的には：
1) **P0（必須）**: TL/Poutの真値定義を固定し、scan90固定の図表を整える（ここはTODO準拠）。
2) **Phase1主結果**: U/CCS→interval（ルールベース）を、scan90 QoS + power table でオフライン評価し、Pareto（pout_1s vs avg_power）を提示。
3) **実機は最小**: 動的切替の動作確認は「100↔500（2値）」で最小本数のみ（固定100/500/2000と合わせて比較、nは小さくてよい）。
4) **Safe-MAB**: レターでは Future Work（またはオフライン1図）に留める。

## 直近の根拠データ（境界条件の確定）
- power table（sleep_eval, n=2）:
  - 100ms: 201.45 mW
  - 500ms: 182.95 mW
  - 1000ms: 180.50 mW
  - 2000ms: 179.75 mW
  - 重要: 電力低下の主効果は「100→500」で、500→2000は小さい。
- Pareto v5（power_table反映 + context mixing）:
  - `results/mhealth_policy_eval/pareto_front_v5_power_table/pareto_summary.md`
  - δ=0.12 は feasible=0、δ=0.13 は feasible&gt;0（境界が 0.12〜0.13 にある）。

## 次アクション（この順で進める）
- A1: `scripts/analyze_stress_causal_real.py` のTL/Pout真値定義を再確認し、`docs/metrics_definition.md` と整合させる（TODO P0）。
- B1: `results/mhealth_policy_eval/pareto_front_v5_power_table/` を主結果候補として固定（図・表の整理）。
- B2: レター用に action を {100,500}（2値）へ縮退した評価を追加（説明簡単・電力の主効果に一致）。
- C1: 実機（動的切替）を最小セットで確認（Fixed 100/500/2000 + 2値制御、各n=1〜3）。

## 生成済み（主張図の固定）
- δ帯の主張図（固定点＋採用候補3点）:
  - `results/mhealth_policy_eval/letter_v1/fig_delta_band.png`
  - 選定点: `results/mhealth_policy_eval/letter_v1/selected_policies.csv`

## 追記（2025-12-13, v5反映後）
- scan90固定メトリクスを v4 → v5 に更新（TL/Poutの時間同期を追加）:
  - v5: `results/stress_fixed/scan90/stress_causal_real_summary_1211_stress_agg_enriched_scan90_v5.csv`
  - v4 は開始位相ズレの影響で TL/Pout が歪む可能性があるため、以後は v5 を基準にする（`docs/metrics_definition.md` の「時間同期」参照）。
- v5を用いて、mHealth Pareto sweep を再実行（power table + context mixing）:
  - v6: `results/mhealth_policy_eval/pareto_front_v6_power_table_scan90_v5/pareto_summary.md`
  - 更新点: δ=0.10 が feasible（例: 90/243）となり、従来の「δ=0.12不可/0.13から可」は v4前提の結論として扱う。
- 影響:
  - `results/mhealth_policy_eval/letter_v1/` と `pareto_front_v5_power_table/` は v4前提の図表なので、レター本文に使う場合は v6（scan90 v5反映）で再生成が必要。</file><file path="docs/metrics_definition.md"># Metrics Definition (ストレス固定 / CCS 評価用)

本ドキュメントでは、実機ログ解析で用いる主要指標の定義を明文化する。PDR/遅延系の解釈がブレないように、分母・分子の取り方や下限値をここで固定する。

## PDR
- `adv_count`: TXSD summary (`# summary` の `adv_count`) を真値とし、RX由来で再計算しない。
- `pdr_raw = rx_count / adv_count`  
  - `rx_count`: RX行数（重複含む）。  
  - `adv_count`: TXSD基準でクランプ（min(rx_count, adv_count) を使う実装）。
- `pdr_unique = rx_unique_seq / adv_count`  
  - `rx_unique_seq`: `seq`（MFD 先頭の数値）でユニーク化した件数。  
  - カバレッジ指標に近い（「広告イベントの何割を一度でも拾えたか」）。  
  - QoS比較にはこちらを使用。  
- 注意: 重複受信が多いと `pdr_raw` は &gt;1 になりうるので、QoS用途には `pdr_unique` を参照する。

## TL / Pout
- 真値: `truth` CSV の `idx,label`（EFFECTIVE_LEN=6352 を基準。末尾遷移が TX 再生範囲外に出ないようクリップ）。  
- 遅延: 各遷移時刻 `t_event` から最初に正しいラベルを観測するまでの時間。  
  - `tl_mean`, `tl_p95`: 遷移ごとの遅延の平均 / 95%点。  
  - `Pout(τ)`: 遷移のうち、遅延 &gt; τ の割合。  

### 時間同期（重要）
TL/Pout は **RXログの `ms` と truth の時間軸が一致している**前提で計算する必要がある。実機では開始タイミングのズレ（例: RX開始が遅れる、TXが先に進む）が入りやすく、ズレを補正しないと **TL/Pout が不自然に小さく見える**（特に長間隔側）ことがある。

本リポジトリでは、固定間隔リプレイ（seqが単調増加）を前提に、次の「定数オフセット」で同期する（`scripts/analyze_stress_causal_real.py` の実装）。

- 各 `seq` の最初の観測時刻を `first_ms(seq)` とする（RXログ由来）。
- 期待される真値時刻は `seq * interval_ms` とみなす。
- `offset_ms = median_{seq&gt;0}( seq*interval_ms - first_ms(seq) )`
- TL/Pout 計算では `ms_aligned = ms + offset_ms` を用いる。

出力CSVでは以下で確認できる。
- `tl_time_offset_ms`: 推定したオフセット（ms）
- `tl_time_offset_n`: 推定に使ったseq数

### 下限（参考）
一般に、τ &lt; interval のとき、受信100%でも遅延の量子化により `Pout(τ)` は 0 にならない（例: interval=2000ms, τ=1s なら 0.5 が目安）。
ただし、実際の `Pout(τ)` の下限は「遷移時刻の分布」と「開始位相」に依存するため、**一律の下限値を前提にせず**、上記の時間同期を行った上で実測値で議論する。

## EFFECTIVE_LEN / 末端遷移
- TX は `EFFECTIVE_LEN=6352` ステップ（約10.6分）でクランプ。  
- truth も同じ長さにクリップして末端遷移のズレを防ぐ。  
- abort試行（短時間）は manifest から除外する。

## ファイル
- scan90（固定フルセット, v5）:
  - per-trial: `results/stress_fixed/scan90/stress_causal_real_summary_1211_stress_full_scan90_v5.csv`
  - per-trial抜粋: `results/stress_fixed/scan90/stress_causal_real_summary_1211_stress_modes_scan90_v5.csv`
  - 集約: `results/stress_fixed/scan90/stress_causal_real_summary_1211_stress_agg_scan90_v5.csv`
  - 集約+派生: `results/stress_fixed/scan90/stress_causal_real_summary_1211_stress_agg_enriched_scan90_v5.csv`
  - インデックス: `results/stress_fixed/scan90/index.md`

## 補足
- RX FW は一部 `RX_ModeC2prime_1202` ログが混在。解析時は manifest で trialごとに明示。  
- 2000ms は Pout/TL が大きく揺れるため、複数trialで平均・分散を見ること。  
- エネルギー: TXSD summary の `E_per_adv_uJ`, `E_total_mJ` を使用。平均電力は `E_total_mJ / duration`.</file></files></repomix>