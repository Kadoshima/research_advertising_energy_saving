% chubuthesis.sty --- 修士論文テンプレート（LuaLaTeX）
% 例の Word→PDF 修論の体裁を参考に、表紙/要旨/目次/図表キャプション等を整えています。

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{chubuthesis}[2025/12/15 Thesis style]

% --- 日本語（LuaLaTeX） ---
\RequirePackage{luatexja}
\RequirePackage[haranoaji]{luatexja-preset}

% --- レイアウト ---
% Word由来PDFの厳密な余白は推定が難しいため、一般的な学位論文の安全域で設定。
% 研究室/学科で指定があればここを調整してください。
\RequirePackage[a4paper,top=25mm,bottom=25mm,left=30mm,right=25mm]{geometry}

% 段落字下げ（1全角）
% LuaLaTeXでは「zw」単位ではなく \zw を使う（luatexja）
\setlength{\parindent}{1\zw}
\setlength{\parskip}{0pt}

% 目次は section まで（先輩修論の見え方に寄せる）
\setcounter{tocdepth}{1}
\setcounter{secnumdepth}{2}

% --- ページ番号（下右に統一） ---
\RequirePackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyfoot[R]{\thepage}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% chapter開始ページなど plain も同じにする
\fancypagestyle{plain}{%
  \fancyhf{}%
  \fancyfoot[R]{\thepage}%
  \renewcommand{\headrulewidth}{0pt}%
  \renewcommand{\footrulewidth}{0pt}%
}

% ltjsreport は章開始などで plainhead/plainfoot を使うため、こちらも同じにする
\fancypagestyle{plainhead}{%
  \fancyhf{}%
  \fancyfoot[R]{\thepage}%
  \renewcommand{\headrulewidth}{0pt}%
  \renewcommand{\footrulewidth}{0pt}%
}
\fancypagestyle{plainfoot}{%
  \fancyhf{}%
  \fancyfoot[R]{\thepage}%
  \renewcommand{\headrulewidth}{0pt}%
  \renewcommand{\footrulewidth}{0pt}%
}

% --- 章見出し（中央寄せ・太字にしない） ---
\RequirePackage{titlesec}
\titleformat{\chapter}[display]
  {\normalfont\Large\centering}
  {第\thechapter\relax 章}
  {2em}
  {\Large}
\titleformat{name=\chapter,numberless}[display]
  {\normalfont\Large\centering}
  {}
  {0pt}
  {\Large}
\titlespacing*{\chapter}{0pt}{0.33\textheight}{0pt}
\titlespacing*{name=\chapter,numberless}{0pt}{0.33\textheight}{0pt}

% --- 図表 ---
\RequirePackage{graphicx}
\RequirePackage{booktabs}
\RequirePackage{tabularx}
\RequirePackage{longtable}
\RequirePackage{array}

% --- 数式 ---
\RequirePackage{amsmath,amssymb}
\numberwithin{equation}{chapter}

% --- 単位 ---
\RequirePackage{siunitx}
\sisetup{detect-all}
\DeclareSIUnit{\decibelmilliwatt}{dBm}

% --- キャプション：図 4-1 タイトル / 表 4-1 タイトル ---
\RequirePackage{caption}
\renewcommand{\thefigure}{\thechapter-\arabic{figure}}
\renewcommand{\thetable}{\thechapter-\arabic{table}}
\captionsetup{labelsep=space}
\captionsetup[figure]{name=図,justification=centering}
\captionsetup[table]{name=表,justification=centering}

% --- 参照（図/表/式） ---
\newcommand{\figref}[1]{図~\ref{#1}}
\newcommand{\tabref}[1]{表~\ref{#1}}
\newcommand{\eqrefj}[1]{式~(\ref{#1})}
\newcommand{\secref}[1]{\ref{#1}節}

% --- 章（番号なし）でも目次に載せる：はじめに / おわりに / 謝辞 ---
\newcommand{\chapterwithtoc}[1]{%
  \chapter*{#1}%
  \addcontentsline{toc}{chapter}{#1}%
  \clearpage
}

% --- 参考文献（biblatex） ---
\RequirePackage[backend=biber,style=numeric,sorting=none]{biblatex}

% \scite{a,b} で [1][2] 形式を作る（普通の \cite は [1,2]）
\DeclareCiteCommand{\scite}
  {}
  {\mkbibbrackets{\usebibmacro{citeindex}\usebibmacro{cite}}}
  {}
  {}

% URL 表記を簡素化（"url:" / "visited on" を出さない）
\DeclareFieldFormat{url}{\url{#1}}
\renewbibmacro*{url+urldate}{\printfield{url}}

% --- ハイパーリンク（最後の方で読み込み） ---
\RequirePackage[hidelinks]{hyperref}
\RequirePackage{bookmark}

% --- 目次 ---
% numberless \chapter の「章扉（縦中央）」体裁を避け、目次の先頭余白を詰めて表示する
\makeatletter
\newcommand{\thesistableofcontents}{%
  \clearpage
  \thispagestyle{plain}%
  \pdfbookmark[0]{\contentsname}{toc}%
  \begin{center}
    {\Large \contentsname\par}
  \end{center}
  \vspace{1em}
  \@starttoc{toc}%
  \clearpage
}
\makeatother

% --- 表紙・要旨ページ ---
% meta.tex で定義するコマンドを使う想定

\newcommand{\makethesistitle}{%
\begin{titlepage}
  \thispagestyle{empty}
  \centering
  \vspace*{20mm}
  {\Large \ThesisYearLabel\par}
  \vspace{25mm}

  \fbox{%
    \parbox{0.85\textwidth}{\centering
      \vspace{6mm}
      {\Large \ThesisTitle\par}
      \vspace{6mm}
    }%
  }

  \vfill
  {\Large \University\ \GraduateSchool\par}
  {\Large \Department\ \Course\par}
  \vspace{10mm}
  {\Large 氏名\hspace{2em}\AuthorFamily\ \AuthorGiven\par}
  \vspace{5mm}
  {\Large 指導教授\hspace{2em}\AdvisorFamily\ \AdvisorGiven\par}
\end{titlepage}
}

\newcommand{\makeabstractpage}{%
\clearpage
\thispagestyle{empty}
\noindent 修士論文題目

\vspace{6mm}
\begin{center}
  {\Large \ThesisTitle\par}
  \vspace{-2mm}
  \rule{0.9\textwidth}{0.4pt}
\end{center}

\vspace{4mm}
\noindent \AbstractDepartment\hspace{2em}氏名\hspace{2em}\AuthorFamily\ \AuthorGiven

\vspace{8mm}
\begin{center}
  論\quad 文\quad 要\quad 旨
\end{center}

\vspace{6mm}
\input{frontmatter/abstract}
\clearpage
}
