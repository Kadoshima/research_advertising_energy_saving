% chapters/ch8_measurement_system.tex --- 第8章 計測系の健全化と再現性
\section{計測系の健全化と再現性確保}
\label{sec:measurement_system}

\subsection{目的}
本研究の主張は，電力とQoSを同時に評価した上で，固定間隔より良い運用点が存在することを示す点にある．したがって，計測系が不健全であれば，結論そのものが崩れる．本節では，計測系の構成と，過去に発生した代表的な不具合（異常値）の原因と対策を整理し，再現性確保のための運用ルールを述べる．

\subsection{三ノード構成（TX/TXSD/RX）}
電力計測はTX（被測定対象）の消費電流・電圧を計測し，受信品質はRXログから算出する．両者を同一試行で取得するために，同期信号で区間を揃える．この三ノード構成により，方策（固定/動的/学習）を差し替えても，同一の評価パイプラインで比較できる．

\subsection{計測装置の外観}
\figref{fig:measurement_setup_overview}に計測系の全体構成を，\figref{fig:measurement_nodes}に各ノードの外観を示す．以降の評価では，この三ノード構成（TX/TXSD/RX）を前提として，同一試行で電力と受信品質を取得する．

\begin{figure}[tb]
  \centering
  \includegraphics[width=0.85\linewidth]{figures/measurement_setup_overview_02}
  \caption{計測系の外観（TX/TXSD/RXの三ノード構成，2025-12-16撮影）}
  \label{fig:measurement_setup_overview}
\end{figure}

\begin{figure}[tb]
  \centering
  \begin{minipage}{0.48\linewidth}
    \centering
    \includegraphics[width=\linewidth]{figures/measurement_rx}
    \vspace{1mm}
    {\small (a) RXロガ（受信ログ）}
  \end{minipage}
  \hfill
  \begin{minipage}{0.48\linewidth}
    \centering
    \includegraphics[width=\linewidth]{figures/measurement_tx_txsd}
    \vspace{1mm}
    {\small (b) TX + TXSD（DUT + 電力ログ）}
  \end{minipage}
  \caption{計測ノードの外観（2025-12-16撮影）}
  \label{fig:measurement_nodes}
\end{figure}

\subsection{計測系の破綻モードと対策}
計測系の問題は，「値が揺れる」だけではなく，結論を逆転させる（例：OFFがONより大きい）形で顕在化し得る．表\ref{tab:measurement_failures}に，代表的な破綻モードと対策をまとめる．

\begin{table}[tb]
  \centering
  \caption{計測系の代表的な破綻モードと対策}
  \label{tab:measurement_failures}
  \begin{tabular}{p{0.30\linewidth}p{0.30\linewidth}p{0.30\linewidth}}
    \toprule
    破綻モード & 兆候 & 代表的対策 \\
    \midrule
    I/Oボトルネック（UART/SD） & 欠損増加，rate低下，dtの歪み & パススルー化，塊書き込み，整数CSV化 \\
    単位換算の誤り & 桁ズレ，ON/OFFの逆転 & 生ログから再積分し監査，式とラベルを固定 \\
    条件混在（LED/SYNCの違い等） & 条件間に定常オフセット & 比較は同一コード系列に限定，条件を明文化 \\
    時間軸不整合（RXとtruth） & TL/Poutが不自然に小さい & 定数オフセットで時間同期（\secref{sec:stress_fixed_metrics}） \\
    \bottomrule
  \end{tabular}
\end{table}

\subsection{代表的な異常：OFFがONより大きい問題}
初期の計測では，「広告OFFの方が広告ONより消費が大きい」という物理的に矛盾した結果が観察された．この問題は，無線スタックそのものではなく，PowerLogger側の処理能力不足（I/Oボトルネック）や，単位換算の不整合，UART通信エラーによる欠損が原因となり得る．

\noindent
本研究では，代表的要因と対策を表\ref{tab:measurement_failures}に要点化し，運用上は以下をチェックポイントとして監査した．
\begin{itemize}
  \item I/Oボトルネック：欠損増加$\rightarrow$dtの歪み$\rightarrow$積分破綻を引き起こすため，塊書き込み等で追従性を確保する．
  \item 単位換算：mV/$\mu$A/ms等の桁ずれは結論を逆転させ得るため，生ログ再積分とsummary整合で監査する．
  \item UART通信：文字混入や欠損を厳密パースで検出し，異常trialはその場で再試行して混在を避ける．
\end{itemize}

\subsection{実装トラブルと修正履歴}
本節では，実験の再現性を担保するため，実装上の問題と対策を「問題→症状→対策→再発防止」の観点で整理する．ここで扱う内容は，結果の水増しではなく，欠損や時間軸ずれによる結論の崩壊を避けるための前提条件である．

\begin{table}[tb]
  \centering
  \caption{代表的な実装トラブルと対策（要点）}
  \label{tab:implementation_troubles_summary}
  \begin{tabularx}{\linewidth}{p{0.26\linewidth}X p{0.28\linewidth}}
    \toprule
    問題 & 対策（要点） & 再発防止（監査） \\
    \midrule
    UARTデータ化け & ボーレート低下，厳密パース，欠損を許さないsummary設計 & 行数・欠損率・単位監査 \\
    SYNC検出失敗（短パルス） & HIGH保持やラッチで確実に検出できる信号設計へ変更 & TX/RX/TXSDの境界一致を確認 \\
    試行境界の不一致 & SYNC\_END等で試行区間を一致させる & ms\_totalとadv\_countの整合 \\
    SD I/O失敗 & SPIクロック調整，塊書き込み，open失敗時の即時停止 & 末尾summaryの有無を監査 \\
    \bottomrule
  \end{tabularx}
\end{table}
\noindent
これらは研究の主張そのものではないが，欠損や試行区間のずれによる結論の崩壊を避けるために不可欠である．対策はRunbook（\secref{sec:runbook}）に固定し，試行ごとにms\_total/adv\_count/欠損率等を監査して再現性を担保した．

\subsection{Golden Master（最小再現構成）}
比較実験では，ON/OFFや条件間でコード系列が混在すると，LEDや同期信号の扱いの差が定常オフセットとなり，純粋な広告間隔の差分を評価できない．したがって，代表的な再現構成（Golden Master）を定め，これを基準としてデータを蓄積する．本研究では，役割ごとにスケッチを分割し，ファイル名の接頭辞（RX\_/TX\_/TXSD\_）で役割を明確化する．

\subsection{運用ルール}
再現性確保のため，以下を原則とする．
\begin{itemize}
  \item 解析対象の選別はマニフェストで明示し，除外理由を記録する．
  \item 単位監査（再積分とsummaryの一致）を定期的に実行し，桁ずれや欠損を早期に検知する．
  \item 重要な作業は作業ログに追記し，生成物のパスとコマンドを残す．
\end{itemize}

\subsection{まとめ}
本節では，計測系の健全化と再現性確保のための要点を整理した．これにより，固定間隔と動的制御の比較が「同一の評価系で再現可能」であることを担保し，次段階（オンライン最適化）へ接続する基盤とする．
