2025-12-13
- [15:40 JST] sleep_eval_scan90 firmware整備（Step1: sleep効果最大見積り用）: TX/RXを「単位の取り扱い」と「本当にその間隔で動いているか」の観点で修正。TXは controller に広告間隔を設定（0.625ms単位変換）し、CPU側の100ms周期ペイロード更新を廃止、trial開始/終了で adv->start/stop と SYNC を揃える最小ダミー広告版に刷新（LED/TICK/Serial/SDをデフォルト無効）。RXはscan interval/windowを0.625ms単位に明示変換してscan90%意図（100ms/90ms）を保証。更新ファイル: sleep_eval_scan90/src/tx/TX_ModeC2prime_1210.ino, sleep_eval_scan90/src/tx/TX_ModeC2prime_1210/TX_ModeC2prime_1210.ino, sleep_eval_scan90/src/rx/RX_ModeC2prime_1210/RX_ModeC2prime_1210.ino, sleep_eval_scan90/README.md。
- [15:42 JST] 追加: .gitignore に repomix-output.* を追加（sleep_eval_scan90配下の生成物混入防止）。
- [15:58 JST] 注意追記: TXで "[TX] SD init FAIL" が出る場合は sleep_eval 用TXではなく旧SD版TXをフラッシュしている可能性が高い。sleep_eval用TXはSD不使用・BLE名=TX_SLEEP_EVAL/ManufacturerData=0000_DUMMY で識別。
- [16:45 JST] sleep_eval_scan90 取得データを集計: sleep_eval_scan90/data/{100,2000}/TX のTXSDログから mean_p_mW を抽出し、interval別の集計CSVと図を生成（sleep_eval_scan90/analysis/summarize_txsd_power.py）。結果: 100ms mean_p≈200.80mW(n=2)、2000ms mean_p≈178.74mW(n=5)、差分≈-22.06mW（約-11%）。途中終了ファイル（trial_064_on.csv）は除外。成果物: sleep_eval_scan90/metrics/{txsd_power_trials.csv,txsd_power_summary.csv,summary.md}, sleep_eval_scan90/plots/txsd_power_summary.png, sleep_eval_scan90/data/README.md。
- [17:10 JST] sleep_eval_scan90 データ構造を ON/OFF 比較向けに整理: sleep_eval_scan90/data/{100,2000} を sleep_eval_scan90/data/sleep_on/{100,2000} に移動し、集計スクリプトを condition(sleep_on/sleep_off) 対応に拡張（sleep_eval_scan90/analysis/summarize_txsd_power.py）。以後 sleep_off は sleep_eval_scan90/data/sleep_off/ に追加して同一スクリプトで比較可能。
- [17:25 JST] 取得データの解釈と比較方針: ユーザ申告により sleep_eval_scan90/data のセットは sleep ON として扱う。scan90 v4（従来: avg_powerが100/2000でほぼ不変=~200mW台）と比較すると、本セットは 2000msで mean_p≈178.74mWまで低下し、100msは≈200.8mWでほぼ同等。→ 2000msでsleep/idleが効いている可能性が高い。確定のため、同一計測系で sleep_off を同条件(100/2000ms)で取得し、sleep_eval_scan90/data/sleep_off/ に追加して同一集計でON/OFF差分を出す方針に決定。
- [17:55 JST] sleep_eval_scan90/src の4条件連続取得に対応: TXを4条件(100/2000 × sleep OFF/ON)を1回の実行で順次実行し、trial境界で adv start/stop + SYNC を揃えるステートマシンに刷新。sleep OFFは esp_pm_lock(ESP_PM_NO_LIGHT_SLEEP) acquire、sleep ONはreleaseで切替。TXSDはSYNC立上り後PREAMBLE_WINDOW_MS内のTICKパルス数をcond_idとして解釈し、ファイル名(trial_*_c{cond}_i{interval}_{sleep}.csv)とmeta(cond_id/adv_interval_ms/sleep)に埋め込み。RXは受信labelを # condition_label としてファイル先頭に追記。README更新。
- [17:58 JST] 解析スクリプト拡張: sleep_eval_scan90/analysis/summarize_txsd_power.py を sleep_on/sleep_off をディレクトリ名から判別し、txsd_power_diff.md に DoD（4条件が揃った場合）を出力するように更新。
